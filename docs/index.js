'use strict';globalThis.mdlr=(()=>{let r,t,e={},l=(r,t,e={})=>u[r]?.l(t,{name:t,require:(u,a)=>([r,t]=n(u),e[u]??l(r,t,a))}),n=e=>([,r="unit",t]=/^(?:\[([a-z]+)\])?([-:a-z0-9_]+)$/.exec(e),[r,`[${r}]${t}`]),u={mdlr:{r:(r,t)=>{/^\[mdlr\]::[a-z]+$/.test(r)?t(u):e[r]=t},l:(r,t)=>e[r](t)}};return(e,a)=>{[r,t]=n(e),a?.constructor===Function?u[r]?.r(t,a):l(r,t,a)}})();mdlr('[mdlr]::unit',(l=>{let r={};l.unit={r:(l,t)=>{r[l]=t},l:(l,t)=>r[l](t)}}));mdlr('base64',(t=>{const e='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/',n={};return e.split('').forEach(((t,e)=>n[t]=e)),n['=']=0,{decode:function(t){let e=t.length,r=e/4*3;'='===t[e-2]&&--r,'='===t[e-1]&&--r;const o=new Uint8Array(r);let c=0;for(let r=0;r<e;r+=4){const e=n[t[r+0]]<<18|n[t[r+1]]<<12|n[t[r+2]]<<6|n[t[r+3]];o[c+0]=e>>16&255,o[c+1]=e>>8&255,o[c+2]=e>>0&255,c+=3}return o},encode:function(t){let n='';const r=new Uint8Array(t.buffer),o=r.byteLength,c=o%3,l=o-c;let f,s,u,i,a;for(let t=0;t<l;t+=3)a=r[t]<<16|r[t+1]<<8|r[t+2],f=a>>18&63,s=a>>12&63,u=a>>6&63,i=a>>0&63,n+=e[f]+e[s]+e[u]+e[i];return 1==c?(a=r[l],f=(252&a)>>2,s=(3&a)<<4,n+=e[f]+e[s]+'=='):2==c&&(a=r[l]<<8|r[l+1],f=(64512&a)>>10,s=(1008&a)>>4,u=(15&a)<<2,n+=e[f]+e[s]+e[u]+'='),n}}}));mdlr('enge:psx',(e=>{Object.assign(window,e.require('enge:utils'),e.require('enge:psx:core'),e.require('enge:psx:trace')),Object.assign(window,e.require('enge:psx:serial'),e.require('enge:psx:gamepad'),e.require('enge:psx:cpu'),e.require('enge:psx:cdr'),e.require('enge:psx:mdec'),e.require('enge:psx:gpu'),e.require('enge:psx:gte'),e.require('enge:psx:dma'),e.require('enge:psx:mmu'),e.require('enge:psx:rec'),e.require('enge:psx:rtc'),e.require('enge:psx:spu')),Object.assign(window,e.require('enge:psx:index'))}));mdlr('enge:psx:cdr',(e=>{var t=function(e){return 16*Math.floor(e/10)+Math.floor(e%10)},s=function(e){return 10*Math.floor(e/16)+Math.floor(e%16)};let r=new Int8Array(0),a=new Int16Array(0),u=new Int32Array(0);var c={cdImage:new Uint32Array(0),cdRomFile:void 0,currLoc:0,filter:{},hasCdFile:!1,irq:0,irqEnable:255,mode:0,ncmdctrl:0,ncmdread:0,params:new Array(16),pcm:new Float32Array(18816),pcmidx:0,pcmmax:0,results:new Array(16),sectorEnd:0,sectorIndex:0,sectorOffset:0,sectorSize:0,seekLoc:0,currTrack:{},status:24,statusCode:0,xa:new Float32Array(8064),playIndex:0,lastCommand:0,tracks:[],volCdLeft2SpuLeft:1,volCdLeft2SpuRight:0,volCdRight2SpuLeft:0,volCdRight2SpuRight:1,config:{volCdLeft2SpuLeft:1,volCdLeft2SpuRight:0,volCdRight2SpuLeft:0,volCdRight2SpuRight:1},mute:!1,rd08r1800:function(){return c.status},rd08r1801:function(){return 33==(35&c.status)?(1===c.results.length&&(c.status&=-65,c.status&=-33),c.results.shift()):0},rd08r1802:function(){return 64&c.status?c.cdImage.getInt8(c.sectorOffset+c.sectorIndex++):0},rd08r1803:function(){switch(3&c.status){case 0:return 224|c.irqEnable;case 1:return c.irq;default:abort('unimplemented index mode:'+(3&c.status))}},wr08r1800:function(e){c.status=-4&c.status|3&e},wr08r1801:function(e){switch(3&c.status){case 0:c.command(e);break;case 3:c.config.volCdRight2SpuRight=((255&e)>>>0)/128;break;default:abort('unimplemented index mode:'+(3&c.status))}},wr08r1802:function(e){switch(3&c.status){case 0:c.params.push(e),16===c.params.length&&(c.status&=-17);break;case 1:c.irqEnable=e,c.irq=0;break;case 2:c.config.volCdLeft2SpuLeft=((255&e)>>>0)/128;break;case 3:c.config.volCdRight2SpuLeft=((255&e)>>>0)/128;break;default:abort('unimplemented index mode:'+(3&c.status))}},wr08r1803:function(e){switch(3&c.status){case 0:128===e&&(c.status|=64);break;case 1:31&e&c.irqEnable&&c.acknowledgeInterrupt(e),64&e&&c.resetparams();break;case 2:c.config.volCdLeft2SpuRight=((255&e)>>>0)/128;break;case 3:32&e&&(c.volCdLeft2SpuLeft=c.config.volCdLeft2SpuLeft,c.volCdLeft2SpuRight=c.config.volCdLeft2SpuRight,c.volCdRight2SpuLeft=c.config.volCdRight2SpuLeft,c.volCdRight2SpuRight=c.config.volCdRight2SpuRight);break;default:abort('unimplemented index mode:'+(3&c.status))}},acknowledgeInterrupt:function(e){c.irq&=~(31&e&c.irqEnable)},resetparams:function(){c.params.length=0},command:function(e){let t=512;switch(c.setIrq(0),c.results.length=0,c.status|=128,c.ncmdctrl=e,e){case 1:t=50401;break;case 3:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 18:case 19:case 20:case 25:case 26:case 30:break;case 10:t=81102;case 2:case 6:case 7:case 8:case 21:case 22:case 27:case 9:c.stopReading();break;case 153:break;default:abort('unimplemented command: $'+hex(e,2))}psx.setEvent(this.eventCmd,t>>>0)},setIrq:function(e){c.irq=224&c.irq|31&e,31&c.irq&c.irqEnable&&(cpu.istat|=4)},enqueueEvent:function(e,...t){this.results.length&&abort('not yet read all results'),this.results.push(t),this.status&=-129,this.status|=32,this.setIrq(e)},eventCmd:null,completeCmd:function(e,r){if(psx.unsetEvent(e),31&c.irq)return void psx.setEvent(this.eventCmd,64);const a=PSX_SPEED/(128&c.mode?150:75),u=c.currLoc-150;var n=c.ncmdctrl;switch(c.ncmdctrl=0,n){case 0:break;case 1:c.hasCdFile?this.enqueueEvent(3,2):this.enqueueEvent(5,1);break;case 2:0!==c.params[0]||0!==c.params[1]||0!==c.params[2]?c.seekLoc=4500*s(c.params[0])+75*s(c.params[1])+s(c.params[2]):c.seekLoc=c.currLoc,this.enqueueEvent(3,2);break;case 3:0!==c.params.length&&0!==c.params[0]||(c.currLoc=c.seekLoc),1===c.params.length&&(c.currTrack=c.tracks[s(c.params[0])],c.currLoc=c.seekLoc=c.currTrack.begin+150,console.log(`CdlPlay: ${s(c.params[0])} : ${c.currLoc}`)),psx.setEvent(this.eventRead,a>>>0),c.ncmdread=3,this.enqueueEvent(3,130);break;case 6:psx.setEvent(this.eventRead,a>>>0),c.ncmdread=6,this.enqueueEvent(3,66),c.currLoc=c.seekLoc;break;case 7:this.enqueueEvent(3,0),c.ncmdctrl=112,c.status|=128;break;case 112:case 160:case 480:this.enqueueEvent(2,2);break;case 8:this.enqueueEvent(3,2),psx.setEvent(this.eventCmd,(128&c.mode?25845878:13863626)>>>0),c.ncmdctrl=128,c.status|=128;break;case 128:this.enqueueEvent(2,0);break;case 9:c.results.push(32|c.statusCode),psx.setEvent(this.eventCmd,(128&c.mode?1097107:2168860)>>>0),c.ncmdctrl=144,c.status|=128,c.status|=32,c.setIrq(3);break;case 144:c.statusCode=-33&c.statusCode|2,c.results.push(c.statusCode),c.status&=-129,c.status|=32,c.setIrq(2);break;case 153:c.statusCode=-161&c.statusCode|2,c.results.push(c.statusCode),c.status&=-129,c.status|=32,c.setIrq(4);break;case 10:this.enqueueEvent(3,2),psx.setEvent(this.eventCmd,4096),c.ncmdctrl=160,c.status|=128;break;case 11:this.enqueueEvent(3,2),this.mute=!0;break;case 12:this.enqueueEvent(3,2),this.mute=!1;break;case 13:this.filter={file:c.params[0],chan:c.params[1]},this.enqueueEvent(3,2);break;case 14:this.enqueueEvent(3,2),this.mode=c.params[0];break;case 15:this.enqueueEvent(3,2,c.mode,0,c.filter.file,c.filter.chan);break;case 16:c.results.push(c.cdImage.getInt8(c.sectorOffset+12+0)),c.results.push(c.cdImage.getInt8(c.sectorOffset+12+1)),c.results.push(c.cdImage.getInt8(c.sectorOffset+12+2)),c.results.push(c.cdImage.getInt8(c.sectorOffset+12+3)),c.results.push(c.cdImage.getInt8(c.sectorOffset+12+4)),c.results.push(c.cdImage.getInt8(c.sectorOffset+12+5)),c.results.push(c.cdImage.getInt8(c.sectorOffset+12+6)),c.results.push(c.cdImage.getInt8(c.sectorOffset+12+7)),c.status&=-129,c.status|=32,c.setIrq(3);break;case 17:{let e=c.currLoc-150-c.currTrack.begin,s=e/4500>>0,r=(e/75>>0)%60,a=e%75;c.results.push(t(c.currTrack.id)),c.results.push(1),c.results.push(t(s)),c.results.push(t(r)),c.results.push(t(a)),c.results.push(t((c.currLoc-150)/75/60%60)),c.results.push(t((c.currLoc-150)/75%60)),c.results.push(t((c.currLoc-150)%75)),c.status&=-129,c.status|=32,c.setIrq(3)}break;case 18:console.log("CdlSetSession"),psx.setEvent(this.eventCmd,4096),c.ncmdctrl=288,c.statusCode|=2,c.results.push(c.statusCode),c.status|=32,c.setIrq(3);break;case 288:c.statusCode|=2;let e=u/4500>>0,r=(u/75>>0)%60,n=u%75;c.results.push(130,t(c.currTrack.id),1,t(e),t(r),t(n),0,0),c.status&=-129,c.status|=32,c.setIrq(1);break;case 19:console.log("CdlGetTN"),c.statusCode|=2,c.results.push(c.statusCode),c.results.push(1),c.results.push(t(this.tracks.length-1)),c.status&=-129,c.status|=32,c.setIrq(3);break;case 20:{let e=0,r=this.tracks[s(c.params[0])];if(!r){c.statusCode|=16,c.results.push(17),c.results.push(128),c.status&=-129,c.status|=32,c.setIrq(5);break}e=0===c.params[0]?Math.floor((r.end+150)/75):Math.floor((r.begin+150)/75),console.log(`CdlGetTD: ${c.params[0]}`,r),c.statusCode|=2,c.results.push(c.statusCode),c.results.push(t(Math.floor(e/60))),c.results.push(t(Math.floor(e%60))),c.status&=-129,c.status|=32,c.setIrq(3)}break;case 21:psx.setEvent(this.eventCmd,4096),c.ncmdctrl=336,this.enqueueEvent(3,66),c.status|=128;break;case 336:case 352:this.enqueueEvent(2,2),c.currLoc=c.seekLoc;break;case 22:psx.setEvent(this.eventCmd,4096),c.ncmdctrl=352,this.enqueueEvent(3,66),c.status|=128;break;case 25:c.results.push(153),c.results.push(2),c.results.push(1),c.results.push(195),c.status&=-129,c.status|=32,c.setIrq(3);break;case 26:psx.setEvent(this.eventCmd,18944),c.results.push(c.statusCode),c.ncmdctrl=416,c.status|=32,c.setIrq(3);break;case 416:c.hasCdFile?(c.results.push(2),c.results.push(0),c.results.push(32),c.results.push(0),c.results.push('e'.charCodeAt(0)),c.results.push('N'.charCodeAt(0)),c.results.push('G'.charCodeAt(0)),c.results.push('E'.charCodeAt(0)),c.status&=-129,c.status|=32,c.setIrq(2)):(c.statusCode|=16,c.results.push(17),c.results.push(128),c.status&=-129,c.status|=32,c.setIrq(5));break;case 27:psx.setEvent(this.eventRead,a>>>0),c.ncmdread=27,this.enqueueEvent(3,66),c.currLoc=c.seekLoc;break;case 30:psx.setEvent(this.eventCmd,4096),c.ncmdctrl=480,this.enqueueEvent(3,2);break;default:abort('unimplemented async command: $'+hex(c.ncmdctrl,2))}c.lastCommand=n,c.resetparams()},eventRead:null,completeRead:function(e,s){if(31&c.irq)return void psx.updateEvent(e,64);let r=33868800/(128&c.mode?150:75),a=c.currLoc-150;switch(c.ncmdread){case 3:if(c.playIndex=0,c.currLoc===c.currTrack.end&&(console.log('end-of-track:',c.currTrack),2&c.mode))return console.log('- autopause:'),psx.unsetEvent(e),c.command(153);if(5==(5&c.mode)){switch(a%75){case 0:case 20:case 40:case 60:{let e=a/4500>>0,s=(a/75>>0)%60,r=a%75;c.results.push(130,t(c.currTrack.id),1,t(e),t(s),t(r),0,0),c.status&=-129,c.status|=64,c.status|=32,c.setIrq(1)}break;case 10:case 30:case 50:case 70:{let e=c.currLoc-c.currTrack.begin,s=e/4500>>0,r=(e/75>>0)%60,a=e%75;c.results.push(130,t(c.currTrack.id),1,t(s),128|t(r),t(a),0,0),c.status&=-129,c.status|=64,c.status|=32,c.setIrq(1)}}c.readSector(c.currLoc),psx.updateEvent(e,r),c.currLoc++;break}case 6:case 27:c.results.push(34),c.status&=-129,c.status|=64,c.status|=32,c.setIrq(1),c.readSector(c.currLoc),psx.updateEvent(e,r),c.currLoc++;break;default:console.log('unimplemented async read: $'+hex(c.ncmdread,2)),psx.unsetEvent(this.eventRead)}},readSector:function(e){if(void 0!==c.cdImage){for(let t=1;t<c.tracks.length;++t){let s=c.currTrack=c.tracks[t];if(s.begin<e&&e<s.end)break}switch(c.sectorOffset=2352*(e-150),48&c.mode){case 0:c.sectorIndex=24,c.sectorSize=2048;break;case 16:c.sectorIndex=24,c.sectorSize=2328;break;case 32:case 48:c.sectorIndex=12,c.sectorSize=2340}if(c.sectorEnd=c.sectorIndex+c.sectorSize,0!=(72&c.mode)){if(2!==r[c.sectorOffset+15])return;if(72==(72&c.mode)){if(r[c.sectorOffset+16]!==c.filter.file)return;if(r[c.sectorOffset+17]!==c.filter.chan)return}if(68!=(68&r[c.sectorOffset+18]))return;var t=r[c.sectorOffset+19];switch(t>>>0&3){case 0:var s='mono';break;case 1:s='stereo'}switch(t>>>2&1){case 0:var a=37800;break;case 1:a=18900}if(c.pcmidx=0,c.xa.fill(0),c.pcm.fill(0),'stereo'===s)var u=c.decodeStereo();'mono'===s&&(u=c.decodeMono());for(var n=44100*u/a,o=0,d=0,i=c.xa,l=(u=-1,c.pcm),f=0;f<n;f+=2)l[++u]=i[o+0],l[++u]=i[o+1],(d+=a)>=44100&&(d-=44100,o+=2);c.pcmmax=u}}},nextpcm:function(e){if(3===c.ncmdread){if(c.currTrack.audio){const t=c.sectorOffset+c.playIndex>>1;let s=a[t+0]/32768,r=a[t+1]/32768,u=s*c.volCdLeft2SpuLeft+r*c.volCdRight2SpuLeft,n=r*c.volCdRight2SpuRight+s*c.volCdLeft2SpuRight;e[0]=u,e[1]=n}return c.currTrack.data&&(e[0]=0,e[1]=0),void(c.playIndex+=4)}if(0!=(72&c.mode)){c.pcmidx>=c.pcmmax-1&&(c.pcmidx=c.pcmmax-1);let t=c.pcm[c.pcmidx+0],s=c.pcm[c.pcmidx+1],r=t*c.volCdLeft2SpuLeft+s*c.volCdRight2SpuLeft,a=s*c.volCdRight2SpuRight+t*c.volCdLeft2SpuRight;e[0]=r,e[1]=a,c.pcmidx+=2}},decodeMono:function(){for(var e=0,t=this.sl,s=c.xa,a=0;a<18;++a)for(var u=c.sectorOffset+24+128*a,n=0;n<8;++n)for(var o=r[u+4+n],d=(15&o)>>>0,i=(240&o)>>>3,l=xa2flt[i+0],f=xa2flt[i+1],h=0;h<28;++h){var p=2*(256*d+(255&r[u+16+4*h+n/2>>>0])),m=t[1]*l+t[0]*f+xa2pcm[p+(1&n)];t[0]=t[1],t[1]=m,s[e++]=m,s[e++]=m}return e},sl:[0,0],sr:[0,0],decodeStereo:function(){for(var e=0,t=this.sl,s=this.sr,a=c.xa,u=0;u<18;++u)for(var n=c.sectorOffset+24+128*u,o=0;o<8;o+=2){for(var d=(15&(v=r[n+4+o]))>>>0,i=(240&v)>>>3,l=xa2flt[i+0],f=xa2flt[i+1],h=0;h<28;++h){var p=2*(256*d+(255&r[n+16+4*h+o/2>>>0])),m=t[1]*l+t[0]*f+xa2pcm[p+0];t[0]=t[1],t[1]=m,a[e+2*h+0]=m}var v;for(d=(15&(v=r[n+5+o]))>>>0,i=(240&v)>>>3,l=xa2flt[i+0],f=xa2flt[i+1],h=0;h<28;++h)p=2*(256*d+(255&r[n+16+4*h+o/2>>>0])),m=s[1]*l+s[0]*f+xa2pcm[p+1],s[0]=s[1],s[1]=m,a[e+2*h+1]=m;e+=56}return e},stopReading:function(){psx.unsetEvent(c.eventRead),c.statusCode&=-129,c.statusCode&=-33,c.ncmdread=0},dmaTransferMode0000:function(e,t){if(!(8388607&e))return 16;var s=(65535&t)<<2;clearCodeCache(e,s);for(var r=0;r<s;r+=4)map[(2097151&e)>>2]=u[c.sectorOffset+c.sectorIndex>>2],c.sectorIndex+=4,e+=4;return c.sectorIndex>=c.sectorEnd&&(c.status&=-65),s},setTOC:function(e){this.tracks=e},setCdImage:function(e){u=new Int32Array(e.buffer),a=new Int16Array(e.buffer),r=new Int8Array(e.buffer),c.hasCdFile=!0,c.cdImage=e}};return{cdr:Object.seal(c)}}));mdlr('enge:psx:core',(e=>{const c={clock:0,eventClock:0,events:[],inactiveEvents:[],lastId:0,addEvent:(e,t)=>{const n=Object.seal({id:c.lastId++,active:!0,clock:+c.clock+ +e,start:+c.clock,cb:t});return c.eventClock>n.clock&&(c.eventClock=n.clock),c.events.push(n),n},updateEvent:(e,t)=>(e.start=e.clock,e.clock+=+t,e.active=!0,c.eventClock>e.clock&&(c.eventClock=e.clock),e),unsetEvent:e=>{if(!e.active)return;const t=c.events.findIndex((c=>c.id===e.id));return-1!==t&&(c.inactiveEvents.push(e),c.events.splice(t,1),e.active=!1),e},eventCycles:e=>+c.clock-e.start,setEvent:(e,t)=>{if(!e.active){const t=c.inactiveEvents.findIndex((c=>c.id===e.id));-1!==t&&(c.inactiveEvents.splice(t,1),c.events.push(e))}return e.clock=+c.clock+ +t,e.start=+c.clock,e.active=!0,c.eventClock>e.clock&&(c.eventClock=e.clock),e},handleEvents:e=>{let t=Number.MAX_SAFE_INTEGER;const n=[];for(let e=0,t=c.events.length;e<t;++e){const t=c.events[e];c.clock>=t.clock&&n.push(t)}for(let e=0,t=n.length;e<t;++e){const t=n[e];t.cb(t,c.clock)}for(let e=0,n=c.events.length;e<n;++e){const n=c.events[e];n.clock<t&&n.active&&(t=n.clock)}return c.eventClock=t,cpuInterrupt(e)}};return Object.seal(c),{psx:c}}));mdlr('enge:psx:cpu',(s=>{const t={cause:0,cop:new Int32Array(32),cycles:0,epc:0,gpr:new Int32Array(32),hi:0,imask:0,istat:0,icurr:0,lo:0,pc:0,sr:0,forceWriteBits:0,getCtrl:function(s){switch(s){case 12:return this.sr>>0;case 13:return this.cause>>0;case 14:return this.epc>>0;case 15:return 2;default:return console.warn('getCtrl:'+s),this.cop[s]}},setCtrl:function(s,t){switch(this.cop[s]=t>>0,s){case 3:case 5:case 6:case 7:case 9:case 11:break;case 12:this.sr=t,this.forceWriteBits=65536&t?33554428:0;break;case 13:this.cause=4294966527&this.cause,this.cause|=768&t;break;default:cons1ole.warn('setCtrl:'+s)}},rfe:function(){this.sr=-16&this.sr|this.sr>>2&15},lwl:function(s,t){var i=memRead32(-4&t&33554431);switch(3&t){case 0:this.gpr[s]=16777215&this.gpr[s]|i<<24;break;case 1:this.gpr[s]=65535&this.gpr[s]|i<<16;break;case 2:this.gpr[s]=255&this.gpr[s]|i<<8;break;case 3:this.gpr[s]=0&this.gpr[s]|i<<0}},lwr:function(s,t){var i=memRead32(-4&t&33554431);switch(3&t){case 0:this.gpr[s]=0&this.gpr[s]|i>>>0;break;case 1:this.gpr[s]=4278190080&this.gpr[s]|i>>>8;break;case 2:this.gpr[s]=4294901760&this.gpr[s]|i>>>16;break;case 3:this.gpr[s]=4294967040&this.gpr[s]|i>>>24}},swl:function(s,t){var i=memRead32(-4&t&33554431)>>>0;switch(3&t){case 0:i=4294967040&i|this.gpr[s]>>>24;break;case 1:i=4294901760&i|this.gpr[s]>>>16;break;case 2:i=4278190080&i|this.gpr[s]>>>8;break;case 3:i=0&i|this.gpr[s]>>>0}memWrite32(-4&t&33554431,i)},swr:function(s,t){var i=memRead32(-4&t&33554431)>>>0;switch(3&t){case 0:i=0&i|this.gpr[s]<<0;break;case 1:i=255&i|this.gpr[s]<<8;break;case 2:i=65535&i|this.gpr[s]<<16;break;case 3:i=16777215&i|this.gpr[s]<<24}memWrite32(-4&t&33554431,i)},neg:function(s){var t=s>>0&65535,i=s>>16&65535,r=1+(65535&~t);return t=65535&r,(i=65535&(r=(65535&~i)+(r>>>16)))<<16|t},mult:function(s,t){t>>=0;var i=0;if((s>>=0)<0&&(i^=1,s=this.neg(s)),t<0&&(i^=1,t=this.neg(t)),this.multu(s,t),1===i){var r=this.lo>>>0&65535,e=this.lo>>>16&65535,c=this.hi>>>0&65535,h=this.hi>>>16&65535,a=1+(65535&~r);r=65535&a,e=65535&(a=(65535&~e)+(a>>>16)),c=65535&(a=(65535&~c)+(a>>>16)),h=65535&(a=(65535&~h)+(a>>>16)),this.hi=(h<<16|c)>>0,this.lo=(e<<16|r)>>>0}},multu:function(s,t){var i=65535&(s>>>=0),r=s>>>16,e=65535&(t>>>=0),c=t>>>16,h=0,a=0,n=0,u=0;n+=(u+=i*e)>>>16,u&=65535,a+=(n+=i*c)>>>16,n&=65535,a+=(n+=r*e)>>>16,n&=65535,h+=(a+=r*c)>>>16,a&=65535,this.hi=(h<<16|a)>>>0,this.lo=(n<<16|u)>>>0},div:function(s,t){0===t?s>>0>=0?(this.hi=s,this.lo=4294967295):(this.hi=s,this.lo=1):t>>0==-1&&s>>>0==2147483648?(this.hi=0,this.lo=-2147483648):(this.hi=(s>>0)%(t>>0)>>0,this.lo=(s>>0)/(t>>0)>>0)},divu:function(s,t){0===t?(this.hi=s,this.lo=4294967295):(this.hi=(s>>>0)%(t>>>0)>>>0,this.lo=(s>>>0)/(t>>>0)>>>0)}};function i(s,i){return t.sr=-64&t.sr|t.sr<<2&63,t.cause=-125&t.cause|s,t.epc=i,vector}return Object.seal(t),{cpu:t,cpuException:i,cpuInterrupt:function(s){if(1==(1&t.sr)){let r=768&t.cause,e=768&t.sr;if(0!=(r&e))return i(r&e,s.pc);if(1024==(1024&t.sr)&&t.istat&t.imask)return i(1024,s.pc)}return s}}}));mdlr('enge:psx:dma',(r=>{const t={dpcr:0,dicr:0,r1080:0,r1084:0,r1088:0,r1080n:0,r1090:0,r1094:0,r1098:0,r1090n:0,r10a0:0,r10a4:0,r10a8:0,r10a0n:0,r10b0:0,r10b4:0,r10b8:0,r10b0n:0,r10c0:0,r10c4:0,r10c8:0,r10c0n:0,r10e0:0,r10e4:0,r10e8:0,r10e0n:0,eventDMA0:null,completeDMA0:function(r,e){this.r1088&=4278190079,this.r1080=this.r1080n,65536&t.dicr&&(t.dicr|=2164260864,cpu.istat|=8),psx.unsetEvent(r)},eventDMA1:null,completeDMA1:function(r,e){this.r1098&=4278190079,this.r1090=this.r1090n,131072&t.dicr&&(t.dicr|=2181038080,cpu.istat|=8),psx.unsetEvent(r)},eventDMA2:null,completeDMA2:function(r,e){this.r10a8&=4278190079,this.r10a0=this.r10a0n,262144&t.dicr&&(t.dicr|=2214592512,cpu.istat|=8),psx.unsetEvent(r)},eventDMA3:null,completeDMA3:function(r,e){this.r10b8&=4278190079,this.r10b0=this.r10b0n,524288&t.dicr&&(t.dicr|=2281701376,cpu.istat|=8),psx.unsetEvent(r)},eventDMA4:null,completeDMA4:function(r,e){this.r10c8&=4278190079,this.r10c0=this.r10c0n,1048576&t.dicr&&(t.dicr|=2415919104,cpu.istat|=8),psx.unsetEvent(r)},eventDMA6:null,completeDMA6:function(r,e){this.r10e8&=4278190079,this.r10e0=this.r10e0n,4194304&t.dicr&&(t.dicr|=3221225472,cpu.istat|=8),psx.unsetEvent(r)},rd08r10f6:function(){return t.dicr>>16&255},rd16r10f0:function(){return 65535&t.dpcr},rd32r10f0:function(){return t.dpcr},rd32r10f4:function(){return 2147483647&t.dicr},wr32r10f0:function(r){t.dpcr=r},wr08r10f6:function(r){r=r<<16|65535&t.dicr,t.dicr=t.dicr&~(2130706432&r|16777215)|16777215&r},wr32r10f4:function(r){t.dicr=t.dicr&~(2130706432&r|16777215)|16777215&r},wr32r1088:function(r){if(this.r1088=r,8&t.dpcr){let t=10;switch(r){case 0:break;case 16777729:t=mdc.dmaTransferMode0201(this.r1080,this.r1084),this.r1080n=this.r1080+(t<<2);break;default:abort('mdi-ctrl:'+hex(r))}psx.setEvent(this.eventDMA0,272*t/256>>>0)}else this.r1088&=4278190079},wr32r1098:function(r){if(this.r1098=r,128&t.dpcr){let t=10;switch(r){case 0:break;case 16777728:t=mdc.dmaTransferMode0200(this.r1090,this.r1094),this.r1090n=this.r1090+(t<<2);break;default:abort('mdo-ctrl:'+hex(r))}}else this.r1098&=4278190079},wr32r10a8:function(r){if(this.r10a8=r,2048&t.dpcr){let t=10;switch(r){case 0:case 1:case 1025:case 513:break;case 16777728:t=gpu.dmaTransferMode0200(this.r10a0,this.r10a4)||10,this.r10a0n=this.r10a0+(t<<2);break;case 16777729:t=gpu.dmaTransferMode0201(this.r10a0,this.r10a4)||10,this.r10a0n=this.r10a0+(t<<2);break;case 16778241:t=gpu.dmaTransferMode0401(this.r10a0,this.r10a4)||10,this.r10a0n=16777215;break;default:abort('gpu-ctrl:'+hex(r))}psx.setEvent(this.eventDMA2,272*t/256>>>0)}else this.r10a8&=4278190079},wr32r10b8:function(r){if(this.r10b8=r,32768&t.dpcr){let t=10;switch(r){case 0:break;case 285212672:case 289407232:t=cdr.dmaTransferMode0000(this.r10b0,this.r10b4),this.r10b0n=this.r10b0+(t<<2);break;default:abort('cd-ctrl:'+hex(r))}psx.setEvent(this.eventDMA3,(t*(128&cdr.mode)?5120:10240)/256>>>0)}else this.r10b8&=4278190079},wr32r10c8:function(r){if(this.r10c8=r,524288&t.dpcr){let t=10;switch(r){case 513:break;case 16777216:case 16777728:t=spu.dmaTransferMode0200(this.r10c0,this.r10c4),this.r10c0n=this.r10c0+(t<<2);break;case 16777217:case 16777729:t=spu.dmaTransferMode0201(this.r10c0,this.r10c4),this.r10c0n=this.r10c0+(t<<2);break;default:abort('spu-ctrl:'+hex(r))}psx.setEvent(this.eventDMA4,1056*t/256>>>0)}else this.r10c8&=4278190079},wr32r10e8:function(r){if(this.r10e8=1342177282&r|2,134217728&t.dpcr){let t=10;switch(this.r10e8){case 2:this.r10e0n=this.r10e0=map[(33554431&this.r10e0)>>2];break;case 268435458:case 1342177282:t=gpu.dmaLinkedListMode0002(this.r10e0,this.r10e4),this.r10e0n=16777215;break;default:abort('otc-ctrl:'+hex(r)+' '+hex(this.r10e8))}psx.setEvent(this.eventDMA6,272*t/256>>>0)}else this.r10e8&=4278190079}};return Object.seal(t),{dma:t}}));mdlr('enge:psx:gamepad',(e=>{let t=null,s=null;const o=new Map;function n(e){if(t===e)return;t=e;const s=document.getElementById('gamepad');s&&(s.classList.remove(...s.classList),s.classList.add('connected'),s.classList.add(e))}return o.set(69,{bits:16,property:'hi'}),o.set(68,{bits:32,property:'hi'}),o.set(88,{bits:64,property:'hi'}),o.set(83,{bits:128,property:'hi'}),o.set(81,{bits:1,property:'hi'}),o.set(84,{bits:2,property:'hi'}),o.set(87,{bits:4,property:'hi'}),o.set(82,{bits:8,property:'hi'}),o.set(38,{bits:16,property:'lo'}),o.set(39,{bits:32,property:'lo'}),o.set(40,{bits:64,property:'lo'}),o.set(37,{bits:128,property:'lo'}),o.set(32,{bits:1,property:'lo'}),o.set(13,{bits:8,property:'lo'}),window.addEventListener("keydown",(function(e){const t=o.get(e.keyCode),s=joy.devices[0];void 0!==t&&(s[t.property]&=~t.bits,n('keyboard'))}),!1),window.addEventListener("keyup",(function(e){const t=o.get(e.keyCode),s=joy.devices[0];void 0!==t&&(s[t.property]|=t.bits)}),!1),window.addEventListener("gamepadconnected",(function(e){s=e.gamepad,console.log(`~~ Gamepad '${s.id}' connected  ~~`),document.getElementById('gamepad').classList.add('connected')})),window.addEventListener("gamepaddisconnected",(function(e){console.log(`~~ Gamepad '${s.id}' disconnected  ~~`),document.getElementById('gamepad').classList.remove('connected'),s=null})),{handleGamePads:function(){if(!s)return;const e=navigator.getGamepads()[s.index];if(e){const t=joy.devices[0];n('gamepad'),t.lo=255,e.axes[0]<=-.4&&(t.lo&=-129),e.axes[0]>=.4&&(t.lo&=-33),e.axes[1]<=-.4&&(t.lo&=-17),e.axes[1]>=.4&&(t.lo&=-65),e.buttons[14].pressed&&(t.lo&=-129),e.buttons[15].pressed&&(t.lo&=-33),e.buttons[12].pressed&&(t.lo&=-17),e.buttons[13].pressed&&(t.lo&=-65),e.buttons[8].pressed&&(t.lo&=-2),e.buttons[9].pressed&&(t.lo&=-9),t.hi=255,e.buttons[3].pressed&&(t.hi&=-17),e.buttons[1].pressed&&(t.hi&=-33),e.buttons[0].pressed&&(t.hi&=-65),e.buttons[2].pressed&&(t.hi&=-129),e.buttons[4].pressed&&(t.hi&=-5),e.buttons[6].pressed&&(t.hi&=-2),e.buttons[5].pressed&&(t.hi&=-9),e.buttons[7].pressed&&(t.hi&=-3)}}}}));mdlr('enge:psx:gpu',(e=>{const a=new Set;var t=[1,1,3,1,1,1,0,0,1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,4,4,7,7,7,7,5,5,5,5,9,9,9,9,6,6,6,6,9,9,9,9,8,8,8,8,12,12,12,12,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,3,3,3,3,4,4,4,4,2,2,2,2,0,0,0,0,2,2,2,2,3,3,3,3,2,2,2,2,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];const n={dispB:256,dispL:0,dispR:0,dispT:16,dispX:0,dispY:0,dispW:0,dmaBuffer:new Int32Array(4096),dmaIndex:0,drawAreaX1:0,drawAreaX2:0,drawAreaY1:0,drawAreaY2:0,drawOffsetX:0,drawOffsetY:0,handlers:[],heights:[1,2,1,2],hline:0,img:{w:0,h:0,x:0,y:0,index:0,pixelCount:0,buffer:new Uint16Array(524288)},info:new Uint32Array(16),maxheights:[240,480,256,512],maxwidths:[256,368,320,368,512,368,640,368],packetSize:0,result:2,status:343941120,tp:0,transferTotal:0,twin:0,tx:0,txflip:0,ty:0,tyflip:0,widths:[10,7,8,7,5,7,4,7],frame:0,internalFrame:0,updated:!1,cyclesToDotClock:function(e){switch(n.status>>16&7){case 0:return 11*e/7/10;case 1:case 3:case 5:case 7:return 11*e/7/7;case 2:return 11*e/7/8;case 4:return 11*e/7/5;case 6:return 11*e/7/4}},getDisplayArea:function(){if(n.status>>20&1)var e=n.dispT%256,a=Math.min(n.dispB,314);else e=n.dispT%240,a=Math.min(n.dispB,263);var t=a-e,d=n.dispR-n.dispL,r=n.maxwidths[n.status>>16&7],c=d/n.widths[n.status>>16&7];c=Math.min(r,c+2&-4);var l=n.maxheights[n.status>>19&3],i=n.heights[n.status>>19&3]*t;return i=Math.min(l,i),{x:n.dispX,y:n.dispY,w:c,h:i}},onScanLine:function(e){n.hline=e;let a=n.status&1<<22,t=!!(n.status>>20&1),d=t?314:263,r=n.dispB-n.dispT>>1,c=t?163:136,l=c-r,i=c+r;i>d&&(i=d),l<0&&(l=0),a?1==(1&n.frame)?n.status|=2147483648:n.status&=2147483647:1==(1&n.hline+(1&n.frame))?n.status|=2147483648:n.status&=2147483647,n.hline===i&&renderer.onVBlankBegin(),n.hline===l&&renderer.onVBlankEnd(),(n.hline>=i||n.hline<l)&&(n.status&=2147483647),++n.hline>=d&&(n.updated&&++n.internalFrame,n.updated=!1,cpu.istat|=1,n.hline=0,++n.frame)},rd32r1810:function(){return 134217728&n.rR1814&&abort('gpu.rd32r1810 not implemented'),n.result},rd32r1814:function(){return n.status},wr32r1810:function(e){if(268435456&n.status){if(n.dmaBuffer[n.dmaIndex++]=e,1===n.dmaIndex&&(n.packetSize=t[e>>>24]),n.dmaIndex===n.packetSize){var a=n.dmaBuffer[0]>>>24;nextPrimitive(),n.handlers[a].call(this,n.dmaBuffer),n.dmaIndex=0}}else{if(n.img.buffer[n.img.index++]=e>>>0&65535,--n.transferTotal<=0)return void n.imgTransferComplete(n.img);if(n.img.buffer[n.img.index++]=e>>>16&65535,--n.transferTotal<=0)return void n.imgTransferComplete(n.img)}},wr32r1814:function(e){switch(e>>>24){case 0:n.status=344064e3,n.dmaIndex=0,n.dispL=512,n.dispR=3072,n.dispW=320,n.dispT=16,n.dispB=256,n.dispX=0,n.dispY=0,n.handlePacketE1([0]),n.handlePacketE2([0]),n.handlePacketE3([0]),n.handlePacketE4([0]),n.handlePacketE5([0]),n.handlePacketE6([0]),renderer.updateDrawArea?.call(renderer);break;case 1:n.status|=1879048192,n.dmaIndex=0;break;case 2:case 64:break;case 3:n.status&=4286578687,n.status|=(1&e)<<23;break;case 4:n.status&=2684354559,n.status|=(3&e)<<29;break;case 5:n.dispX=e>>0&1023,n.dispY=e>>10&511;break;case 6:n.dispL=e>>0&4095,n.dispR=e>>12&4095;var a=n.dispR-n.dispL,t=n.maxwidths[n.status>>16&7],d=a/n.widths[n.status>>16&7];n.dispW=Math.min(t,d+2&-4);break;case 7:n.dispT=e>>0&1023,n.dispB=e>>10&1023,n.dispB<n.dispT&&(n.dispB+=288);break;case 8:n.status&=4286644223,n.status|=(63&e)<<17,n.status|=64&e?65536:0;break;case 16:switch(15&e){case 2:case 3:case 4:case 5:case 7:case 8:n.result=n.info[15&e]}break;default:console.warn('gpu.cmnd'+hex(e>>>24,2))}n.updateTexturePage()},invalidPacketHandler:function(e){},updateTexturePage:function(e){switch(void 0!==e&&(n.status=-2560&n.status|2559&e),n.tx=(n.status>>>0&15)<<6,n.ty=(n.status>>>4&1)<<8,n.tp=n.status>>>7&3,n.tp){case 0:n.tx<<=2;break;case 1:n.tx<<=1;break;case 2:case 3:n.tx<<=0}},handlePacket00:function(e){},handlePacket01:function(e){n.status=-134217729&(268435456|n.status)},handlePacket02:function(e){renderer.fillRectangle(e)},handlePacket03:function(e){},handlePacket04:function(e){},handlePacket05:function(e){},handlePacket08:function(e){},handlePacket09:function(e){},handlePacket0D:function(e){},handlePacket20:function(e){renderer.drawTriangle(e,0,1,0,2,0,3)},renderTexture:function(e,a){6==(6&e[0]>>>24)?(e[0]|=2147483648,a(),nextPrimitive(),e[0]&=-33554433,a()):a()},handlePacket24:function(e){n.updateTexturePage(e[4]>>>16),this.renderTexture(e,(()=>{renderer.drawTriangle(e,0,1,0,3,0,5,n.tx,n.ty,2,4,6,e[2]>>>16)}))},handlePacket28:function(e){renderer.drawTriangle(e,0,1,0,2,0,3),renderer.drawTriangle(e,0,2,0,3,0,4)},handlePacket2C:function(e){n.updateTexturePage(e[4]>>>16),this.renderTexture(e,(()=>{renderer.drawTriangle(e,0,1,0,3,0,5,n.tx,n.ty,2,4,6,e[2]>>>16),renderer.drawTriangle(e,0,3,0,5,0,7,n.tx,n.ty,4,6,8,e[2]>>>16)}))},handlePacket30:function(e){renderer.drawTriangle(e,0,1,2,3,4,5)},handlePacket34:function(e){n.updateTexturePage(e[5]>>>16),this.renderTexture(e,(()=>{renderer.drawTriangle(e,0,1,3,4,6,7,n.tx,n.ty,2,5,8,e[2]>>>16)}))},handlePacket38:function(e){renderer.drawTriangle(e,0,1,2,3,4,5),renderer.drawTriangle(e,2,3,4,5,6,7)},handlePacket3C:function(e){n.updateTexturePage(e[5]>>>16),this.renderTexture(e,(()=>{renderer.drawTriangle(e,0,1,3,4,6,7,n.tx,n.ty,2,5,8,e[2]>>>16),renderer.drawTriangle(e,3,4,6,7,9,10,n.tx,n.ty,5,8,11,e[2]>>>16)}))},handlePacket40:function(e){renderer.drawLine(e,0,1,0,2)},handlePacket48:function(e,a){for(var t=2;t<a;t+=1)renderer.drawLine(e,0,t-1,0,t)},handlePacket50:function(e){renderer.drawLine(e,0,1,2,3)},handlePacket58:function(e,a){for(var t=3;t<a;t+=2)renderer.drawLine(e,t-3,t-2,t-1,t)},handlePacket60:function(e){renderer.drawRectangle([e[0],e[1],e[2]],0,0,0)},handlePacket64:function(e){const a=e[2]>>>0&255,t=e[2]>>>8&255;this.renderTexture(e,(()=>{renderer.drawRectangle([e[0],e[1],e[3]],a,t,e[2]>>>16)}))},handlePacket68:function(e){renderer.drawRectangle([e[0],e[1],65537],0,0,0)},handlePacket70:function(e){renderer.drawRectangle([e[0],e[1],524296],0,0,0)},handlePacket74:function(e){const a=e[2]>>>0&255,t=e[2]>>>8&255;this.renderTexture(e,(()=>{renderer.drawRectangle([e[0],e[1],524296],a,t,e[2]>>>16)}))},handlePacket78:function(e){renderer.drawRectangle([e[0],e[1],1048592],0,0,0)},handlePacket7C:function(e){const a=e[2]>>>0&255,t=e[2]>>>8&255;this.renderTexture(e,(()=>{renderer.drawRectangle([e[0],e[1],1048592],a,t,e[2]>>>16)}))},handlePacket80:function(e){if(e[1]!==e[2]){var a=e[1]>>0,t=e[1]>>16,n=e[2]>>0,d=e[2]>>16,r=e[3]>>0,c=e[3]>>16;n&=1023,d&=511,a&=1023,t&=511,(r=1+(r-1&1023))*(c=1+(c-1&511))&&renderer.moveImage(a,t,n,d,r,c)}},handlePacketA0:function(e){n.status&=-268435457;var a=e[1]<<16>>>16,t=e[1]<<0>>>16,d=e[2]<<16>>>16,r=e[2]<<0>>>16;n.img.w=1+(d-1&1023),n.img.h=1+(r-1&511),n.img.x=1023&a,n.img.y=511&t,n.img.index=0,n.transferTotal=n.img.w*n.img.h+1&-2,n.img.pixelCount=n.transferTotal},handlePacketC0:function(e){n.status|=134217728;var a=e[1]<<16>>>16,t=e[1]<<0>>>16,d=e[2]<<16>>>16,r=e[2]<<0>>>16;n.img.w=1+(d-1&1023),n.img.h=1+(r-1&511),n.img.x=1023&a,n.img.y=511&t,n.img.index=0,n.transferTotal=n.img.w*n.img.h+1&-2,n.img.pixelCount=n.transferTotal,renderer.loadImage(n.img.x,n.img.y,n.img.w,n.img.h,n.img.buffer)},handlePacketE1:function(e){n.status=4294965248&n.status|2047&e[0],n.txflip=e[0]>>>12&1,n.tyflip=e[0]>>>13&1,n.updateTexturePage()},handlePacketE2:function(e){n.info[2]=1048575&e[0];const a=((e[0]>>0&31)<<3<<0)+((e[0]>>5&31)<<3<<8)+((e[0]>>10&31)<<3<<16)+((e[0]>>15&31)<<3<<24);n.twin=a},handlePacketE3:function(e){n.info[3]=1048575&e[0],n.drawAreaX1=e[0]<<22>>>22,n.drawAreaY1=e[0]<<12>>>22,renderer.setDrawAreaTL(n.drawAreaX1,n.drawAreaY1)},handlePacketE4:function(e){n.info[4]=1048575&e[0],n.drawAreaX2=e[0]<<22>>>22,n.drawAreaY2=e[0]<<12>>>22,renderer.setDrawAreaBR(n.drawAreaX2,n.drawAreaY2)},handlePacketE5:function(e){n.info[5]=4194303&e[0],n.drawOffsetX=e[0]<<21>>21,n.drawOffsetY=e[0]<<11>>22,renderer.setDrawAreaOF(n.drawOffsetX,n.drawOffsetY)},handlePacketE6:function(e){n.status&=4294961151,n.status|=(3&e[0])<<11},imgTransferComplete:function(e){renderer.storeImage(n.img),n.status|=268435456},dmaTransferMode0200:function(e,a){if(!(8388607&e))return 16;var t=(a>>16)*(65535&a)<<1;n.transferTotal-=t;const d=n.img;for(;--t>=0;){const a=n.img.buffer[d.index++];map16[(2097151&e)>>>1]=a,e+=2}return n.transferTotal<=0&&(n.status&=-134217729),(a>>16)*(65535&a)},dmaTransferMode0201:function(e,a){if(!(8388607&e))return 16;if(0==(-4&e))return(a>>16)*(65535&a);var t=(a>>16)*(65535&a)<<1;n.transferTotal-=t;const d=n.img;for(;--t>=0;){const a=map16[(2097151&e)>>>1];d.buffer[d.index++]=a,e+=2}return n.transferTotal<=0&&(n.imgTransferComplete(n.img),n.updated=!0),(a>>16)*(65535&a)},dmaTransferMode0401:function(e,d){if(!(8388607&e))return 16;if(0!==n.dmaIndex&&abort('not implemented'),0==(-4&e))return(d>>16)*(65535&d);const r=new Set;var c=n.dmaBuffer;let l=0;for(;;){e&=2097151;var i=ram.getInt32(e,!0),h=i>>>24,s=2097151&i;for(e+=4,++l;h>0;){if(r.has(e))return l;r.add(e);const d=ram.getInt32(e,!0)>>>0,s=d>>>24;if(0===t[s]){if(e+=4,--h,++l,a.has(s))continue;return a.add(s),console.warn('invalid packetId:',hex(s,2),hex(i),hex(d)),l}if(s>=72&&s<80||s>=88&&s<96){let a=0;for(;a<4096;++a){const t=ram.getInt32(e,!0);if(e+=4,--h,++l,1431655765===t)break;if(1342197760===t)break;c[a]=t}nextPrimitive(),n.handlers[s].call(this,c,a),n.updated=!0}else{for(var k=0;k<t[s];++k)c[k]=ram.getInt32(e,!0),e+=4,--h,++l;nextPrimitive(),n.handlers[s].call(this,c,0),n.updated=!0}}if(!s||2097151==s)break;e=s}return l},dmaLinkedListMode0002:function(e,a){if(!e)return;if(0==(-4&e))throw 43;a>=65536&&abort('unexpected blck size'),0===a&&(a=65536),e&=2097151;let t=a;for(;--a>=1;){const a=e-4&2097151;ram.setInt32(e,a,!0),e=a}return ram.setInt32(e,16777215,!0),t}};n.handlePacket21=n.handlePacket20,n.handlePacket22=n.handlePacket20,n.handlePacket23=n.handlePacket20,n.handlePacket25=n.handlePacket24,n.handlePacket26=n.handlePacket24,n.handlePacket27=n.handlePacket24,n.handlePacket29=n.handlePacket28,n.handlePacket2A=n.handlePacket28,n.handlePacket2B=n.handlePacket28,n.handlePacket2D=n.handlePacket2C,n.handlePacket2E=n.handlePacket2C,n.handlePacket2F=n.handlePacket2C,n.handlePacket31=n.handlePacket30,n.handlePacket32=n.handlePacket30,n.handlePacket33=n.handlePacket30,n.handlePacket35=n.handlePacket34,n.handlePacket36=n.handlePacket34,n.handlePacket37=n.handlePacket34,n.handlePacket39=n.handlePacket38,n.handlePacket3A=n.handlePacket38,n.handlePacket3B=n.handlePacket38,n.handlePacket3D=n.handlePacket3C,n.handlePacket3E=n.handlePacket3C,n.handlePacket3F=n.handlePacket3C,n.handlePacket41=n.handlePacket40,n.handlePacket42=n.handlePacket40,n.handlePacket43=n.handlePacket40,n.handlePacket44=n.handlePacket40,n.handlePacket45=n.handlePacket40,n.handlePacket46=n.handlePacket40,n.handlePacket47=n.handlePacket40,n.handlePacket49=n.handlePacket48,n.handlePacket4A=n.handlePacket48,n.handlePacket4B=n.handlePacket48,n.handlePacket4C=n.handlePacket48,n.handlePacket4D=n.handlePacket48,n.handlePacket4E=n.handlePacket48,n.handlePacket4F=n.handlePacket48,n.handlePacket51=n.handlePacket50,n.handlePacket52=n.handlePacket50,n.handlePacket53=n.handlePacket50,n.handlePacket54=n.handlePacket50,n.handlePacket55=n.handlePacket50,n.handlePacket56=n.handlePacket50,n.handlePacket57=n.handlePacket50,n.handlePacket59=n.handlePacket58,n.handlePacket5A=n.handlePacket58,n.handlePacket5B=n.handlePacket58,n.handlePacket5C=n.handlePacket58,n.handlePacket5D=n.handlePacket58,n.handlePacket5E=n.handlePacket58,n.handlePacket5F=n.handlePacket58,n.handlePacket61=n.handlePacket60,n.handlePacket62=n.handlePacket60,n.handlePacket63=n.handlePacket60,n.handlePacket65=n.handlePacket64,n.handlePacket66=n.handlePacket64,n.handlePacket67=n.handlePacket64,n.handlePacket69=n.handlePacket68,n.handlePacket6A=n.handlePacket68,n.handlePacket6B=n.handlePacket68,n.handlePacket71=n.handlePacket70,n.handlePacket72=n.handlePacket70,n.handlePacket73=n.handlePacket70,n.handlePacket75=n.handlePacket74,n.handlePacket76=n.handlePacket74,n.handlePacket77=n.handlePacket74,n.handlePacket79=n.handlePacket78,n.handlePacket7A=n.handlePacket78,n.handlePacket7B=n.handlePacket78,n.handlePacket7D=n.handlePacket7C,n.handlePacket7E=n.handlePacket7C,n.handlePacket7F=n.handlePacket7C;for(var d=0;d<256;++d){var r='handlePacket'+hex(d,2).toUpperCase();n.handlers[d]=n[r]||n.invalidPacketHandler}for(d=129;d<=159;++d)n.handlers[d]=n.handlePacket80;for(d=161;d<=191;++d)n.handlers[d]=n.handlePacketA0;for(d=193;d<=223;++d)n.handlers[d]=n.handlePacketC0;return n.info[7]=2,n.info[8]=0,{gpu:n}}));mdlr('enge:psx:gte',(s=>{const e=new Int32Array(4),t=new Int32Array(4),a=new Int32Array(4),c=new Int32Array(9),r=new Int32Array(9),i=new Int32Array(9),n=new Int32Array(9),h=new Int32Array(3),o=new Int32Array(3),b=new Int32Array(3),u=new Int32Array(4),k=new Float64Array(4),l=new Float64Array(4),f=new Int32Array(64),m=new Int32Array(32),p=Object.seal({sx:new Int32Array(3),sy:new Int32Array(3),sz:new Int32Array(4),zsf3:0,zsf4:0,lzcr:0,sf:0,lm:0,lim:function(s,e,t,a,c){return s<e?(f[63]|=m[t],e):s>a?(f[63]|=m[c],a):s},countLeadingZeros:function(s){if(2147483648&s&&(s^=4294967295),0===s)this.lzcr=32;else{for(var e=31;0==(s&1<<e)&&e>=0;--e);this.lzcr=31-e}},get:function(s){switch(s){case 0:case 2:case 4:case 6:case 23:case 30:case 32:case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:case 59:case 60:case 61:case 62:case 63:return f[s];case 1:return e[3]<<16>>16;case 3:return t[3]<<16>>16;case 5:return a[3]<<16>>16;case 7:return f[s]<<16>>>16;case 8:return k[0]<<16>>16;case 9:return k[1]<<16>>16;case 10:return k[2]<<16>>16;case 11:return k[3]<<16>>16;case 12:return 65535&this.sx[0]|this.sy[0]<<16;case 13:return 65535&this.sx[1]|this.sy[1]<<16;case 14:case 15:return 65535&this.sx[2]|this.sy[2]<<16;case 16:return this.sz[0]<<16>>>16;case 17:return this.sz[1]<<16>>>16;case 18:return this.sz[2]<<16>>>16;case 19:return this.sz[3]<<16>>>16;case 20:return u[0];case 21:return u[1];case 22:return u[2];case 24:return l[0];case 25:return l[1];case 26:return l[2];case 27:return l[3];case 29:var c=0;return c|=k[1]>>7<<0,(c|=k[2]>>7<<5)|k[3]>>7<<10;case 31:return this.lzcr;case 58:return f[s]<<16>>16;default:abort('get gte.r'+hex(s,2)+' not yet implemented')}},set:function(s,n){switch(f[s]=n,s){case 0:e[1]=n<<16>>16,e[2]=n<<0>>16;break;case 1:e[3]=n<<16>>16;break;case 2:t[1]=n<<16>>16,t[2]=n<<0>>16;break;case 3:t[3]=n<<16>>16;break;case 4:a[1]=n<<16>>16,a[2]=n<<0>>16;break;case 5:a[3]=n<<16>>16;break;case 6:u[3]=n;break;case 7:case 23:case 29:case 31:break;case 8:k[0]=n<<16>>16;break;case 9:k[1]=n<<16>>16;break;case 10:k[2]=n<<16>>16;break;case 11:k[3]=n<<16>>16;break;case 12:this.sx[0]=n<<16>>16,this.sy[0]=n<<0>>16;break;case 13:this.sx[1]=n<<16>>16,this.sy[1]=n<<0>>16;break;case 14:this.sx[2]=n<<16>>16,this.sy[2]=n<<0>>16;break;case 15:this.sx[0]=this.sx[1],this.sy[0]=this.sy[1],this.sx[1]=this.sx[2],this.sy[1]=this.sy[2],this.sx[2]=n<<16>>16,this.sy[2]=n<<0>>16;break;case 16:this.sz[0]=n<<16>>>16;break;case 17:this.sz[1]=n<<16>>>16;break;case 18:this.sz[2]=n<<16>>>16;break;case 19:this.sz[3]=n<<16>>>16;break;case 20:u[0]=n;break;case 21:u[1]=n;break;case 22:u[2]=n;break;case 24:l[0]=n<<0>>0;break;case 25:l[1]=n<<0>>0;break;case 26:l[2]=n<<0>>0;break;case 27:l[3]=n<<0>>0;break;case 28:k[1]=(31&n)<<7,k[2]=(992&n)<<2,k[3]=(31744&n)>>3;break;case 30:this.countLeadingZeros(n);break;case 32:i[0]=n<<16>>16,i[1]=n<<0>>16;break;case 33:i[2]=n<<16>>16,i[3]=n<<0>>16;break;case 34:i[4]=n<<16>>16,i[5]=n<<0>>16;break;case 35:i[6]=n<<16>>16,i[7]=n<<0>>16;break;case 36:f[s]=i[8]=n<<16>>16;break;case 37:b[0]=n<<0>>0;break;case 38:b[1]=n<<0>>0;break;case 39:b[2]=n<<0>>0;break;case 40:c[0]=n<<16>>16,c[1]=n<<0>>16;break;case 41:c[2]=n<<16>>16,c[3]=n<<0>>16;break;case 42:c[4]=n<<16>>16,c[5]=n<<0>>16;break;case 43:c[6]=n<<16>>16,c[7]=n<<0>>16;break;case 44:f[s]=c[8]=n<<16>>16;break;case 45:h[0]=n<<0>>0;break;case 46:h[1]=n<<0>>0;break;case 47:h[2]=n<<0>>0;break;case 48:r[0]=n<<16>>16,r[1]=n<<0>>16;break;case 49:r[2]=n<<16>>16,r[3]=n<<0>>16;break;case 50:r[4]=n<<16>>16,r[5]=n<<0>>16;break;case 51:r[6]=n<<16>>16,r[7]=n<<0>>16;break;case 52:f[s]=r[8]=n<<16>>16;break;case 53:o[0]=n<<0>>0;break;case 54:o[1]=n<<0>>0;break;case 55:o[2]=n<<0>>0;break;case 56:case 57:case 60:f[s]=n<<0>>0;break;case 58:f[s]=n<<16>>>16;break;case 59:f[s]=n<<16>>16;break;case 61:f[s]=this.zsf3=n<<16>>16;break;case 62:f[s]=this.zsf4=n<<16>>16;break;case 63:f[s]=2147479552&n,2139611136&f[s]&&(f[s]|=2147483648);break;default:abort('gte.set(r'+hex(s,2)+', '+hex(n)+') not yet implemented')}},limit:function(s){const e=s?0:-32768;k[1]=this.lim(l[1],e,24,32767,24),k[2]=this.lim(l[2],e,23,32767,23),k[3]=this.lim(l[3],e,22,32767,22)},depthCue:function(){const s=this.sf?4096:1;k[1]=(4096*o[0]-l[1])/s,k[2]=(4096*o[1]-l[2])/s,k[3]=(4096*o[2]-l[3])/s,k[1]=this.lim(k[1],-32768,24,32767,24),k[2]=this.lim(k[2],-32768,23,32767,23),k[3]=this.lim(k[3],-32768,22,32767,22)},interpolate:function(){const s=this.sf?4096:1;l[1]=(l[1]+k[1]*k[0])/s,l[2]=(l[2]+k[2]*k[0])/s,l[3]=(l[3]+k[3]*k[0])/s,this.limit(this.lm)},transform:function(s,e,t){const a=this.sf?4096:1;l[1]=(4096*s[0]+e[0]*t[1]+e[1]*t[2]+e[2]*t[3])/a,l[2]=(4096*s[1]+e[3]*t[1]+e[4]*t[2]+e[5]*t[3])/a,l[3]=(4096*s[2]+e[6]*t[1]+e[7]*t[2]+e[8]*t[3])/a,this.limit(this.lm)},updateColorFifo:function(){const s=u[3]>>>24,e=this.lim(l[1]/16,0,21,255,21),t=this.lim(l[2]/16,0,20,255,20),a=this.lim(l[3]/16,0,19,255,19);u[0]=u[1],u[1]=u[2],u[2]=s<<24|a<<16|t<<8|e<<0},avsz3:function(){const s=this.sz,e=this.zsf3;l[0]=e*(s[1]+s[2]+s[3]),l[0]>2147483647&&(f[63]|=m[16]),l[0]<-2147483648&&(f[63]|=m[15]),f[7]=p.lim(l[0]/4096,0,18,65535,18)},avsz4:function(){const s=this.sz,e=this.zsf4;l[0]=e*(s[0]+s[1]+s[2]+s[3]),l[0]>2147483647&&(f[63]|=m[16]),l[0]<-2147483648&&(f[63]|=m[15]),f[7]=p.lim(l[0]/4096,0,18,65535,18)},cc:function(){const s=this.sf?4096:1;this.transform(h,r,k),l[1]=(u[3]>>0&255)*k[1]*16,l[2]=(u[3]>>8&255)*k[2]*16,l[3]=(u[3]>>16&255)*k[3]*16,l[1]=l[1]/s,l[2]=l[2]/s,l[3]=l[3]/s,this.limit(this.lm),this.updateColorFifo()},cdp:function(){const s=this.sf?4096:1;this.transform(h,r,k),l[1]=(u[3]>>0&255)*k[1]*16,l[2]=(u[3]>>8&255)*k[2]*16,l[3]=(u[3]>>16&255)*k[3]*16,this.depthCue(),this.interpolate(),l[1]=l[1]/s,l[2]=l[2]/s,l[3]=l[3]/s,this.limit(this.lm),this.updateColorFifo()},dcpl:function(){l[1]=(u[3]>>0&255)*k[1]*16,l[2]=(u[3]>>8&255)*k[2]*16,l[3]=(u[3]>>16&255)*k[3]*16,this.depthCue(),this.interpolate(),this.updateColorFifo()},dpcs:function(s){l[1]=65536*(s>>0&255),l[2]=65536*(s>>8&255),l[3]=65536*(s>>16&255),this.depthCue(),this.interpolate(),this.updateColorFifo()},gpf:function(){l[1]=0,l[2]=0,l[3]=0,this.interpolate(),this.updateColorFifo()},gpl:function(){const s=this.sf?4096:1;l[1]=l[1]*s,l[2]=l[2]*s,l[3]=l[3]*s,this.interpolate(),this.updateColorFifo()},intpl:function(){l[1]=4096*k[1],l[2]=4096*k[2],l[3]=4096*k[3],this.depthCue(),this.interpolate(),this.updateColorFifo()},mvmva:function(s){switch(s>>17&3){case 0:var u=i;break;case 1:u=c;break;case 2:u=r;break;case 3:u=n}switch(s>>15&3){case 0:var l=e;break;case 1:l=t;break;case 2:l=a;break;case 3:l=k}switch(s>>13&3){case 0:var f=b;break;case 1:f=h;break;case 2:f=o,abort('faulty');break;case 3:f=n}this.transform(f,u,l)},nccs:function(s){const e=this.sf?4096:1;this.transform(n,c,s),this.transform(h,r,k),l[1]=(u[3]>>0&255)*k[1]*16,l[2]=(u[3]>>8&255)*k[2]*16,l[3]=(u[3]>>16&255)*k[3]*16,l[1]=l[1]/e,l[2]=l[2]/e,l[3]=l[3]/e,this.limit(this.lm),this.updateColorFifo()},ncds:function(s){this.transform(n,c,s),this.transform(h,r,k),l[1]=(u[3]>>0&255)*k[1]*16,l[2]=(u[3]>>8&255)*k[2]*16,l[3]=(u[3]>>16&255)*k[3]*16,this.depthCue(),this.interpolate(),this.updateColorFifo()},nclip:function(){const s=this.sx,e=this.sy;l[0]=s[0]*(e[1]-e[2])+s[1]*(e[2]-e[0])+s[2]*(e[0]-e[1]),l[0]>2147483647&&(f[63]|=m[16]),l[0]<-2147483648&&(f[63]|=m[15])},ncs:function(s){this.transform(n,c,s),this.transform(h,r,k),this.updateColorFifo()},op:function(){const s=this.sf?4096:1;l[1]=(k[3]*i[4]-k[2]*i[8])/s,l[2]=(k[1]*i[8]-k[3]*i[0])/s,l[3]=(k[2]*i[0]-k[1]*i[4])/s,this.limit(this.lm)},rtps:function(s){const e=65535&f[58],t=f[56],a=f[57],c=f[59],r=f[60],n=this.sx,h=this.sy,o=this.sz,u=this.sf?4096:1;l[1]=(4096*b[0]+i[0]*s[1]+i[1]*s[2]+i[2]*s[3])/u,l[1]>8796093022207&&(f[63]|=m[30]),l[1]<-8796093022208&&(f[63]|=m[27]),l[2]=(4096*b[1]+i[3]*s[1]+i[4]*s[2]+i[5]*s[3])/u,l[2]>8796093022207&&(f[63]|=m[29]),l[2]<-8796093022208&&(f[63]|=m[26]),l[3]=(4096*b[2]+i[6]*s[1]+i[7]*s[2]+i[8]*s[3])/u,l[3]>8796093022207&&(f[63]|=m[28]),l[3]<-8796093022208&&(f[63]|=m[25]),this.limit(this.lm),n[0]=n[1],n[1]=n[2],h[0]=h[1],h[1]=h[2],o[0]=o[1],o[1]=o[2],o[2]=o[3];let p=l[3]/(this.sf?1:4096);o[3]=this.lim(p,0,18,65535,18);let d=131072;d=(131072*e/o[3]+1)/2,d>131071&&(f[63]|=m[17],d=131071),l[0]=d*k[1]+t,n[2]=l[0]/65536,l[0]>2147483647&&(f[63]|=m[16]),l[0]<-2147483648&&(f[63]|=m[15]),l[0]=d*k[2]+a,h[2]=l[0]/65536,l[0]>2147483647&&(f[63]|=m[16]),l[0]<-2147483648&&(f[63]|=m[15]),l[0]=d*c+r,k[0]=l[0]/4096,l[0]>2147483647&&(f[63]|=m[16]),l[0]<-2147483648&&(f[63]|=m[15]),n[2]=this.lim(n[2],-1024,14,1023,14),h[2]=this.lim(h[2],-1024,13,1023,13),k[0]=this.lim(k[0],0,12,4096,12)},sqr:function(){const s=this.sf?4096:1;l[1]=k[1]*k[1]/s,l[2]=k[2]*k[2]/s,l[3]=k[3]*k[3]/s,this.limit(this.lm)},command:function(s){switch(this.sf=s>>19&1,this.lm=s>>10&1,f[63]=0,63&s){case 1:this.rtps(e);break;case 6:this.nclip();break;case 12:this.op();break;case 16:this.dpcs(u[3]);break;case 17:this.intpl();break;case 18:this.mvmva(s);break;case 19:this.ncds(e);break;case 20:this.cdp();break;case 22:this.ncds(e),this.ncds(t),this.ncds(a);break;case 27:this.nccs(e);break;case 28:this.cc();break;case 30:this.ncs(e);break;case 32:this.ncs(e),this.ncs(t),this.ncs(a);break;case 40:this.sqr();break;case 41:this.dcpl();break;case 42:this.dpcs(u[0]),this.dpcs(u[0]),this.dpcs(u[0]);break;case 45:this.avsz3();break;case 46:this.avsz4();break;case 48:this.rtps(e),this.rtps(t),this.rtps(a);break;case 61:this.gpf();break;case 62:this.gpl();break;case 63:this.nccs(e),this.nccs(t),this.nccs(a);break;default:abort('gte.$'+hex(s,5)+' not yet implemented')}},cycles:function(s){switch(63&s){case 1:return 15;case 6:case 16:case 17:case 18:case 41:return 8;case 12:case 46:return 6;case 19:return 19;case 20:return 13;case 22:return 44;case 27:case 42:return 17;case 28:return 11;case 30:return 14;case 32:return 30;case 40:case 45:case 61:case 62:return 5;case 48:return 23;case 63:return 39;default:return abort('gte.$'+hex(s,5)+' has no cycles'),5}}});for(var d=0;d<=31;++d)m[d]=1<<d;for(d=23;d<=30;++d)m[d]|=2147483648;for(d=13;d<=18;++d)m[d]|=2147483648;return{gte:p}}));mdlr('enge:psx:index',(e=>{let t,n=!1;const d=33868800;function r(){throw console.error(Array.prototype.slice.call(arguments).join(' ')),t.style.borderColor='red',n=!1,spu.silence(),'abort'}let o=!0;document.addEventListener("visibilitychange",(function(){'visible'===document.visibilityState?o=!0:(o=!1,spu.silence())}));const a={timeStamp:0,realtime:0,emutime:0,counter:0};psx.addEvent(0,spu.event.bind(spu)),dma.eventDMA0=psx.addEvent(0,dma.completeDMA0.bind(dma)),dma.eventDMA2=psx.addEvent(0,dma.completeDMA2.bind(dma)),dma.eventDMA3=psx.addEvent(0,dma.completeDMA3.bind(dma)),dma.eventDMA4=psx.addEvent(0,dma.completeDMA4.bind(dma)),dma.eventDMA6=psx.addEvent(0,dma.completeDMA6.bind(dma)),cdr.eventRead=psx.addEvent(0,cdr.completeRead.bind(cdr)),cdr.eventCmd=psx.addEvent(0,cdr.completeCmd.bind(cdr)),joy.eventIRQ=psx.addEvent(0,joy.completeIRQ.bind(joy)),mdc.event=psx.addEvent(0,mdc.complete.bind(mdc)),dot.event=psx.addEvent(0,dot.complete.bind(dot));let c=psx.addEvent(0,(function(e,t){i=!0,psx.unsetEvent(e)})),i=!1;function s(e){(function(e){const t=e-a.timeStamp;if(a.timeStamp=e,!n||!o||t>250)return;a.realtime+=t;const s=(a.realtime-a.emutime)*(d/1e3);i=!1,psx.setEvent(c,+s),++a.counter,function(){let e=getCacheEntry(cpu.pc);if(!e)return r('invalid pc');handleGamePads();const t=psx;for(;!i;)CodeTrace.add(e),e=e.code(t),t.clock>=t.eventClock&&(e=t.handleEvents(e));cpu.pc=e.pc}(),a.emutime=psx.clock/(d/1e3)})(e),requestAnimationFrame(s)}function l(){n=!1;let e=getCacheEntry(3217031168);const t=psx;for(;196608!==e.pc;)CodeTrace.add(e),e=e.code(t),t.clock>=t.eventClock&&(e=t.handleEvents(e));a.realtime=a.emutime=psx.clock/(d/1e3),vector=getCacheEntry(128),cpu.pc=e.pc}function p(e){var t=new FileReader;t.onload=function(t){console.log(escape(e.name),e.size),function(e){const t=new DataView(e);if(21328===t.getUint16(0,!0)){for(let s=0;s<64;s+=4)console.log(hex(s,2),hex(t.getInt32(s,8)));cpu.pc=t.getInt32(16,!0),cpu.gpr[28]=t.getInt32(20,!0),cpu.gpr[29]=t.getInt32(48,!0)||2149580784,cpu.gpr[30]=t.getInt32(48,!0)||2149580784,cpu.gpr[31]=cpu.pc;for(var d=t.getInt32(24,!0),r=t.getInt32(28,!0),o=0;o<r;++o)2048+o>=e.byteLength||ram.setInt8(2097151&d++,t.getInt8(2048+o,!0),!0);clearCodeCache(t.getInt32(24,!0),e.byteLength),n=!0}else if(17229===t.getUint32(0,!0)){console.log('loaded MEMCARD');var a=new Uint8Array(e);let p=joy.devices?joy.devices[0].data:joy.cardOneMemory;for(o=0;o<a.length;++o)p[o]=a[o]}else if(524288===e.byteLength){for(writeStorageStream('bios',e),o=0;o<524288;o+=4){const m=t.getInt32(o,!0);rom.setInt32(o,m,!0)}l();let u=document.querySelector('span.nobios');u&&u.classList.remove('nobios')}else{let f=e.byteLength/4/588,g=[];g.push({id:0,begin:0,end:f});const v=2352;function c(e){let n=t.getInt32(e*v+0,!0)>>>0,d=t.getInt32(e*v+4,!0)>>>0,r=t.getInt32(e*v+8,!0)>>>0;return 4294967040===n&&4294967295===d&&16777215===r||!n&&!d&&!r}function i(e){let n=0;for(let d=0;d<v;d+=4)n|=t.getInt32(e*v+d,!0);return n>>>0==0}let y,b,E,h=0;for(y=h;h<f&&c(h);)++h;for(b=h;h<f&&i(h);)++h;g.push({id:1,begin:y,end:b,data:!0});let x=2;if(h<f){for(y=h;h<f;){for(;h<f&&!i(h);)++h;for(b=h;h<f&&i(h);)++h;E=h,E-b<75||(g.push({id:x,begin:y,end:b,audio:!0}),y=h,x++)}y<f&&(b=E=f,g.push({id:x,begin:y,end:b,audio:!0}))}cdr.setCdImage(t),cdr.setTOC(g),n=!0}}(t.target.result)},t.readAsArrayBuffer(e)}function u(e){e.stopPropagation(),e.preventDefault();const t=e.dataTransfer?e.dataTransfer.files:e.target.files;for(var n,d=0;n=t[d];d++)p(n)}function m(e){e.stopPropagation(),e.preventDefault()}return window.renderer=void 0,{init:function(){t=document.getElementById('display'),document.addEventListener('dragover',m,!1),document.addEventListener('drop',u,!1);const e=document.getElementById('file');e?.addEventListener('change',u,!1),settings.updateQuality();const d=document.getElementById('quality');d?.addEventListener('click',(e=>(settings.updateQuality(!0),e.stopPropagation(),e.preventDefault(),!1))),s(performance.now()),renderer=new WebGLRenderer(t),t.addEventListener("dblclick",(function(e){n=!n,n||spu.silence()})),t.addEventListener("touchstart",(function(e){n=!n,n||spu.silence()})),window.addEventListener("keydown",(function(e){'F12'!==e.key&&'F11'!==e.key&&'F5'!==e.key&&e.preventDefault()}),!1),window.addEventListener("keyup",(function(e){'1'===e.key&&e.ctrlKey&&renderer.setMode('disp'),'2'===e.key&&e.ctrlKey&&renderer.setMode('draw'),'3'===e.key&&e.ctrlKey&&renderer.setMode('clut8'),'4'===e.key&&e.ctrlKey&&renderer.setMode('clut4'),'0'===e.key&&e.ctrlKey&&renderer.setMode('page2'),'F12'!==e.key&&'F11'!==e.key&&'F5'!==e.key&&e.preventDefault()}),!1),readStorageStream('bios',(e=>{if(e){let n=new Uint32Array(e.buffer);for(var t=0;t<524288;t+=4)map[29360128+t>>>2]=n[t>>>2];let d=document.querySelector('span.nobios');d&&d.classList.remove('nobios'),l()}})),readStorageStream('card1',(e=>{if(e){let t=new Uint8Array(e.buffer);console.log('loading card1',t.length);for(let e=0;e<131072;++e)joy.devices[0].data[e]=t[e]}})),readStorageStream('card2',(e=>{if(e){let t=new Uint8Array(e.buffer);console.log('loading card2',t.length);for(let e=0;e<131072;++e)joy.devices[1].data[e]=t[e]}}))},PSX_SPEED:d,abort:r,context:a}}));mdlr('enge:psx:mdec',(t=>{var s={iq:new Int32Array(128),scale:new Uint8Array(768),zscan:[0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63],aanscales:[16384,22725,21407,19266,16384,12873,8867,4520,22725,31521,29692,26722,22725,17855,12299,6270,21407,29692,27969,25172,21407,16819,11585,5906,19266,26722,25172,22654,19266,15137,10426,5315,16384,22725,21407,19266,16384,12873,8867,4520,12873,17855,16819,15137,12873,10114,6967,3552,8867,12299,11585,10426,8867,6967,4799,2446,4520,6270,5906,5315,4520,3552,2446,1247],SCALERC256:function(t,s){return this.scale[384+t+s]},iqtab_reset:function(){this.iq.fill(0)},iqtab_init:function(t,s){for(let r=0;r<s;++r){const s=255&map8[(t+r&2097151)>>>0];this.iq[r]=s*this.aanscales[this.zscan[63&r]]>>12}},icdt:function(t,s){let r,n,e,i,a=s;for(let a=8;a>0;--a,s+=8){r=t[s+0]+t[s+4]>>0,n=t[s+0]-t[s+4]>>0,i=t[s+2]+t[s+6]>>0,e=t[s+2]-t[s+6]>>0,e=(362*e>>8)-i>>0;const a=r+i>>0,u=r-i>>0,c=n+e>>0,o=n-e>>0;i=t[s+3]+t[s+5]>>0,r=t[s+3]-t[s+5]>>0,n=t[s+1]+t[s+7]>>0,e=t[s+1]-t[s+7]>>0;const h=473*(e-r)>>8,p=n+i>>0,C=(669*r>>8)+h-p>>0,l=(362*(n-i)>>8)-C>>0,d=(277*e>>8)-h+l>>0;t[s+0]=a+p>>5,t[s+1]=c+C>>5,t[s+2]=o+l>>5,t[s+3]=u-d>>5,t[s+4]=u+d>>5,t[s+5]=o-l>>5,t[s+6]=c-C>>5,t[s+7]=a-p>>5}s=a;for(let a=8;a>0;--a,++s){r=t[s+0]+t[s+32]>>0,n=t[s+0]-t[s+32]>>0,i=t[s+16]+t[s+48]>>0,e=t[s+16]-t[s+48]>>0,e=(362*e>>8)-i>>0;const a=r+i>>0,u=r-i>>0,c=n+e>>0,o=n-e>>0;i=t[s+24]+t[s+40]>>0,r=t[s+24]-t[s+40]>>0,n=t[s+8]+t[s+56]>>0,e=t[s+8]-t[s+56]>>0;const h=473*(e-r)>>8,p=n+i>>0,C=(669*r>>8)+h-p>>0,l=(362*(n-i)>>8)-C>>0,d=(277*e>>8)-h+l>>0;t[s+0]=a+p>>0,t[s+8]=c+C>>0,t[s+16]=o+l>>0,t[s+24]=u-d>>0,t[s+32]=u+d>>0,t[s+40]=o-l>>0,t[s+48]=c-C>>0,t[s+56]=a-p>>0}},rl2blk:function(t,s){const r=this.iq;t.fill(0);let n=(2097151&s)>>>1;for(let s=0;s<6;s++){const e=s>=2?0:64,i=64*s,a=65535&map16[n++];let u=0;const c=a>>10,o=a<<22>>22;for(t[i]=r[e]*o;;){const s=65535&map16[n++];if(u+=1+(s>>10),u<=63){const n=s<<22>>22,a=r[e+u]*c*n>>3;t[i+this.zscan[u]]=a}if(u>63)break}this.icdt(t,i)}return n<<1},putquadrgb15:function(t,s,n,e,i){let a,u,c,o,h=r.STP;const p=1433*e>>10,C=-351*i-728*e>>10,l=1807*i>>10,d=(2097151&t)>>>0;a=s[n+0]<<0,u=this.SCALERC256(a,p)>>>3,c=this.SCALERC256(a,C)>>>3,o=this.SCALERC256(a,l)>>>3,map16[d+0>>>1]=h|o<<10|c<<5|u,a=s[n+1]<<0,u=this.SCALERC256(a,p)>>>3,c=this.SCALERC256(a,C)>>>3,o=this.SCALERC256(a,l)>>>3,map16[d+2>>>1]=h|o<<10|c<<5|u,a=s[n+8]<<0,u=this.SCALERC256(a,p)>>>3,c=this.SCALERC256(a,C)>>>3,o=this.SCALERC256(a,l)>>>3,map16[d+32>>>1]=h|o<<10|c<<5|u,a=s[n+9]<<0,u=this.SCALERC256(a,p)>>>3,c=this.SCALERC256(a,C)>>>3,o=this.SCALERC256(a,l)>>>3,map16[d+34>>>1]=h|o<<10|c<<5|u},yuv2rgb15:function(t,s){let r,n=0,e=64,i=128;for(r=0;r<16;r+=2,n+=8,e+=8,i+=16,s+=64)8==r&&(i+=64),this.putquadrgb15(s+0,t,i+0,t[n+0],t[e+0]),this.putquadrgb15(s+4,t,i+2,t[n+1],t[e+1]),this.putquadrgb15(s+8,t,i+4,t[n+2],t[e+2]),this.putquadrgb15(s+12,t,i+6,t[n+3],t[e+3]),this.putquadrgb15(s+16,t,i+64,t[n+4],t[e+4]),this.putquadrgb15(s+20,t,i+66,t[n+5],t[e+5]),this.putquadrgb15(s+24,t,i+68,t[n+6],t[e+6]),this.putquadrgb15(s+28,t,i+70,t[n+7],t[e+7])},putquadrgb24:function(t,s,r,n,e){let i;const a=1433*n>>10,u=-351*e-728*n>>10,c=1807*e>>10,o=(2097151&t)>>>0;i=s[r+0]<<0,map8[o+0]=this.SCALERC256(i,a),map8[o+1]=this.SCALERC256(i,u),map8[o+2]=this.SCALERC256(i,c),i=s[r+1]<<0,map8[o+3]=this.SCALERC256(i,a),map8[o+4]=this.SCALERC256(i,u),map8[o+5]=this.SCALERC256(i,c),i=s[r+8]<<0,map8[o+48]=this.SCALERC256(i,a),map8[o+49]=this.SCALERC256(i,u),map8[o+50]=this.SCALERC256(i,c),i=s[r+9]<<0,map8[o+51]=this.SCALERC256(i,a),map8[o+52]=this.SCALERC256(i,u),map8[o+53]=this.SCALERC256(i,c)},yuv2rgb24:function(t,s){let r;3&s&&abort('alignment');let n=0,e=64,i=128;for(r=0;r<16;r+=2,n+=8,e+=8,i+=16,s+=96)8==r&&(i+=64),this.putquadrgb24(s+0,t,i+0,t[n+0],t[e+0]),this.putquadrgb24(s+6,t,i+2,t[n+1],t[e+1]),this.putquadrgb24(s+12,t,i+4,t[n+2],t[e+2]),this.putquadrgb24(s+18,t,i+6,t[n+3],t[e+3]),this.putquadrgb24(s+24,t,i+64,t[n+4],t[e+4]),this.putquadrgb24(s+30,t,i+66,t[n+5],t[e+5]),this.putquadrgb24(s+36,t,i+68,t[n+6],t[e+6]),this.putquadrgb24(s+42,t,i+70,t[n+7],t[e+7])}},r={r1820:0,r1824:2147745792,rl:0,STP:0,end:0,block:new Int32Array(384),rd32r1820:function(){return r.r1820},wr32r1820:function(t){r.r1820=t},rd32r1824:function(){return r.r1824},wr32r1824:function(t){2147483648&t&&(r.r1820=0,r.r1824=2147745792,psx.unsetEvent(r.event))},dmaTransferMode0201:function(t,n){if(!(8388607&t))return 16;t&=2097151;const e=(n>>>16)*(65535&n);switch(r.r1820>>>29){case 0:case 1:r.rl=t;break;case 2:if(s.iqtab_init(t,e<<2),1073741825!==r.r1820)return abort('unsupported quant mode');break;default:console.log('not implemented',r.r1820>>>29)}return e},dmaTransferMode0200:function(t,n){if(!(8388607&t))return 16;t&=2097151;const e=(n>>>16)*(65535&n);clearCodeCache(t,e<<2);const i=r.block,a=t+(e<<2);r.end=a;let u=0;const c=r.r1820>>>27&3;for(r.STP=r.r1820&1<<25?32768:0;t<a;){switch(r.rl=s.rl2blk(i,r.rl),c){case 0:console.warn('unsupported depth',c),t+=128;break;case 1:console.warn('unsupported depth',c),t+=256;break;case 2:s.yuv2rgb24(i,t),t+=768;break;case 3:s.yuv2rgb15(i,t),t+=512}u+=6}const o=PSX_SPEED/9e3*(u/6);return psx.setEvent(this.event,o>>>0),e},event:null,complete:function(t,s){dma.completeDMA1({}),psx.unsetEvent(t)}};for(let t=0;t<256;++t)s.scale[0+t]=0,s.scale[256+t]=t,s.scale[512+t]=255;return Object.seal(s),Object.seal(r),{mdc:r}}));mdlr('enge:psx:mmu',(r=>{const e=new Int32Array(8388608),a=new Int8Array(e.buffer),c=new Int16Array(e.buffer),t=new DataView(e.buffer,0,2097152),s=new DataView(e.buffer,29360128,524288);return{map:e,map8:a,map16:c,ram:t,rom:s,memRead8:function(r){return r<8388608?(psx.clock+=2,t.getInt8(2097151&r)):r>=25165824&&r<25178112?function(r){switch(psx.clock+=3,16383&r){case 4160:return joy.rd08r1040();case 4164:return joy.rd16r1044()<<24>>24;case 4180:return 0;case 4192:return a[r>>>0]>>0;case 4208:return cpu.istat<<24>>24;case 4336:return dma.rd16r10f0()<<24>>24;case 4342:return dma.rd08r10f6();case 4352:return rc0.getValue()<<24>>24;case 6144:return cdr.rd08r1800();case 6145:return cdr.rd08r1801();case 6146:return cdr.rd08r1802();case 6147:return cdr.rd08r1803();case 6164:return gpu.rd32r1814()<<24>>24;case 6180:return mdc.rd32r1824()<<24>>24;default:if(r<25169920)return psx.clock-=3,a[r>>>0];if(r>=25174016)return psx.clock+=10,a[r>>>0];if(r>=25172992&&r<25174016)return spu.getInt16(16383&r)}}(r)<<24>>24:r>=27262976&&r<27787264?(psx.clock+=5,a[r>>>0]>>0):r>=29360128&&r<29884416?(psx.clock+=8,a[r>>>0]>>0):r>=16777216&&r<17301504?(psx.clock+=6,a[r>>>0]>>0):33423664===r?a[r>>>0]>>0:void abort(`r8: unable to load from $${hex(r,8)}`)},memRead16:function(r){return r<8388608?(psx.clock+=3,t.getInt16(2097151&r,!0)):r>=25165824&&r<25178112?function(r){switch(psx.clock+=3,16383&r){case 4116:return c[r>>>1];case 4164:return joy.rd16r1044();case 4170:return joy.rd16r104a();case 4174:return joy.rd16r104e();case 4180:case 4186:case 4190:case 4400:return 0;case 4192:return c[r>>>1]>>0;case 4208:return cpu.istat;case 4212:return cpu.imask;case 4336:return dma.rd16r10f0();case 4352:return rc0.getValue();case 4356:return rc0.getMode();case 4360:return rc0.getTarget();case 4368:return rc1.getValue();case 4372:return rc1.getMode();case 4376:return rc1.getTarget();case 4384:return rc2.getValue();case 4388:return rc2.getMode();case 4392:return rc2.getTarget();case 6144:return cdr.rd08r1800();case 6164:return gpu.rd32r1814()<<16>>16;case 6180:return mdc.rd32r1824()<<16>>16;default:if(r<25169920)return psx.clock-=3,c[r>>>1];if(r>=25174016)return psx.clock+=24,c[r>>>1];if(r>=25172992&&r<25174016)return spu.getInt16(16383&r)}}(r)<<16>>16:r>=27262976&&r<27787264?(psx.clock+=5,c[r>>>1]>>0):r>=29360128&&r<29884416||r>=16777216&&r<17301504?(psx.clock+=12,c[r>>>1]):33423664===r?c[r>>>1]>>0:void abort(`r16: unable to load from $${hex(r,8)}`)},memRead32:function(r){return r<8388608?(psx.clock+=5,t.getInt32(2097151&r,!0)):r>=25165824&&r<25178112?function(r){switch(psx.clock+=3,16383&r){case 4116:case 4128:case 4192:return e[r>>>2]>>0;case 4164:return joy.rd16r1044()>>0;case 4180:return 0;case 4208:return cpu.istat>>0;case 4212:return cpu.imask>>0;case 4224:return dma.r1080>>0;case 4232:return dma.r1088>>0;case 4240:return dma.r1090>>0;case 4248:return dma.r1098>>0;case 4256:return dma.r10a0>>0;case 4264:return dma.r10a8>>0;case 4272:return dma.r10b0>>0;case 4280:return dma.r10b8>>0;case 4288:return dma.r10c0>>0;case 4296:return dma.r10c8>>0;case 4320:return dma.r10e0>>0;case 4328:return dma.r10e8>>0;case 4336:return dma.rd32r10f0()>>0;case 4340:return dma.rd32r10f4()>>0;case 4352:return rc0.getValue()>>0;case 4356:return rc0.getMode()>>0;case 4360:return rc0.getTarget()>>0;case 4368:return rc1.getValue()>>0;case 4372:return rc1.getMode()>>0;case 4376:return rc1.getTarget()>>0;case 4384:return rc2.getValue()>>0;case 4388:return rc2.getMode()>>0;case 4392:return rc2.getTarget()>>0;case 6144:return cdr.rd08r1800();case 6160:return gpu.rd32r1810()>>0;case 6164:return gpu.rd32r1814()>>0;case 6176:return mdc.rd32r1820()>>0;case 6180:return mdc.rd32r1824()>>0;default:if(r<25169920)return psx.clock-=3,e[r>>>2]>>0;if(r>=25174016)return psx.clock+=56,e[r>>>2]>>0;if(r>=25172992&&r<25174016)return 65535&spu.getInt16(16383&r)|spu.getInt16(r+2&16383)<<16}abort(`r32: unable to load from $${hex(r,8)}`)}(r)>>0:r>=27262976&&r<27787264?(psx.clock+=9,e[r>>>2]>>0):r>=29360128&&r<29884416?(psx.clock+=24,e[r>>>2]>>0):33423664===r?e[r>>>2]>>0:r>=16777216&&r<17301504?(psx.clock+=24,e[r>>>2]):void abort(`r32: unable to load from $${hex(r,8)}`)},memWrite8:function(r,e){if(r<8388608){const c=2097151&r;return a[(c|cpu.forceWriteBits)>>>0]=e,void(fastCache[c]=0)}if(r>=25165824&&r<25174016)return a[r>>>0]=e,void(r>=25169920&&function(r,e){switch(16383&r){case 4160:return joy.wr08r1040(e);case 4342:return dma.wr08r10f6(e);case 6144:return cdr.wr08r1800(e);case 6145:return cdr.wr08r1801(e);case 6146:return cdr.wr08r1802(e);case 6147:return cdr.wr08r1803(e);default:abort(`w8: unable to store at $${hex(r,8)}`)}}(r,e));25174081!==r?abort(`w8: unable to store at $${hex(r,8)}`):a[r>>>0]=e},memWrite16:function(r,e){if(r<8388608){const a=2097151&r;return c[(a|cpu.forceWriteBits)>>>1]=e,void(fastCache[a]=0)}if(r>=25165824&&r<25174016)return c[r>>>1]=e,void(r>=25169920&&function(r,e){switch(16383&r){case 4116:return c[r>>>1]=e;case 4168:return joy.wr16r1048(e);case 4170:return joy.wr16r104a(e);case 4174:return joy.wr16r104e(e);case 4184:case 4186:case 4190:return;case 4208:return void(cpu.istat&=65535&e&cpu.imask);case 4212:return void(cpu.imask=e);case 4336:return dma.wr32r10f0(e);case 4352:return rc0.setValue(e);case 4356:return rc0.setMode(e);case 4360:return rc0.setTarget(e);case 4368:return rc1.setValue(e);case 4372:return rc1.setMode(e);case 4376:return rc1.setTarget(e);case 4384:return rc2.setValue(e);case 4388:return rc2.setMode(e);case 4392:return rc2.setTarget(e);default:if(r>=25172992&&r<25174016)return c[r>>>1]=e,spu.setInt16(16383&r,e);abort(`w16: unable to store at $${hex(r,8)}`)}}(r,e));abort(`w16: unable to store at $${hex(r,8)}`)},memWrite32:function(r,a){if(r<8388608){const c=2097151&r;return e[(c|cpu.forceWriteBits)>>>2]=a,void(fastCache[c]=0)}if(r>=25165824&&r<25174016)return e[r>>>2]=a,void(r>=25169920&&function(r,a){switch(16383&r){case 4096:case 4100:case 4104:case 4108:case 4112:case 4116:case 4120:case 4124:case 4128:case 4192:break;case 4208:cpu.istat&=a&cpu.imask;break;case 4212:cpu.imask=a>>>0;break;case 4224:dma.r1080=a>>>0;break;case 4228:dma.r1084=a>>>0;break;case 4232:dma.wr32r1088(a);break;case 4240:dma.r1090=a>>>0;break;case 4244:dma.r1094=a>>>0;break;case 4248:dma.wr32r1098(a);break;case 4256:dma.r10a0=a>>>0;break;case 4260:dma.r10a4=a>>>0;break;case 4264:dma.wr32r10a8(a);break;case 4272:dma.r10b0=a>>>0;break;case 4276:dma.r10b4=a>>>0;break;case 4280:dma.wr32r10b8(a);break;case 4288:dma.r10c0=a>>>0;break;case 4292:dma.r10c4=a>>>0;break;case 4296:dma.wr32r10c8(a);break;case 4320:dma.r10e0=a>>>0;break;case 4324:dma.r10e4=a>>>0;break;case 4328:dma.wr32r10e8(a);break;case 4336:dma.wr32r10f0(a);break;case 4340:dma.wr32r10f4(a);break;case 4352:rc0.setValue(a);break;case 4356:rc0.setMode(a);break;case 4360:rc0.setTarget(a);break;case 4368:rc1.setValue(a);break;case 4372:rc1.setMode(a);break;case 4376:rc1.setTarget(a);break;case 4384:rc2.setValue(a);break;case 4388:rc2.setMode(a);break;case 4392:rc2.setTarget(a);break;case 6160:gpu.wr32r1810(a);break;case 6164:gpu.wr32r1814(a);break;case 6176:mdc.wr32r1820(a);break;case 6180:mdc.wr32r1824(a);break;default:if(r>=25172992&&r<25174016)return e[r>>>2]=a,spu.setInt16(r+0&16383,a>>>0),void spu.setInt16(r+2&16383,a>>>16);abort(`w32: unable to store at $${hex(r,8)}`)}}(r,a));33423664!==r?abort(`w32: unable to store at $${hex(r,8)}`):e[r>>>2]=a}}}));mdlr('enge:psx:rec',(t=>{function e(t,e,r){const s=["  return function $"+hex(t).toUpperCase()+"(psx) { ++calls;\n    "+e.replace(/[\r\n]/g,'\n    ')+"\n  }"];return s.unshift(''),[...new Set(r||[])].forEach((t=>{s.unshift(`  const _${hex(t)} = getCacheEntry(0x${hex(t)});`)})),s.unshift("'use strict;'"),new Function(s.join('\n'))()}const r={compile02:function(t,e){t.stop=!0,t.jump=!0,t.skipNext=!0,t.branchTarget=(8388607&e)<<2;const r='j       $'+hex(t.branchTarget);return t.setReg(r,0,`target = _${hex(t.branchTarget)}`)},compile03:function(t,e){t.stop=!0,t.jump=!0,t.branchTarget=(8388607&e)<<2;const r='jal     $'+hex(t.branchTarget),s=t.setReg(r,0,`target = _${hex(t.branchTarget)};\n`+t.reg(31)+' = 0x'+hex(t.pc+8));return h.resetConst(31),s},compile04:function(t,e){t.stop=!0,t.branchTarget=t.pc+4+4*(e<<16>>16);const r='beq     r'+t.rs+', r'+t.rt+', $'+hex(e,4);return t.setReg(r,0,`target = (${t.getRS()} === ${t.getRT()}) ? _${hex(t.branchTarget)} : _${hex(t.pc+8)}`)},compile05:function(t,e){t.stop=!0,t.branchTarget=t.pc+4+4*(e<<16>>16);const r='bne     r'+t.rs+', r'+t.rt+', $'+hex(e,4);return t.setReg(r,0,`target = (${t.getRS()} !== ${t.getRT()}) ? _${hex(t.branchTarget)} : _${hex(t.pc+8)}`)},compile06:function(t,e){t.stop=!0,t.branchTarget=t.pc+4+4*(e<<16>>16);const r='blez    r'+t.rs+', $'+hex(e,4);return t.setReg(r,0,`target = (${t.getRS()} <= 0) ? _${hex(t.branchTarget)} : _${hex(t.pc+8)}`)},compile07:function(t,e){t.stop=!0,t.branchTarget=t.pc+4+4*(e<<16>>16);const r='bgtz    r'+t.rs+', $'+hex(e,4);return t.setReg(r,0,`target = (${t.getRS()} > 0) ? _${hex(t.branchTarget)} : _${hex(t.pc+8)}`)},compile08:function(t,e){const r='addi    r'+t.rt+', r'+t.rs+', $'+hex(e,4);if(h.isConst(t.rs)){const s=e<<16>>16,n=h.getConst(t.rs)+s,o=t.setReg(r,t.rt,`0x${hex(n)}`);return h.setConst(t.rt,n),o}const s=t.setReg(r,t.rt,(e<<16>>16)+' + '+t.getRS());return h.resetConst(t.rt),s},compile09:function(t,e){const r='addiu   r'+t.rt+', r'+t.rs+', $'+hex(e,4);if(h.isConst(t.rs)){const s=e<<16>>16,n=h.getConst(t.rs)+s,o=t.setReg(r,t.rt,`0x${hex(n)}`);return h.setConst(t.rt,n),o}const s=t.setReg(r,t.rt,(e<<16>>16)+' + '+t.getRS());return h.resetConst(t.rt),s},compile0A:function(t,e){const r='slti    r'+t.rt+', r'+t.rs+', $'+hex(e,4),s=t.setReg(r,t.rt,'('+t.getRS()+' < '+(e<<16>>16)+') ? 1 : 0');return h.resetConst(t.rt),s},compile0B:function(t,e){const r='sltiu   r'+t.rt+', r'+t.rs+', $'+hex(e,4),s=t.setReg(r,t.rt,'(('+t.getRS()+' >>> 0) < ('+(e<<16>>16)+' >>> 0)) ? 1 : 0');return h.resetConst(t.rt),s},compile0C:function(t,e){const r='andi    r'+t.rt+', r'+t.rs+', $'+hex(e,4);if(h.isConst(t.rs)){const s=e<<16>>>16,n=h.getConst(t.rs)&s,o=t.setReg(r,t.rt,`0x${hex(n)}`);return h.setConst(t.rt,n),o}const s=t.setReg(r,t.rt,t.getRS()+' & 0x'+hex(e,4));return h.resetConst(t.rt),s},compile0D:function(t,e){const r='ori     r'+t.rt+', r'+t.rs+', $'+hex(e,4);if(h.isConst(t.rs)){const s=e<<16>>>16,n=h.getConst(t.rs)|s,o=t.setReg(r,t.rt,`0x${hex(n)}`);return h.setConst(t.rt,n),o}const s=t.setReg(r,t.rt,t.getRS()+' | 0x'+hex(e,4));return h.resetConst(t.rt),s},compile0E:function(t,e){const r='xori    r'+t.rt+', r'+t.rs+', $'+hex(e,4);if(h.isConst(t.rs)){const s=e<<16>>>16,n=h.getConst(t.rs)^s,o=t.setReg(r,t.rt,`0x${hex(n)}`);return h.setConst(t.rt,n),o}const s=t.setReg(r,t.rt,t.getRS()+' ^ 0x'+hex(e,4));return h.resetConst(t.rt),s},compile0F:function(t,e){const r='lui     r'+t.rt+', $'+hex(e,4),s=t.setReg(r,t.rt,'0x'+hex((65535&e)<<16),!0);return h.setConst(t.rt,(65535&e)<<16),s},compile20:function(t,e){const r='lb      r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')',s=t.setReg(r,t.rt,'(memRead8('+t.getOF(e)+') << 24) >> 24');return h.resetConst(t.rt),s},compile21:function(t,e){const r='lh      r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')',s=t.setReg(r,t.rt,'(memRead16 ('+t.getOF(e)+') << 16) >> 16');return h.resetConst(t.rt),s},compile22:function(t,e){const r='lwl     r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')',s=t.setReg(r,0,'cpu.lwl('+t.rt+', '+t.getOF(e)+')');return h.resetConst(t.rt),s},compile23:function(t,e){const r='lw      r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')';if(h.isConst(t.rs)){const s=e<<16>>16,n=h.getConst(t.rs)+s&33554431;if(n<=8388608){t.cycles+=5;const e=t.setReg(r,t.rt,`ram.getInt32(0x${hex(2097151&n)}, true)`);return h.resetConst(t.rt),e}}const s=t.setReg(r,t.rt,'memRead32('+t.getOF(e)+')');return h.resetConst(t.rt),s},compile24:function(t,e){const r='lbu     r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')';if(h.isConst(t.rs)){const s=e<<16>>16,n=h.getConst(t.rs)+s&33554431;if(n<=8388608){t.cycles+=5;const e=t.setReg(r,t.rt,`ram.getUint8(0x${hex(2097151&n)})`);return h.resetConst(t.rt),e}}const s=t.setReg(r,t.rt,'memRead8('+t.getOF(e)+') & 0xff');return h.resetConst(t.rt),s},compile25:function(t,e){const r='lhu     r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')',s=t.setReg(r,t.rt,'memRead16('+t.getOF(e)+') & 0xffff');return h.resetConst(t.rt),s},compile26:function(t,e){const r='lwr     r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')',s=t.setReg(r,0,'cpu.lwr('+t.rt+', '+t.getOF(e)+')');return h.resetConst(t.rt),s},compile28:function(t,e){const r='sb      r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')';return t.setReg(r,0,'memWrite8('+t.getOF(e)+', '+t.getRT()+')')},compile29:function(t,e){const r='sh      r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')';return t.setReg(r,0,'memWrite16('+t.getOF(e)+', '+t.getRT()+')')},compile2A:function(t,e){const r='swl     r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')';return t.setReg(r,0,'cpu.swl('+t.rt+', '+t.getOF(e)+')')},compile2B:function(t,e){const r='sw      r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')';if(h.isConst(t.rs)){const s=e<<16>>16,n=h.getConst(t.rs)+s&33554431;if(n<=8388608){const e=t.setReg(r,0,`map[(0x${hex(2097151&n)} | cpu.forceWriteBits) >> 2] = ${t.getRT()}`);return h.resetConst(t.rt),e}}return t.setReg(r,0,`memWrite32(${t.getOF(e)}, ${t.getRT()})`)},compile2E:function(t,e){const r='swr     r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')';return t.setReg(r,0,'cpu.swr('+t.rt+', '+t.getOF(e)+')')},compile32:function(t,e){const r='lwc2    r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')';return t.setReg(r,0,'gte.set('+t.rt+', memRead32('+t.getOF(e)+'))')},compile3A:function(t,e){const r='swc2    r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')';return t.setReg(r,0,'memWrite32('+t.getOF(e)+', gte.get('+t.rt+'))')},compile40:function(t,e){if(0===e)return'// '+hex(t.pc)+': '+hex(e)+': nop';const r='sll     r'+t.rd+', r'+t.rt+', $'+(e>>6&31),s=t.setReg(r,t.rd,t.getRT()+' << '+(e>>6&31));return h.resetConst(t.rd),s},compile42:function(t,e){const r='srl     r'+t.rd+', r'+t.rt+', $'+(e>>6&31),s=t.setReg(r,t.rd,t.getRT()+' >>> '+(e>>6&31));return h.resetConst(t.rd),s},compile43:function(t,e){const r='sra     r'+t.rd+', r'+t.rt+', $'+(e>>6&31),s=t.setReg(r,t.rd,t.getRT()+' >> '+(e>>6&31));return h.resetConst(t.rd),s},compile44:function(t,e){const r='sllv    r'+t.rd+', r'+t.rt+', r'+t.rs,s=t.setReg(r,t.rd,t.getRT()+' << ('+t.getRS()+' & 0x1f)');return h.resetConst(t.rd),s},compile46:function(t,e){const r='srlv    r'+t.rd+', r'+t.rt+', r'+t.rs;return h.resetConst(t.rd),t.setReg(r,t.rd,t.getRT()+' >>> ('+t.getRS()+' & 0x1f)')},compile47:function(t,e){const r='srav    r'+t.rd+', r'+t.rt+', r'+t.rs,s=t.setReg(r,t.rd,t.getRT()+' >> ('+t.getRS()+' & 0x1f)');return h.resetConst(t.rd),s},compile48:function(t,e){t.stop=!0,t.jump=!0,t.skipNext=!0;const r='jr      r'+t.rs;return h.isConst(t.rs)?(t.branchTarget=33554431&h.getConst(t.rs),t.setReg(r,0,`target = _${hex(t.branchTarget)}`)):t.setReg(r,0,'target = getCacheEntry('+t.getRS()+')')},compile49:function(t,e){t.stop=!0,t.jump=!0;const r='jalr    r'+t.rs+', r'+t.rd,s=t.setReg(r,t.rd,'0x'+hex(t.pc+8)+';\ntarget = getCacheEntry('+t.getRS()+')');return h.resetConst(t.rd),s},compile4C:function(t,e){return t.stop=!0,t.syscall=!0,t.setReg('syscall',0,'target = cpuException(8 << 2, 0x'+hex(t.pc)+')')},compile4D:function(t,e){return'//break'},compile50:function(t,e){const r='mfhi     r'+t.rd,s=t.setReg(r,t.rd,'cpu.hi');return h.resetConst(t.rd),s},compile51:function(t,e){const r='mthi     r'+t.rs;return t.setReg(r,0,'cpu.hi = '+t.getRS())},compile52:function(t,e){const r='mflo     r'+t.rd,s=t.setReg(r,t.rd,'cpu.lo');return h.resetConst(t.rd),s},compile53:function(t,e){const r='mtlo     r'+t.rs;return t.setReg(r,0,'cpu.lo = '+t.getRS())},compile58:function(t,e){const r='mult    r'+t.rs+', r'+t.rt,s=t.setReg(r,0,'cpu.mult('+t.getRS()+', '+t.getRT()+')');return t.cycles+=8,s},compile59:function(t,e){const r='multu   r'+t.rs+', r'+t.rt,s=t.setReg(r,0,'cpu.multu('+t.getRS()+', '+t.getRT()+')');return t.cycles+=8,s},compile5A:function(t,e){const r='div     r'+t.rs+', r'+t.rt,s=t.setReg(r,0,'cpu.div('+t.getRS()+', '+t.getRT()+')');return t.cycles+=35,s},compile5B:function(t,e){const r='divu    r'+t.rs+', r'+t.rt,s=t.setReg(r,0,'cpu.divu('+t.getRS()+', '+t.getRT()+')');return t.cycles+=35,s},compile60:function(t,e){const r='add     r'+t.rd+', r'+t.rs+', r'+t.rt;if(h.isConst(t.rs)&&h.isConst(t.rt)){const e=h.getConst(t.rs)+h.getConst(t.rt),s=t.setReg(r,t.rd,`0x${hex(e)}`);return h.setConst(t.rd,e),s}const s=t.setReg(r,t.rd,t.getRS()+' + '+t.getRT());return h.resetConst(t.rd),s},compile61:function(t,e){const r='addu    r'+t.rd+', r'+t.rs+', r'+t.rt;if(h.isConst(t.rs)&&h.isConst(t.rt)){const e=h.getConst(t.rs)+h.getConst(t.rt),s=t.setReg(r,t.rd,`0x${hex(e)}`);return h.setConst(t.rd,e),s}const s=t.setReg(r,t.rd,t.getRS()+' + '+t.getRT());return h.resetConst(t.rd),s},compile62:function(t,e){const r='sub     r'+t.rd+', r'+t.rs+', r'+t.rt;if(h.isConst(t.rs)&&h.isConst(t.rt)){const e=h.getConst(t.rs)-h.getConst(t.rt),s=t.setReg(r,t.rd,`0x${hex(e)}`);return h.setConst(t.rd,e),s}const s=t.setReg(r,t.rd,t.getRS()+' - '+t.getRT());return h.resetConst(t.rd),s},compile63:function(t,e){const r='subu    r'+t.rd+', r'+t.rs+', r'+t.rt;if(h.isConst(t.rs)&&h.isConst(t.rt)){const e=h.getConst(t.rs)-h.getConst(t.rt),s=t.setReg(r,t.rd,`0x${hex(e)}`);return h.setConst(t.rd,e),s}const s=t.setReg(r,t.rd,t.getRS()+' - '+t.getRT());return h.resetConst(t.rd),s},compile64:function(t,e){const r='and     r'+t.rd+', r'+t.rs+', r'+t.rt;if(h.isConst(t.rs)&&h.isConst(t.rt)){const e=h.getConst(t.rs)&h.getConst(t.rt),s=t.setReg(r,t.rd,`0x${hex(e)}`);return h.setConst(t.rd,e),s}const s=t.setReg(r,t.rd,t.getRS()+' & '+t.getRT());return h.resetConst(t.rd),s},compile65:function(t,e){const r='or      r'+t.rd+', r'+t.rs+', r'+t.rt;if(h.isConst(t.rs)&&h.isConst(t.rt)){const e=h.getConst(t.rs)|h.getConst(t.rt),s=t.setReg(r,t.rd,`0x${hex(e)}`);return h.setConst(t.rd,e),s}const s=t.setReg(r,t.rd,t.getRS()+' | '+t.getRT());return h.resetConst(t.rd),s},compile66:function(t,e){const r='xor     r'+t.rd+', r'+t.rs+', r'+t.rt;if(h.isConst(t.rs)&&h.isConst(t.rt)){const e=h.getConst(t.rs)^h.getConst(t.rt),s=t.setReg(r,t.rd,`0x${hex(e)}`);return h.setConst(t.rd,e),s}const s=t.setReg(r,t.rd,t.getRS()+' ^ '+t.getRT());return h.resetConst(t.rd),s},compile67:function(t,e){const r='nor     r'+t.rd+', r'+t.rs+', r'+t.rt;if(h.isConst(t.rs)&&h.isConst(t.rt)){const e=~(h.getConst(t.rs)|h.getConst(t.rt)),s=t.setReg(r,t.rd,`0x${hex(e)}`);return h.setConst(t.rd,e),s}const s=t.setReg(r,t.rd,'~('+t.getRS()+' | '+t.getRT()+')');return h.resetConst(t.rd),s},compile6A:function(t,e){const r='slt     r'+t.rd+', r'+t.rs+', r'+t.rt,s=t.setReg(r,t.rd,'('+t.getRS()+' < '+t.getRT()+') ? 1 : 0');return h.resetConst(t.rd),s},compile6B:function(t,e){const r='sltu    r'+t.rd+', r'+t.rs+', r'+t.rt,s=t.setReg(r,t.rd,'(('+t.getRS()+' >>> 0) < ('+t.getRT()+' >>> 0)) ? 1 : 0');return h.resetConst(t.rd),s},compile80:function(t,e){t.stop=!0,t.branchTarget=t.pc+4+4*(e<<16>>16);const r='bltz    r'+t.rs+', $'+hex(e,4);return t.setReg(r,0,`target = (${t.getRS()} < 0) ? _${hex(t.branchTarget)} : _${hex(t.pc+8)}`)},compile81:function(t,e){t.stop=!0,t.branchTarget=t.pc+4+4*(e<<16>>16);const r='bgez    r'+t.rs+', $'+hex(e,4);return t.setReg(r,0,`target = (${t.getRS()} >= 0) ? _${hex(t.branchTarget)} : _${hex(t.pc+8)}`)},compile90:function(t,e){t.stop=!0,t.branchTarget=t.pc+4+4*(e<<16>>16);const r='bltzal  r'+t.rs+', $'+hex(e,4),s=t.setReg(r,0,`target = (${t.getRS()} < 0) ? _${hex(t.branchTarget)} : _${hex(t.pc+8)};\n`+t.reg(31)+' = 0x'+hex(t.pc+8));return h.resetConst(31),s},compile91:function(t,e){t.stop=!0,t.branchTarget=t.pc+4+4*(e<<16>>16);const r='bgezal  r'+t.rs+', $'+hex(e,4),s=t.setReg(r,0,`target = (${t.getRS()} >= 0) ? _${hex(t.branchTarget)} : _${hex(t.pc+8)};\n`+t.reg(31)+' = 0x'+hex(t.pc+8));return h.resetConst(31),s},compileA0:function(t,e){const r='mfc0    r'+t.rt+', r'+t.rd,s=t.setReg(r,t.rt,'cpu.getCtrl('+t.rd+')');return h.resetConst(t.rt),s},compileA4:function(t,e){const r='mtc0    r'+t.rt+', r'+t.rd;return t.setReg(r,0,'cpu.setCtrl('+t.rd+', '+t.getRT()+')')},compileB0:function(t,e){return t.setReg('rfe',0,'cpu.rfe()')},compileC0:function(t,e){const r='mfc2    r'+t.rt+', r'+t.rd,s=t.setReg(r,t.rt,'gte.get('+t.rd+')');return h.resetConst(t.rt),s},compileC2:function(t,e){const r='cfc2    r'+t.rt+', r'+t.rd,s=t.setReg(r,t.rt,'gte.get('+(32+t.rd)+')');return h.resetConst(t.rt),s},compileC4:function(t,e){const r='mtc2    r'+t.rt+', r'+t.rd;return t.setReg(r,0,'gte.set('+t.rd+', '+t.getRT()+')')},compileC6:function(t,e){const r='ctc2    r'+t.rt+', r'+t.rd;return t.setReg(r,0,'gte.set('+(32+t.rd)+', '+t.getRT()+')')},compileD0:function(t,e){t.cycles+=gte.cycles(33554431&e);const r='cop2    0x'+hex(33554431&e);return t.setReg(r,0,'gte.command(0x'+hex(33554431&e)+')')},invalid:(t,e)=>{abort('invalid instruction')}};r.compileD1=r.compileD0,r.compileD2=r.compileD0,r.compileD3=r.compileD0,r.compileD4=r.compileD0,r.compileD5=r.compileD0,r.compileD6=r.compileD0,r.compileD7=r.compileD0,r.compileD8=r.compileD0,r.compileD9=r.compileD0,r.compileDA=r.compileD0,r.compileDB=r.compileD0,r.compileDC=r.compileD0,r.compileDD=r.compileD0,r.compileDE=r.compileD0,r.compileDF=r.compileD0;const s=new Array(256);for(let t=0;t<256;++t)s[t]=r[`compile${hex(t,2).toUpperCase()}`]||r.invalid;function n(t,e,r){const n=u(t.pc),o=map[n>>2];var c=0;switch(o>>>26&63){default:c=0+(o>>>26&63);break;case 0:c=64+(o>>>0&63);break;case 1:c=128+(o>>>16&31);break;case 16:c=160+(o>>>21&31);break;case 18:c=192+(o>>>21&31)}t.rd=o>>>11&31,t.rs=o>>>21&31,t.rt=o>>>16&31,e.push(s[c](t,o))}const o={pc:0,rt:0,rs:0,rd:0,stop:!1,break:!1,syscall:!1,cause:!1,sr:!1,cycles:0,skipNext:!1,entry:null,branchTarget:0,jump:!1,entryPC:0,reg:function(t){return t?'gpr['+t+']':'0'},getRS:function(){if(h.isConst(this.rs)){const t=h.getConst(this.rs);return t<-127||t>127?`(0x${hex(t)}|0)`:`${t}`}return`${this.reg(this.rs)}`},getRT:function(){if(h.isConst(this.rt)){const t=h.getConst(this.rt);return t<-127||t>127?`(0x${hex(t)}|0)`:`${t}`}return`${this.reg(this.rt)}`},getOF:function(t){const e=t<<16>>16;return h.isConst(this.rs)?`0x${hex(e+h.getConst(this.rs)&33554431)}`:e?`(${e} + ${this.reg(this.rs)}) & 0x01ffffff`:`${this.reg(this.rs)} & 0x01ffffff`},setReg:function(t,e,r){const s=map[u(this.pc)>>>2];let n='// '+hex(this.pc)+': '+hex(s)+': '+t;return r&&(n+='\n'+(e?this.reg(e)+' = ':'')+`${r};`),n},clear:function(){this.branchTarget=0,this.jump=!1,this.stop=!1,this.break=!1,this.syscall=!1,this.cause=!1,this.sr=!1,this.cycles=0,this.skipNext=!1}},c=new Map,i=new Uint8Array(2097152);function u(t){let e=33554431&t;return e<8388608&&(e&=2097151),e}i.fill(0),Object.seal(o),Object.seal(r),Object.seal(c);let g=0;function p(){if(this.loop.length){const t=new Set,r=[],s=[];for(let e=0;e<this.loop.length;++e){let n=this.loop[e];t.add(n.pc),s.push(n.text),s.push(`_${hex(n.pc)}.clock = psx.clock;`),s.push(`++_${hex(n.pc)}.count;`),s.push('');let o=e+1<this.loop.length?this.loop[e+1].pc:this.pc;s.push("if (psx.clock >= psx.eventClock) break;"),s.push(`if (target !== _${hex(o)}) break;`),n.jump&&t.add(n.jump.pc),n.next&&t.add(n.next.pc),n.pc<2097152&&r.push(`if (!fastCache[${n.pc}]) { return resetCacheEntry(_${hex(this.pc)}); }\n`),s.push(''),this.code=null,i[n.pc]=1}let n=r.join('');return n+=`\nconst gpr = cpu.gpr; let target = _${hex(this.pc)};\nfor (;;) {\n`,n+=s.join('\n'),n+='\n}\nreturn target;',this.code=e(this.pc,n,[...t]),this.jump=this,this}return this.code=function(t){const r=t.pc>>>0;let s=function(t){const e=t.pc>>>0;o.clear(),o.pc=e,o.entryPC=e,o.entry=t;const r=[];for(h.resetState();!o.stop&&o.cycles<2048;)n(o,r),o.cycles+=1,o.pc+=4;if(!o.stop&&o.cycles>=64){o.branchTarget=o.pc>>>0&33554431,o.skipNext=!0,o.jump=!0;const t=o.setReg('*snip*',0,`target = _${hex(o.branchTarget)}`);r.push(t)}return!o.stop||o.break||o.syscall||o.sr||(n(o,r),o.cycles+=1,o.pc+=4),160!==e&&176!==e&&192!==e||r.unshift(`trace(${e}, gpr[9]);`),r.push('psx.clock += '+o.cycles+';'),r}(t).join('\n').split('\n');t.jump=l(o.branchTarget),t.next=o.skipNext?null:l(o.pc);let c=[o.branchTarget>>>0,o.skipNext?0:o.pc>>>0,r].filter((t=>null!==t||void 0!==t));if(s.length>=6){const t=s[0].indexOf('8fa20010');if(-1!==t&&t===s[2].indexOf('00000000')&&t===s[3].indexOf('2442ffff')&&t===s[5].indexOf('afa20010')&&t===s[7].indexOf('8fa20010')&&t===s[9].indexOf('00000000')){const t=s.filter(((t,e)=>e<10&&-1!==t.indexOf('//'))).join('\n');console.log(`HLE detected @$${hex(r)}...`),s.splice(0,10,['gpr[2] = --map[((16 + gpr[29]) & 0x001ffffc) >>> 2];']),s.push('psx.clock += 10;'),s.unshift(t)}}return t.text=s.join('\n'),t.opt,s.push(' '),s.push('return target;'),s.unshift(`const gpr = cpu.gpr; let target = _${hex(r)};\n`),r<2097152&&(s.unshift(`if (!fastCache[${r}]) { return invalidateCache(this); }`),i[r]=1),e(r,s.filter((t=>t)).join('\n'),c)}(this),this}function l(t){const e=u(t);let r=c.get(e);return r||(c.set(e,r=a.createCacheEntry(e)),r.code=p),r}const h={values:new Int32Array(32),state:new Int8Array(32),resetState:function(){this.state.fill(0)},isConst:function(t){return!t||this.state[t]},getConst:function(t){return t?this.values[t]:0},setConst:function(t,e){t&&(this.values[t]=e,this.state[t]=1)},resetConst:function(t){this.state[t]=0}},a={createCacheEntry:t=>Object.seal({pc:t>>>0,code:null,jump:null,next:null,count:0,clock:0,opt:!1,text:'',loop:[]})},f=1024;window.CodeTrace={loop:[],history:new Array(f),index:0,add:function(t){this.index=(this.index+1)%f,this.history[this.index]=t},detectLoop:function(t){for(let e=1;e<=8;++e){const r=(this.index-e+f)%f;if(this.history[r].opt)return 0;if(!this.history[r].jump||!this.history[r].next)return 0;if(this.history[r]===t)return e}return 0},optimise:function(t){}},window.stats=window.stats||{},window.stats.top=(t=1,e=25)=>{const r=psx.clock-33868800*t,s=[...c.values()].filter((t=>t.clock>r)),n=s.reduce(((t,e)=>t+e.count),0);s.sort(((t,e)=>e.count-t.count)).slice(0,e).forEach((t=>{console.log(`$${hex(t.pc)}\t${(t.count/n).toFixed(3)}\t`,{code:t.code},`\t${t.count}`)}))},window.calls=0;const x=33868800,d=0===window.location.href.indexOf('file://');let R=0,m=0,C=0;return psx.addEvent(0,(t=>{const e=renderer.fpsRenderCounter-C;C=renderer.fpsRenderCounter,d&&console.log(`${calls} ${(x/calls).toFixed(1)} ${g} ${context.counter-R}/${renderer.fpsCounter-m}/${e}`),psx.setEvent(t,x),R=context.counter,m=renderer.fpsCounter,g=0,calls=0})),window.vector=null,window.fastCache=i,window.cached=c,window.invalidateCache=t=>(t.code=p,t.count=0,t.clock=0,t.opt=!1,t),window.resetCacheEntry=t=>(t.code=p,t.count=0,t.clock=0,t.opt=!1,t.loop=[],t),{getCacheEntry:l,clearCodeCache:function(t,e){const r=u(t);r>=2097152||(i.fill(0,r,r+e),++g)}}}));mdlr('enge:psx:rtc',(e=>{const t=new Float64Array(4),s=new Uint32Array(4),a=new Uint32Array(4);function c(e,c,n){const i=8&s[e]?11:12;switch(i){case 11:var r=+(a[e]+1);break;case 12:r=65536;break;default:return abort('invalid limit bit')}let o=t[e]+c;return o>=r?(n&&n(),s[e]|=1<<i,o%r):o}t.fill(0),s.fill(0),a.fill(65535);const n={freerun:!1,getValue:function(e){const t=this.freerun;let a=0;switch(7&s[0]){case 0:a=+(psx.clock-o.start);break;case 1:switch(o.whereInScanLine()){case-1:a=0;break;case 0:a=+(psx.clock-o.dispHStart);break;case 1:a=+(o.dispHStop-o.dispHStart)}break;case 3:switch(o.whereInScanLine()){case-1:case 0:a=+(psx.clock-o.start);break;case 1:a=+(psx.clock-o.dispHStop)}break;case 5:switch(o.whereInScanLine()){case-1:a=+(psx.clock-o.start);break;case 0:a=+(o.dispHStart-o.start);break;case 1:a=+(psx.clock-o.dispHStop)}break;case 7:switch(o.whereInScanLine()){case-1:case 0:a=t?+(psx.clock-o.start):0;break;case 1:a=t?+(psx.clock-o.start):+(psx.clock-o.dispHStop)}break;default:return abort(`RC0: invalid mode: $${hex(s[0],4)}`)}return 256&s[0]?c(0,+gpu.cyclesToDotClock(a)):c(0,+a)},getTarget:function(e){return a[0]},getMode:function(){let e=s[0];return s[0]&=59391,e},setMode:function(e){s[0]=1023&e|1024;let a=0;switch(7&e){case 0:a=+(psx.clock-o.start);break;case 1:switch(o.whereInScanLine()){case-1:a=0;break;case 0:a=+(psx.clock-o.dispHStart);break;case 1:a=0}break;case 3:case 5:switch(o.whereInScanLine()){case-1:case 0:a=0;break;case 1:a=+(psx.clock-o.dispHStop)}break;case 7:this.freerun=!1,a=0;break;default:return abort(`RC0: invalid mode: $${hex(s[0],4)}`)}256&s[0]?(t[0]=0,c(0,-gpu.cyclesToDotClock(a))):(t[0]=0,c(0,-a))},setTarget:function(e){e||(e=65535),a[0]=e},setValue:function(e){if(e)return abort('not supported');t[0]=e},onLimitReached:function(){48&s[0]&&(cpu.istat|=16)},onScanLine:function(){const e=this.freerun;let a=0;switch(7&s[0]){case 0:a=+(o.stop-o.start);break;case 1:a=+(o.dispHStop-o.dispHStart);break;case 3:case 5:switch(o.whereInScanLine()){case-1:case 0:a=0;break;case 1:a=-+(psx.clock-o.dispHStop)}break;case 7:a=e?+(o.stop-o.start):+(o.stop-o.dispHStop),this.freerun=!0;break;default:return abort(`RC1: invalid mode: $${hex(s[0],4)}`)}256&s[0]?t[0]=c(0,gpu.cyclesToDotClock(a),this.onLimitReached):t[0]=c(0,a,this.onLimitReached)}},i={freerun:!1,getValue:function(e){switch(o.isInVBlank(),263&s[1]){case 0:return c(1,+(psx.clock-o.start));case 1:return c(1,o.isInVBlank()?0:+psx.eventCycles(o.event));case 3:return c(1,+psx.eventCycles(o.event));case 5:return c(1,(o.isInVBlank(),0));case 7:return this.freerun?c(1,+psx.eventCycles(o.event)):c(1,0);case 256:case 257:case 259:case 261:return c(1,0);case 263:return this.freerun,c(1,0);default:return abort(`RC1: invalid mode: $${hex(s[1],4)}`)}},getTarget:function(e){return a[1]},getMode:function(){let e=s[1];return s[1]&=59391,e},setMode:function(e){switch(s[1]=(319&e|1024)>>>0,263&s[1]){case 0:case 1:case 3:case 5:t[1]=-+(psx.clock-o.start),t[1]=c(1,0);break;case 7:case 263:this.freerun=!1,t[1]=0;break;case 256:case 257:case 259:case 261:t[1]=0;break;default:return abort(`RC1: invalid mode: $${hex(s[1],4)}`)}},setTarget:function(e){e||(e=65535),a[1]=e>>>0},setValue:function(e){if(e)return abort('not supported');t[1]=+e},onLimitReached:function(){48&s[1]&&(cpu.istat|=32)},onScanLine:function(e){const a=+(o.stop-o.start);switch(263&s[1]){case 0:t[1]=c(1,a,this.onLimitReached);break;case 1:t[1]=c(1,o.isInVBlank()?0:a,this.onLimitReached);break;case 3:t[1]=c(1,a,this.onLimitReached),e&&(t[1]=0);break;case 5:t[1]=c(1,o.isInVBlank()?a:0,this.onLimitReached),o.isInVBlank()&&(t[1]=0);break;case 7:this.freerun?t[1]=c(1,a,this.onLimitReached):(t[1]=c(1,0,this.onLimitReached),e&&(this.freerun=!0));break;case 256:t[1]=c(1,1,this.onLimitReached);break;case 257:t[1]=c(1,o.isInVBlank()?0:1,this.onLimitReached);break;case 259:t[1]=c(1,1,this.onLimitReached),e&&(t[1]=0);break;case 261:t[1]=c(1,o.isInVBlank()?0:1,this.onLimitReached),e&&(t[1]=0);break;case 263:this.freerun?t[1]=c(1,1,this.onLimitReached):(t[1]=c(1,0,this.onLimitReached),e&&(this.freerun=!0));break;default:return abort(`RC1: invalid mode: $${hex(s[1],4)}`)}}},r={getValue:function(e){switch(519&s[2]){case 0:case 3:case 5:case 8:return c(2,+(psx.clock-o.start));case 1:case 7:return c(2,0);case 512:return c(2,.125*+(psx.clock-o.start));default:return abort(`RC2: invalid mode: $${hex(s[2],4)}`)}},getTarget:function(e){return a[2]},getMode:function(){let e=s[2];return s[2]&=59391,e},setMode:function(e){switch(s[2]=1023&e|1024,519&s[2]){case 0:case 3:case 5:t[2]=-+(psx.clock-o.start),t[2]=c(2,0);break;case 1:case 7:t[2]=0;break;case 8:t[2]=-1*psx.eventCycles(o.event);break;case 512:t[2]=-.125*psx.eventCycles(o.event);break;default:return abort(`RC2: invalid mode: $${hex(s[2],4)}`)}},setTarget:function(e){e||(e=65535),a[2]=65535&e},setValue:function(e){if(e)return abort('not supported');t[2]=e},onLimitReached:function(){48&s[2]&&(cpu.istat|=64)},onScanLine:function(){switch(519&s[2]){case 0:case 3:case 5:t[2]=c(2,+(o.stop-o.start),this.onLimitReached);break;case 1:case 7:t[2]=c(2,0,this.onLimitReached);break;case 512:t[2]=c(2,.125*+(o.stop-o.start),this.onLimitReached);break;default:return abort(`RC2: invalid mode: $${hex(s[2],4)}`)}}},o={event:null,remainder:0,scanLine:0,vblank:!1,dispHStart:+Number.MAX_SAFE_INTEGER,dispHStop:+Number.MAX_SAFE_INTEGER,start:+Number.MAX_SAFE_INTEGER,stop:+Number.MAX_SAFE_INTEGER,upateToLastGpuState:function(e){const t=7*(gpu.status>>20&1?3406:3413)/11*(PSX_SPEED/33868800);this.start=+e.clock,this.stop=+t+this.start,this.dispHStart=this.start+7*+gpu.dispL/11,this.dispHStop=this.start+7*+gpu.dispR/11},complete:function(e,t){this.upateToLastGpuState(e);const s=gpu.status>>20&1?314:263;this.scanLine=(this.scanLine+1)%s,this.vblank=this.scanLine<gpu.dispT||this.scanLine>=gpu.dispB,n.onScanLine(),i.onScanLine(this.scanLine===gpu.dispB),r.onScanLine(),gpu.onScanLine(this.scanLine);let a=this.stop-this.start;psx.updateEvent(e,+a)},isInVBlank:function(){return this.vblank},whereInScanLine:function(){return psx.clock<this.dispHStart?-1:psx.clock<this.dispHStop?0:1}};return Object.seal(n),Object.seal(i),Object.seal(r),Object.seal(o),{rc0:n,rc1:i,rc2:r,dot:o}}));mdlr('enge:psx:serial',(e=>{const s=e.require('base64');var t={baud:136,data:0,r1044:0,r104a:0,command:0,devices:[{id:0,lo:255,hi:255,data:new Uint8Array(131072),addr:0,checkSum:0,mode:0,response:[],received:[],initMemCard:function(){this.mode=0,this.response=[],this.received=[]},initController:function(){this.mode=0,this.response=[],this.received=[]},buildMemCardResponse:function(e){switch(this.mode=e,e){case 82:this.response.push(0,90,93,0,-1,92,-1,-1,-1);for(let e=0;e<128;++e)this.response.push(-1);this.response.push(-1),this.response.push(71);break;case 87:this.response.push(0,90,93,-1,-1);for(let e=0;e<128;++e)this.response.push(-1);this.response.push(-1),this.response.push(92),this.response.push(93),this.response.push(71);break;default:this.response.push(255)}},buildControllerResponse:function(e){switch(this.mode=e,e){case 66:this.response.push(65,90,this.lo,this.hi);break;case 67:this.response.push(255);break;default:return abort(`unknown subCommand: $${hex(e,2)}`)}},sendReceiveByte:function(e){this.response.length<=0&&console.log(`#${this.id}: reading unexpected in mode $${hex(this.mode,2)}`);let t=this.response.shift()||0;if(82===this.mode&&-1===t){let e=this.received.length;switch(!0){case 4===e:t=this.received[3];break;case 6===e:t=93;break;case 7===e:t=this.received[3],this.checkSum=t;break;case 8===e:this.addr=this.received[3]<<8|this.received[4],t=this.received[4],this.checkSum^=t;break;case e>=9&&e<137:let s=128*this.addr+e-9;t=this.data[s],this.checkSum^=t;break;case 137===e:t=255&this.checkSum}}if(87===this.mode&&-1===t){let i=this.received.length;switch(!0){case 3===i:t=this.received[3],this.checkSum=t;break;case 4===i:t=this.received[3],this.checkSum^=t,this.addr=t<<8|e;break;case i>=5&&i<133:let h=128*this.addr+i-5;t=this.data[h-1],this.data[h]=e,this.checkSum^=e;break;case 133===i:t=this.data[132];const r=s.encode(this.data);localStorage.setItem('card1',r)}}return this.received.push(e),255&t},hasMore:function(){return this.response.length>0}},{id:1,lo:255,hi:255,data:new Uint8Array(131072),addr:0,checkSum:0,mode:0,response:[],received:[],initMemCard:function(){this.mode=0,this.response=[],this.received=[]},initController:function(){this.mode=0,this.response=[],this.received=[]},buildMemCardResponse:function(e){switch(this.mode=e,e){case 82:this.response.push(0,90,93,0,-1,92,-1,-1,-1);for(let e=0;e<128;++e)this.response.push(-1);this.response.push(-1),this.response.push(71);break;case 87:this.response.push(0,90,93,-1,-1);for(let e=0;e<128;++e)this.response.push(-1);this.response.push(-1),this.response.push(92),this.response.push(93),this.response.push(71);break;default:this.response.push(255)}},buildControllerResponse:function(e){switch(this.mode=e,e){case 66:this.response.push(65,90,this.lo,this.hi);break;case 67:this.response.push(255);break;default:return abort(`unknown subCommand: $${hex(e,2)}`)}},sendReceiveByte:function(e){this.response.length<=0&&console.log(`#${this.id}: reading unexpected in mode $${hex(this.mode,2)}`);let t=this.response.shift()||0;if(82===this.mode&&-1===t){let e=this.received.length;switch(!0){case 4===e:t=this.received[3];break;case 6===e:t=93;break;case 7===e:t=this.received[3],this.checkSum=t;break;case 8===e:this.addr=this.received[3]<<8|this.received[4],t=this.received[4],this.checkSum^=t;break;case e>=9&&e<137:let s=128*this.addr+e-9;t=this.data[s],this.checkSum^=t;break;case 137===e:t=255&this.checkSum}}if(87===this.mode&&-1===t){let i=this.received.length;switch(!0){case 3===i:t=this.received[3],this.checkSum=t;break;case 4===i:t=this.received[3],this.checkSum^=t,this.addr=t<<8|e;break;case i>=5&&i<133:let h=128*this.addr+i-5;t=this.data[h-1],this.data[h]=e,this.checkSum^=e;break;case 133===i:t=this.data[132];const r=s.encode(this.data);localStorage.setItem('card2',r)}}return this.received.push(e),255&t},hasMore:function(){return this.response.length>0}}],rd08r1040:function(){return 2&this.r1044&&(this.r1044&=-3),this.data},rd16r1044:function(){return this.r1044},rd16r104a:function(){return this.r104a},rd16r104e:function(){return this.baud},wr08r1040:function(e){let s=null;switch(0==(2&this.r104a)&&abort('should not receive byte for device null'),2==(2&this.r104a)&&(s=8192&this.r104a?this.devices[1]:this.devices[0]),this.command){case 0:if(!s)return this.setResult(255,!0);this.setResult(255,!1),this.command=255&e,129===this.command&&s.initMemCard(),1===this.command&&s.initController();break;case 1:s.buildControllerResponse(255&e),this.command=2;case 2:{let t=s.sendReceiveByte(255&e),i=s.hasMore();this.setResult(t,!i)}break;case 129:s.buildMemCardResponse(255&e),this.command=130;case 130:{let t=s.sendReceiveByte(255&e),i=s.hasMore();this.setResult(t,!i)}break;case 131:return this.setResult(255,!0);default:console.warn('unknown command state:',hex(this.command,4),' device:',s.id)}},wr16r1048:function(e){13!==e&&abort(`invalid JOY_MODE: $${hex(e,4)}`)},wr16r104a:function(e){if(this.r104a=-81&e,64&e||!(2&this.r104a)){let e=null;2==(2&this.r104a)&&(e.initController(),e.initMemCard()),psx.unsetEvent(this.eventIRQ),this.command=0,this.r1044=5}16&e&&(this.r1044&=-513)},wr16r104e:function(e){136!==e&&abort(`invalid JOY_BAUD: $${hex(e,4)}`),this.baud=65535&e},setResult:function(e,s){this.r1044|=2,this.data=255&e,s||psx.setEvent(this.eventIRQ,8*this.baud>>>0)},eventIRQ:null,completeIRQ:function(e,s){this.r1044|=512,cpu.istat|=128,psx.unsetEvent(e)}};return Object.seal(t),{joy:t}}));mdlr('enge:psx:spu',(e=>{const t=22050;var s=114688;let a=null,i=null;var r={totalSamples:0,voices:[],index:0,writeIndex:5512,data:new Uint8Array(524288),ENDX:16777215,SPUCNT:0,SPUSTAT:0,SPUSTATm:0,mainVolumeLeft:0,mainVolumeRight:0,reverbVolumeLeft:0,reverbVolumeRight:0,cdVolumeLeft:0,cdVolumeRight:0,extVolumeLeft:0,extVolumeRight:0,irqOffset:0,ramOffset:0,reverbOffset:0,silence:function(){if(a&&i)for(var e=0;e<t;++e)a[e]=i[e]=0},getVolume:function(e){return(e<<17>>16)/32768},getInt16:function(e){switch(e){case 7594:return this.SPUCNT;case 7598:return-64&this.SPUSTAT|63&this.SPUCNT;case 7580:return this.ENDX;default:if(e>=7168&&e<7552){const t=e-7168>>4;return this.voices[t].getRegister(e)}return map16[(25165824+e&33554431)>>>1]}},setInt16:function(e,s){switch(s&=65535,e){case 7552:this.mainVolumeLeft=this.getVolume(s);break;case 7554:this.mainVolumeRight=this.getVolume(s);break;case 7556:this.reverbVolumeLeft=this.getVolume(s);break;case 7558:this.reverbVolumeRight=this.getVolume(s);break;case 7560:for(var r=0;r<16;++r)0!=(s&1<<r)&&(this.voices[r].keyOn(),this.ENDX&=~(1<<r));break;case 7562:for(r=0;r<8;++r)0!=(s&1<<r)&&(this.voices[16+r].keyOn(),this.ENDX&=~(1<<16+r));break;case 7564:for(r=0;r<16;++r)0!=(s&1<<r)&&this.voices[r].keyOff();break;case 7566:for(r=0;r<8;++r)0!=(s&1<<r)&&this.voices[16+r].keyOff();break;case 7568:for(r=0;r<16;++r)0!=(s&1<<r)&&this.voices[r].modOn();break;case 7570:for(r=0;r<8;++r)0!=(s&1<<r)&&this.voices[16+r].modOn();break;case 7572:for(r=0;r<16;++r)0!=(s&1<<r)&&this.voices[r].noiseOn();break;case 7574:for(r=0;r<8;++r)0!=(s&1<<r)&&this.voices[16+r].noiseOn();break;case 7576:for(r=0;r<16;++r)0!=(s&1<<r)&&this.voices[r].echoOn();break;case 7578:for(r=0;r<8;++r)0!=(s&1<<r)&&this.voices[16+r].echoOn();break;case 7580:case 7582:case 7584:case 7596:case 7598:case 7608:case 7610:case 7612:case 7614:break;case 7586:this.reverbOffset=s<<3;break;case 7588:this.irqOffset=s<<3;break;case 7590:this.ramOffset=s<<3;break;case 7592:this.data[this.ramOffset+0]=s>>0&255,this.data[this.ramOffset+1]=s>>8&255,this.ramOffset+=2,this.checkIrq();break;case 7594:this.SPUCNT=s,a&&i||!(32768&this.SPUCNT)||function(){const e=new AudioContext,s=e.createBuffer(2,t,e.sampleRate),r=e.createBufferSource();a=s.getChannelData(0),a.fill(0),i=s.getChannelData(1),i.fill(0),r.playbackRate.value=44100/e.sampleRate,r.buffer=s,r.loop=!0,r.connect(e.destination),r.start()}(),64&this.SPUCNT&&(this.SPUSTAT&=-65),this.SPUSTATm=63&this.SPUCNT;break;case 7600:this.cdVolumeLeft=s/32768;break;case 7602:this.cdVolumeRight=s/32768;break;case 7604:this.extVolumeLeft=s/32768;break;case 7606:this.extVolumeRight=s/32768;break;default:if(e>=7168&&e<7552){var h=(e-7168)/16|0;this.voices[h].setRegister(e,s);break}if(e>=7616&&e<7680){this.setReverbRegister(e,s);break}abort("Unimplemented spu register:"+hex(e,4))}},dmaTransferMode0200:function(e,t){if(!(8388607&e))return 16;var s=(t>>16)*(65535&t)*4>>>0;for(clearCodeCache(e,s);s>0;){var a=0;a|=this.data[this.ramOffset+0]>>>0<<0,a|=this.data[this.ramOffset+1]>>>0<<8,map16[(2097151&e)>>>1]=a,this.ramOffset+=2,s-=2,e+=2}return(t>>16)*(65535&t)},dmaTransferMode0201:function(e,t){if(!(8388607&e))return 16;for(var s=(t>>16)*(65535&t)*4>>>0;s>0;){const t=map16[(2097151&e)>>>1];this.data[this.ramOffset+0]=t>>0&255,this.data[this.ramOffset+1]=t>>8&255,this.checkIrq(),this.ramOffset+=2,s-=2,e+=2}return(t>>16)*(65535&t)},setReverbRegister:function(e,t){},checkIrq:function(e){if(32832!=(32832&this.SPUCNT))return;const t=this.totalSamples%512<<1;var s=!1;void 0!==e?e.blockAddress<=this.irqOffset&&this.irqOffset<e.blockAddress+16&&(s=!0):(this.ramOffset===this.irqOffset&&(s=!0),t===this.irqOffset&&(s=!0)),s&&(cpu.istat|=512,this.SPUSTAT|=64)},event:function(e,r){if(psx.updateEvent(e,PSX_SPEED/44100*8),a&&i){this.SPUSTAT&=-64,this.SPUSTAT|=63&this.SPUSTATm;for(let e=8;e>0;--e){++this.totalSamples;let e=0,r=0;const c=this.totalSamples%512<<1;this.checkIrq();for(let t=0;t<24;++t){let a=this.voices[t];if(!a.adsrState)continue;a.pitchCounter+=a.pitchStep,a.pitchCounter>=s&&(a.pitchCounter-=s,a.decodeBlock(),this.checkIrq(a));const i=a.pitchCounter>>>12,h=a.buffer[i],d=a.mixADSR(),o=h*d*a.volumeLeft,n=h*d*a.volumeRight;if(3===t){const e=32768*o>>>0;this.data[3072+c]=255&e,this.data[3073+c]=e>>8}if(1===t){const e=32768*o>>>0;this.data[2048+c]=255&e,this.data[2049+c]=e>>8}e+=o,r+=n}var h=[0,0];cdr.nextpcm(h);let d=h[0]*this.cdVolumeLeft,o=h[1]*this.cdVolumeRight;{const e=32768*d>>>0;this.data[0+c]=255&e,this.data[1+c]=e>>8}{const e=32768*o>>>0;this.data[1024+c]=255&e,this.data[1025+c]=e>>8}e+=d,r+=o,e*=this.mainVolumeLeft,r*=this.mainVolumeRight,a[this.writeIndex]=Math.max(Math.min(e,1),-1),i[this.writeIndex]=Math.max(Math.min(r,1),-1),this.writeIndex=(this.writeIndex+1)%t,0===c&&(this.SPUSTAT&=-2049),512===c&&(this.SPUSTAT|=2048)}}}};function h(e){this.id=e,this.pitchCounter=0,this.repeatAddress=0,this.blockAddress=0,this.s0=0,this.s1=0,this.buffer=new Float32Array(28),this.volumeLeft=0,this.volumeRight=0,this.pitchStep=0,this.adsrLevel=0,this.adsrState=0,this.r1Cx0=0,this.r1Cx2=0,this.r1Cx4=0,this.r1Cx6=0,this.r1Cx8=0,this.r1CxA=0,this.r1CxE=0}h.prototype.startAdsrAttack=function(){this.adsrState=1,this.adsrLevel=0},h.prototype.startAdsrRelease=function(){this.adsrState=4},h.prototype.keyOn=function(){this.s0=0,this.s1=0,this.pitchCounter=s,this.blockAddress=this.r1Cx6<<3,this.repeatAddress=this.r1CxE<<3,this.startAdsrAttack()},h.prototype.echoOn=function(){},h.prototype.modOn=function(){},h.prototype.noiseOn=function(){},h.prototype.keyOff=function(){this.startAdsrRelease()},h.prototype.decodeBlock=function(){var e=this.blockAddress;let t=r.data[e+0],s=r.data[e+1];var a=(15&t)>>>0,i=(240&t)>>>3,h=d[i+0],c=d[i+1],n=this.s0,l=this.s1,f=0,u=this.buffer;let v;for(var k=2;k<16;++k){var m=(a<<8)+r.data[e+k]<<1;u[f++]=v=n*h+l*c+o[m+0],l=n,n=v,u[f++]=v=n*h+l*c+o[m+1],l=n,n=v}this.s0=n,this.s1=l,4==(4&s)&&(this.repeatAddress=this.blockAddress),this.blockAddress+=16,1==(1&s)&&(this.blockAddress=this.repeatAddress,r.ENDX|=1<<this.id,0==(2&s)&&(this.startAdsrRelease(),this.adsrLevel=0))},h.prototype.mixADSR=function(){switch(this.adsrState){case 0:return 0;case 1:this.adsrAttack();break;case 2:this.adsrDecay();break;case 3:this.adsrSustain();break;case 4:this.adsrRelease();break;default:abort('not implemented')}return this.adsrLevel>2147483647&&(this.adsrLevel=2147483647),this.adsrLevel<0&&(4===this.adsrState&&1!==this.id&&3!==this.id&&(this.adsrState=0),this.adsrLevel=0),(this.adsrLevel>>16)/32768},h.prototype.adsrAttack=function(){this.adsrAttackMode?this.adsrLevel<1610612736?this.adsrLevel+=l[this.adsrAttackRate-16+32]:this.adsrLevel+=l[this.adsrAttackRate-24+32]:this.adsrLevel+=l[this.adsrAttackRate-16+32],this.adsrLevel>=2147483647&&(this.adsrState=2)},h.prototype.adsrDecay=function(){if(this.adsrDecayMode)switch(this.adsrLevel>>29&7){case 0:this.adsrLevel-=l[this.adsrDecayRate-24+0+32];break;case 1:this.adsrLevel-=l[this.adsrDecayRate-24+4+32];break;case 2:this.adsrLevel-=l[this.adsrDecayRate-24+6+32];break;case 3:this.adsrLevel-=l[this.adsrDecayRate-24+8+32];break;case 4:this.adsrLevel-=l[this.adsrDecayRate-24+9+32];break;case 5:this.adsrLevel-=l[this.adsrDecayRate-24+10+32];break;case 6:this.adsrLevel-=l[this.adsrDecayRate-24+11+32];break;case 7:this.adsrLevel-=l[this.adsrDecayRate-24+12+32]}(this.adsrLevel>>28&15)<=this.adsrSustainLevel&&(this.adsrState=3)},h.prototype.adsrSustain=function(){if(this.adsrSustainMode)if(0==this.adsrSustainDirection)this.adsrLevel<1610612736?this.adsrLevel+=l[this.adsrSustainRate-16+32]:this.adsrLevel+=l[this.adsrSustainRate-24+32];else switch(this.adsrLevel>>29&7){case 0:this.adsrLevel-=l[this.adsrSustainRate-27+0+32];break;case 1:this.adsrLevel-=l[this.adsrSustainRate-27+4+32];break;case 2:this.adsrLevel-=l[this.adsrSustainRate-27+6+32];break;case 3:this.adsrLevel-=l[this.adsrSustainRate-27+8+32];break;case 4:this.adsrLevel-=l[this.adsrSustainRate-27+9+32];break;case 5:this.adsrLevel-=l[this.adsrSustainRate-27+10+32];break;case 6:this.adsrLevel-=l[this.adsrSustainRate-27+11+32];break;case 7:this.adsrLevel-=l[this.adsrSustainRate-27+12+32]}else this.adsrLevel+=this.adsrLinearSustainRate},h.prototype.adsrRelease=function(){if(this.adsrReleaseMode)switch(this.adsrLevel>>29&7){case 0:this.adsrLevel-=l[this.adsrReleaseRate-24+0+32];break;case 1:this.adsrLevel-=l[this.adsrReleaseRate-24+4+32];break;case 2:this.adsrLevel-=l[this.adsrReleaseRate-24+6+32];break;case 3:this.adsrLevel-=l[this.adsrReleaseRate-24+8+32];break;case 4:this.adsrLevel-=l[this.adsrReleaseRate-24+9+32];break;case 5:this.adsrLevel-=l[this.adsrReleaseRate-24+10+32];break;case 6:this.adsrLevel-=l[this.adsrReleaseRate-24+11+32];break;case 7:this.adsrLevel-=l[this.adsrReleaseRate-24+12+32]}else this.adsrLevel-=this.adsrLinearReleaseRate},h.prototype.getRegister=function(e,t){switch(e%16){case 0:return this.r1Cx0;case 2:return this.r1Cx2;case 4:return this.r1Cx4;case 6:return this.r1Cx6;case 8:return this.r1Cx8;case 10:return this.r1CxA;case 12:return this.adsrLevel>>>16;case 14:return this.r1CxE;default:abort(`Unimplemented spu-voice register: ${(e%16>>>0).toString(16)}`)}},h.prototype.setRegister=function(e,t){switch(e%16){case 0:this.volumeLeft=r.getVolume(t),this.r1Cx0=t;break;case 2:this.volumeRight=r.getVolume(t),this.r1Cx2=t;break;case 4:this.pitchStep=Math.min(t,16384),this.r1Cx4=t;break;case 6:this.blockAddress=t<<3,this.r1Cx6=t;break;case 8:this.adsrAttackMode=(32768&t)>>>15,this.adsrAttackRate=(32512&t)>>>8^127,this.adsrDecayMode=1,this.adsrDecayRate=((240&t)>>>4^31)<<2,this.adsrSustainLevel=(15&t)>>>0,this.r1Cx8=t;break;case 10:this.adsrSustainMode=(32768&t)>>>15,this.adsrSustainDirection=(16384&t)>>>14,this.adsrSustainRate=(8128&t)>>>6^127,this.adsrReleaseMode=(32&t)>>>5,this.adsrReleaseRate=((31&t)>>>0^31)<<2,this.r1CxA=t,this.adsrLinearReleaseRate=l[this.adsrReleaseRate-12+32],0==this.adsrSustainDirection?this.adsrLinearSustainRate=l[this.adsrSustainRate-16+32]:this.adsrLinearSustainRate=-l[this.adsrSustainRate-15+32];break;case 12:this.adsrLevel=t<<16;break;case 14:this.repeatAddress=t<<3,this.r1CxE=t;break;default:abort("Unimplemented spu-voice register",hex(e,4))}};for(var c=0;c<24;++c)r.voices[c]=new h(c);const d=new Float32Array(32);d.fill(0),d[2]=60/64,d[3]=0,d[4]=115/64,d[5]=-52/64,d[6]=98/64,d[7]=-55/64,d[8]=122/64,d[9]=-60/64;const o=new Float32Array(8192);for(let e=0;e<16;++e)for(let t=0;t<256;++t){const s=(e<<8)+t<<1;var n;32768&(n=(240&t)<<8)&&(n|=4294901760),o[s+1]=(n>>e)/32768,32768&(n=(15&t)<<12)&&(n|=4294901760),o[s+0]=(n>>e)/32768}const l=new Uint32Array(160);return function(){let e,t,s;l.fill(0),e=3,t=1,s=0;for(let a=32;a<160;++a)e<2147483647&&(e+=t,s++,5===s&&(s=1,t*=2)),e>2147483647&&(e=2147483647),l[a]=e}(),{spu:r,xa2flt:d,xa2pcm:o}}));mdlr('enge:psx:trace',(e=>{const c=/[A-Za-z]{4}_[0-9]{3}\.[0-9]{2}/;let t='',n=null,r='';function o(e){t+=String.fromCharCode(e),10!==e&&13!==e||(t!==n&&(function(){const e=c.exec(t);if(e){let c=e[0].replace('.','').toUpperCase();r!==c&&(document.title=`eNGE - [${c}]`,r=c)}}(),n=t),console.debug(t),t='')}return{trace:function(e,c){switch(e){case 160:60===c&&o(cpu.gpr[4]);break;case 176:61===c&&o(cpu.gpr[4])}}}}));mdlr('enge:psx:webgl',(e=>{e.require('enge:psx'),e.require('enge:webgl')}));mdlr('enge:utils',(t=>{const e=t.require('base64'),o=(()=>{const t=JSON.parse(localStorage.getItem('config')||'{}');return Object.assign({quality:1,overscan:0},t)})();return o.updateQuality=t=>{const e=document.getElementById('quality');e&&(t&&(o.quality<<=1,o.quality>4&&(o.quality=1),localStorage.setItem('config',JSON.stringify(o)),e.classList.add('restart')),e.innerText=`Q${o.quality}`)},window.addEventListener('storage',(()=>{const t=JSON.parse(localStorage.getItem('config')||'{}');Object.assign(o,t)})),{log:function(){console.log.call(console,('000000000000'+psx.clock).substr(-12)+']',Array.prototype.slice.call(arguments).join(''))},hex:function(t,e){return("00000000"+(t>>>0).toString(16)).substr(-(e||8))},readStorageStream:function(t,o){const n=localStorage.getItem(t);return o(n?e.decode(n):null)},writeStorageStream:function(t,o){const n=e.encode(o);localStorage.setItem(t,n)},settings:o}}));mdlr('enge:webgl',(e=>{var t=settings.quality||1,r=settings.quality||1,a=1024*t,i=512*r;const o={flushes:0,dump:()=>{o.flushes=0}};Uint32Array.prototype.addVertexDisp=function(e,t,r,a){var i=t<<16|65535&e,o=a<<16|65535&r,s=this.index>>>2;this[s+0]=i,this[s+1]=o,this.index+=8},Uint32Array.prototype.addVertex=function(e,t,r){var a=(t*=16)<<16|65535&(e*=16),i=this.index>>>2;this[i+0]=16777215&r|50331648,this[i+1]=a,this.index+=24},Uint32Array.prototype.addVertexUV=function(e,t,r,a,i,o,s,n){var h=(t*=16)<<16|65535&(e*=16),x=o<<16|65535&i,u=n<<16|65535&s,f=gpu.ty<<16|65535&gpu.tx,d=this.index>>>2;this[d+0]=16777215&r|a<<24,this[d+1]=h,this[d+2]=x,this[d+3]=u,this[d+4]=f,this[d+5]=gpu.twin,this.index+=24},Uint32Array.prototype.getNumberOfVertices=function(){return this.index/24},Uint32Array.prototype.canHold=function(e){return this.index+24*e*2<4*this.length},Uint32Array.prototype.reset=function(){this.index=0},Uint32Array.prototype.view=function(){return new Uint32Array(this.buffer,0,this.index>>2)};const s="precision highp float;attribute vec2 aVertexPosition;attribute vec2 aVertexTexture;varying vec2 vTextureCoord;varying vec2 tx;void main(void) {  gl_Position = vec4(aVertexPosition, 0.0, 1.0);  tx.xy = aVertexTexture;  vTextureCoord.x = aVertexTexture.x / 1024.0;  vTextureCoord.y = aVertexTexture.y / 512.0;}",n="precision highp float;uniform sampler2D uVRAM;varying vec2 tx;vec4 getColor(float tx, float ty) {  if (ty >= 511.0) ty = 511.0;  if (tx >= 1023.0) tx = 1023.0;  return texture2D(uVRAM, vec2((tx + 0.0) / 1024.0, (ty + 0.0) / 512.0));}void main(void) {  gl_FragColor = vec4(getColor(tx.x, tx.y).rgb, 1.0);}",h="precision highp float;uniform sampler2D uVRAM;varying vec2 vTextureCoord;void main(void) {  vec4 pixel = texture2D(uVRAM, vTextureCoord);  gl_FragColor = vec4(pixel.aaa, 1.0);}",x="precision highp float;uniform sampler2D uVRAM;uniform vec3 ts;varying vec2 tx;varying vec2 vTextureCoord;vec4 getColor(float tx, float ty) {  if (ty >= 512.0) ty = 512.0;  if (tx >= 2048.0) tx = 2048.0;  float r = texture2D(uVRAM, vec2((tx + 0.0) / 2048.0, ty / 512.0)).a;  float g = texture2D(uVRAM, vec2((tx + 1.0) / 2048.0, ty / 512.0)).a;  float b = texture2D(uVRAM, vec2((tx + 2.0) / 2048.0, ty / 512.0)).a;  return vec4(r, g, b, 1.0);}void main(void) {  float td = (tx.x - ts.x);  float x = 3.0 * floor(td) + 2.0 * ts.x;  gl_FragColor = getColor(x , floor(tx.y));}",u="precision highp float;attribute vec2 aVertexPosition;attribute vec2 aVertexTexture;attribute vec4 aVertexColor;attribute vec4 aTextureWindow;attribute vec2 aTexturePage;attribute vec2 aTextureClut;uniform float uBlendAlpha;varying float vTextureMode;varying float vSTP;varying vec4 vColor;varying vec2 vClut;varying float tmx;varying float tmy;varying float tox;varying float toy;varying float tcx;varying float tcy;varying float twin;void main(void) {  gl_Position = vec4(aVertexPosition, 0.0, 1.0);   gl_Position.x -= 8192.0; gl_Position.y -= 4096.0;  gl_Position.x /= 8192.0; gl_Position.y /= 4096.0;  vClut = aTextureClut;  vClut.x /= 1024.0;  vClut.y /= 512.0;  twin = aTextureWindow.x + aTextureWindow.y;  tmx = 256.0 - aTextureWindow.x;  tmy = 256.0 - aTextureWindow.y;  tox = aTexturePage.x + aTextureWindow.z;  toy = aTexturePage.y + aTextureWindow.a;  tcx = aVertexTexture.x;  tcy = aVertexTexture.y;  vTextureMode = mod(aVertexColor.a, 8.0);  if (vTextureMode == 7.0) {    tcx = aVertexPosition.x / 8192.0 / 2.0;    tcy = aVertexPosition.y / 4096.0 / 2.0;  }  else {    vSTP = floor(aVertexColor.a / 8.0);  }  vColor = vec4(aVertexColor.rgb / 256.0, uBlendAlpha);}",f="precision highp float;uniform sampler2D uTex8;uniform float uBlendAlpha;varying float vTextureMode;varying float vSTP;varying vec4 vColor;varying vec2 vClut;varying float tmx;varying float tmy;varying float tox;varying float toy;varying float tcx;varying float tcy;varying float twin;float getSRGB16(float cx, float cy) {  float tx = floor(cx * 1024.0) * 2.0;  float ty = floor(cy * 512.0);  float lo = floor(texture2D(uTex8, vec2(tx + 0.0, ty) / vec2(2048.0, 512.0)).a * 255.0);  float hi = floor(texture2D(uTex8, vec2(tx + 1.0, ty) / vec2(2048.0, 512.0)).a * 255.0);  return hi * 256.0 + lo;}vec4 getColor(float cx, float cy) {  float srgb = getSRGB16(cx, cy);  float r = mod(floor(srgb /     1.0), 32.0) / 32.0;  float g = mod(floor(srgb /    32.0), 32.0) / 32.0;  float b = mod(floor(srgb /  1024.0), 32.0) / 32.0;  float a = srgb >= 32768.0 ? 1.0 : 0.0;  return vec4(r, g, b, a);}vec4 getClutColor() {  float cx, cy, val, tx, ty;  vec4 rgba;  if (twin != 0.0) {    tx = tox + mod(floor(tcx), tmx);    ty = toy + mod(floor(tcy), tmy);  }  else {    tx = tox + floor(tcx);    ty = toy + floor(tcy);  }  if (vTextureMode == 1.0) {    val = texture2D(uTex8, vec2(tx / 2048.0, ty / 512.0)).a * 255.0;    cx = vClut.x + (val / 1024.0); cy = vClut.y;    rgba = getColor(cx, cy);  }  else  if (vTextureMode == 0.0) {    val = texture2D(uTex8, vec2(tx / 4096.0, ty / 512.0)).a * 255.0;    if (mod((tx), 2.0) == 0.0) { val = mod(val, 16.0); } else { val = mod(floor(val / 16.0), 16.0); }    cx = vClut.x + (val / 1024.0); cy = vClut.y;    rgba = getColor(cx, cy);  }  else  if (vTextureMode == 2.0) {    cx = (tox + tcx) / 1024.0; cy = (toy + tcy) / 512.0;    rgba = texture2D(uTex8, vec2(cx, cy));  }  if (rgba.a == 0.0) {    if (vSTP == 3.0) return vec4(0.0,0.0,0.0,0.0);  }  else {    if (vSTP == 2.0) return vec4(0.0,0.0,0.0,0.0);  }  return rgba;}void main(void) {  float fx = tcx - floor(tcx);  float fy = tcy - floor(tcy);  if (vTextureMode == 7.0) {    gl_FragColor = getColor(tcx, tcy);    return;  }  if (vTextureMode == 3.0) {    gl_FragColor = vec4(vColor.rgb, uBlendAlpha);    return;  }  vec4 c = getClutColor();  if (c == vec4(0.0, 0.0, 0.0, 0.0)) discard;  gl_FragColor = vec4(2.0 * (vColor.rgb * c.rgb), uBlendAlpha);}";function d(e){this.gl=null,this.programDisplay=null,this.vertexBuffer=new Uint32Array(4608),this.drawOffsetX=0,this.drawOffsetY=0,this.displaymode=2,this.vram=new Uint16Array(524288),this.vertexClip=!1,this.drawAreaChange=!1,this.seenRender=!1,this.fpsRenderCounter=0,this.fpsCounter=0;try{this.gl=e.getContext("webgl",{alpha:!1,antialias:!1,preserveDrawingBuffer:!1,premultipliedAlpha:!1,depth:!1,stencil:!1,powerPreference:'high-performance'})}catch(e){return void alert("Error: Unable to get WebGL context")}if(this.gl){this.initShaders(),this.initTextures(),this.setupBuffers();var t=this.gl;this.setupWebGL(e),t.useProgram(this.programDraw),t.bindFramebuffer(this.gl.FRAMEBUFFER,this.buf16draw),t.activeTexture(this.gl.TEXTURE1),t.bindTexture(this.gl.TEXTURE_2D,this.tex8vram),this.vertexBuffer.reset(),this.setupProgramDraw()}else alert("Error: Your browser does not appear to support WebGL.")}d.prototype.getClutInfo=function(e,t){if(2===t)return 3;if(1===t)var r=256;0===t&&(r=16);for(var a=0,i=1024*(e>>>6&511)+16*(e>>>0&63),o=this.vram;--r>=0;){var s=o[i++];0!==s&&(a|=s<=32767?1:2)}return a},d.prototype.outsideDrawArea=function(e,t,r,a,i,o){return e<this.drawAreaL&&r<this.drawAreaL&&i<this.drawAreaL||e>this.drawAreaR&&r>this.drawAreaR&&i>this.drawAreaR||t<this.drawAreaT&&a<this.drawAreaT&&o<this.drawAreaT||t>this.drawAreaB&&a>this.drawAreaB&&o>this.drawAreaB},d.prototype.largePrimitive=function(e,t,r,a,i,o){return Math.abs(e-r)>1023||Math.abs(r-i)>1023||Math.abs(i-e)>1023||Math.abs(t-a)>511||Math.abs(a-o)>511||Math.abs(o-t)>511},d.prototype.setupWebGL=function(e){var t=this.gl;t.viewport(0,0,e.width,e.height),t.disable(t.STENCIL_TEST),t.disable(t.DEPTH_TEST),t.disable(t.BLEND),t.disable(t.CULL_FACE),t.disable(t.DITHER),t.disable(t.POLYGON_OFFSET_FILL),t.disable(t.SAMPLE_COVERAGE),t.disable(t.SCISSOR_TEST),t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT),t.clear(t.DEPTH_BUFFER_BIT),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.PACK_ALIGNMENT,1),this.canvas=e},d.prototype.initShaders=function(){try{var e=this.gl;this.programDraw=e.createProgram(),e.attachShader(this.programDraw,this.makeShader(u,e.VERTEX_SHADER)),e.attachShader(this.programDraw,this.makeShader(f,e.FRAGMENT_SHADER)),e.linkProgram(this.programDraw),e.getProgramParameter(this.programDraw,e.LINK_STATUS)||console.log("Unable to initialize the shader program."),e.useProgram(this.programDraw),this.programDraw.uTex8=e.getUniformLocation(this.programDraw,"uTex8"),e.uniform1i(this.programDraw.uTex8,1),this.programDisplay=e.createProgram(),e.attachShader(this.programDisplay,this.makeShader(s,e.VERTEX_SHADER)),e.attachShader(this.programDisplay,this.makeShader(n,e.FRAGMENT_SHADER)),e.linkProgram(this.programDisplay),e.getProgramParameter(this.programDisplay,e.LINK_STATUS)||console.log("Unable to initialize the shader program."),e.useProgram(this.programDisplay),this.programDisplay.vram=e.getUniformLocation(this.programDisplay,"uVRAM"),this.programDisplay.ts=e.getUniformLocation(this.programDisplay,"ts"),e.uniform1i(this.programDisplay.vram,0),this.program24bit=e.createProgram(),e.attachShader(this.program24bit,this.makeShader(s,e.VERTEX_SHADER)),e.attachShader(this.program24bit,this.makeShader(x,e.FRAGMENT_SHADER)),e.linkProgram(this.program24bit),e.getProgramParameter(this.program24bit,e.LINK_STATUS)||console.log("Unable to initialize the shader program."),e.useProgram(this.program24bit),this.program24bit.vram=e.getUniformLocation(this.program24bit,"uVRAM"),this.program24bit.ts=e.getUniformLocation(this.program24bit,"ts"),e.uniform1i(this.program24bit.vram,1),this.programTexture=e.createProgram(),e.attachShader(this.programTexture,this.makeShader(s,e.VERTEX_SHADER)),e.attachShader(this.programTexture,this.makeShader(h,e.FRAGMENT_SHADER)),e.linkProgram(this.programTexture),e.getProgramParameter(this.programTexture,e.LINK_STATUS)||console.log("Unable to initialize the shader program."),e.useProgram(this.programTexture),this.programTexture.vram=e.getUniformLocation(this.programTexture,"uVRAM"),e.uniform1i(this.programTexture.vram,0)}catch(e){console.log("Failed to init shaders:\n\n"+e.stack)}},d.prototype.initTextures=function(){var e=this.gl;this.tex8vram=this.createTexture(),e.texImage2D(e.TEXTURE_2D,0,e.ALPHA,2048,512,0,e.ALPHA,e.UNSIGNED_BYTE,null),this.buf8vram=this.createBuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this.buf8vram),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.tex8vram,0),e.bindFramebuffer(e.FRAMEBUFFER,null),this.tex16draw=this.createTexture(),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,a,i,0,e.RGBA,e.UNSIGNED_BYTE,null),this.buf16draw=this.createBuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this.buf16draw),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.tex16draw,0),e.bindFramebuffer(e.FRAMEBUFFER,null),this.vramP2=this.createTexture(),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,a,i,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindFramebuffer(e.FRAMEBUFFER,null)},d.prototype.loadImage=function(e,t,r,a,i){let o=0;for(let s=0;s<a;++s){const a=(t+s)%512*1024;for(let t=0;t<r;++t)i[o++]=this.vram[a+(e+t)%1024]}},d.prototype.moveImage=function(e,t,r,a,i,o){this.gl;var s=0,n=gpu.img;n.x=r,n.y=a,n.w=i,n.h=o,n.pixelCount=i*o;for(var h=n.buffer,x=this.vram,u=o;u>0;--u)for(var f=e,d=t++%512*1024,l=i;l>0;--l)h[s++]=x[d+f++%1024];this.storeImage(n)},d.prototype.storeImage=function(e){this.seenRender=!0,this.gl;for(var t=0,r=e.buffer,a=this.vram,i=0;i<e.h;++i){const n=(e.y+i)%512*1024;for(var o=e.x,s=e.w;s>0;--s)a[n+o++%1024]=r[t++]}this.storeImageInTexture(e)},d.prototype.storeImageInTexture=function(e){const t=this.gl;if(this.flushVertexBuffer(!0),e.x+e.w>1024){let t=1024-e.x,r=e.w-t,a=new Uint16Array(t*e.h),i=new Uint16Array(r*e.h),o=0,s=0;for(let n=0;n<e.h;++n){const h=n*e.w;for(let r=0;r<t;++r)a[o++]=e.buffer[h+r];for(let a=0;a<r;++a)i[s++]=e.buffer[h+a+t]}return this.storeImageInTexture({x:e.x,y:e.y,w:t,h:e.h,buffer:a,pixelCount:o}),void this.storeImageInTexture({x:0,y:e.y,w:r,h:e.h,buffer:i,pixelCount:s})}if(e.y+e.h>512){let t=512-e.y,r=e.h-t;return this.storeImageInTexture({x:e.x,y:e.y,w:e.w,h:t,buffer:new Uint16Array(e.buffer.buffer,0,t*e.w),pixelCount:t*e.w}),void this.storeImageInTexture({x:e.x,y:0,w:e.w,h:r,buffer:new Uint16Array(e.buffer.buffer,t*e.w),pixelCount:r*e.w})}const r=new Uint8Array(e.buffer.buffer,0,e.pixelCount<<1);t.bindTexture(t.TEXTURE_2D,this.tex8vram),t.texSubImage2D(t.TEXTURE_2D,0,e.x<<1,e.y,e.w<<1,e.h,t.ALPHA,t.UNSIGNED_BYTE,r);var a=e.x,i=e.x+e.w,o=e.y,s=e.y+e.h,n=this.getVertexBuffer(6,0);n.addVertexUV(a,o,0,7,0,0,0,0),n.addVertexUV(i,o,0,7,0,0,0,0),n.addVertexUV(a,s,0,7,0,0,0,0),n.addVertexUV(i,o,0,7,0,0,0,0),n.addVertexUV(a,s,0,7,0,0,0,0),n.addVertexUV(i,s,0,7,0,0,0,0),this.flushVertexBuffer(!1)},d.prototype.makeShader=function(e,t){var r=this.gl;if(e===s||e===n||e===h||e===x||e===u||e===f){var a=r.createShader(t);return r.shaderSource(a,e),r.compileShader(a),r.getShaderParameter(a,r.COMPILE_STATUS)||(alert("Error compiling shader: "+r.getShaderInfoLog(a)),r.deleteShader(a)),a}},d.prototype.setupBuffers=function(){var e=this.gl;this.programDraw.blendAlpha=e.getUniformLocation(this.programDraw,"uBlendAlpha"),this.programDraw.vertexPosition=e.getAttribLocation(this.programDraw,"aVertexPosition"),e.enableVertexAttribArray(this.programDraw.vertexPosition),this.programDraw.vertexTexture=e.getAttribLocation(this.programDraw,"aVertexTexture"),e.enableVertexAttribArray(this.programDraw.vertexTexture),this.programDraw.textureWindow=e.getAttribLocation(this.programDraw,"aTextureWindow"),e.enableVertexAttribArray(this.programDraw.textureWindow),this.programDraw.texturePage=e.getAttribLocation(this.programDraw,"aTexturePage"),e.enableVertexAttribArray(this.programDraw.texturePage),this.programDraw.vertexColor=e.getAttribLocation(this.programDraw,"aVertexColor"),e.enableVertexAttribArray(this.programDraw.vertexColor),this.programDraw.aclut=e.getAttribLocation(this.programDraw,"aTextureClut"),e.enableVertexAttribArray(this.programDraw.aclut),this.programDraw.vertexTexture=e.getAttribLocation(this.programDraw,"aVertexTexture"),e.enableVertexAttribArray(this.programDraw.vertexTexture),this.programDisplay.vertexPosition=e.getAttribLocation(this.programDraw,"aVertexPosition"),e.enableVertexAttribArray(this.programDisplay.vertexPosition),this.programDisplay.vertexTexture=e.getAttribLocation(this.programDisplay,"aVertexTexture"),e.enableVertexAttribArray(this.programDisplay.vertexTexture),this.program24bit.vertexTexture=e.getAttribLocation(this.program24bit,"aVertexTexture"),e.enableVertexAttribArray(this.program24bit.vertexTexture),this.program24bit.vertexPosition=e.getAttribLocation(this.program24bit,"aVertexPosition"),e.enableVertexAttribArray(this.program24bit.vertexPosition),this.programTexture.vertexPosition=e.getAttribLocation(this.programDraw,"aVertexPosition"),e.enableVertexAttribArray(this.programTexture.vertexPosition),this.programTexture.vertexTexture=e.getAttribLocation(this.programDisplay,"aVertexTexture"),e.enableVertexAttribArray(this.programTexture.vertexTexture),this.canvasBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.canvasBuffer),e.bufferData(e.ARRAY_BUFFER,this.vertexBuffer,e.DYNAMIC_DRAW)},d.prototype.createBuffer=function(){var e=this.gl,t=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,t),t},d.prototype.createTexture=function(e){var t=this.gl,r=t.createTexture();return void 0===e&&(e=t.NEAREST),t.bindTexture(t.TEXTURE_2D,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,e),r},d.prototype.setupProgramDraw=function(){var e=this.gl;e.viewport(0,0,a,i),e.useProgram(this.programDraw),e.bindFramebuffer(e.FRAMEBUFFER,this.buf16draw),e.vertexAttribPointer(this.programDraw.vertexColor,4,e.UNSIGNED_BYTE,!1,24,0),e.vertexAttribPointer(this.programDraw.vertexPosition,2,e.SHORT,!1,24,4),e.vertexAttribPointer(this.programDraw.vertexTexture,2,e.SHORT,!1,24,8),e.vertexAttribPointer(this.programDraw.aclut,2,e.SHORT,!1,24,12),e.vertexAttribPointer(this.programDraw.texturePage,2,e.SHORT,!1,24,16),e.vertexAttribPointer(this.programDraw.textureWindow,4,e.UNSIGNED_BYTE,!1,24,20),e.enable(e.SCISSOR_TEST)},d.prototype.flushVertexBuffer=function(e){const a=this.gl;if(o.flushes++,this.vertexBuffer.index<=0)return;if(this.vertexClip!==e||!e||this.drawAreaChange){if(a.enable(a.SCISSOR_TEST),e){let e=(this.drawAreaB-this.drawAreaT+1)*r,i=this.drawAreaT*r;a.scissor(this.drawAreaL*t,i,(this.drawAreaR-this.drawAreaL+1)*t,e)}else a.scissor(0,0,1024*t,512*r);this.vertexClip=e}const i=this.vertexBuffer.view(),s=this.vertexBuffer.getNumberOfVertices();switch(a.bufferData(a.ARRAY_BUFFER,i,a.STREAM_DRAW),this.renderMode>>4){case 0:case 1:a.activeTexture(this.gl.TEXTURE1),a.bindTexture(this.gl.TEXTURE_2D,this.tex8vram),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.vramP2,0),a.drawArrays(a.TRIANGLES,0,s),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.tex16draw,0),a.drawArrays(a.TRIANGLES,0,s);break;case 2:case 3:a.activeTexture(this.gl.TEXTURE1),a.bindTexture(this.gl.TEXTURE_2D,this.tex16draw),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.vramP2,0),a.drawArrays(a.TRIANGLES,0,s),a.bindTexture(this.gl.TEXTURE_2D,this.vramP2),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.tex16draw,0),a.drawArrays(a.TRIANGLES,0,s),a.bindTexture(this.gl.TEXTURE_2D,this.tex8vram)}this.vertexBuffer.reset()},d.prototype.setBlendMode=function(e){if(this.renderMode!==e){this.flushVertexBuffer(!0),this.renderMode=e;var t=this.gl;switch(15&e){case 0:t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.SRC_ALPHA,t.SRC_ALPHA),t.uniform1f(this.programDraw.blendAlpha,.5);break;case 1:t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ONE),t.uniform1f(this.programDraw.blendAlpha,1);break;case 2:t.enable(t.BLEND),t.blendEquation(t.FUNC_REVERSE_SUBTRACT),t.blendFunc(t.ZERO,t.ONE_MINUS_SRC_COLOR),t.uniform1f(this.programDraw.blendAlpha,1);break;case 3:t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE_MINUS_SRC_ALPHA,t.ONE),t.uniform1f(this.programDraw.blendAlpha,.75);break;case 4:t.disable(t.BLEND),t.uniform1f(this.programDraw.blendAlpha,0)}}},d.prototype.getVertexBuffer=function(e,t){var r=(33554432&(t||0)?gpu.status>>5&3:4)|gpu.tp<<4;return this.vertexBuffer.canHold(e)||this.flushVertexBuffer(!0),this.setBlendMode(r),this.vertexBuffer},d.prototype.drawLine=function(e,t,r,a,i){this.seenRender=!0;var o=this.drawOffsetX+(e[r]<<21>>21),s=this.drawOffsetY+(e[r]<<5>>21),n=this.drawOffsetX+(e[i]<<21>>21),h=this.drawOffsetY+(e[i]<<5>>21);if(!this.outsideDrawArea(o,s,n,h,o,s)&&!this.largePrimitive(o,s,n,h,o,s)){var x=Math.abs(o-n),u=Math.abs(s-h),f=this.getVertexBuffer(6,e[0]);o!==n||s!==h?x>=u?(f.addVertex(o,s+1,e[t]),f.addVertex(o,s+0,e[t]),f.addVertex(n,h+0,e[a]),f.addVertex(n,h+0,e[a]),f.addVertex(n,h+1,e[a]),f.addVertex(o,s+1,e[t])):(f.addVertex(o+0,s,e[t]),f.addVertex(o+1,s,e[t]),f.addVertex(n+1,h,e[a]),f.addVertex(n+1,h,e[a]),f.addVertex(n+0,h,e[a]),f.addVertex(o+0,s,e[t])):(f.addVertex(n+0,h+0,e[a]),f.addVertex(n+1,h+0,e[a]),f.addVertex(n+0,h+1,e[a]),f.addVertex(n+0,h+1,e[a]),f.addVertex(n+1,h+0,e[a]),f.addVertex(n+1,h+1,e[a]))}},d.prototype.drawTriangle=function(e,t,r,a,i,o,s,n,h,x,u,f,d){if(this.seenRender=!0,-2147483648!=(2181038080&e[0])){16777216&e[0]&&(e[t]=4278190080&e[t]|8421504),16777216&e[0]&&(e[a]=4278190080&e[a]|8421504),16777216&e[0]&&(e[o]=4278190080&e[o]|8421504);var l=this.drawOffsetX+(e[r]<<21>>21),g=this.drawOffsetY+(e[r]<<5>>21),p=this.drawOffsetX+(e[i]<<21>>21),v=this.drawOffsetY+(e[i]<<5>>21),m=this.drawOffsetX+(e[s]<<21>>21),T=this.drawOffsetY+(e[s]<<5>>21);if(!this.outsideDrawArea(l,g,p,v,m,T)&&!this.largePrimitive(l,g,p,v,m,T)){if(67108864!=(67108864&e[0]))return(c=this.getVertexBuffer(3,e[0])).addVertex(l,g,16711422&e[t]),c.addVertex(p,v,16711422&e[a]),void c.addVertex(m,T,16711422&e[o]);(gpu.txflip||gpu.tyflip)&&console.warn('texture flip with triangles');var c,A=e[x]>>>0&255,b=e[x]>>>8&255,y=e[u]>>>0&255,w=e[u]>>>8&255,E=e[f]>>>0&255,R=e[f]>>>8&255,D=16*(d>>>0&63),V=d>>>6&511,U=Math.min(gpu.status>>7&3,2),B=33554432==(33554432&e[0]),P=(this.renderMode>>4&3)<2,S=3;B&&(S=this.getClutInfo(d,U)),B&&2!=(2&S)||((c=this.getVertexBuffer(3,e[0])).addVertexUV(l,g,16711422&e[t],8|U,A,b,D,V),c.addVertexUV(p,v,16711422&e[a],8|U,y,w,D,V),c.addVertexUV(m,T,16711422&e[o],8|U,E,R,D,V)),P&&B&&1==(1&S)&&((c=this.getVertexBuffer(3,0)).addVertexUV(l,g,16711422&e[t],16|U,A,b,D,V),c.addVertexUV(p,v,16711422&e[a],16|U,y,w,D,V),c.addVertexUV(m,T,16711422&e[o],16|U,E,R,D,V))}}},d.prototype.drawRectangle=function(e,t,r,a){if(this.seenRender=!0,-2147483648!=(2181038080&e[0])){16777216&e[0]&&(e[0]=4278190080&e[0]|8421504);var i=this.drawOffsetX+(e[1]<<21>>21),o=this.drawOffsetY+(e[1]<<5>>21),s=16711422&e[0],n=e[2]<<16>>16,h=e[2]>>16;if(n&&h){var x=!this.outsideDrawArea(i+0,o+0,i+n-1,o+0,i+0,o+h-1),u=!this.outsideDrawArea(i+0,o+h-1,i+n-1,o+0,i+n-1,o+h-1);if(x||u){if(67108864!=(67108864&e[0]))return(T=this.getVertexBuffer(6,e[0])).addVertex(i+0,o+0,s),T.addVertex(i+n,o+0,s),T.addVertex(i+0,o+h,s),T.addVertex(i+n,o+0,s),T.addVertex(i+0,o+h,s),T.addVertex(i+n,o+h,s),void(!s&&n>1&&h>1&&(this.flushVertexBuffer(!0),this.clearVRAM(i,o,n,h,s,!0)));var f=16*(a>>>0&63),d=a>>>6&511,l=Math.min(gpu.status>>7&3,2),g=t+0,p=t+n;gpu.txflip&&(g=t+0,p=t-n+1);var v=r+0,m=r+h;gpu.tyflip&&(v=r+0,m=r-h+1);var T,c=33554432==(33554432&e[0]),A=(this.renderMode>>4&3)<2,b=3;c&&(b=this.getClutInfo(a,l)),c&&2!=(2&b)||((T=this.getVertexBuffer(6,e[0])).addVertexUV(i+0,o+0,s,8|l,g,v,f,d),T.addVertexUV(i+n,o+0,s,8|l,p,v,f,d),T.addVertexUV(i+0,o+h,s,8|l,g,m,f,d),T.addVertexUV(i+n,o+0,s,8|l,p,v,f,d),T.addVertexUV(i+0,o+h,s,8|l,g,m,f,d),T.addVertexUV(i+n,o+h,s,8|l,p,m,f,d)),A&&c&&1==(1&b)&&((T=this.getVertexBuffer(6,0)).addVertexUV(i+0,o+0,s,16|l,g,v,f,d),T.addVertexUV(i+n,o+0,s,16|l,p,v,f,d),T.addVertexUV(i+0,o+h,s,16|l,g,m,f,d),T.addVertexUV(i+n,o+0,s,16|l,p,v,f,d),T.addVertexUV(i+0,o+h,s,16|l,g,m,f,d),T.addVertexUV(i+n,o+h,s,16|l,p,m,f,d))}}}};let l=new Uint16Array(524288);const g={color:0,c:0,size:524288};function p(e,t,r,a){var i=e.gl,o=gpu.status>>22&1?2:1;i.useProgram(e.programDisplay),i.uniform3f(e.programDisplay.ts,r,a,o),i.vertexAttribPointer(e.programDisplay.vertexPosition,2,i.SHORT,!0,8,0),i.vertexAttribPointer(e.programDisplay.vertexTexture,2,i.SHORT,!1,8,4);const s=3===e.displaymode?e.vramP2:e.tex16draw;i.bindTexture(i.TEXTURE_2D,s),i.bufferSubData(i.ARRAY_BUFFER,0,t),i.drawArrays(i.TRIANGLES,0,6)}l.fill(0),d.prototype.clearVRAM=function(e,t,r,a,i,o){var s=this.gl;if(o&&!(gpu.status&1<<21)){let i=e,o=i+r,s=t,n=t+a;i=i<=gpu.drawAreaX1?gpu.drawAreaX1:i,o=o>=gpu.drawAreaX2?gpu.drawAreaX2:o,s=s<=gpu.drawAreaY1?gpu.drawAreaY1:s,n=n>=gpu.drawAreaY2?gpu.drawAreaY2:n,e=i,r=o-i,t=s,a=n-s}const n=r*a>>>0;if(g.color!==i||g.size<n){g.color=i,g.size=n;const e=(i>>>19&31)<<10|(i>>>11&31)<<5|i>>>3&31;g.c=e,l.fill(e,0,n)}for(let i=0;i<a;++i){const a=(t+i)%512*1024;for(let t=0;t<r;++t)this.vram[a+(e+t)%1024]=g.c}s.bindTexture(s.TEXTURE_2D,this.tex8vram);const h=new Uint8Array(l.buffer,0,n<<1);s.texSubImage2D(s.TEXTURE_2D,0,e<<1,t,r<<1,a,s.ALPHA,s.UNSIGNED_BYTE,h),s.bindTexture(s.TEXTURE_2D,null)},d.prototype.fillRectangle=function(e){this.seenRender=!0,this.gl;var t=e[1]<<16>>16,r=e[1]>>16,a=16316664&e[0],i=e[2]<<16>>>16,o=e[2]>>16>>>0;if(t&=1008,r&=511,o&=511,(i=15+(1023&i)&-16)&&o)if(t+i>1024)console.log('fillRectangle does not support x-wrap',t,i);else if(r+o>512)console.log('fillRectangle does not support y-wrap',o,r);else{this.flushVertexBuffer(!0),this.clearVRAM(t,r,i,o,a,!1);var s=this.getVertexBuffer(6,0);s.addVertex(t+0,r+0,a),s.addVertex(t+i,r+0,a),s.addVertex(t+0,r+o,a),s.addVertex(t+0,r+o,a),s.addVertex(t+i,r+0,a),s.addVertex(t+i,r+o,a),this.flushVertexBuffer(!1)}},d.prototype.setDrawAreaOF=function(e,t){this.drawOffsetX=e,this.drawOffsetY=t},d.prototype.setDrawAreaTL=function(e,t){this.flushVertexBuffer(!0),this.drawAreaChange=!0,this.drawAreaT=t,this.drawAreaL=e},d.prototype.setDrawAreaBR=function(e,t){this.flushVertexBuffer(!0),this.drawAreaChange=!0,this.drawAreaB=t,this.drawAreaR=e},d.prototype.onVBlankEnd=function(){},d.prototype.onVBlankBegin=function(){var e=this.gl;this.flushVertexBuffer(!0),o.dump(),e.disable(e.SCISSOR_TEST),e.useProgram(this.programDisplay),this.vertexBuffer.addVertexDisp(-32768,32767,0,0),this.vertexBuffer.addVertexDisp(32767,32767,1024,0),this.vertexBuffer.addVertexDisp(-32768,-32768,0,512),this.vertexBuffer.addVertexDisp(32767,32767,1024,0),this.vertexBuffer.addVertexDisp(-32768,-32768,0,512),this.vertexBuffer.addVertexDisp(32767,-32768,1024,512),e.disable(e.BLEND),this.renderMode=5,e.bindFramebuffer(e.FRAMEBUFFER,null),e.activeTexture(e.TEXTURE0),e.vertexAttribPointer(this.programDisplay.vertexPosition,2,e.SHORT,!0,8,4),e.vertexAttribPointer(this.programDisplay.vertexTexture,2,e.SHORT,!1,8,8);var a=this.vertexBuffer.subarray(0,this.vertexBuffer.index/4);if(0===this.displaymode&&(e.viewport(0,0,this.canvas.width=2048,this.canvas.height=1024),function(e,t){var r=e.gl;r.useProgram(e.programTexture),r.vertexAttribPointer(e.programTexture.vertexPosition,2,r.SHORT,!0,8,0),r.vertexAttribPointer(e.programTexture.vertexTexture,2,r.SHORT,!1,8,4),r.bindTexture(r.TEXTURE_2D,e.tex8vram),r.bufferSubData(r.ARRAY_BUFFER,0,t),r.drawArrays(r.TRIANGLES,0,6)}(this,a)),1===this.displaymode&&(e.viewport(0,0,this.canvas.width=4096,this.canvas.height=2048),p(this,a)),3===this.displaymode&&(e.viewport(0,0,this.canvas.width=4096,this.canvas.height=2048),p(this,a)),2===this.displaymode){var i=gpu.getDisplayArea();this.vertexBuffer.reset();var s=i.x,n=i.x+i.w,h=i.y,x=i.y+i.h;this.vertexBuffer.addVertexDisp(-32768,32767,s,h),this.vertexBuffer.addVertexDisp(32767,32767,n,h),this.vertexBuffer.addVertexDisp(-32768,-32768,s,x),this.vertexBuffer.addVertexDisp(32767,32767,n,h),this.vertexBuffer.addVertexDisp(-32768,-32768,s,x),this.vertexBuffer.addVertexDisp(32767,-32768,n,x),a=this.vertexBuffer.subarray(0,this.vertexBuffer.index/4),gpu.status&1<<23?(e.viewport(0,0,this.canvas.width=i.w,this.canvas.height=i.h),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT)):gpu.status&1<<21?(e.viewport(0,0,this.canvas.width=i.w,this.canvas.height=i.h),function(e,t,r,a){var i=e.gl,o=gpu.status>>22&1?2:1;i.useProgram(e.program24bit),i.uniform3f(e.program24bit.ts,r,a,o),i.vertexAttribPointer(e.program24bit.vertexPosition,2,i.SHORT,!0,8,0),i.vertexAttribPointer(e.program24bit.vertexTexture,2,i.SHORT,!1,8,4),i.bindTexture(i.TEXTURE_2D,e.tex16draw),i.bufferSubData(i.ARRAY_BUFFER,0,t),i.drawArrays(i.TRIANGLES,0,6)}(this,a,s,h)):(e.viewport(0,0,this.canvas.width=i.w*t,this.canvas.height=i.h*r),p(this,a,s,h))}this.vertexBuffer.reset(),this.setupProgramDraw(),this.seenRender&&++this.fpsRenderCounter,++this.fpsCounter,this.seenRender=!1},d.prototype.setMode=function(e){switch(e){default:case'disp':this.displaymode=2;break;case'draw':this.displaymode=1;break;case'clut4':case'clut8':this.displaymode=0;break;case'page2':this.displaymode=3}},window.primitiveId=0,window.WebGLRenderer=d,window.nextPrimitive=()=>{}}));mdlr('[unit]enge:psx:webgl')