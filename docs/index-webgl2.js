'use strict';globalThis.mdlr=(()=>{let r,t,e={},l=(r,t,e={})=>u[r]?.l(t,{name:t,require:(u,a)=>([r,t]=n(u),e[u]??l(r,t,a))}),n=e=>([,r="unit",t]=/^(?:\[([a-z]+)\])?([-:a-z0-9_]+)$/.exec(e),[r,`[${r}]${t}`]),u={mdlr:{r:(r,t)=>{/^\[mdlr\]::[a-z]+$/.test(r)?t(u):e[r]=t},l:(r,t)=>e[r](t)}};return(e,a)=>{[r,t]=n(e),a?.constructor===Function?u[r]?.r(t,a):l(r,t,a)}})();mdlr('[mdlr]::unit',(l=>{let r={};l.unit={r:(l,t)=>{r[l]=t},l:(l,t)=>r[l](t)}}));mdlr('base64',(e=>{const t='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/',r={};return t.split('').forEach(((e,t)=>r[e]=t)),r['=']=0,{decode:e=>{let t=e.length,n=t/4*3;'='===e[t-2]&&--n,'='===e[t-1]&&--n;const o=new Uint8Array(n);let l=0;for(let n=0;n<t;n+=4){const t=r[e[n+0]]<<18|r[e[n+1]]<<12|r[e[n+2]]<<6|r[e[n+3]];o[l+0]=t>>16&255,o[l+1]=t>>8&255,o[l+2]=t>>0&255,l+=3}return o},encode:e=>{const r=new Uint8Array(e.buffer),n=r.byteLength,o=n%3,l=n-o;let c,s,f,a,d,u='';for(let e=0;e<l;e+=3)d=r[e]<<16|r[e+1]<<8|r[e+2],c=d>>18&63,s=d>>12&63,f=d>>6&63,a=d>>0&63,u+=t[c]+t[s]+t[f]+t[a];return 1==o?(d=r[l],c=(252&d)>>2,s=(3&d)<<4,u+=t[c]+t[s]+'=='):2==o&&(d=r[l]<<8|r[l+1],c=(64512&d)>>10,s=(1008&d)>>4,f=(15&d)<<2,u+=t[c]+t[s]+t[f]+'='),u}}}));mdlr('enge:psx',(e=>{Object.assign(window,e.require('enge:psx:core'),e.require('enge:psx:trace')),Object.assign(window,e.require('enge:psx:serial'),e.require('enge:psx:gamepad'),e.require('enge:psx:cpu'),e.require('enge:psx:cdr'),e.require('enge:psx:mdec'),e.require('enge:psx:gpu'),e.require('enge:psx:gte'),e.require('enge:psx:mmu'),e.require('enge:psx:rec'),e.require('enge:psx:spu')),Object.assign(window,e.require('enge:psx:index'))}));mdlr('enge:psx:cdr',(e=>{let a=new Int8Array(0),r=new Int16Array(0),s=24,c=0,t=0,n=0,b=0,l=0,k=0,i=0,f=0,o=255,d=0,h=!1,u=0,w=0,x=1,g=0,p=0,v=1,m=1,y=0,A=0,E=1,I=0,C=0,F=0,P=0,S={};const[T,D,M]=[psx.addEvent,psx.setEvent,psx.unsetEvent],O=e=>e>>0,X=e=>16*O(e/10)+O(e%10),j=e=>10*O(e/16)+O(e%16),q=new Array(16),z=q.push.bind(q),B=new Array(16),G=new Float32Array(18816),H=new Float32Array(8064),J=[],K=[0,0],L=[0,0],N=e=>((255&e)>>>0)/128,Q=e=>{f=224&f|31&e,31&f&o&&(cpu.istat|=4)},R=(e,...a)=>{s=-129&s|32,z(a),Q(e)},U=()=>{B.length=0},V=T(0,(e=>{if(M(e),31&f)return void W(64);const r=PSX_SPEED/(128&d?150:75),l=u-150;let k=n;switch(n=0,k){case 0:break;case 1:a.length?R(3,2):R(5,1);break;case 2:w=0!==B[0]||0!==B[1]||0!==B[2]?4500*j(B[0])+75*j(B[1])+j(B[2]):u,R(3,2);break;case 3:0!==B.length&&0!==B[0]||(u=w),1===B.length&&(S=J[j(B[0])],u=w=S.begin+150),Z(r>>>0),t=3,R(3,130);break;case 6:Z(r>>>0),t=6,R(3,66),u=w;break;case 7:R(3,0),n=112,s|=128;break;case 112:case 160:case 480:R(2,2);break;case 8:R(3,2),W((128&d?25845878:13863626)>>>0),n=128,s|=128;break;case 128:R(2,0);break;case 9:z(32|c),W((128&d?1097107:2168860)>>>0),n=144,s|=160,Q(3);break;case 144:c=-33&c|2,z(c),s=-129&s|32,Q(2);break;case 153:c=-161&c|2,z(c),s=-129&s|32,Q(4);break;case 10:R(3,2),W(4096),n=160,s|=128;break;case 11:R(3,2),h=!0;break;case 12:R(3,2),h=!1;break;case 13:F=B[0],P=B[1],R(3,2);break;case 14:R(3,2),d=B[0];break;case 15:R(3,2,d,0,F,P);break;case 16:{const e=b+12;z(a[e+0],a[e+1],a[e+2],a[e+3],a[e+4],a[e+5],a[e+6],a[e+7]),s=-129&s|32,Q(3)}break;case 17:{let e=u-150-S.begin,a=e/4500>>0,r=(e/75>>0)%60,c=e%75;z(X(S.id),1,X(a),X(r),X(c)),z(X((u-150)/75/60%60)),z(X((u-150)/75%60)),z(X((u-150)%75)),s=-129&s|32,Q(3)}break;case 18:W(4096),n=288,c|=2,z(c),s|=32,Q(3);break;case 288:c|=2;let e=l/4500>>0,k=(l/75>>0)%60,i=l%75;z(130,X(S.id),1,X(e),X(k),X(i),0,0),s=-129&s|32,Q(1);break;case 19:c|=2,z(c,1,X(J.length-1)),s=-129&s|32,Q(3);break;case 20:{let e=0,a=J[j(B[0])];if(!a){c|=16,z(17,128),s=-129&s|32,Q(5);break}e=0===B[0]?O((a.end+150)/75):O((a.begin+150)/75),c|=2,z(c,X(O(e/60)),X(O(e%60))),s=-129&s|32,Q(3)}break;case 21:W(4096),n=336,R(3,66),s|=128;break;case 336:case 352:R(2,2),u=w;break;case 22:W(4096),n=352,R(3,66),s|=128;break;case 25:z(153,2,1,195),s=-129&s|32,Q(3);break;case 26:W(18944),z(c),n=416,s|=32,Q(3);break;case 416:a.length?(z(2,0,32,0,101,78,71,69),s=-129&s|32,Q(2)):(c|=16,z(17,128),s=-129&s|32,Q(5));break;case 27:Z(r>>>0),t=27,R(3,66),u=w;break;case 30:W(4096),n=480,R(3,2);break;default:abort(hex(n,2))}U()})),W=e=>D(V,e),Y=T(0,(e=>{if(31&f)return void psx.updateEvent(e,64);let a=33868800/(128&d?150:75),r=u-150;switch(t){case 0:M(Y);break;case 3:if(i=0,u===S.end&&2&d)return M(e),$(153);if(5==(5&d)){switch(r%75){case 0:case 20:case 40:case 60:{let e=r/4500>>0,a=(r/75>>0)%60,c=r%75;z(130,X(S.id),1,X(e),X(a),X(c),0,0),s=-129&s|96,Q(1)}break;case 10:case 30:case 50:case 70:{let e=u-S.begin,a=e/4500>>0,r=(e/75>>0)%60,c=e%75;z(130,X(S.id),1,X(a),128|X(r),X(c),0,0),s=-129&s|96,Q(1)}}ee(u),psx.updateEvent(e,a),u++;break}case 6:case 27:z(34),s=-129&s|96,Q(1),ee(u),psx.updateEvent(e,a),u++;break;default:abort(hex(t,2))}})),Z=e=>D(Y,e),$=e=>{let a=512;switch(Q(0),q.length=0,s|=128,n=e,e){case 1:a=50401;break;case 3:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 18:case 19:case 20:case 25:case 26:case 30:break;case 10:a=81102;case 2:case 6:case 7:case 8:case 21:case 22:case 27:case 9:se();break;case 153:break;default:abort(hex(e,2))}W(a>>>0)},ee=e=>{if(a.length<=0)return;for(let a=1;a<J.length;++a){let r=S=J[a];if(r.begin<e&&e<r.end)break}b=2352*(e-150);let r=0;switch(48&d){case 0:l=24,r=2048;break;case 16:l=24,r=2328;break;case 32:case 48:l=12,r=2340}if(k=l+r,0!=(72&d)){if(2!==a[b+15])return;if(72==(72&d)){if(a[b+16]!==F)return;if(a[b+17]!==P)return}if(68!=(68&a[b+18]))return;let e,r,s=a[b+19];switch(s>>>0&3){case 0:e=ae;break;case 1:e=re}switch(s>>>2&1){case 0:r=37800;break;case 1:r=18900}I=0,H.fill(0),G.fill(0);let c=e?.call()||0,t=44100*c/r,n=0,l=0;c=-1;for(let e=0;e<t;e+=2)G[++c]=H[n+0],G[++c]=H[n+1],l+=r,l>=44100&&(l-=44100,n+=2);C=c}},ae=()=>{let e=0;for(let r=0;r<18;++r){const s=b+24+128*r;for(let r=0;r<8;++r){const c=a[s+4+r],t=(15&c)>>>0,n=(240&c)>>>3,b=xa2flt[n+0],l=xa2flt[n+1];for(let c=0;c<28;++c){const n=2*(256*t+(255&a[s+16+4*c+r/2>>>0]));let k=K[1]*b+K[0]*l+xa2pcm[n+(1&r)];K[0]=K[1],K[1]=k,H[e+2*c+0]=k,H[e+2*c+1]=k}e+=56}}return e},re=()=>{let e=0;for(let r=0;r<18;++r){const s=b+24+128*r;for(let r=0;r<8;r+=2){{const c=a[s+4+r],t=(15&c)>>>0,n=(240&c)>>>3,b=xa2flt[n+0],l=xa2flt[n+1];for(let c=0;c<28;++c){const n=2*(256*t+(255&a[s+16+4*c+r/2>>>0]));let k=K[1]*b+K[0]*l+xa2pcm[n+0];K[0]=K[1],K[1]=k,H[e+2*c+0]=k}}{const c=a[s+5+r],t=(15&c)>>>0,n=(240&c)>>>3,b=xa2flt[n+0],l=xa2flt[n+1];for(let c=0;c<28;++c){const n=2*(256*t+(255&a[s+16+4*c+r/2>>>0]));let k=L[1]*b+L[0]*l+xa2pcm[n+1];L[0]=L[1],L[1]=k,H[e+2*c+1]=k}}e+=56}}return e},se=()=>{M(Y),c&=-129,c&=-33,t=0};return{cdr:{rd08r1800:()=>s,rd08r1801:()=>33==(35&s)?(1===q.length&&(s&=-97),q.shift()):0,rd08r1802:()=>64&s?a[b+l++]:0,rd08r1803:()=>{switch(3&s){case 0:return 224|o;case 1:return f}},wr08r1800:e=>{s=-4&s|3&e},wr08r1801:e=>{switch(3&s){case 0:$(e);break;case 3:E=N(e)}},wr08r1802:e=>{switch(3&s){case 0:B.push(e),16===B.length&&(s&=-17);break;case 1:o=e,f=0;break;case 2:m=N(e);break;case 3:A=N(e)}},wr08r1803:e=>{switch(3&s){case 0:128===e&&(s|=64);break;case 1:31&e&o&&(e=>{f&=~(31&e&o)})(e),64&e&&U();break;case 2:y=N(e);break;case 3:32&e&&(x=m,g=y,p=A,v=E)}},nextpcm:e=>{if(3===t){if(S.audio){let a=b+i>>1,s=r[a+0]/32768,c=r[a+1]/32768,t=s*x+c*p,n=c*v+s*g;e[0]=t,e[1]=n}return S.data&&(e[0]=0,e[1]=0),void(i+=4)}if(0!=(72&d)){I>=C-1&&(I=C-1);let a=G[I+0],r=G[I+1],s=a*x+r*p,c=r*v+a*g;e[0]=s,e[1]=c,I+=2}},dmaTransferMode0000:(e,a)=>{if(!(8388607&e))return 16;const c=(65535&a)<<2;clearCodeCache(e,c);for(let a=0;a<c;a+=2)map16[(2097151&e)>>1]=r[b+l>>1],l+=2,e+=2;return l>=k&&(s&=-65),c},setTOC:e=>{J.splice(0,J.length,...e)},setCdImage:e=>{r=new Int16Array(e.buffer),a=new Int8Array(e.buffer)}}}}));mdlr('enge:psx:core',(c=>{let e=0;const t=[],l=[],o={clock:0,eventClock:0,addEvent:(c,l)=>{const n={id:++e,active:!0,clock:+o.clock+ +c,start:+o.clock,cb:l};return o.eventClock>n.clock&&(o.eventClock=n.clock),t.push(n),n},updateEvent:(c,e)=>(c.start=c.clock,c.clock+=+e,c.active=!0,o.eventClock>c.clock&&(o.eventClock=c.clock),c),unsetEvent:c=>{if(!c.active)return;const e=t.findIndex((e=>e.id===c.id));return-1!==e&&(l.push(c),t.splice(e,1),c.active=!1),c},eventCycles:c=>+o.clock-c.start,setEvent:(c,e)=>{if(!c.active){const e=l.findIndex((e=>e.id===c.id));-1!==e&&(l.splice(e,1),t.push(c))}return c.clock=+o.clock+ +e,c.start=+o.clock,c.active=!0,o.eventClock>c.clock&&(o.eventClock=c.clock),c},handleEvents:c=>{let e=Number.MAX_SAFE_INTEGER;for(let c of t)c.active&&(o.clock>=c.clock&&c.cb(c,o.clock),c.clock<e&&(e=c.clock));return o.eventClock=e,cpuInterrupt(c)}};return{psx:o}}));mdlr('enge:psx:cpu',(e=>{const r=new Int32Array(32),s=new Int32Array(32),c={gpr:s,cause:0,cycles:0,epc:0,hi:0,imask:0,istat:0,icurr:0,lo:0,pc:0,sr:0,forceWriteBits:0,getCtrl:e=>{switch(e){case 12:return c.sr>>0;case 13:return c.cause>>0;case 14:return c.epc>>0;case 15:return 2}return r[e]},setCtrl:(e,s)=>{switch(r[e]=s>>0,e){case 12:c.sr=s,c.forceWriteBits=65536&s?33554428:0;break;case 13:c.cause=4294966527&c.cause,c.cause|=768&s}},rfe:()=>{c.sr=-16&c.sr|c.sr>>2&15},lwl:(e,r)=>{const c=memRead32(-4&r&33554431);switch(3&r){case 0:s[e]=16777215&s[e]|c<<24;break;case 1:s[e]=65535&s[e]|c<<16;break;case 2:s[e]=255&s[e]|c<<8;break;case 3:s[e]=0&s[e]|c<<0}},lwr:(e,r)=>{const c=memRead32(-4&r&33554431);switch(3&r){case 0:s[e]=0&s[e]|c>>>0;break;case 1:s[e]=4278190080&s[e]|c>>>8;break;case 2:s[e]=4294901760&s[e]|c>>>16;break;case 3:s[e]=4294967040&s[e]|c>>>24}},swl:(e,r)=>{let c=memRead32(-4&r&33554431)>>>0;switch(3&r){case 0:c=4294967040&c|s[e]>>>24;break;case 1:c=4294901760&c|s[e]>>>16;break;case 2:c=4278190080&c|s[e]>>>8;break;case 3:c=0&c|s[e]>>>0}memWrite32(-4&r&33554431,c)},swr:(e,r)=>{let c=memRead32(-4&r&33554431)>>>0;switch(3&r){case 0:c=0&c|s[e]<<0;break;case 1:c=255&c|s[e]<<8;break;case 2:c=65535&c|s[e]<<16;break;case 3:c=16777215&c|s[e]<<24}memWrite32(-4&r&33554431,c)},neg:e=>{let r=e>>0&65535,s=e>>16&65535,c=1+(65535&~r);return r=65535&c,c=(65535&~s)+(c>>>16),s=65535&c,s<<16|r},mult:(e,r)=>{r>>=0;let s=0;if((e>>=0)<0&&(s^=1,e=c.neg(e)),r<0&&(s^=1,r=c.neg(r)),c.multu(e,r),1===s){let e=c.lo>>>0&65535,r=c.lo>>>16&65535,s=c.hi>>>0&65535,a=c.hi>>>16&65535,t=1+(65535&~e);e=65535&t,t=(65535&~r)+(t>>>16),r=65535&t,t=(65535&~s)+(t>>>16),s=65535&t,t=(65535&~a)+(t>>>16),a=65535&t,c.hi=(a<<16|s)>>0,c.lo=(r<<16|e)>>>0}},multu:(e,r)=>{let s=65535&(e>>>=0),a=e>>>16,t=65535&(r>>>=0),i=r>>>16,u=0,l=0,n=0,m=0;m+=s*t,n+=m>>>16,m&=65535,n+=s*i,l+=n>>>16,n&=65535,n+=a*t,l+=n>>>16,n&=65535,l+=a*i,u+=l>>>16,l&=65535,c.hi=(u<<16|l)>>>0,c.lo=(n<<16|m)>>>0},div:(e,r)=>{0===r?e>>0>=0?(c.hi=e,c.lo=4294967295):(c.hi=e,c.lo=1):r>>0==-1&&e>>>0==2147483648?(c.hi=0,c.lo=-2147483648):(c.hi=(e>>0)%(r>>0)>>0,c.lo=(e>>0)/(r>>0)>>0)},divu:(e,r)=>{0===r?(c.hi=e,c.lo=4294967295):(c.hi=(e>>>0)%(r>>>0)>>>0,c.lo=(e>>>0)/(r>>>0)>>>0)}},a=(e,r)=>(c.sr=-64&c.sr|c.sr<<2&63,c.cause=-125&c.cause|e,c.epc=r,vector);return{cpu:c,cpuException:a,cpuInterrupt:e=>{if(1==(1&c.sr)){let r=768&c.cause,s=768&c.sr;if(0!=(r&s))return a(r&s,e.pc);if(1024==(1024&c.sr)&&c.istat&c.imask)return a(1024,e.pc)}return e}}}));mdlr('enge:psx:dma',(r=>{let e=0,a=0;const[c,s,d]=[psx.addEvent,psx.setEvent,psx.unsetEvent],n=r=>{const e=1<<16+r,c=1<<31|e<<8;a&e&&(cpu.istat|=8,a|=c)},t={r1080:0,r1084:0,r1088:0,r1080n:0,r1090:0,r1094:0,r1098:0,r1090n:0,r10a0:0,r10a4:0,r10a8:0,r10a0n:0,r10b0:0,r10b4:0,r10b8:0,r10b0n:0,r10c0:0,r10c4:0,r10c8:0,r10c0n:0,r10e0:0,r10e4:0,r10e8:0,r10e0n:0,completeDMA1:(r,e)=>{n(1),t.r1098&=4278190079,t.r1090=t.r1090n,d(r)},rd08r10f6:()=>a>>16&255,rd16r10f0:()=>65535&e,rd32r10f0:()=>e,rd32r10f4:()=>2147483647&a,wr32r10f0:r=>{e=r},wr08r10f6:r=>{a=a&~(2130706432&(r=r<<16|65535&a)|16777215)|16777215&r},wr32r10f4:r=>{a=a&~(2130706432&r|16777215)|16777215&r},wr32r1088:r=>{if(t.r1088=r,8&e){let e=10;switch(r){case 0:break;case 16777729:e=mdc.dmaTransferMode0201(t.r1080,t.r1084),t.r1080n=t.r1080+(e<<2);break;default:abort(hex(r))}s(b,272*e/256>>>0)}else t.r1088&=4278190079},wr32r1098:r=>{if(t.r1098=r,128&e){let e=10;switch(r){case 0:break;case 16777728:e=mdc.dmaTransferMode0200(t.r1090,t.r1094),t.r1090n=t.r1090+(e<<2);break;default:abort(hex(r))}}else t.r1098&=4278190079},wr32r10a8:r=>{if(t.r10a8=r,2048&e){let e=10;switch(r){case 0:case 1:case 1025:case 513:break;case 16777728:e=gpu.dmaTransferMode0200(t.r10a0,t.r10a4)||10,t.r10a0n=t.r10a0+(e<<2);break;case 16777729:e=gpu.dmaTransferMode0201(t.r10a0,t.r10a4)||10,t.r10a0n=t.r10a0+(e<<2);break;case 16778241:e=gpu.dmaTransferMode0401(t.r10a0,t.r10a4)||10,t.r10a0n=16777215;break;default:abort(hex(r))}s(f,272*e/256>>>0)}else t.r10a8&=4278190079},wr32r10b8:r=>{if(t.r10b8=r,32768&e){let e=10;switch(r){case 0:break;case 285212672:case 289407232:e=cdr.dmaTransferMode0000(t.r10b0,t.r10b4),t.r10b0n=t.r10b0+(e<<2);break;default:abort(hex(r))}s(l,(e*(128&cdr.mode)?5120:10240)/256>>>0)}else t.r10b8&=4278190079},wr32r10c8:r=>{if(t.r10c8=r,524288&e){let e=10;switch(r){case 513:break;case 16777216:case 16777728:e=spu.dmaTransferMode0200(t.r10c0,t.r10c4),t.r10c0n=t.r10c0+(e<<2);break;case 16777217:case 16777729:e=spu.dmaTransferMode0201(t.r10c0,t.r10c4),t.r10c0n=t.r10c0+(e<<2);break;default:abort(hex(r))}s(o,1056*e/256>>>0)}else t.r10c8&=4278190079},wr32r10e8:r=>{if(t.r10e8=1342177282&r|2,134217728&e){let e=10;switch(t.r10e8){case 2:t.r10e0n=t.r10e0=map[(33554431&t.r10e0)>>2];break;case 268435458:case 1342177282:e=gpu.dmaLinkedListMode0002(t.r10e0,t.r10e4),t.r10e0n=16777215;break;default:abort(hex(r)+' '+hex(t.r10e8))}s(m,272*e/256>>>0)}else t.r10e8&=4278190079}},b=c(0,((r,e)=>{n(0),t.r1088&=4278190079,t.r1080=t.r1080n,d(r)})),f=c(0,((r,e)=>{n(2),t.r10a8&=4278190079,t.r10a0=t.r10a0n,d(r)})),l=c(0,((r,e)=>{n(3),t.r10b8&=4278190079,t.r10b0=t.r10b0n,d(r)})),o=c(0,((r,e)=>{n(4),t.r10c8&=4278190079,t.r10c0=t.r10c0n,d(r)})),m=c(0,((r,e)=>{n(6),t.r10e8&=4278190079,t.r10e0=t.r10e0n,d(r)}));return{dma:t}}));mdlr('enge:psx:gamepad',(e=>{let t=null,s=null;const o=new Map,d=e=>{if(t===e)return;t=e;const s=document.getElementById('gamepad');s&&(s.classList.remove(...s.classList),s.classList.add('connected'),s.classList.add(e))},i=e=>e.pressed;return o.set(69,{bits:16,property:'hi'}),o.set(68,{bits:32,property:'hi'}),o.set(88,{bits:64,property:'hi'}),o.set(83,{bits:128,property:'hi'}),o.set(81,{bits:1,property:'hi'}),o.set(84,{bits:2,property:'hi'}),o.set(87,{bits:4,property:'hi'}),o.set(82,{bits:8,property:'hi'}),o.set(38,{bits:16,property:'lo'}),o.set(39,{bits:32,property:'lo'}),o.set(40,{bits:64,property:'lo'}),o.set(37,{bits:128,property:'lo'}),o.set(32,{bits:1,property:'lo'}),o.set(13,{bits:8,property:'lo'}),window.addEventListener("keydown",(e=>{const t=o.get(e.keyCode),s=joy.devices[0];void 0!==t&&(s[t.property]&=~t.bits,d('keyboard'))}),!1),window.addEventListener("keyup",(e=>{const t=o.get(e.keyCode),s=joy.devices[0];void 0!==t&&(s[t.property]|=t.bits)}),!1),window.addEventListener("gamepadconnected",(e=>{s=e.gamepad,document.getElementById('gamepad').classList.add('connected')})),window.addEventListener("gamepaddisconnected",(e=>{document.getElementById('gamepad').classList.remove('connected'),s=null})),{handleGamePads:()=>{if(!s)return;const e=navigator.getGamepads()[s.index];if(e){const t=joy.devices[0],{axes:s,buttons:o}=e;d('gamepad');let r=255;s[0]<=-.4&&(r&=-129),s[0]>=.4&&(r&=-33),s[1]<=-.4&&(r&=-17),s[1]>=.4&&(r&=-65),i(o[14])&&(r&=-129),i(o[15])&&(r&=-33),i(o[12])&&(r&=-17),i(o[13])&&(r&=-65),i(o[8])&&(r&=-2),i(o[9])&&(r&=-9),t.lo=r;let n=255;i(o[3])&&(n&=-17),i(o[1])&&(n&=-33),i(o[0])&&(n&=-65),i(o[2])&&(n&=-129),i(o[4])&&(n&=-5),i(o[6])&&(n&=-2),i(o[5])&&(n&=-9),i(o[7])&&(n&=-3),t.hi=n}}}}));mdlr('enge:psx:gpu',(t=>{const e=renderer,[p,c,r,a]=[e.drawLine,e.drawTriangle,e.drawRectangle,e.setDrawAreaOF].map((t=>t.bind(e))),k=new Set,s=[],i=new Int32Array(4096),n=(t,e)=>{6==(6&t[0]>>>24)?(t[0]|=2147483648,e(),nextPrimitive(),t[0]&=-33554433,e()):e()},d=[1,1,3,1,1,1,1,0,1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,4,4,7,7,7,7,5,5,5,5,9,9,9,9,6,6,6,6,9,9,9,9,8,8,8,8,12,12,12,12,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,3,3,3,3,4,4,4,4,2,2,2,2,0,0,0,0,2,2,2,2,3,3,3,3,2,2,2,2,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1];let u=0,f={dispB:256,dispL:0,dispR:0,dispT:16,dispX:0,dispY:0,dispW:0,drawAreaX1:0,drawAreaX2:0,drawAreaY1:0,drawAreaY2:0,heights:[1,2,1,2],hline:0,img:{w:0,h:0,x:0,y:0,index:0,pixelCount:0,buffer:new Uint16Array(524288)},info:new Uint32Array(16),maxheights:[240,480,256,512],maxwidths:[256,368,320,368,512,368,640,368],packetSize:0,result:2,status:343941120,tp:0,transferTotal:0,twin:0,tx:0,txflip:0,ty:0,tyflip:0,widths:[10,7,8,7,5,7,4,7],frame:0,internalFrame:0,updated:!1,cyclesToDotClock:function(t){switch(f.status>>16&7){case 0:return 11*t/7/10;case 1:case 3:case 5:case 7:return 11*t/7/7;case 2:return 11*t/7/8;case 4:return 11*t/7/5;case 6:return 11*t/7/4}},getDisplayArea:function(){if(f.status>>20&1)var t=f.dispT%256,e=Math.min(f.dispB,314);else t=f.dispT%240,e=Math.min(f.dispB,263);var p=e-t,c=f.dispR-f.dispL,r=f.maxwidths[f.status>>16&7],a=c/f.widths[f.status>>16&7];a=Math.min(r,a+2&-4);var k=f.maxheights[f.status>>19&3],s=f.heights[f.status>>19&3]*p;return s=Math.min(k,s),{x:f.dispX,y:f.dispY,w:a,h:s}},onScanLine:function(t){f.hline=t;let e=f.status&1<<22,p=!!(f.status>>20&1),c=p?314:263,r=f.dispB-f.dispT>>1,a=p?163:136,k=a-r,s=a+r;s>c&&(s=c),k<0&&(k=0),e?1==(1&f.frame)?f.status|=2147483648:f.status&=2147483647:1==(1&f.hline+(1&f.frame))?f.status|=2147483648:f.status&=2147483647,f.hline===s&&renderer.onVBlankBegin(),f.hline===k&&renderer.onVBlankEnd(),(f.hline>=s||f.hline<k)&&(f.status&=2147483647),++f.hline>=c&&(f.updated&&++f.internalFrame,f.updated=!1,cpu.istat|=1,f.hline=0,++f.frame)},rd32r1810:function(){return 134217728&f.rR1814&&abort('gpu.rd32r1810 not implemented'),f.result},rd32r1814:function(){return f.status},wr32r1810:t=>{if(268435456&f.status){if(i[u++]=t,1===u&&(f.packetSize=d[t>>>24]),u===f.packetSize){var e=i[0]>>>24;nextPrimitive(),s[e].call(f,i),u=0}}else{if(f.img.buffer[f.img.index++]=t>>>0&65535,--f.transferTotal<=0)return void f.imgTransferComplete(f.img);if(f.img.buffer[f.img.index++]=t>>>16&65535,--f.transferTotal<=0)return void f.imgTransferComplete(f.img)}},wr32r1814:t=>{switch(t>>>24){case 0:f.status=344064e3,u=0,f.dispL=512,f.dispR=3072,f.dispW=320,f.dispT=16,f.dispB=256,f.dispX=0,f.dispY=0,f.pcktE1([0]),f.pcktE2([0]),f.pcktE3([0]),f.pcktE4([0]),f.pcktE5([0]),f.pcktE6([0]),renderer.updateDrawArea?.call(renderer);break;case 1:f.status|=1879048192,u=0;break;case 2:case 64:break;case 3:f.status&=4286578687,f.status|=(1&t)<<23;break;case 4:f.status&=2684354559,f.status|=(3&t)<<29;break;case 5:f.dispX=t>>0&1023,f.dispY=t>>10&511;break;case 6:f.dispL=t>>0&4095,f.dispR=t>>12&4095;var e=f.dispR-f.dispL,p=f.maxwidths[f.status>>16&7],c=e/f.widths[f.status>>16&7];f.dispW=Math.min(p,c+2&-4);break;case 7:f.dispT=t>>0&1023,f.dispB=t>>10&1023,f.dispB<f.dispT&&(f.dispB+=288);break;case 8:f.status&=4286644223,f.status|=(63&t)<<17,f.status|=64&t?65536:0;break;case 16:f.result=f.info[15&t];break;default:console.warn('gpu.cmnd'+hex(t>>>24,2))}},invalidPacketHandler:t=>{},updateTexturePage:function(t){switch(void 0!==t&&(f.status=-2560&f.status|2559&t),f.tx=(f.status>>>0&15)<<6,f.ty=(f.status>>>4&1)<<8,f.tp=f.status>>>7&3,f.tp){case 0:f.tx<<=2;break;case 1:f.tx<<=1;break;case 2:case 3:f.tx<<=0}},pckt00:t=>{},pckt01:t=>{f.status=-134217729&(268435456|f.status)},pckt02:t=>{renderer.fillRectangle(t)},pckt03:t=>{},pckt04:t=>{},pckt05:t=>{},pckt08:t=>{},pckt09:t=>{},pckt0D:t=>{},pckt20:t=>{c(t,0,1,0,2,0,3)},pckt24:t=>{f.updateTexturePage(t[4]>>>16),n(t,(()=>{c(t,0,1,0,3,0,5,f.tx,f.ty,2,4,6,t[2]>>>16)}))},pckt28:t=>{c(t,0,1,0,2,0,3),c(t,0,2,0,3,0,4)},pckt2C:t=>{f.updateTexturePage(t[4]>>>16),n(t,(()=>{c(t,0,1,0,3,0,5,f.tx,f.ty,2,4,6,t[2]>>>16),c(t,0,3,0,5,0,7,f.tx,f.ty,4,6,8,t[2]>>>16)}))},pckt30:t=>{c(t,0,1,2,3,4,5)},pckt34:t=>{f.updateTexturePage(t[5]>>>16),n(t,(()=>{c(t,0,1,3,4,6,7,f.tx,f.ty,2,5,8,t[2]>>>16)}))},pckt38:t=>{c(t,0,1,2,3,4,5),c(t,2,3,4,5,6,7)},pckt3C:t=>{f.updateTexturePage(t[5]>>>16),n(t,(()=>{c(t,0,1,3,4,6,7,f.tx,f.ty,2,5,8,t[2]>>>16),c(t,3,4,6,7,9,10,f.tx,f.ty,5,8,11,t[2]>>>16)}))},pckt40:t=>{p(t,0,1,0,2)},pckt48:function(t,e){for(var c=2;c<e;c+=1)p(t,0,c-1,0,c)},pckt50:t=>{p(t,0,1,2,3)},pckt58:function(t,e){for(var c=3;c<e;c+=2)p(t,c-3,c-2,c-1,c)},pckt60:t=>{r([t[0],t[1],t[2]],0,0,0)},pckt64:t=>{const e=t[2]>>>0&255,p=t[2]>>>8&255;n(t,(()=>{r([t[0],t[1],t[3]],e,p,t[2]>>>16)}))},pckt68:t=>{r([t[0],t[1],65537],0,0,0)},pckt70:t=>{r([t[0],t[1],524296],0,0,0)},pckt74:t=>{const e=t[2]>>>0&255,p=t[2]>>>8&255;n(t,(()=>{r([t[0],t[1],524296],e,p,t[2]>>>16)}))},pckt78:t=>{r([t[0],t[1],1048592],0,0,0)},pckt7C:t=>{const e=t[2]>>>0&255,p=t[2]>>>8&255;n(t,(()=>{r([t[0],t[1],1048592],e,p,t[2]>>>16)}))},pckt80:t=>{if(t[1]!==t[2]){var e=t[1]>>0,p=t[1]>>16,c=t[2]>>0,r=t[2]>>16,a=t[3]>>0,k=t[3]>>16;c&=1023,r&=511,e&=1023,p&=511,(a=1+(a-1&1023))*(k=1+(k-1&511))&&renderer.moveImage(e,p,c,r,a,k)}},pcktA0:t=>{f.status&=-268435457;var e=t[1]<<16>>>16,p=t[1]<<0>>>16,c=t[2]<<16>>>16,r=t[2]<<0>>>16;f.img.w=1+(c-1&1023),f.img.h=1+(r-1&511),f.img.x=1023&e,f.img.y=511&p,f.img.index=0,f.transferTotal=f.img.w*f.img.h+1&-2,f.img.pixelCount=f.transferTotal},pcktC0:t=>{f.status|=134217728;var e=t[1]<<16>>>16,p=t[1]<<0>>>16,c=t[2]<<16>>>16,r=t[2]<<0>>>16;f.img.w=1+(c-1&1023),f.img.h=1+(r-1&511),f.img.x=1023&e,f.img.y=511&p,f.img.index=0,f.transferTotal=f.img.w*f.img.h+1&-2,f.img.pixelCount=f.transferTotal,renderer.loadImage(f.img.x,f.img.y,f.img.w,f.img.h,f.img.buffer)},pcktE1:t=>{f.status=4294965248&f.status|2047&t[0],f.txflip=t[0]>>>12&1,f.tyflip=t[0]>>>13&1,f.updateTexturePage()},pcktE2:t=>{f.info[2]=1048575&t[0];const e=((t[0]>>0&31)<<3<<0)+((t[0]>>5&31)<<3<<8)+((t[0]>>10&31)<<3<<16)+((t[0]>>15&31)<<3<<24);f.twin=e},pcktE3:t=>{f.info[3]=1048575&t[0],f.drawAreaX1=t[0]<<22>>>22,f.drawAreaY1=t[0]<<12>>>22,renderer.setDrawAreaTL(f.drawAreaX1,f.drawAreaY1)},pcktE4:t=>{f.info[4]=1048575&t[0],f.drawAreaX2=t[0]<<22>>>22,f.drawAreaY2=t[0]<<12>>>22,renderer.setDrawAreaBR(f.drawAreaX2,f.drawAreaY2)},pcktE5:t=>{f.info[5]=4194303&t[0];const e=t[0]<<21>>21,p=t[0]<<11>>22;a(e,p)},pcktE6:t=>{f.status&=4294961151,f.status|=(3&t[0])<<11},imgTransferComplete:function(t){renderer.storeImage(f.img),f.status|=268435456},dmaTransferMode0200:function(t,e){if(!(8388607&t))return 16;var p=(e>>16)*(65535&e)<<1;f.transferTotal-=p;const c=f.img;for(;--p>=0;){const e=f.img.buffer[c.index++];map16[(2097151&t)>>>1]=e,t+=2}return f.transferTotal<=0&&(f.status&=-134217729),(e>>16)*(65535&e)},dmaTransferMode0201:function(t,e){if(!(8388607&t))return 16;if(0==(-4&t))return(e>>16)*(65535&e);var p=(e>>16)*(65535&e)<<1;f.transferTotal-=p;const c=f.img;for(;--p>=0;){const e=map16[(2097151&t)>>>1];c.buffer[c.index++]=e,t+=2}return f.transferTotal<=0&&(f.imgTransferComplete(f.img),f.updated=!0),(e>>16)*(65535&e)},dmaTransferMode0401:function(t,e){if(!(8388607&t))return 16;if(0!==u&&abort('not implemented'),0==(-4&t))return(e>>16)*(65535&e);const p=new Set,c=i;let r=0;for(;;){t&=2097151;let e=ram.getInt32(t,!0);dma.r10e0n=e;let i=e>>>24;for(t+=4,++r;i>0;){if(p.has(t))return r;p.add(t);const n=ram.getInt32(t,!0)>>>0,u=n>>>24;if(0===d[u])return k.has(u)||(k.add(u),console.warn('invalid packetId:',hex(u,2),hex(e),hex(n))),r;if(u>=72&&u<80||u>=88&&u<96){let e=0;for(;e<4096;++e){const p=ram.getInt32(t,!0);if(t+=4,--i,++r,1431655765===p)break;if(1342197760===p)break;c[e]=p}if(i<0)return r;nextPrimitive(),s[u].call(f,c,e),f.updated=!0}else{for(var a=0;a<d[u];++a)c[a]=ram.getInt32(t,!0),t+=4,--i,++r;if(i<0)return r;nextPrimitive(),s[u].call(f,c,0),f.updated=!0}}if(8388608&e)break;t=2097151&e}return r},dmaLinkedListMode0002:function(t,e){if(!t)return;if(0==(-4&t))throw 43;e>=65536&&abort('unexpected blck size'),0===e&&(e=65536),t&=2097151;let p=e;for(;--e>=1;){const e=t-4&2097151;ram.setInt32(t,e,!0),t=e}return ram.setInt32(t,16777215,!0),p}};f.pckt21=f.pckt20,f.pckt22=f.pckt20,f.pckt23=f.pckt20,f.pckt25=f.pckt24,f.pckt26=f.pckt24,f.pckt27=f.pckt24,f.pckt29=f.pckt28,f.pckt2A=f.pckt28,f.pckt2B=f.pckt28,f.pckt2D=f.pckt2C,f.pckt2E=f.pckt2C,f.pckt2F=f.pckt2C,f.pckt31=f.pckt30,f.pckt32=f.pckt30,f.pckt33=f.pckt30,f.pckt35=f.pckt34,f.pckt36=f.pckt34,f.pckt37=f.pckt34,f.pckt39=f.pckt38,f.pckt3A=f.pckt38,f.pckt3B=f.pckt38,f.pckt3D=f.pckt3C,f.pckt3E=f.pckt3C,f.pckt3F=f.pckt3C,f.pckt41=f.pckt40,f.pckt42=f.pckt40,f.pckt43=f.pckt40,f.pckt44=f.pckt40,f.pckt45=f.pckt40,f.pckt46=f.pckt40,f.pckt47=f.pckt40,f.pckt49=f.pckt48,f.pckt4A=f.pckt48,f.pckt4B=f.pckt48,f.pckt4C=f.pckt48,f.pckt4D=f.pckt48,f.pckt4E=f.pckt48,f.pckt4F=f.pckt48,f.pckt51=f.pckt50,f.pckt52=f.pckt50,f.pckt53=f.pckt50,f.pckt54=f.pckt50,f.pckt55=f.pckt50,f.pckt56=f.pckt50,f.pckt57=f.pckt50,f.pckt59=f.pckt58,f.pckt5A=f.pckt58,f.pckt5B=f.pckt58,f.pckt5C=f.pckt58,f.pckt5D=f.pckt58,f.pckt5E=f.pckt58,f.pckt5F=f.pckt58,f.pckt61=f.pckt60,f.pckt62=f.pckt60,f.pckt63=f.pckt60,f.pckt65=f.pckt64,f.pckt66=f.pckt64,f.pckt67=f.pckt64,f.pckt69=f.pckt68,f.pckt6A=f.pckt68,f.pckt6B=f.pckt68,f.pckt71=f.pckt70,f.pckt72=f.pckt70,f.pckt73=f.pckt70,f.pckt75=f.pckt74,f.pckt76=f.pckt74,f.pckt77=f.pckt74,f.pckt79=f.pckt78,f.pckt7A=f.pckt78,f.pckt7B=f.pckt78,f.pckt7D=f.pckt7C,f.pckt7E=f.pckt7C,f.pckt7F=f.pckt7C;for(let t=0;t<256;++t){var o='pckt'+hex(t,2).toUpperCase();s[t]=f[o]||f.invalidPacketHandler}for(let t=129;t<=159;++t)s[t]=f.pckt80;for(let t=161;t<=191;++t)s[t]=f.pcktA0;for(let t=193;t<=223;++t)s[t]=f.pcktC0;return f.info[7]=2,f.info[8]=0,{gpu:f}}));mdlr('enge:psx:gte',(e=>{let a,r,s,c=0,n=0,t=0;const b=new Int32Array(4),k=new Int32Array(4),u=new Int32Array(4),o=new Int32Array(9),w=new Int32Array(9),y=new Int32Array(9),A=new Int32Array(9),I=new Int32Array(3),d=new Int32Array(3),i=new Int32Array(3),l=new Int32Array(4),v=new Float64Array(4),f=new Float64Array(4),g=new Int32Array(64),h=new Int32Array(32),m=new Int32Array(3),p=new Int32Array(3),x=new Int32Array(4),F=[y,o,w,A],M=[b,k,u,v],j=[i,I,d,A],q=new Map([[1,15],[6,8],[12,6],[16,8],[17,8],[18,8],[19,19],[20,13],[22,44],[27,17],[28,11],[30,14],[32,30],[41,8],[42,17],[46,6],[48,23],[63,39]]),z=(e,a,r,s,c)=>e<a?(g[63]|=h[r],a):e>s?(g[63]|=h[c],s):e,B=e=>{const a=e?0:-32768;v[1]=z(f[1],a,24,32767,24),v[2]=z(f[2],a,23,32767,23),v[3]=z(f[3],a,22,32767,22)},C=()=>{f[0]>2147483647&&(g[63]|=h[16]),f[0]<-2147483648&&(g[63]|=h[15])},D=()=>{v[1]=(4096*d[0]-f[1])/r,v[2]=(4096*d[1]-f[2])/r,v[3]=(4096*d[2]-f[3])/r,v[1]=z(v[1],-32768,24,32767,24),v[2]=z(v[2],-32768,23,32767,23),v[3]=z(v[3],-32768,22,32767,22)},E=()=>{f[1]=(f[1]+v[1]*v[0])/r,f[2]=(f[2]+v[2]*v[0])/r,f[3]=(f[3]+v[3]*v[0])/r,B(a)},G=(e,s,c)=>{f[1]=(4096*e[0]+s[0]*c[1]+s[1]*c[2]+s[2]*c[3])/r,f[2]=(4096*e[1]+s[3]*c[1]+s[4]*c[2]+s[5]*c[3])/r,f[3]=(4096*e[2]+s[6]*c[1]+s[7]*c[2]+s[8]*c[3])/r,B(a)},H=()=>{const e=l[3]>>>24,a=z(f[1]/16,0,21,255,21),r=z(f[2]/16,0,20,255,20),s=z(f[3]/16,0,19,255,19);l[0]=l[1],l[1]=l[2],l[2]=e<<24|s<<16|r<<8|a<<0},J=e=>{f[1]=65536*(e>>0&255),f[2]=65536*(e>>8&255),f[3]=65536*(e>>16&255),D(),E(),H()},K=e=>{G(A,o,e),G(I,w,v),f[1]=(l[3]>>0&255)*v[1]*16,f[2]=(l[3]>>8&255)*v[2]*16,f[3]=(l[3]>>16&255)*v[3]*16,f[1]=f[1]/r,f[2]=f[2]/r,f[3]=f[3]/r,B(a),H()},L=e=>{G(A,o,e),G(I,w,v),f[1]=(l[3]>>0&255)*v[1]*16,f[2]=(l[3]>>8&255)*v[2]*16,f[3]=(l[3]>>16&255)*v[3]*16,D(),E(),H()},N=e=>{G(A,o,e),G(I,w,v),H()},O=8796093022207,P=-8796093022208,Q=e=>{const c=65535&g[58],n=g[56],t=g[57],b=g[59],k=g[60];f[1]=(4096*i[0]+y[0]*e[1]+y[1]*e[2]+y[2]*e[3])/r,f[1]>O&&(g[63]|=h[30]),f[1]<P&&(g[63]|=h[27]),f[2]=(4096*i[1]+y[3]*e[1]+y[4]*e[2]+y[5]*e[3])/r,f[2]>O&&(g[63]|=h[29]),f[2]<P&&(g[63]|=h[26]),f[3]=(4096*i[2]+y[6]*e[1]+y[7]*e[2]+y[8]*e[3])/r,f[3]>O&&(g[63]|=h[28]),f[3]<P&&(g[63]|=h[25]),B(a),m[0]=m[1],m[1]=m[2],p[0]=p[1],p[1]=p[2],x[0]=x[1],x[1]=x[2],x[2]=x[3];let u=f[3]/s;x[3]=z(u,0,18,65535,18);let o=131072;o=(131072*c/x[3]+1)/2,o>131071&&(g[63]|=h[17],o=131071),f[0]=o*v[1]+n,m[2]=f[0]/65536,C(),f[0]=o*v[2]+t,p[2]=f[0]/65536,C(),f[0]=o*b+k,v[0]=f[0]/4096,C(),m[2]=z(m[2],-1024,14,1023,14),p[2]=z(p[2],-1024,13,1023,13),v[0]=z(v[0],0,12,4096,12)},R=e=>e<<16>>16,S=e=>e<<0>>16,T=e=>e<<0>>0,U=e=>e<<16>>>16,V={get:e=>{switch(e){case 7:return U(g[e]);case 8:return R(v[0]);case 9:return R(v[1]);case 10:return R(v[2]);case 11:return R(v[3]);case 12:return 65535&m[0]|p[0]<<16;case 13:return 65535&m[1]|p[1]<<16;case 14:case 15:return 65535&m[2]|p[2]<<16;case 16:return U(x[0]);case 17:return U(x[1]);case 18:return U(x[2]);case 19:return U(x[3]);case 20:return l[0];case 21:return l[1];case 22:return l[2];case 24:return f[0];case 25:return f[1];case 26:return f[2];case 27:return f[3];case 29:let a=0;return a|=v[1]>>7<<0,a|=v[2]>>7<<5,a|=v[3]>>7<<10,a;case 31:return t;case 58:return R(g[e]);default:return g[e]}},set:(e,a)=>{switch(g[e]=a,e){case 0:b[1]=R(a),b[2]=S(a);break;case 1:b[3]=R(a);break;case 2:k[1]=R(a),k[2]=S(a);break;case 3:k[3]=R(a);break;case 4:u[1]=R(a),u[2]=S(a);break;case 5:u[3]=R(a);break;case 6:l[3]=a;break;case 7:case 23:case 29:case 31:break;case 8:v[0]=R(a);break;case 9:v[1]=R(a);break;case 10:v[2]=R(a);break;case 11:v[3]=R(a);break;case 12:m[0]=R(a),p[0]=S(a);break;case 13:m[1]=R(a),p[1]=S(a);break;case 14:m[2]=R(a),p[2]=S(a);break;case 15:m[0]=m[1],p[0]=p[1],m[1]=m[2],p[1]=p[2],m[2]=R(a),p[2]=S(a);break;case 16:x[0]=U(a);break;case 17:x[1]=U(a);break;case 18:x[2]=U(a);break;case 19:x[3]=U(a);break;case 20:l[0]=a;break;case 21:l[1]=a;break;case 22:l[2]=a;break;case 24:f[0]=T(a);break;case 25:f[1]=T(a);break;case 26:f[2]=T(a);break;case 27:f[3]=T(a);break;case 28:v[1]=(31&a)<<7,v[2]=(992&a)<<2,v[3]=(31744&a)>>3;break;case 30:(e=>{if(2147483648&e&&(e^=4294967295),0===e)t=32;else{for(var a=31;0==(e&1<<a)&&a>=0;--a);t=31-a}})(a);break;case 32:y[0]=R(a),y[1]=S(a);break;case 33:y[2]=R(a),y[3]=S(a);break;case 34:y[4]=R(a),y[5]=S(a);break;case 35:y[6]=R(a),y[7]=S(a);break;case 36:g[e]=y[8]=R(a);break;case 37:i[0]=T(a);break;case 38:i[1]=T(a);break;case 39:i[2]=T(a);break;case 40:o[0]=R(a),o[1]=S(a);break;case 41:o[2]=R(a),o[3]=S(a);break;case 42:o[4]=R(a),o[5]=S(a);break;case 43:o[6]=R(a),o[7]=S(a);break;case 44:g[e]=o[8]=R(a);break;case 45:I[0]=T(a);break;case 46:I[1]=T(a);break;case 47:I[2]=T(a);break;case 48:w[0]=R(a),w[1]=S(a);break;case 49:w[2]=R(a),w[3]=S(a);break;case 50:w[4]=R(a),w[5]=S(a);break;case 51:w[6]=R(a),w[7]=S(a);break;case 52:g[e]=w[8]=R(a);break;case 53:d[0]=T(a);break;case 54:d[1]=T(a);break;case 55:d[2]=T(a);break;case 56:case 57:case 60:g[e]=T(a);break;case 58:g[e]=U(a);break;case 59:g[e]=R(a);break;case 61:g[e]=c=R(a);break;case 62:g[e]=n=R(a);break;case 63:g[e]=2147479552&a,2139611136&g[e]&&(g[e]|=2147483648);break;default:abort(hex(e,2))}},command:e=>{r=e>>19&1?4096:1,s=e>>19&1?1:4096,a=e>>10&1,g[63]=0,Y.get(63&e)(e)},cycles:e=>q.get(63&e)||5},W=e=>{e(b)},X=e=>{e(b),e(k),e(u)},Y=new Map([[1,_=>W(Q)],[6,_=>(f[0]=m[0]*(p[1]-p[2])+m[1]*(p[2]-p[0])+m[2]*(p[0]-p[1]),void C())],[12,_=>(f[1]=(v[3]*y[4]-v[2]*y[8])/r,f[2]=(v[1]*y[8]-v[3]*y[0])/r,f[3]=(v[2]*y[0]-v[1]*y[4])/r,void B(a))],[16,_=>J(l[3])],[17,_=>(f[1]=4096*v[1],f[2]=4096*v[2],f[3]=4096*v[3],D(),E(),void H())],[18,_=>{var e;G(j[(e=_)>>13&3],F[e>>17&3],M[e>>15&3])}],[19,_=>W(L)],[20,_=>(G(I,w,v),f[1]=(l[3]>>0&255)*v[1]*16,f[2]=(l[3]>>8&255)*v[2]*16,f[3]=(l[3]>>16&255)*v[3]*16,D(),E(),f[1]=f[1]/r,f[2]=f[2]/r,f[3]=f[3]/r,B(a),void H())],[22,_=>X(L)],[27,_=>W(K)],[28,_=>(G(I,w,v),f[1]=(l[3]>>0&255)*v[1]*16,f[2]=(l[3]>>8&255)*v[2]*16,f[3]=(l[3]>>16&255)*v[3]*16,f[1]=f[1]/r,f[2]=f[2]/r,f[3]=f[3]/r,B(a),void H())],[30,_=>W(N)],[32,_=>X(N)],[40,_=>(f[1]=v[1]*v[1]/r,f[2]=v[2]*v[2]/r,f[3]=v[3]*v[3]/r,void B(a))],[41,_=>(f[1]=(l[3]>>0&255)*v[1]*16,f[2]=(l[3]>>8&255)*v[2]*16,f[3]=(l[3]>>16&255)*v[3]*16,D(),E(),void H())],[42,_=>{J(l[0]),J(l[0]),J(l[0])}],[45,_=>(f[0]=c*(x[1]+x[2]+x[3]),C(),void(g[7]=z(f[0]/4096,0,18,65535,18)))],[46,_=>(f[0]=n*(x[0]+x[1]+x[2]+x[3]),C(),void(g[7]=z(f[0]/4096,0,18,65535,18)))],[48,_=>X(Q)],[61,_=>(f[1]=0,f[2]=0,f[3]=0,E(),void H())],[62,_=>(f[1]=f[1]*r,f[2]=f[2]*r,f[3]=f[3]*r,E(),void H())],[63,_=>X(K)]]);for(let e=0;e<=31;++e)h[e]=1<<e;for(let e=23;e<=30;++e)h[e]|=2147483648;for(let e=13;e<=18;++e)h[e]|=2147483648;return{gte:V}}));mdlr('enge:psx:index',(e=>{let t,r=!1;const n=(...e)=>{throw t.style.borderColor='red',r=!1,spu.silence(),new Error([...e].join(' '))};let o=!1,a=!0;document.addEventListener("visibilitychange",(()=>{'visible'===document.visibilityState?a=!0:(a=!1,spu.silence())}));const s={timeStamp:0,realtime:0,emutime:0,counter:0},d=psx.addEvent(0,(e=>{o=!0,psx.unsetEvent(e)})),i=e=>{(e=>{const t=e-s.timeStamp;if(s.timeStamp=e,!r||!a||t>250)return;s.realtime+=t;const i=33868.8*(s.realtime-s.emutime);o=!1,psx.setEvent(d,+i);let c=getCacheEntry(cpu.pc);if(!c)return n();handleGamePads();const l=psx;for(;!o;)c=c.code(l),l.clock>=l.eventClock&&(c=l.handleEvents(c));cpu.pc=c.pc,s.emutime=psx.clock/33868.8,++s.counter})(e),requestAnimationFrame(i)},c=()=>{r=!1;let e=getCacheEntry(3217031168);const t=psx;for(;196608!==e.pc;)e=e.code(t),t.clock>=t.eventClock&&(e=t.handleEvents(e));s.realtime=s.emutime=psx.clock/33868.8,vector=getCacheEntry(128),cpu.pc=e.pc},l=e=>{const t=new DataView(e);if(21328===t.getUint16(0,!0)){cpu.pc=t.getInt32(16,!0),cpu.gpr[28]=t.getInt32(20,!0),cpu.gpr[29]=t.getInt32(48,!0)||2149580784,cpu.gpr[30]=t.getInt32(48,!0)||2149580784,cpu.gpr[31]=cpu.pc;for(var n=t.getInt32(24,!0),o=t.getInt32(28,!0),a=0;a<o;++a)2048+a>=e.byteLength||ram.setInt8(2097151&n++,t.getInt8(2048+a,!0),!0);clearCodeCache(t.getInt32(24,!0),e.byteLength),r=!0}else if(17229===t.getUint32(0,!0)){var s=new Uint8Array(e);let t=joy.devices?joy.devices[0].data:joy.cardOneMemory;for(a=0;a<s.length;++a)t[a]=s[a]}else if(524288===e.byteLength){for(writeStorageStream('bios',e),a=0;a<524288;a+=4){const e=t.getInt32(a,!0);rom.setInt32(a,e,!0)}c();let r=document.querySelector('span.nobios');r&&r.classList.remove('nobios')}else{let n=e.byteLength/4/588,o=[];o.push({id:0,begin:0,end:n});const a=2352,s=e=>{let r=t.getInt32(e*a+0,!0)>>>0,n=t.getInt32(e*a+4,!0)>>>0,o=t.getInt32(e*a+8,!0)>>>0;return 4294967040===r&&4294967295===n&&16777215===o||!r&&!n&&!o},d=e=>{let r=0;for(let n=0;n<a;n+=4)r|=t.getInt32(e*a+n,!0);return r>>>0==0};let i,c,l,p=0;for(i=p;p<n&&s(p);)++p;for(c=p;p<n&&d(p);)++p;o.push({id:1,begin:i,end:c,data:!0});let u=2;if(p<n){for(i=p;p<n;){for(;p<n&&!d(p);)++p;for(c=p;p<n&&d(p);)++p;l=p,l-c<75||(o.push({id:u,begin:i,end:c,audio:!0}),i=p,u++)}i<n&&(c=l=n,o.push({id:u,begin:i,end:c,audio:!0}))}cdr.setCdImage(t),cdr.setTOC(o),r=!0}},p=e=>{e.stopPropagation(),e.preventDefault();const t=e.dataTransfer?e.dataTransfer.files:e.target.files;for(let e,o=0;e=t[o];++o)r=e,n=void 0,(n=new FileReader).onload=e=>{l(e.target.result)},n.readAsArrayBuffer(r);var r,n},u=e=>{e.stopPropagation(),e.preventDefault()};return{init:()=>{t=document.getElementById('display'),document.addEventListener('dragover',u,!1),document.addEventListener('drop',p,!1);const e=document.getElementById('file');e?.addEventListener('change',p,!1),settings.updateQuality();const n=document.getElementById('quality');n?.addEventListener('click',(e=>(settings.updateQuality(!0),e.stopPropagation(),e.preventDefault(),!1))),i(performance.now()),t.addEventListener("dblclick",(()=>{r=!r,r||spu.silence()})),t.addEventListener("touchstart",(()=>{r=!r,r||spu.silence()})),window.addEventListener("keydown",(e=>{'F12'!==e.key&&'F11'!==e.key&&'F5'!==e.key&&e.preventDefault()}),!1),window.addEventListener("keyup",(e=>{'1'===e.key&&e.ctrlKey&&renderer.setMode('disp'),'2'===e.key&&e.ctrlKey&&renderer.setMode('draw'),'3'===e.key&&e.ctrlKey&&renderer.setMode('clut8'),'4'===e.key&&e.ctrlKey&&renderer.setMode('clut4'),'0'===e.key&&e.ctrlKey&&renderer.setMode('page2'),'F12'!==e.key&&'F11'!==e.key&&'F5'!==e.key&&e.preventDefault()}),!1),readStorageStream('bios',(e=>{if(e){let r=new Uint32Array(e.buffer);for(var t=0;t<524288;t+=4)map[29360128+t>>>2]=r[t>>>2];let n=document.querySelector('span.nobios');n&&n.classList.remove('nobios'),c()}})),readStorageStream('card1',(e=>{e&&joy.devices[0].setMemoryCard(e)})),readStorageStream('card2',(e=>{e&&joy.devices[1].setMemoryCard(e)}))},PSX_SPEED:33868800,abort:n,context:s}}));mdlr('enge:psx:mdec',(e=>{const r=new Int32Array(128),t=new Uint8Array(768),n=(e,r)=>t[384+e+r],o=(e,r)=>n(e,r)>>>3,s=[0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63],c=[16384,22725,21407,19266,16384,12873,8867,4520,22725,31521,29692,26722,22725,17855,12299,6270,21407,29692,27969,25172,21407,16819,11585,5906,19266,26722,25172,22654,19266,15137,10426,5315,16384,22725,21407,19266,16384,12873,8867,4520,12873,17855,16819,15137,12873,10114,6967,3552,8867,12299,11585,10426,8867,6967,4799,2446,4520,6270,5906,5315,4520,3552,2446,1247],l=(e,r)=>{let t,n,o,s,c=r;for(let c=8;c>0;--c,r+=8){t=e[r+0]+e[r+4]>>0,n=e[r+0]-e[r+4]>>0,s=e[r+2]+e[r+6]>>0,o=e[r+2]-e[r+6]>>0,o=(362*o>>8)-s>>0;const c=t+s>>0,l=t-s>>0,a=n+o>>0,f=n-o>>0;s=e[r+3]+e[r+5]>>0,t=e[r+3]-e[r+5]>>0,n=e[r+1]+e[r+7]>>0,o=e[r+1]-e[r+7]>>0;const d=473*(o-t)>>8,m=n+s>>0,p=(669*t>>8)+d-m>>0,u=(362*(n-s)>>8)-p>>0,b=(277*o>>8)-d+u>>0;e[r+0]=c+m>>5,e[r+1]=a+p>>5,e[r+2]=f+u>>5,e[r+3]=l-b>>5,e[r+4]=l+b>>5,e[r+5]=f-u>>5,e[r+6]=a-p>>5,e[r+7]=c-m>>5}r=c;for(let c=8;c>0;--c,++r){t=e[r+0]+e[r+32]>>0,n=e[r+0]-e[r+32]>>0,s=e[r+16]+e[r+48]>>0,o=e[r+16]-e[r+48]>>0,o=(362*o>>8)-s>>0;const c=t+s>>0,l=t-s>>0,a=n+o>>0,f=n-o>>0;s=e[r+24]+e[r+40]>>0,t=e[r+24]-e[r+40]>>0,n=e[r+8]+e[r+56]>>0,o=e[r+8]-e[r+56]>>0;const d=473*(o-t)>>8,m=n+s>>0,p=(669*t>>8)+d-m>>0,u=(362*(n-s)>>8)-p>>0,b=(277*o>>8)-d+u>>0;e[r+0]=c+m>>0,e[r+8]=a+p>>0,e[r+16]=f+u>>0,e[r+24]=l-b>>0,e[r+32]=l+b>>0,e[r+40]=f-u>>0,e[r+48]=a-p>>0,e[r+56]=c-m>>0}},a=(e,t)=>{e.fill(0);let n=(2097151&t)>>>1;for(let t=0;t<6;++t){const o=t>=2?0:64,c=64*t,a=65535&map16[n++],f=a>>10,d=a<<22>>22;let m=0;for(e[c]=r[o]*d;;){const t=65535&map16[n++];if(m+=1+(t>>10),m<=63){const n=t<<22>>22,l=r[o+m]*f*n>>3;e[c+s[m]]=l}if(m>63)break}l(e,c)}return n<<1},f=(e,r,t,n,s)=>{const c=1433*n>>10,l=-351*s-728*n>>10,a=1807*s>>10,f=(2097151&e)>>>0,d=map16;let m,p,b,i,k=u.STP;m=r[t+0]<<0,p=o(m,c),b=o(m,l),i=o(m,a),d[f+0>>>1]=k|i<<10|b<<5|p,m=r[t+1]<<0,p=o(m,c),b=o(m,l),i=o(m,a),d[f+2>>>1]=k|i<<10|b<<5|p,m=r[t+8]<<0,p=o(m,c),b=o(m,l),i=o(m,a),d[f+32>>>1]=k|i<<10|b<<5|p,m=r[t+9]<<0,p=o(m,c),b=o(m,l),i=o(m,a),d[f+34>>>1]=k|i<<10|b<<5|p},d=(e,r)=>{let t,n=0,o=64,s=128;for(t=0;t<16;t+=2,n+=8,o+=8,s+=16,r+=64)8==t&&(s+=64),f(r+0,e,s+0,e[n+0],e[o+0]),f(r+4,e,s+2,e[n+1],e[o+1]),f(r+8,e,s+4,e[n+2],e[o+2]),f(r+12,e,s+6,e[n+3],e[o+3]),f(r+16,e,s+64,e[n+4],e[o+4]),f(r+20,e,s+66,e[n+5],e[o+5]),f(r+24,e,s+68,e[n+6],e[o+6]),f(r+28,e,s+70,e[n+7],e[o+7])},m=(e,r,t,o,s)=>{const c=1433*o>>10,l=-351*s-728*o>>10,a=1807*s>>10,f=(2097151&e)>>>0,d=map8;let m;m=r[t+0]<<0,d[f+0]=n(m,c),d[f+1]=n(m,l),d[f+2]=n(m,a),m=r[t+1]<<0,d[f+3]=n(m,c),d[f+4]=n(m,l),d[f+5]=n(m,a),m=r[t+8]<<0,d[f+48]=n(m,c),d[f+49]=n(m,l),d[f+50]=n(m,a),m=r[t+9]<<0,d[f+51]=n(m,c),d[f+52]=n(m,l),d[f+53]=n(m,a)},p=(e,r)=>{let t,n=0,o=64,s=128;for(t=0;t<16;t+=2,n+=8,o+=8,s+=16,r+=96)8==t&&(s+=64),m(r+0,e,s+0,e[n+0],e[o+0]),m(r+6,e,s+2,e[n+1],e[o+1]),m(r+12,e,s+4,e[n+2],e[o+2]),m(r+18,e,s+6,e[n+3],e[o+3]),m(r+24,e,s+64,e[n+4],e[o+4]),m(r+30,e,s+66,e[n+5],e[o+5]),m(r+36,e,s+68,e[n+6],e[o+6]),m(r+42,e,s+70,e[n+7],e[o+7])},u={r1820:0,r1824:2147745792,rl:0,STP:0,end:0,block:new Int32Array(384),rd32r1820:()=>u.r1820,wr32r1820:e=>{u.r1820=e},rd32r1824:()=>u.r1824,wr32r1824:e=>{2147483648&e&&(u.r1820=0,u.r1824=2147745792,psx.unsetEvent(u.event))},dmaTransferMode0201:(e,t)=>{if(!(8388607&e))return 16;e&=2097151;const n=(t>>>16)*(65535&t);switch(u.r1820>>>29){case 1:u.rl=e;break;case 2:if(((e,t)=>{for(let n=0;n<t;++n){const t=255&map8[(e+n&2097151)>>>0];r[n]=t*c[s[63&n]]>>12}})(e,n<<2),1073741825!==u.r1820)return abort();break;default:console.log(hex(u.r1820>>>29))}return u.r1820&=4169138175,u.r1820|=(503316480&u.r1824)>>2,n},dmaTransferMode0200:(e,r)=>{if(!(8388607&e))return 16;e&=2097151;const t=(r>>>16)*(65535&r),n=u.block,o=e+(t<<2),s=u.r1820>>>27&3;u.end=o,u.STP=u.r1820&1<<25?32768:0;let c=0;for(;e<o;){switch(u.rl=a(n,u.rl),s){case 0:e+=128;break;case 1:e+=256;break;case 2:p(n,e),e+=768;break;case 3:d(n,e),e+=512}c+=6}const l=PSX_SPEED/9e3*(c/6);return psx.setEvent(u.event,l>>>0),t},event:null,complete:(e,r)=>{dma.completeDMA1({}),psx.unsetEvent(e)}};u.event=psx.addEvent(0,u.complete.bind(u));for(let e=0;e<256;++e)t[0+e]=0,t[256+e]=e,t[512+e]=255;return{mdc:u}}));mdlr('enge:psx:mmu',(r=>{const{dma:e}=r.require('enge:psx:dma'),{rtc:c}=r.require('enge:psx:rtc');window.dma=e;const t=new Int32Array(8388608),s=new Int8Array(t.buffer),a=new Int16Array(t.buffer),u=new DataView(t.buffer,0,2097152),n=new DataView(t.buffer,29360128,524288);return{map:t,map8:s,map16:a,ram:u,rom:n,memRead8:r=>r<8388608?(psx.clock+=2,u.getInt8(2097151&r)):r>=25165824&&r<25178112?(r=>{const t=16383&r;switch(psx.clock+=3,!0){case t>=4352&&t<4400:return c.rd32(t);case t>=7168&&t<8192:return!(1&t)&&spu.getInt16(t)}switch(16383&r){case 4160:return joy.rd08r1040();case 4164:return joy.rd16r1044()<<24>>24;case 4180:return 0;case 4192:return s[r>>>0]>>0;case 4208:return cpu.istat<<24>>24;case 4336:return e.rd16r10f0()<<24>>24;case 4342:return e.rd08r10f6();case 6144:return cdr.rd08r1800();case 6145:return cdr.rd08r1801();case 6146:return cdr.rd08r1802();case 6147:return cdr.rd08r1803();case 6164:return gpu.rd32r1814()<<24>>24;case 6180:return mdc.rd32r1824()<<24>>24;default:if(r<25169920)return psx.clock-=3,s[r>>>0];if(r>=25174016)return psx.clock+=10,s[r>>>0]}})(r)<<24>>24:r>=27262976&&r<27787264?(psx.clock+=5,s[r>>>0]>>0):r>=29360128&&r<29884416?(psx.clock+=8,s[r>>>0]>>0):r>=16777216&&r<17301504?(psx.clock+=6,s[r>>>0]>>0):33423664===r?s[r>>>0]>>0:void abort(hex(r,8)),memRead16:r=>r<8388608?(psx.clock+=3,u.getInt16(2097151&r,!0)):r>=25165824&&r<25178112?(r=>{const t=16383&r;switch(psx.clock+=3,!0){case t>=4352&&t<4400:return c.rd32(t);case t>=7168&&t<8192:return spu.getInt16(t)}switch(16383&r){case 4116:return a[r>>>1];case 4164:return joy.rd16r1044();case 4170:return joy.rd16r104a();case 4174:return joy.rd16r104e();case 4180:case 4186:case 4190:case 4400:return 0;case 4192:return a[r>>>1]>>0;case 4208:return cpu.istat;case 4212:return cpu.imask;case 4336:return e.rd16r10f0();case 6144:return cdr.rd08r1800();case 6164:return gpu.rd32r1814()<<16>>16;case 6180:return mdc.rd32r1824()<<16>>16;default:if(r<25169920)return psx.clock-=3,a[r>>>1];if(r>=25174016)return psx.clock+=24,a[r>>>1]}})(r)<<16>>16:r>=27262976&&r<27787264?(psx.clock+=5,a[r>>>1]>>0):r>=29360128&&r<29884416||r>=16777216&&r<17301504?(psx.clock+=12,a[r>>>1]):33423664===r?a[r>>>1]>>0:void abort(hex(r,8)),memRead32:r=>r<8388608?(psx.clock+=5,u.getInt32(2097151&r,!0)):r>=25165824&&r<25178112?(r=>{const s=16383&r;if(psx.clock+=3,1==(s>=4352&&s<4400))return c.rd32(s);switch(16383&r){case 4116:case 4128:case 4192:return t[r>>>2]>>0;case 4164:return joy.rd16r1044()>>0;case 4180:return 0;case 4208:return cpu.istat>>0;case 4212:return cpu.imask>>0;case 4224:return e.r1080>>0;case 4232:return e.r1088>>0;case 4240:return e.r1090>>0;case 4248:return e.r1098>>0;case 4256:return e.r10a0>>0;case 4264:return e.r10a8>>0;case 4272:return e.r10b0>>0;case 4280:return e.r10b8>>0;case 4288:return e.r10c0>>0;case 4296:return e.r10c8>>0;case 4320:return e.r10e0>>0;case 4328:return e.r10e8>>0;case 4336:return e.rd32r10f0()>>0;case 4340:return e.rd32r10f4()>>0;case 6144:return cdr.rd08r1800();case 6160:return gpu.rd32r1810()>>0;case 6164:return gpu.rd32r1814()>>0;case 6176:return mdc.rd32r1820()>>0;case 6180:return mdc.rd32r1824()>>0;default:if(r<25169920)return psx.clock-=3,t[r>>>2]>>0;if(r>=25174016)return psx.clock+=56,t[r>>>2]>>0;if(r>=25172992&&r<25174016)return 65535&spu.getInt16(16383&r)|spu.getInt16(r+2&16383)<<16}abort(hex(r,8))})(r)>>0:r>=27262976&&r<27787264?(psx.clock+=9,t[r>>>2]>>0):r>=29360128&&r<29884416?(psx.clock+=24,t[r>>>2]>>0):33423664===r?t[r>>>2]>>0:r>=16777216&&r<17301504?(psx.clock+=24,t[r>>>2]):void abort(hex(r,8)),memWrite8:(r,c)=>{if(r<8388608){const e=2097151&r;return s[(e|cpu.forceWriteBits)>>>0]=c,void(fastCache[e]=0)}if(r>=25165824&&r<25174016)return s[r>>>0]=c,void(r>=25169920&&((r,c)=>{switch(16383&r){case 4160:return joy.wr08r1040(c);case 4342:return e.wr08r10f6(c);case 6144:return cdr.wr08r1800(c);case 6145:return cdr.wr08r1801(c);case 6146:return cdr.wr08r1802(c);case 6147:return cdr.wr08r1803(c)}abort(hex(r,8))})(r,c));25174081!==r?abort(hex(r,8)):s[r>>>0]=c},memWrite16:(r,t)=>{if(r<8388608){const e=2097151&r;return a[(e|cpu.forceWriteBits)>>>1]=t,void(fastCache[e]=0)}if(r>=25165824&&r<25174016)return a[r>>>1]=t,void(r>=25169920&&((r,t)=>{const s=16383&r;switch(!0){case s>=4352&&s<4400:return void c.wr32(s,t);case s>=7168&&s<8192:return void spu.setInt16(s,t>>>0)}switch(16383&r){case 4116:return a[r>>>1]=t;case 4168:return joy.wr16r1048(t);case 4170:return joy.wr16r104a(t);case 4174:return joy.wr16r104e(t);case 4184:case 4186:case 4190:return;case 4208:return void(cpu.istat&=65535&t&cpu.imask);case 4212:return void(cpu.imask=t);case 4336:return e.wr32r10f0(t)}abort(hex(r,8))})(r,t));abort(hex(r,8))},memWrite32:(r,s)=>{if(r<8388608){const e=2097151&r;return t[(e|cpu.forceWriteBits)>>>2]=s,void(fastCache[e]=0)}if(r>=25165824&&r<25174016)return t[r>>>2]=s,void(r>=25169920&&((r,t)=>{const s=16383&r;switch(!0){case s>=4352&&s<4400:return void c.wr32(s,t);case s>=7168&&s<8192:return spu.setInt16(s+0,t>>>0),void spu.setInt16(s+2,t>>>16)}switch(s){case 4096:case 4100:case 4104:case 4108:case 4112:case 4116:case 4120:case 4124:case 4128:case 4192:return;case 4208:return void(cpu.istat&=t&cpu.imask);case 4212:return void(cpu.imask=t>>>0);case 4224:return void(e.r1080=t>>>0);case 4228:return void(e.r1084=t>>>0);case 4232:return void e.wr32r1088(t);case 4240:return void(e.r1090=t>>>0);case 4244:return void(e.r1094=t>>>0);case 4248:return void e.wr32r1098(t);case 4256:return void(e.r10a0=t>>>0);case 4260:return void(e.r10a4=t>>>0);case 4264:return void e.wr32r10a8(t);case 4272:return void(e.r10b0=t>>>0);case 4276:return void(e.r10b4=t>>>0);case 4280:return void e.wr32r10b8(t);case 4288:return void(e.r10c0=t>>>0);case 4292:return void(e.r10c4=t>>>0);case 4296:return void e.wr32r10c8(t);case 4320:return void(e.r10e0=t>>>0);case 4324:return void(e.r10e4=t>>>0);case 4328:return void e.wr32r10e8(t);case 4336:return void e.wr32r10f0(t);case 4340:return void e.wr32r10f4(t);case 6160:return void gpu.wr32r1810(t);case 6164:return void gpu.wr32r1814(t);case 6176:return void mdc.wr32r1820(t);case 6180:return void mdc.wr32r1824(t)}abort(hex(r,8))})(r,s));33423664!==r?abort(hex(r,8)):t[r>>>2]=s}}}));mdlr('enge:psx:rec',(e=>{const t=e=>`(${e<<16>>16} + ${r()}) & 0x01ffffff`,r=()=>h.reg(h.rs),c=()=>h.reg(h.rt),n=(e,t)=>(e?h.reg(e)+' = ':'')+`${t};`,a={'02':(e,t)=>(e.stop=!0,e.jump=!0,e.skipNext=!0,e.branchTarget=(8388607&t)<<2,n(0,`target = _${hex(e.branchTarget)}`)),'03':(e,t)=>(e.stop=!0,e.jump=!0,e.branchTarget=(8388607&t)<<2,n(0,`target = _${hex(e.branchTarget)};\n`+e.reg(31)+' = 0x'+hex(e.pc+8))),'04':(e,t)=>(e.stop=!0,e.branchTarget=e.pc+4+4*(t<<16>>16),n(0,`target = (${r()} === ${c()}) ? _${hex(e.branchTarget)} : _${hex(e.pc+8)}`)),'05':(e,t)=>(e.stop=!0,e.branchTarget=e.pc+4+4*(t<<16>>16),n(0,`target = (${r()} !== ${c()}) ? _${hex(e.branchTarget)} : _${hex(e.pc+8)}`)),'06':(e,t)=>(e.stop=!0,e.branchTarget=e.pc+4+4*(t<<16>>16),n(0,`target = (${r()} <= 0) ? _${hex(e.branchTarget)} : _${hex(e.pc+8)}`)),'07':(e,t)=>(e.stop=!0,e.branchTarget=e.pc+4+4*(t<<16>>16),n(0,`target = (${r()} > 0) ? _${hex(e.branchTarget)} : _${hex(e.pc+8)}`)),'08':(e,t)=>n(e.rt,(t<<16>>16)+' + '+r()),'09':(e,t)=>n(e.rt,(t<<16>>16)+' + '+r()),'0A':(e,t)=>n(e.rt,'('+r()+' < '+(t<<16>>16)+') ? 1 : 0'),'0B':(e,t)=>n(e.rt,'(('+r()+' >>> 0) < ('+(t<<16>>16)+' >>> 0)) ? 1 : 0'),'0C':(e,t)=>n(e.rt,r()+' & 0x'+hex(t,4)),'0D':(e,t)=>n(e.rt,r()+' | 0x'+hex(t,4)),'0E':(e,t)=>n(e.rt,r()+' ^ 0x'+hex(t,4)),'0F':(e,t)=>n(e.rt,'0x'+hex((65535&t)<<16)),20:(e,r)=>n(e.rt,'(memRead8('+t(r)+') << 24) >> 24'),21:(e,r)=>n(e.rt,'(memRead16 ('+t(r)+') << 16) >> 16'),22:(e,r)=>n(0,'cpu.lwl('+e.rt+', '+t(r)+')'),23:(e,r)=>n(e.rt,'memRead32('+t(r)+')'),24:(e,r)=>n(e.rt,'memRead8('+t(r)+') & 0xff'),25:(e,r)=>n(e.rt,'memRead16('+t(r)+') & 0xffff'),26:(e,r)=>n(0,'cpu.lwr('+e.rt+', '+t(r)+')'),28:(e,r)=>n(0,'memWrite8('+t(r)+', '+c()+')'),29:(e,r)=>n(0,'memWrite16('+t(r)+', '+c()+')'),'2A':(e,r)=>n(0,'cpu.swl('+e.rt+', '+t(r)+')'),'2B':(e,r)=>n(0,`memWrite32(${t(r)}, ${c()})`),'2E':(e,r)=>n(0,'cpu.swr('+e.rt+', '+t(r)+')'),32:(e,r)=>n(0,'gte.set('+e.rt+', memRead32('+t(r)+'))'),'3A':(e,r)=>n(0,'memWrite32('+t(r)+', gte.get('+e.rt+'))'),40:(e,t)=>0===t?'':n(e.rd,c()+' << '+(t>>6&31)),42:(e,t)=>n(e.rd,c()+' >>> '+(t>>6&31)),43:(e,t)=>n(e.rd,c()+' >> '+(t>>6&31)),44:(e,t)=>n(e.rd,c()+' << ('+r()+' & 0x1f)'),46:(e,t)=>n(e.rd,c()+' >>> ('+r()+' & 0x1f)'),47:(e,t)=>n(e.rd,c()+' >> ('+r()+' & 0x1f)'),48:(e,t)=>(e.stop=!0,e.jump=!0,e.skipNext=!0,n(0,'target = getCacheEntry('+r()+')')),49:(e,t)=>(e.stop=!0,e.jump=!0,n(e.rd,'0x'+hex(e.pc+8)+';\ntarget = getCacheEntry('+r()+')')),'4C':(e,t)=>(e.stop=!0,e.syscall=!0,n(0,'target = cpuException(8 << 2, 0x'+hex(e.pc)+')')),'4D':(e,t)=>'//break',50:(e,t)=>n(e.rd,'cpu.hi'),51:(e,t)=>n(0,'cpu.hi = '+r()),52:(e,t)=>n(e.rd,'cpu.lo'),53:(e,t)=>n(0,'cpu.lo = '+r()),58:(e,t)=>{const a=n(0,'cpu.mult('+r()+', '+c()+')');return e.cycles+=8,a},59:(e,t)=>{const a=n(0,'cpu.multu('+r()+', '+c()+')');return e.cycles+=8,a},'5A':(e,t)=>{const a=n(0,'cpu.div('+r()+', '+c()+')');return e.cycles+=35,a},'5B':(e,t)=>{const a=n(0,'cpu.divu('+r()+', '+c()+')');return e.cycles+=35,a},60:(e,t)=>n(e.rd,r()+' + '+c()),61:(e,t)=>n(e.rd,r()+' + '+c()),62:(e,t)=>n(e.rd,r()+' - '+c()),63:(e,t)=>n(e.rd,r()+' - '+c()),64:(e,t)=>n(e.rd,r()+' & '+c()),65:(e,t)=>n(e.rd,r()+' | '+c()),66:(e,t)=>n(e.rd,r()+' ^ '+c()),67:(e,t)=>n(e.rd,'~('+r()+' | '+c()+')'),'6A':(e,t)=>n(e.rd,'('+r()+' < '+c()+') ? 1 : 0'),'6B':(e,t)=>n(e.rd,'(('+r()+' >>> 0) < ('+c()+' >>> 0)) ? 1 : 0'),80:(e,t)=>(e.stop=!0,e.branchTarget=e.pc+4+4*(t<<16>>16),n(0,`target = (${r()} < 0) ? _${hex(e.branchTarget)} : _${hex(e.pc+8)}`)),81:(e,t)=>(e.stop=!0,e.branchTarget=e.pc+4+4*(t<<16>>16),n(0,`target = (${r()} >= 0) ? _${hex(e.branchTarget)} : _${hex(e.pc+8)}`)),90:(e,t)=>(e.stop=!0,e.branchTarget=e.pc+4+4*(t<<16>>16),n(0,`target = (${r()} < 0) ? _${hex(e.branchTarget)} : _${hex(e.pc+8)};\n`+e.reg(31)+' = 0x'+hex(e.pc+8))),91:(e,t)=>(e.stop=!0,e.branchTarget=e.pc+4+4*(t<<16>>16),n(0,`target = (${r()} >= 0) ? _${hex(e.branchTarget)} : _${hex(e.pc+8)};\n`+e.reg(31)+' = 0x'+hex(e.pc+8))),A0:(e,t)=>n(e.rt,'cpu.getCtrl('+e.rd+')'),A4:(e,t)=>n(0,'cpu.setCtrl('+e.rd+', '+c()+')'),B0:(e,t)=>n(0,'cpu.rfe()'),C0:(e,t)=>n(e.rt,'gte.get('+e.rd+')'),C2:(e,t)=>n(e.rt,'gte.get('+(32+e.rd)+')'),C4:(e,t)=>n(0,'gte.set('+e.rd+', '+c()+')'),C6:(e,t)=>n(0,'gte.set('+(32+e.rd)+', '+c()+')'),D0:(e,t)=>(e.cycles+=gte.cycles(33554431&t),n(0,'gte.command(0x'+hex(33554431&t)+')')),invalid:(e,t)=>{abort('invalid instruction')}};a.D1=a.D0,a.D2=a.D0,a.D3=a.D0,a.D4=a.D0,a.D5=a.D0,a.D6=a.D0,a.D7=a.D0,a.D8=a.D0,a.D9=a.D0,a.DA=a.D0,a.DB=a.D0,a.DC=a.D0,a.DD=a.D0,a.DE=a.D0,a.DF=a.D0;const s=new Array(256);for(let e=0;e<256;++e)s[e]=a[`${hex(e,2).toUpperCase()}`]||a.invalid;function p(e,t){const r=u(e.pc),c=map[r>>2];let n=0;switch(c>>>26&63){default:n=0+(c>>>26&63);break;case 0:n=64+(c>>>0&63);break;case 1:n=128+(c>>>16&31);break;case 16:n=160+(c>>>21&31);break;case 18:n=192+(c>>>21&31)}e.rd=c>>>11&31,e.rs=c>>>21&31,e.rt=c>>>16&31,t.push(s[n](e,c))}const h={pc:0,rt:0,rs:0,rd:0,stop:!1,break:!1,syscall:!1,cause:!1,sr:!1,cycles:0,skipNext:!1,entry:null,branchTarget:0,jump:!1,entryPC:0,reg:e=>e?'gpr['+e+']':'0',clear:function(){h.branchTarget=0,h.jump=!1,h.stop=!1,h.break=!1,h.syscall=!1,h.cause=!1,h.sr=!1,h.cycles=0,h.skipNext=!1}},o=new Map,l=new Uint8Array(2097152);function u(e){let t=33554431&e;return t<8388608&&(t&=2097151),t}l.fill(0);let g=0;function i(){return this.code=(e=>{const t=e.pc>>>0;let r=(e=>{const t=e.pc>>>0;h.clear(),h.pc=t,h.entryPC=t,h.entry=e;const r=[];for(;!h.stop&&h.cycles<2048;)p(h,r),h.cycles+=1,h.pc+=4;if(!h.stop&&h.cycles>=64){h.branchTarget=h.pc>>>0&33554431,h.skipNext=!0,h.jump=!0;const e=n(0,`target = _${hex(h.branchTarget)}`);r.push(e)}return!h.stop||h.break||h.syscall||h.sr||(p(h,r),h.cycles+=1,h.pc+=4),160!==t&&176!==t&&192!==t||r.unshift(`trace(${t}, gpr[9]);`),r.push('psx.clock += '+h.cycles+';'),r})(e).join('\n').split('\n'),c=[h.branchTarget>>>0,h.skipNext?0:h.pc>>>0].filter((e=>null!==e||void 0!==e));return r.push(' '),r.push('return target;'),r.unshift("const gpr = cpu.gpr; let target;\n"),t<2097152&&(r.unshift(`if (!fastCache[${t}]) { return invalidateCache(this); }`),l[t]=1),((e,t,r)=>{const c=["  return function $"+hex(e).toUpperCase()+"(psx) { ++calls;\n    "+t.replace(/[\r\n]/g,'\n    ')+"\n  }"];return c.unshift(''),[...new Set(r?.filter((e=>e))||[])].forEach((e=>{c.unshift(`  const _${hex(e)} = getCacheEntry(0x${hex(e)});`)})),c.unshift("'use strict;'"),new Function(c.join('\n'))()})(t,r.filter((e=>e)).join('\n'),c)})(this),this}const d=33868800,x=0===window.location.href.indexOf('file://');let f=0,$=0,b=0;return psx.addEvent(0,(e=>{const t=renderer.fpsRenderCounter-b;b=renderer.fpsRenderCounter,x&&console.log(`${calls} ${(d/calls).toFixed(1)} ${g} ${context.counter-f}/${renderer.fpsCounter-$}/${t}`),psx.setEvent(e,d),f=context.counter,$=renderer.fpsCounter,g=0,calls=0})),window.calls=0,window.vector=null,window.fastCache=l,window.cached=o,window.invalidateCache=e=>(e.code=i,e),window.resetCacheEntry=e=>(e.code=i,e),{getCacheEntry:function(e){const t=u(e);let r=o.get(t);return r||(o.set(t,r=(e=>({pc:e>>>0,code:null}))(t)),r.code=i),r},clearCodeCache:function(e,t){const r=u(e);r>=2097152||(l.fill(0,r,r+t),++g)}}}));mdlr('enge:psx:rtc',(e=>{const s=new Float64Array(4),a=new Uint32Array(4),t=new Uint32Array(4),c=(e,c,r)=>{const n=8&a[e]?11:12;switch(n){case 11:var p=+(t[e]+1);break;case 12:p=65536}let i=s[e]+c;return i>=p?(r?.onLimitReached(r),a[e]|=1<<n,i%p):i},r={freerun:!1,getValue:()=>{const e=r.freerun;let s=0;switch(7&a[0]){case 0:s=+(psx.clock-o.start);break;case 1:switch(o.whereInScanLine()){case-1:s=0;break;case 0:s=+(psx.clock-o.dispHStart);break;case 1:s=+(o.dispHStop-o.dispHStart)}break;case 3:switch(o.whereInScanLine()){case-1:case 0:s=+(psx.clock-o.start);break;case 1:s=+(psx.clock-o.dispHStop)}break;case 5:switch(o.whereInScanLine()){case-1:s=+(psx.clock-o.start);break;case 0:s=+(o.dispHStart-o.start);break;case 1:s=+(psx.clock-o.dispHStop)}break;case 7:switch(o.whereInScanLine()){case-1:case 0:s=e?+(psx.clock-o.start):0;break;case 1:s=e?+(psx.clock-o.start):+(psx.clock-o.dispHStop)}}return 256&a[0]?c(0,+gpu.cyclesToDotClock(s)):c(0,+s)},getTarget:()=>t[0],getMode:()=>{let e=a[0];return a[0]&=59391,e},setMode:e=>{a[0]=1023&e|1024;let t=0;switch(7&e){case 0:t=+(psx.clock-o.start);break;case 1:switch(o.whereInScanLine()){case-1:t=0;break;case 0:t=+(psx.clock-o.dispHStart);break;case 1:t=0}break;case 3:case 5:switch(o.whereInScanLine()){case-1:case 0:t=0;break;case 1:t=+(psx.clock-o.dispHStop)}break;case 7:r.freerun=!1,t=0}256&a[0]?(s[0]=0,c(0,-gpu.cyclesToDotClock(t))):(s[0]=0,c(0,-t))},setTarget:e=>{e||(e=65535),t[0]=e},setValue:e=>{s[0]=e},onLimitReached:()=>{48&a[0]&&(cpu.istat|=16)},onScanLine:()=>{const e=r.freerun;let t=0;switch(7&a[0]){case 0:t=+(o.stop-o.start);break;case 1:t=+(o.dispHStop-o.dispHStart);break;case 3:case 5:switch(o.whereInScanLine()){case-1:case 0:t=0;break;case 1:t=-+(psx.clock-o.dispHStop)}break;case 7:t=e?+(o.stop-o.start):+(o.stop-o.dispHStop),r.freerun=!0}256&a[0]?s[0]=c(0,gpu.cyclesToDotClock(t),r):s[0]=c(0,t,r)}},n={freerun:!1,getValue:()=>{switch(263&a[1]){case 0:return c(1,+(psx.clock-o.start));case 1:return c(1,o.isInVBlank()?0:+psx.eventCycles(o.event));case 3:return c(1,+psx.eventCycles(o.event));case 5:return c(1,(o.isInVBlank(),0));case 7:return n.freerun?c(1,+psx.eventCycles(o.event)):c(1,0);case 256:case 257:case 259:case 261:return c(1,0);case 263:return n.freerun,c(1,0)}},getTarget:()=>t[1],getMode:()=>{let e=a[1];return a[1]&=59391,e},setMode:e=>{switch(a[1]=(319&e|1024)>>>0,263&a[1]){case 0:case 1:case 3:case 5:s[1]=-+(psx.clock-o.start),s[1]=c(1,0);break;case 7:case 263:n.freerun=!1,s[1]=0;break;case 256:case 257:case 259:case 261:s[1]=0}},setTarget:e=>{e||(e=65535),t[1]=e>>>0},setValue:e=>{s[1]=+e},onLimitReached:()=>{48&a[1]&&(cpu.istat|=32)},onScanLine:e=>{const t=+(o.stop-o.start);switch(263&a[1]){case 0:s[1]=c(1,t,n);break;case 1:s[1]=c(1,o.isInVBlank()?0:t,n);break;case 3:s[1]=c(1,t,n),e&&(s[1]=0);break;case 5:s[1]=c(1,o.isInVBlank()?t:0,n),o.isInVBlank()&&(s[1]=0);break;case 7:n.freerun?s[1]=c(1,t,n):(s[1]=c(1,0,n),e&&(n.freerun=!0));break;case 256:s[1]=c(1,1,n);break;case 257:s[1]=c(1,o.isInVBlank()?0:1,n);break;case 259:s[1]=c(1,1,n),e&&(s[1]=0);break;case 261:s[1]=c(1,o.isInVBlank()?0:1,n),e&&(s[1]=0);break;case 263:n.freerun?s[1]=c(1,1,n):(s[1]=c(1,0,n),e&&(n.freerun=!0))}}},p={getValue:()=>{switch(519&a[2]){case 0:case 3:case 5:case 8:return c(2,+(psx.clock-o.start));case 1:case 7:return c(2,0);case 512:return c(2,.125*+(psx.clock-o.start))}},getTarget:()=>t[2],getMode:()=>{let e=a[2];return a[2]&=59391,e},setMode:e=>{switch(a[2]=1023&e|1024,519&a[2]){case 0:case 3:case 5:s[2]=-+(psx.clock-o.start),s[2]=c(2,0);break;case 1:case 7:s[2]=0;break;case 8:s[2]=-1*psx.eventCycles(o.event);break;case 512:s[2]=-.125*psx.eventCycles(o.event)}},setTarget:e=>{e||(e=65535),t[2]=65535&e},setValue:e=>{s[2]=e},onLimitReached:()=>{48&a[2]&&(cpu.istat|=64)},onScanLine:()=>{switch(519&a[2]){case 0:case 3:case 5:s[2]=c(2,+(o.stop-o.start),p);break;case 1:case 7:s[2]=c(2,0,p);break;case 512:s[2]=c(2,.125*+(o.stop-o.start),p)}}},i=+Number.MAX_SAFE_INTEGER,o={event:null,remainder:0,scanLine:0,vblank:!1,dispHStart:i,dispHStop:i,start:i,stop:i,upateToLastGpuState:e=>{const s=7*(gpu.status>>20&1?3406:3413)/11*(PSX_SPEED/33868800);o.start=+e.clock,o.stop=+s+o.start,o.dispHStart=o.start+7*+gpu.dispL/11,o.dispHStop=o.start+7*+gpu.dispR/11},complete:e=>{o.upateToLastGpuState(e);const s=gpu.status>>20&1?314:263;o.scanLine=(o.scanLine+1)%s,o.vblank=o.scanLine<gpu.dispT||o.scanLine>=gpu.dispB,r.onScanLine(),n.onScanLine(o.scanLine===gpu.dispB),p.onScanLine(),gpu.onScanLine(o.scanLine);let a=o.stop-o.start;psx.updateEvent(e,+a)},isInVBlank:()=>o.vblank,whereInScanLine:()=>psx.clock<o.dispHStart?-1:psx.clock<o.dispHStop?0:1},u={rd32:e=>{switch(!0){case 4352===e:return r.getValue();case 4356===e:return r.getMode();case 4360===e:return r.getTarget();case 4368===e:return n.getValue();case 4372===e:return n.getMode();case 4376===e:return n.getTarget();case 4384===e:return p.getValue();case 4388===e:return p.getMode();case 4392===e:return p.getTarget()}},wr32:(e,s)=>{switch(!0){case 4352===e:return r.setValue(s);case 4356===e:return r.setMode(s);case 4360===e:return r.setTarget(s);case 4368===e:return n.setValue(s);case 4372===e:return n.setMode(s);case 4376===e:return n.setTarget(s);case 4384===e:return p.setValue(s);case 4388===e:return p.setMode(s);case 4392===e:return p.setTarget(s)}}};return o.event=psx.addEvent(0,o.complete.bind(o)),s.fill(0),a.fill(0),t.fill(65535),{rtc:u}}));mdlr('enge:psx:serial',(e=>{const r=[e.require('enge:psx:serial-device').setId(0),e.require('enge:psx:serial-device').setId(1)],n=(e,r)=>{let n=e.sendReceiveByte(255&r),t=e.hasMore();s(n,!t)},s=(e,r)=>{c|=2,a=255&e,r||psx.setEvent(t,8*i>>>0)},t=psx.addEvent(0,((e,r)=>{c|=512,cpu.istat|=128,psx.unsetEvent(e)}));let i=136,a=0,d=0,c=0,l=0,o={devices:r,rd08r1040:()=>(2&c&&(c&=-3),a),rd16r1044:()=>c,rd16r104a:()=>l,rd16r104e:()=>i,wr08r1040:function(e){let t=null;switch(0==(2&l)&&abort(),2==(2&l)&&(t=8192&l?r[1]:r[0]),d){case 0:if(!t)return s(255,!0);s(255,!1),d=255&e,129===d&&t.init(),1===d&&t.init();break;case 1:t.buildControllerResponse(255&e),d=2;case 2:n(t,e);break;case 129:t.buildMemCardResponse(255&e),d=130;case 130:n(t,e);break;case 131:return s(255,!0);default:console.warn('unknown command state:',hex(d,4),' device:',t.id)}},wr16r1048:e=>{13!==e&&abort(hex(e,4))},wr16r104a:function(e){l=-81&e,(64&e||!(2&l))&&(2==(2&l)&&null.init(),psx.unsetEvent(t),d=0,c=5),16&e&&(c&=-513)},wr16r104e:function(e){136!==e&&abort(`invalid JOY_BAUD: $${hex(e,4)}`),i=65535&e}};return{joy:o}}));mdlr('enge:psx:serial-device',(e=>{const{encode:s}=e.require('base64'),t=new Uint8Array(131072),a=(e,s)=>{n.push(...e);for(let e=0;e<128;++e)n.push(-1);n.push(...s)};let r=0,c=0,n=[],h=[],i=0,o=0;return{lo:255,hi:255,setId:function(e){return r=e,this},setMemoryCard:e=>{for(let s=0;s<e.length;++s)t[s]=e[s]},init:()=>{c=0,n=[],h=[]},buildMemCardResponse:e=>{switch(c=e,e){case 82:a([0,90,93,0,-1,92,-1,-1,-1],[-1,71]);break;case 87:a([0,90,93,-1,-1],[-1,92,93,71]);break;default:n.push(255)}},buildControllerResponse:function(e){switch(c=e,e){case 66:n.push(65,90,this.lo,this.hi);break;case 67:n.push(255);break;default:return abort(hex(e,2))}},sendReceiveByte:e=>{n.length<=0&&console.log(`#${r}: reading unexpected in mode $${hex(c,2)}`);let a=n.shift()||0;if(82===c&&-1===a){const e=h.length;switch(!0){case 4===e:a=h[3];break;case 6===e:a=93;break;case 7===e:a=h[3],i=a;break;case 8===e:o=h[3]<<8|h[4],a=h[4],i^=a;break;case e>=9&&e<137:a=t[128*o+e-9],i^=a;break;case 137===e:a=255&i}}if(87===c&&-1===a){const c=h.length;switch(!0){case 3===c:a=h[3],i=a;break;case 4===c:a=h[3],i^=a,o=a<<8|e;break;case c>=5&&c<133:const n=128*o+c-5;a=t[n-1],t[n]=e,i^=e;break;case 133===c:a=t[132],localStorage.setItem(`card${r+1}`,s(t))}}return h.push(e),255&a},hasMore:()=>n.length>0}}));mdlr('enge:psx:spu',(e=>{const r=e.require('enge:psx:spu-reverb'),a=22050,t=new Uint8Array(524288),c=new Array(24),s=new DataView(t.buffer),n=new Map;psx.addEvent(0,(e=>{if(psx.updateEvent(e,768),!o||!l)return;p&=-64,p|=63&d,++k;let n=0,f=0;const b=k%512<<1;y.checkIrq();let I=[0,0],w=0,x=0;for(let e of c)if(e.advance(t,I)&&(n+=I[0],f+=I[1],e.reverb&&(w+=I[0],x+=I[1]),e.capture)){const r=32768*I[0]>>0;s.setInt16(e.capture+b,r,!0)}var O=[0,0];cdr.nextpcm(O);let q=O[0]*v,D=O[1]*m;{const e=32768*q>>>0;s.setInt16(0+b,e,!0)}{const e=32768*D>>>0;s.setInt16(1024+b,e,!0)}if(n+=q,f+=D,4&i&&(w+=q,x+=D),128&i){const[e,a]=r.advance(k,w,x,s);n+=e,f+=a}n*=g,f*=h,o[u]=n,l[u]=f,u=(u+1)%a,0===b&&(p&=-2049),512===b&&(p|=2048)}));let o=null,l=null,f=0,b=0,u=5512,k=0,i=0,p=0,d=0,g=0,h=0,v=0,m=0,I=0,w=0,y={ENDX:16777215,silence:()=>{if(o&&l)for(var e=0;e<a;++e)o[e]=l[e]=0},getVolume:e=>(e<<17>>16)/32768,getInt16:e=>{switch(e){case 7594:return i;case 7598:return-64&p|63&i;case 7580:return y.ENDX;default:return e>=7168&&e<7552?c[e-7168>>4].rd16(15&e):e>=7616&&e<7680?r.rd16(e):n.get(e)}},setInt16:(e,u)=>{switch(u&=65535,n.set(e,u),e){case 7552:g=y.getVolume(u);break;case 7554:h=y.getVolume(u);break;case 7556:case 7558:case 7586:r.wr16(e,u);break;case 7560:for(let e=0;e<16;++e)0!=(u&1<<e)&&(c[e].keyOn(),y.ENDX&=~(1<<e));break;case 7562:for(let e=0;e<8;++e)0!=(u&1<<e)&&(c[16+e].keyOn(),y.ENDX&=~(1<<16+e));break;case 7564:for(let e=0;e<16;++e)0!=(u&1<<e)&&c[e].keyOff();break;case 7566:for(let e=0;e<8;++e)0!=(u&1<<e)&&c[16+e].keyOff();break;case 7568:for(let e=0;e<16;++e)0!=(u&1<<e)&&c[e].modOn();break;case 7570:for(let e=0;e<8;++e)0!=(u&1<<e)&&c[16+e].modOn();break;case 7572:for(let e=0;e<16;++e)0!=(u&1<<e)&&c[e].noiseOn();break;case 7574:for(let e=0;e<8;++e)0!=(u&1<<e)&&c[16+e].noiseOn();break;case 7576:for(let e=0;e<16;++e)c[e].echoOn(u&1<<e);break;case 7578:for(let e=0;e<8;++e)c[16+e].echoOn(u&1<<e);break;case 7580:case 7582:case 7584:case 7596:case 7598:case 7608:case 7610:case 7612:case 7614:break;case 7588:b=u<<3;break;case 7590:f=u<<3;break;case 7592:f%=t.byteLength,s.setInt16(f,u,!0),f+=2,y.checkIrq();break;case 7594:!(128&i)&&128&u&&console.log('reverb','on'),128&i&&!(128&u)&&console.log('reverb','off'),i=u,o&&l||!(32768&i)||(()=>{const e=new AudioContext,r=e.createBuffer(2,a,e.sampleRate),t=e.createBufferSource();o=r.getChannelData(0),o.fill(0),l=r.getChannelData(1),l.fill(0),t.playbackRate.value=44100/e.sampleRate,t.buffer=r,t.loop=!0,t.connect(e.destination),t.start()})(),64&i&&(p&=-65),d=63&i;break;case 7600:v=(u<<16>>16)/32768;break;case 7602:m=(u<<16>>16)/32768;break;case 7604:I=(u<<16>>16)/32768;break;case 7606:w=(u<<16>>16)/32768;break;default:if(e>=7168&&e<7552){c[e-7168>>>4].wr16(15&e,u);break}if(e>=7616&&e<7680){r.wr16(e,u);break}abort(hex(e,4))}},dmaTransferMode0200:(e,r)=>{if(!(8388607&e))return 16;let a=(r>>16)*(65535&r)*4>>>0;for(;a>0;){f%=t.byteLength;const r=s.getInt16(f,!0);map16[(2097151&e)>>>1]=r,f+=2,a-=2,e+=2}return(r>>16)*(65535&r)},dmaTransferMode0201:(e,r)=>{if(!(8388607&e))return 16;let a=(r>>16)*(65535&r)*4>>>0;for(;a>0;){f%=t.byteLength;const r=map16[(2097151&e)>>>1];s.setInt16(f,r,!0),y.checkIrq(),f+=2,a-=2,e+=2}return(r>>16)*(65535&r)},checkIrq:e=>{if(32832!=(32832&i))return;const r=k%512<<1;let a=!1;void 0!==e?a=e.checkIrq(b):(f===b&&(a=!0),r===b&&(a=!0)),a&&(cpu.istat|=512,p|=64)}};for(let r=0;r<24;++r){const{voice:a}=e.require('enge:psx:spu-voice');c[r]=a.setId(r)}const x=new Float32Array(32);x.fill(0),x[2]=60/64,x[3]=0,x[4]=115/64,x[5]=-52/64,x[6]=98/64,x[7]=-55/64,x[8]=122/64,x[9]=-60/64;const O=new Float32Array(8192);for(let e=0;e<16;++e)for(let r=0;r<256;++r){const a=(e<<8)+r<<1;var q;32768&(q=(240&r)<<8)&&(q|=4294901760),O[a+1]=(q>>e)/32768,32768&(q=(15&r)<<12)&&(q|=4294901760),O[a+0]=(q>>e)/32768}return{spu:y,xa2flt:x,xa2pcm:O}}));mdlr('enge:psx:spu-reverb',(e=>{let t,n,r,s,l,o,c,d,g,u,a,p,v,w,x,I,b,h,m,M,f,i,j,k,q,y,z,A,B,C,D,E,F,G,H,J,K,L,N;const O=e=>e<<16>>16,P=e=>e<<16>>>13,Q=new Map([[7556,e=>t=O(e)],[7558,e=>n=O(e)],[7586,e=>K=r=e<<16>>>13],[7616,e=>s=P(e)],[7618,e=>l=P(e)],[7620,e=>o=O(e)],[7622,e=>c=O(e)],[7624,e=>d=O(e)],[7626,e=>g=O(e)],[7628,e=>u=O(e)],[7630,e=>a=O(e)],[7632,e=>p=O(e)],[7634,e=>v=O(e)],[7636,e=>w=P(e)],[7638,e=>x=P(e)],[7640,e=>I=P(e)],[7642,e=>b=P(e)],[7644,e=>h=P(e)],[7646,e=>m=P(e)],[7648,e=>M=P(e)],[7650,e=>f=P(e)],[7652,e=>i=P(e)],[7654,e=>j=P(e)],[7656,e=>k=P(e)],[7658,e=>q=P(e)],[7660,e=>y=P(e)],[7662,e=>z=P(e)],[7664,e=>A=P(e)],[7666,e=>B=P(e)],[7668,e=>C=P(e)],[7670,e=>D=P(e)],[7672,e=>E=P(e)],[7674,e=>F=P(e)],[7676,e=>G=O(e)],[7678,e=>H=O(e)]]),R=e=>r+(K+e)%(524288-r),S=e=>J.getInt16(R(e),!0),T=(e,t)=>J.setInt16(R(e),(e=>e<-32768?-32768:e>32767?32767:e)(t),!0),U=e=>e/32768>>0,V=e=>{const n=G*e;T(w,U((n+U(S(M)*a)-S(w-2))*o)+S(w-2)),T(i,U((n+U(S(B)*a)-S(i-2))*o)+S(i-2));let r=U(c*S(I))+U(d*S(h))+U(g*S(k))+U(u*S(y));return r-=U(p*S(C-s)),T(C,r),r=U(r*p)+S(C-s),r-=U(v*S(E-l)),T(E,r),r=U(r*v)+S(E-l),L=U(r*t)/32768},W=e=>{const t=H*e;T(x,U((t+U(S(f)*a)-S(x-2))*o)+S(x-2)),T(j,U((t+U(S(A)*a)-S(j-2))*o)+S(j-2));let r=U(c*S(b))+U(d*S(m))+U(g*S(q))+U(u*S(z));return r-=U(p*S(D-s)),T(D,r),r=U(r*p)+S(D-s),r-=U(v*S(F-l)),T(F,r),r=U(r*v)+S(F-l),K+=2,N=U(r*n)/32768};return{advance:(e,t,n,r)=>(J=r,1&e?[L,W(n)]:[V(t),N]),rd16:e=>{console.log('rd16',hex(e,4))},wr16:(e,t)=>{Q.get(e)(t)}}}));mdlr('enge:psx:spu-voice',(e=>{let r=114688,a=0,c=0,t=0,s=0,n=0,o=0,u=0,l=0,k=0,i=0,p=0,b=0,d=[],m=[],f=0,v=r,h=0,w=0,x=new Float32Array(28),O=0,y=0,g=0,I=0,q=new Uint16Array(16);const A=(e,r,a,t=c)=>{const s=r?(e?M:F)[t>>>28]:0,n=E[a+s];return e?-n:n},V=()=>{t=4},D={reverb:0,capture:0,setId:e=>(a=e,1===e&&(D.capture=2048),3===e&&(D.capture=3072),D),advance(e,E){if(!t)return t;v+=f,v>=r&&(v-=r,(e=>{const r=e[w+0],t=e[w+1],s=(15&r)>>>0,n=(240&r)>>>3,o=xa2flt[n+0],u=xa2flt[n+1];let l=-1;for(let r=2;r<16;++r){let a,c=(s<<8)+e[w+r]<<1;a=O*o+y*u+xa2pcm[c+0],y=O,O=x[++l]=a,a=O*o+y*u+xa2pcm[c+1],y=O,O=x[++l]=a}4==(4&t)&&(h=w),w+=16,1==(1&t)&&(w=h,spu.ENDX|=1<<a,0==(2&t)&&(V(),c=0))})(e),spu.checkIrq(D));const F=x[v>>>12],M=(()=>{switch(t){case 0:c=0;case 1:c+=A(0,s,n),c>=2147483647&&(t=2);break;case 2:c+=A(1,1,o),(c>>>27&15)<=k&&(t=3);break;case 3:c+=A(i,u,l);break;case 4:c+=A(1,p,b),c<=0&&(t=0)}return c>2147483647&&(c=2147483647),c<0&&(c=0),(q[12]=c>>>16)/32768})();return E[0]=F*M*g*X(d),E[1]=F*M*I*X(m),t},checkIrq:e=>w<=e&&e<w+16,keyOn(){O=0,y=0,v=r,w=q[6]<<3,h=q[14]<<3,t=1,c=0},echoOn(e){D.reverb=e},modOn(){},noiseOn(){},keyOff(){V()},rd16:e=>q[15&e],wr16(e,r){switch(q[15&e]=r,e%16){case 0:32768&r?d=U(r):(d=[],g=spu.getVolume(r));break;case 2:32768&r?m=U(r):(m=[],I=spu.getVolume(r));break;case 4:f=Math.min(r,16384);break;case 8:s=r>>>15&1,n=r>>>8&127,o=(r>>>4&15)<<3,k=1+(15&r);break;case 10:u=r>>>15&1,i=r>>>14&1,l=r>>>6&127,p=r>>>5&1,b=(31&r)<<2;break;case 14:h=r<<3}}},E=[],F=[0,0,0,0,0,0,8,8],M=[12,8,6,4,3,2,1,0],N=(e,r)=>e>r?e:r,U=e=>[16384&e?1:0,8192&e?1:0,e>>0&127,c],X=e=>{const{mode:r,direction:a,rate:c,level:t}=e;return void 0===r?1:(e[3]+=A(a,r,c,t),(e[3]>>>16)/32768)};for(let e=0;e<140;++e){const r=3&e,a=e>>2,c=1<<N(0,a-11),t=8-r<<N(0,11-a);E[e]=t/c*65536>>>0}return{voice:D}}));mdlr('enge:psx:trace',(e=>{const c=/[A-Za-z]{4}_[0-9]{3}\.[0-9]{2}/;let t='',n=null,r='';function o(e){t+=String.fromCharCode(e),10!==e&&13!==e||(t!==n&&(function(){const e=c.exec(t);if(e){let c=e[0].replace('.','').toUpperCase();r!==c&&(document.title=`eNGE - [${c}]`,r=c)}}(),n=t),console.debug(t),t='')}return{trace:function(e,c){switch(e){case 160:60===c&&o(cpu.gpr[4]);break;case 176:61===c&&o(cpu.gpr[4])}}}}));mdlr('enge:psx:webgl2',(e=>{Object.assign(window,e.require('enge:utils')),e.require('enge:webgl2'),e.require('enge:psx')}));mdlr('enge:utils',(t=>{const e=t.require('base64'),o=(()=>{const t=JSON.parse(localStorage.getItem('config')||'{}');return Object.assign({quality:1,overscan:0},t)})();return o.updateQuality=t=>{const e=document.getElementById('quality');e&&(t&&(o.quality<<=1,o.quality>4&&(o.quality=1),localStorage.setItem('config',JSON.stringify(o)),e.classList.add('restart')),e.innerText=`Q${o.quality}`)},window.addEventListener('storage',(()=>{const t=JSON.parse(localStorage.getItem('config')||'{}');Object.assign(o,t)})),{log:function(){console.log.call(console,('000000000000'+psx.clock).substr(-12)+']',Array.prototype.slice.call(arguments).join(''))},hex:function(t,e){return("00000000"+(t>>>0).toString(16)).substr(-(e||8))},readStorageStream:function(t,o){const n=localStorage.getItem(t);return o(n?e.decode(n):null)},writeStorageStream:function(t,o){const n=e.encode(o);localStorage.setItem(t,n)},settings:o}}));mdlr('enge:webgl2',(e=>{const{createVertexBuffer:r,createProgramFromScripts:a}=e.require('enge:webgl2:utils'),t={},d=new Uint32Array(65536),n=new Uint32Array(8388608),s=new Uint8Array(n.buffer),i=r(),l=document.getElementById('display'),o=document.querySelector('#ambilight').getContext('2d',{alpha:!1});o.imageSmoothingEnabled=!1;for(let e=0;e<65536;++e)d[e]=(e>>>0&31)<<3,d[e]|=(e>>>5&31)<<11,d[e]|=(e>>>10&31)<<19,d[e]|=e>>>15&1?4278190080:0;let u=null;try{u=l.getContext("webgl2",{alpha:!1,antialias:!1,preserveDrawingBuffer:!0,premultipliedAlpha:!1,depth:!1,stencil:!1})}catch(e){return abort()}const[T,E,R,c,h,f,p,A,x,g,b,m,w,D,B]=[u.ONE,u.ZERO,u.CONSTANT_ALPHA,u.BLEND,u.FUNC_ADD,u.STENCIL_TEST,u.FRAMEBUFFER,u.READ_FRAMEBUFFER,u.DRAW_FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_2D,u.RGBA,u.UNSIGNED_BYTE,u.NEAREST,u.COLOR_BUFFER_BIT],[S,y,V,F,M,P,C,L,N,O,U,I,v,H,Y,X]=[u.blendColor,u.blendFuncSeparate,u.blendEquationSeparate,u.enable,u.disable,u.getUniformLocation,u.texSubImage2D,u.bindFramebuffer,u.framebufferTexture2D,u.blitFramebuffer,u.enableVertexAttribArray,u.getAttribLocation,u.vertexAttribPointer,u.bindTexture,u.texImage2D,u.createFramebuffer].map((e=>e.bind(u))),k=(e,r,a,t,d,n,s=d,i=n)=>Math.abs(e-a)>1023||Math.abs(a-d)>1023||Math.abs(d-e)>1023||Math.abs(s-a)>1023||Math.abs(s-d)>1023||Math.abs(r-t)>511||Math.abs(t-n)>511||Math.abs(n-r)>511||Math.abs(i-t)>511||Math.abs(i-n)>511;function G(e,r=0){return 4278190080&e[0]|16316664&e[r]}function q(){F(u.DEPTH_TEST),L(p,ae),N(p,g,b,ee,0),N(p,u.DEPTH_ATTACHMENT,b,re,0),u.clearDepth(0),u.clear(u.DEPTH_BUFFER_BIT),L(p,null),primitiveId=1,M(u.DEPTH_TEST)}function W(e,r=!1,a=!1){if(a){const{x:e,y:r,w:a,h:t}=gpu.getDisplayArea();L(A,ae),N(A,g,b,ee,0),L(x,de),N(x,g,b,te,0),O(4*e,4*r,4*(e+a),4*(r+t),4*e,4*r,4*(e+a),4*(r+t),B,D)}else{const e=4*(r?t.daLold:t.daL),a=4*(r?t.daTold:t.daT),d=4*(r?t.daRold:t.daR+1),n=4*(r?t.daBold:t.daB+1);L(A,ae),N(A,g,b,ee,0),L(x,de),N(x,g,b,te,0),O(e,a,d,n,e,a,d,n,B,D)}L(p,null)}function z(e,r){e.size()&&(F(u.DEPTH_TEST),u.depthMask(!0),u.depthFunc(u.GREATER),renderer.setTransparencyMode(r,renderer.programRenderer),u.useProgram(renderer.programRenderer),u.viewport(0,0,4096,2048),u.bindBuffer(u.ARRAY_BUFFER,renderer.displayBuffer),u.bufferData(u.ARRAY_BUFFER,e,u.STREAM_DRAW,e.base(),e.bytes()),L(p,ae),N(p,g,b,ee,0),N(p,u.DEPTH_ATTACHMENT,b,re,0),H(b,te),u.drawArrays(u.TRIANGLES,0,e.size()),L(p,null),e.reset(),M(u.DEPTH_TEST))}let Z=4;const j=(e,r)=>{const a=33554432&r[0]?gpu.status>>5&3:4;return 4!==a&&a!==Z&&(J(),Z=a),e.buffers[a]},J=()=>{z(renderer.buffers[4],4),z(renderer.buffers[Z],Z)},K=(e,r,a={x:0,y:0,w:1024,h:512})=>{const d=e.programDisplay;l.width===a.w*settings.quality&&l.height===a.h*settings.quality||(l.width=o.canvas.width=a.w*settings.quality,l.height=o.canvas.height=a.h*settings.quality),u.viewport(0,0,l.width,l.height),u.useProgram(d);const n=gpu.getDisplayArea();u.uniform4i(d.displayArea,n.x,n.y,n.x+n.w-1,n.y+n.h-1),u.uniform1i(d.mode,r),u.uniform4i(d.drawArea,t.daL,t.daT,t.daR,t.daB),L(p,null),u.bindBuffer(u.ARRAY_BUFFER,e.displayBuffer),u.bufferData(u.ARRAY_BUFFER,(({x:e,y:r,w:a,h:t})=>(i.addVertex(0,0,e+0,r+0),i.addVertex(1024,0,e+a,r+0),i.addVertex(0,512,e+0,r+t),i.addVertex(0,512,e+0,r+t),i.addVertex(1024,0,e+a,r+0),i.addVertex(1024,512,e+a,r+t),i.view()))(a),u.STATIC_DRAW),u.activeTexture(u.TEXTURE0),H(b,ee),u.drawArrays(u.TRIANGLES,0,6),i.reset(),l.width&&l.height&&o.drawImage(l,0,0)},Q=24,$=()=>{const e=u.createTexture();return H(b,e),u.texParameteri(b,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(b,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),u.texParameteri(b,u.TEXTURE_MIN_FILTER,D),u.texParameteri(b,u.TEXTURE_MAG_FILTER,D),e},ee=$();Y(b,0,m,4096,2048,0,m,w,null);const re=((e,r)=>{const a=$();return Y(b,0,u.DEPTH_COMPONENT16,4096,2048,0,u.DEPTH_COMPONENT,u.UNSIGNED_SHORT,null),H(b,null),a})(),ae=X();L(p,ae),N(p,g,b,ee,0),H(b,re),N(p,u.DEPTH_ATTACHMENT,b,re,0),L(p,null);const te=$();Y(b,0,m,4096,2048,0,m,w,null);const de=X();L(p,de),N(p,g,b,te,0),L(p,null);const ne=$();Y(b,0,m,4096,2048,0,m,w,null);const se=X();window.primitiveId=0,window.nextPrimitive=()=>{++primitiveId},window.renderer=new class{buffers=[r(),r(),r(),r(),r(!0)];constructor(){this.mode='disp',this.fpsRenderCounter=0,this.fpsCounter=0,this.skipped=0,this.seenRender=!1,u?(M(f),M(u.DEPTH_TEST),M(c),M(u.CULL_FACE),M(u.DITHER),M(u.POLYGON_OFFSET_FILL),M(u.SAMPLE_COVERAGE),M(u.SCISSOR_TEST),U(0),S(0,0,0,0),u.clearDepth(0),this.displayBuffer=u.createBuffer(),this.programDisplay=(e=>{const r=a(u,'vertex','displayScreen');let t;return u.useProgram(r),r.displayArea=P(r,"u_disp"),r.mode=P(r,"u_mode"),r.drawArea=P(r,"u_draw"),u.bindBuffer(u.ARRAY_BUFFER,e),t=I(r,"a_position"),U(t),v(t,3,u.SHORT,!1,Q,0),t=I(r,"a_texcoord"),U(t),v(t,2,u.SHORT,!1,Q,6),r})(this.displayBuffer),this.renderBuffer=u.createBuffer(),this.programRenderer=(e=>{const r=a(u,'pixel','videoram');let t;return u.useProgram(r),r.drawArea=P(r,"u_draw"),t=I(r,"a_position"),U(t),v(t,3,u.SHORT,!1,Q,0),t=I(r,"a_texcoord"),U(t),v(t,2,u.SHORT,!1,Q,6),t=I(r,"a_color"),U(t),v(t,4,w,!0,Q,10),t=I(r,"a_twin"),U(t),v(t,4,w,!1,Q,14),t=I(r,"a_clut"),U(t),v(t,1,u.SHORT,!1,Q,18),t=I(r,"a_tmode"),U(t),v(t,1,u.BYTE,!1,Q,20),r})(this.renderBuffer),H(b,ee),n.fill(0),C(b,0,0,0,4096,2048,m,w,s),q()):alert("Error: Your browser does not appear to support WebGL.")}loadImage(e,r,a,t,d){J(),L(A,ae),N(A,g,b,ee,0),L(x,se),N(x,g,b,ne,0),O(4*e,4*r,4*(e+a),4*(r+t),e,r,e+a,r+t,B,D),L(A,se),u.readPixels(e,r,a,t,m,w,s);const i=a*t;for(let e=0;e<i;++e){const r=n[e];let a=0;a|=r>>>24&255?32768:0,a|=(r>>>19&31)<<10,a|=(r>>>11&31)<<5,a|=(r>>>3&31)<<0,d[e]=a}L(p,null)}moveImage(e,r,a,t,d,n){this.seenRender=!0,J(),L(A,ae),N(A,g,b,ee,0),L(x,de),N(x,g,b,te,0),O(4*e,4*r,4*(e+d),4*(r+n),4*a,4*t,4*(a+d),4*(t+n),B,D),L(A,de),N(A,g,b,te,0),L(x,ae),N(x,g,b,ee,0),O(4*a,4*t,4*(a+d),4*(t+n),4*a,4*t,4*(a+d),4*(t+n),B,D),L(A,de),N(A,g,b,te,0),L(x,se),N(x,g,b,ne,0),O(4*a,4*t,4*(a+d),4*(t+n),a,t,a+d,t+n,B,D),L(x,null),L(A,null),u.activeTexture(u.TEXTURE0+0)}storeImage(e){this.seenRender=!0,J();for(let r=0,a=e.pixelCount;r<a;++r){const a=e.buffer[r]>>>0;n[r]=d[a]}const{x:r,y:a,w:t,h:i}=e;H(b,ne),C(b,0,r,a,t,i,m,w,s),H(b,null),L(A,se),N(A,g,b,ne,0),L(x,ae),N(x,g,b,ee,0),O(r,a,r+t,a+i,4*r,4*a,4*(r+t),4*(a+i),B,D),L(A,ae),N(A,g,b,ee,0),L(x,de),N(x,g,b,te,0),O(4*r,4*a,4*(r+t),4*(a+i),4*r,4*a,4*(r+t),4*(a+i),B,D),L(p,null)}setTransparencyMode(e,r){switch(u.useProgram(r),7&e){case 0:F(c),V(h,h),y(R,R,T,E),S(0,0,0,.5);break;case 1:F(c),V(h,h),y(R,R,T,E),S(0,0,0,1);break;case 2:F(c),V(u.FUNC_REVERSE_SUBTRACT,h),y(E,u.ONE_MINUS_SRC_COLOR,T,E);break;case 3:F(c),V(h,h),y(u.ONE_MINUS_CONSTANT_ALPHA,T,T,E),S(0,0,0,.75);break;case 4:M(c)}}drawLine(e,r,a,d,n){this.seenRender=!0,this.updateDrawArea();var s=t.daX+(e[a]<<21>>21),i=t.daY+(e[a]<<5>>21),l=t.daX+(e[n]<<21>>21),o=t.daY+(e[n]<<5>>21);if(k(s,i,l,o,s,i))return;r=G(e,r),d=G(e,d);const u=j(renderer,e);var T=Math.abs(s-l),E=Math.abs(i-o),R=u;s!==l||i!==o?T>=E?(R.addVertex(s,i+1,0,0,r),R.addVertex(s,i+0,0,0,r),R.addVertex(l,o+0,0,0,d),R.addVertex(l,o+0,0,0,d),R.addVertex(l,o+1,0,0,d),R.addVertex(s,i+1,0,0,r)):(R.addVertex(s+0,i,0,0,r),R.addVertex(s+1,i,0,0,r),R.addVertex(l+1,o,0,0,d),R.addVertex(l+1,o,0,0,d),R.addVertex(l+0,o,0,0,d),R.addVertex(s+0,i,0,0,r)):(R.addVertex(l+0,o+0,0,0,d),R.addVertex(l+1,o+0,0,0,d),R.addVertex(l+0,o+1,0,0,d),R.addVertex(l+0,o+1,0,0,d),R.addVertex(l+1,o+0,0,0,d),R.addVertex(l+1,o+1,0,0,d))}drawTriangle(e,r,a,d,n,s,i,l,o,u,T,E,R){this.seenRender=!0,this.updateDrawArea();const c=t.daX+(e[a]<<21>>21),h=t.daY+(e[a]<<5>>21),f=t.daX+(e[n]<<21>>21),p=t.daY+(e[n]<<5>>21),A=t.daX+(e[i]<<21>>21),x=t.daY+(e[i]<<5>>21);if(k(c,h,f,p,A,x))return;r=G(e,r),d=G(e,d),s=G(e,s);const g=j(renderer,e),b=e[u]>>>0&255,m=e[u]>>>8&255,w=e[T]>>>0&255,D=e[T]>>>8&255,B=e[E]>>>0&255,S=e[E]>>>8&255;g.addVertex(c,h,b,m,r,R),g.addVertex(f,p,w,D,d,R),g.addVertex(A,x,B,S,s,R)}drawRectangle(e,r,a,d){this.seenRender=!0,this.updateDrawArea();var n=t.daX+(e[1]<<21>>21),s=t.daY+(e[1]<<5>>21),i=G(e,0),l=e[2]<<16>>16,o=e[2]>>16;if(!l||!o)return;if(k(n,s,n+l,s,n,s+o,n+l,s+o))return;const u=j(renderer,e);var T=r+0,E=r+l;gpu.txflip&&(T=r+0,E=r-l+1);var R=a+0,c=a+o;gpu.tyflip&&(R=a+0,c=a-o+1);var h=u;h.addVertex(n+0,s+0,T,R,i,d),h.addVertex(n+l,s+0,E,R,i,d),h.addVertex(n+0,s+o,T,c,i,d),h.addVertex(n+l,s+0,E,R,i,d),h.addVertex(n+0,s+o,T,c,i,d),h.addVertex(n+l,s+o,E,c,i,d)}fillRectangle(e){J();var r=e[1]<<16>>>16,a=e[1]<<0>>>16,t=e[2]<<16>>>16,d=e[2]<<0>>>16,i=16316664&e[0];(t||d)&&(r&=1008,a&=511,t=15+(1023&t)&-16,d&=511,n.fill(i,0,t*d),H(b,ne),C(b,0,r,a,t,d,m,w,s),H(b,null),L(A,se),N(A,g,b,ne,0),L(x,ae),N(x,g,b,ee,0),O(r,a,r+t,a+d,4*r,4*a,4*(r+t),4*(a+d),B,D),L(A,ae),N(A,g,b,ee,0),L(x,de),N(x,g,b,te,0),O(4*r,4*a,4*(r+t),4*(a+d),4*r,4*a,4*(r+t),4*(a+d),B,D),L(x,null),L(A,null),L(p,null))}updateDrawArea(){t.daM&&(J(),W(0,!0),q(),t.daM=!1,u.useProgram(this.programRenderer),u.uniform4i(this.programRenderer.drawArea,t.daL,t.daT,t.daR,t.daB))}setDrawAreaOF(e,r){t.daX=e,t.daY=r}setDrawAreaTL(e,r){t.daLold=t.daL,t.daTold=t.daT,t.daL=e,t.daT=r,t.daM=!0}setDrawAreaBR(e,r){t.daRold=t.daR,t.daBold=t.daB,t.daR=e,t.daB=r,t.daM=!0}onVBlankEnd(){}onVBlankBegin(){if(++this.fpsCounter,!this.seenRender)return;J(),q(),W(0,!1,!0),++this.fpsRenderCounter,this.seenRender=!1,this.setTransparencyMode(4,this.programDisplay);const e=gpu.getDisplayArea();switch(this.mode){case'clut4':K(this,3);break;case'clut8':K(this,2);break;case'draw':K(this,6);break;case'page2':K(this,7);break;case'disp':const r=settings.overscan*e.w,a=settings.overscan*e.h;e.x+=r>>1,e.y+=a>>1,e.w-=r>>0,e.h-=a>>0,K(this,gpu.status>>21&5,e)}}setMode(e){this.mode=e,this.seenRender=!0}}}));mdlr('enge:webgl2:utils',(e=>{function t(e,t,r){var n=document.getElementById(t);if(!n)throw"*** Error: unknown script element: "+t;var a=n.text;if(!r)if("x-shader/x-vertex"==n.type)r=e.VERTEX_SHADER;else if("x-shader/x-fragment"==n.type)r=e.FRAGMENT_SHADER;else if(!r)throw"*** Error: shader type not set";return function(e,t,r){var n=e.createShader(r);if(e.shaderSource(n,t),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS))throw"could not compile shader:"+e.getShaderInfoLog(n);return n}(e,a,r)}return{createProgramFromScripts:function(e,r,n){return function(e,t,r){var n=e.createProgram();if(e.attachShader(n,t),e.attachShader(n,r),e.linkProgram(n),!e.getProgramParameter(n,e.LINK_STATUS))throw"program filed to link:"+e.getProgramInfoLog(n);return n}(e,t(e,r,e.VERTEX_SHADER),t(e,n,e.FRAGMENT_SHADER))},createVertexBuffer:function(e=!1){const t=new Uint8Array(1048576),r=new DataView(t.buffer);let n=0;return t.addVertex=(t,a,i,o,s=8421504,u)=>{e&&(n-=24),r.setInt16(n+0,t,!0),r.setInt16(n+2,a,!0),r.setInt16(n+4,primitiveId,!0),r.setInt16(n+6,i,!0),r.setInt16(n+8,o,!0),r.setUint32(n+10,s,!0),r.setUint32(n+14,gpu.twin,!0),r.setUint16(n+18,u>>>0,!0),r.setUint8(n+20,gpu.status>>7&3|(31&gpu.status)<<2,!0),e||(n+=24)},t.reset=()=>{n=e?t.length:0},t.size=()=>e?(t.length-n)/24:n/24,t.view=()=>e?new Uint8Array(t.buffer,n,t.length-n):new Uint8Array(t.buffer,0,n),t.base=()=>e?n:0,t.bytes=()=>e?t.length-n:n,t.reset(),t}}}));mdlr('[unit]enge:psx:webgl2')