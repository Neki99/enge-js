'use strict';globalThis.mdlr=(()=>{let r,t,e={},l=(r,t,e={})=>u[r]?.l(t,{name:t,require:(u,a)=>([r,t]=n(u),e[u]??l(r,t,a))}),n=e=>([,r="unit",t]=/^(?:\[([a-z]+)\])?([-:a-z0-9_]+)$/.exec(e),[r,`[${r}]${t}`]),u={mdlr:{r:(r,t)=>{/^\[mdlr\]::[a-z]+$/.test(r)?t(u):e[r]=t},l:(r,t)=>e[r](t)}};return(e,a)=>{[r,t]=n(e),a?.constructor===Function?u[r]?.r(t,a):l(r,t,a)}})();mdlr('[mdlr]::unit',(l=>{let r={};l.unit={r:(l,t)=>{r[l]=t},l:(l,t)=>r[l](t)}}));mdlr('base64',(t=>{const e='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/',n={};return e.split('').forEach(((t,e)=>n[t]=e)),n['=']=0,{decode:function(t){let e=t.length,r=e/4*3;'='===t[e-2]&&--r,'='===t[e-1]&&--r;const o=new Uint8Array(r);let c=0;for(let r=0;r<e;r+=4){const e=n[t[r+0]]<<18|n[t[r+1]]<<12|n[t[r+2]]<<6|n[t[r+3]];o[c+0]=e>>16&255,o[c+1]=e>>8&255,o[c+2]=e>>0&255,c+=3}return o},encode:function(t){let n='';const r=new Uint8Array(t.buffer),o=r.byteLength,c=o%3,l=o-c;let f,s,u,i,a;for(let t=0;t<l;t+=3)a=r[t]<<16|r[t+1]<<8|r[t+2],f=a>>18&63,s=a>>12&63,u=a>>6&63,i=a>>0&63,n+=e[f]+e[s]+e[u]+e[i];return 1==c?(a=r[l],f=(252&a)>>2,s=(3&a)<<4,n+=e[f]+e[s]+'=='):2==c&&(a=r[l]<<8|r[l+1],f=(64512&a)>>10,s=(1008&a)>>4,u=(15&a)<<2,n+=e[f]+e[s]+e[u]+'='),n}}}));mdlr('enge:psx',(e=>{Object.assign(window,e.require('enge:psx:core'),e.require('enge:psx:trace')),Object.assign(window,e.require('enge:psx:serial'),e.require('enge:psx:gamepad'),e.require('enge:psx:cpu'),e.require('enge:psx:cdr'),e.require('enge:psx:mdec'),e.require('enge:psx:gpu'),e.require('enge:psx:gte'),e.require('enge:psx:dma'),e.require('enge:psx:mmu'),e.require('enge:psx:rec'),e.require('enge:psx:rtc'),e.require('enge:psx:spu')),Object.assign(window,e.require('enge:psx:index'))}));mdlr('enge:psx:cdr',(e=>{let a=new Int8Array(0),r=new Int16Array(0),s=24,c=0,t=0,n=0,b=0,k=0,l=0,i=0,f=0,d=255,u=0,h=!1,x=0,p=0,o=1,v=0,w=0,g=1,E=1,m=0,y=0,A=1,I=0,C=0,F=0,O=0,P={};const S=e=>e>>0,T=e=>16*S(e/10)+S(e%10),j=e=>10*S(e/16)+S(e%16),D=new Array(16),M=D.push.bind(D),X=new Array(16),q=new Float32Array(18816),z=new Float32Array(8064),B=[],G=[0,0],H=[0,0],J=e=>((255&e)>>>0)/128,K=e=>{f=224&f|31&e,31&f&d&&(cpu.istat|=4)},L=(e,...a)=>{s=-129&s|32,M(a),K(e)},N=()=>{X.length=0},Q=psx.addEvent(0,(e=>{if(psx.unsetEvent(e),31&f)return void R(64);const r=PSX_SPEED/(128&u?150:75),k=x-150;var l=n;switch(n=0,l){case 0:break;case 1:a.length?L(3,2):L(5,1);break;case 2:p=0!==X[0]||0!==X[1]||0!==X[2]?4500*j(X[0])+75*j(X[1])+j(X[2]):x,L(3,2);break;case 3:0!==X.length&&0!==X[0]||(x=p),1===X.length&&(P=B[j(X[0])],x=p=P.begin+150),V(r>>>0),t=3,L(3,130);break;case 6:V(r>>>0),t=6,L(3,66),x=p;break;case 7:L(3,0),n=112,s|=128;break;case 112:case 160:case 480:L(2,2);break;case 8:L(3,2),R((128&u?25845878:13863626)>>>0),n=128,s|=128;break;case 128:L(2,0);break;case 9:M(32|c),R((128&u?1097107:2168860)>>>0),n=144,s|=160,K(3);break;case 144:c=-33&c|2,M(c),s=-129&s|32,K(2);break;case 153:c=-161&c|2,M(c),s=-129&s|32,K(4);break;case 10:L(3,2),R(4096),n=160,s|=128;break;case 11:L(3,2),h=!0;break;case 12:L(3,2),h=!1;break;case 13:F=X[0],O=X[1],L(3,2);break;case 14:L(3,2),u=X[0];break;case 15:L(3,2,u,0,F,O);break;case 16:{const e=b+12;M(a[e+0],a[e+1],a[e+2],a[e+3],a[e+4],a[e+5],a[e+6],a[e+7]),s=-129&s|32,K(3)}break;case 17:{let e=x-150-P.begin,a=e/4500>>0,r=(e/75>>0)%60,c=e%75;M(T(P.id),1,T(a),T(r),T(c)),M(T((x-150)/75/60%60)),M(T((x-150)/75%60)),M(T((x-150)%75)),s=-129&s|32,K(3)}break;case 18:R(4096),n=288,c|=2,M(c),s|=32,K(3);break;case 288:c|=2;let e=k/4500>>0,l=(k/75>>0)%60,i=k%75;M(130,T(P.id),1,T(e),T(l),T(i),0,0),s=-129&s|32,K(1);break;case 19:c|=2,M(c,1,T(B.length-1)),s=-129&s|32,K(3);break;case 20:{let e=0,a=B[j(X[0])];if(!a){c|=16,M(17,128),s=-129&s|32,K(5);break}e=0===X[0]?S((a.end+150)/75):S((a.begin+150)/75),c|=2,M(c,T(S(e/60)),T(S(e%60))),s=-129&s|32,K(3)}break;case 21:R(4096),n=336,L(3,66),s|=128;break;case 336:case 352:L(2,2),x=p;break;case 22:R(4096),n=352,L(3,66),s|=128;break;case 25:M(153,2,1,195),s=-129&s|32,K(3);break;case 26:R(18944),M(c),n=416,s|=32,K(3);break;case 416:a.length?(M(2,0,32,0,101,78,71,69),s=-129&s|32,K(2)):(c|=16,M(17,128),s=-129&s|32,K(5));break;case 27:V(r>>>0),t=27,L(3,66),x=p;break;case 30:R(4096),n=480,L(3,2);break;default:abort(hex(n,2))}N()})),R=psx.setEvent.bind(psx,Q),U=psx.addEvent(0,(e=>{if(31&f)return void psx.updateEvent(e,64);let a=33868800/(128&u?150:75),r=x-150;switch(t){case 0:break;case 3:if(i=0,x===P.end&&2&u)return psx.unsetEvent(e),W(153);if(5==(5&u)){switch(r%75){case 0:case 20:case 40:case 60:{let e=r/4500>>0,a=(r/75>>0)%60,c=r%75;M(130,T(P.id),1,T(e),T(a),T(c),0,0),s=-129&s|96,K(1)}break;case 10:case 30:case 50:case 70:{let e=x-P.begin,a=e/4500>>0,r=(e/75>>0)%60,c=e%75;M(130,T(P.id),1,T(a),128|T(r),T(c),0,0),s=-129&s|96,K(1)}}Y(x),psx.updateEvent(e,a),x++;break}case 6:case 27:M(34),s=-129&s|96,K(1),Y(x),psx.updateEvent(e,a),x++;break;default:abort(hex(t,2)),psx.unsetEvent(U)}})),V=psx.setEvent.bind(psx,U),W=e=>{let a=512;switch(K(0),D.length=0,s|=128,n=e,e){case 1:a=50401;break;case 3:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 18:case 19:case 20:case 25:case 26:case 30:break;case 10:a=81102;case 2:case 6:case 7:case 8:case 21:case 22:case 27:case 9:ee();break;case 153:break;default:abort(hex(e,2))}R(a>>>0)},Y=e=>{if(a.length<=0)return;for(let a=1;a<B.length;++a){let r=P=B[a];if(r.begin<e&&e<r.end)break}b=2352*(e-150);let r=0;switch(48&u){case 0:k=24,r=2048;break;case 16:k=24,r=2328;break;case 32:case 48:k=12,r=2340}if(l=k+r,0!=(72&u)){if(2!==a[b+15])return;if(72==(72&u)){if(a[b+16]!==F)return;if(a[b+17]!==O)return}if(68!=(68&a[b+18]))return;let e,r,s=a[b+19];switch(s>>>0&3){case 0:e=Z;break;case 1:e=$}switch(s>>>2&1){case 0:r=37800;break;case 1:r=18900}I=0,z.fill(0),q.fill(0);let c=e?.call()||0,t=44100*c/r,n=0,k=0;c=-1;for(let e=0;e<t;e+=2)q[++c]=z[n+0],q[++c]=z[n+1],k+=r,k>=44100&&(k-=44100,n+=2);C=c}},Z=()=>{for(var e=0,r=0;r<18;++r)for(var s=b+24+128*r,c=0;c<8;++c)for(var t=a[s+4+c],n=(15&t)>>>0,k=(240&t)>>>3,l=xa2flt[k+0],i=xa2flt[k+1],f=0;f<28;++f){var d=2*(256*n+(255&a[s+16+4*f+c/2>>>0])),u=G[1]*l+G[0]*i+xa2pcm[d+(1&c)];G[0]=G[1],G[1]=u,z[e++]=u,z[e++]=u}return e},$=()=>{for(var e=0,r=0;r<18;++r)for(var s=b+24+128*r,c=0;c<8;c+=2){for(var t=(15&(u=a[s+4+c]))>>>0,n=(240&u)>>>3,k=xa2flt[n+0],l=xa2flt[n+1],i=0;i<28;++i){var f=2*(256*t+(255&a[s+16+4*i+c/2>>>0])),d=G[1]*k+G[0]*l+xa2pcm[f+0];G[0]=G[1],G[1]=d,z[e+2*i+0]=d}var u;for(t=(15&(u=a[s+5+c]))>>>0,n=(240&u)>>>3,k=xa2flt[n+0],l=xa2flt[n+1],i=0;i<28;++i)f=2*(256*t+(255&a[s+16+4*i+c/2>>>0])),d=H[1]*k+H[0]*l+xa2pcm[f+1],H[0]=H[1],H[1]=d,z[e+2*i+1]=d;e+=56}return e},ee=()=>{psx.unsetEvent(U),c&=-129,c&=-33,t=0};return{cdr:Object.seal({rd08r1800:()=>s,rd08r1801:()=>33==(35&s)?(1===D.length&&(s&=-97),D.shift()):0,rd08r1802:()=>64&s?a[b+k++]:0,rd08r1803:()=>{switch(3&s){case 0:return 224|d;case 1:return f}},wr08r1800:e=>{s=-4&s|3&e},wr08r1801:e=>{switch(3&s){case 0:W(e);break;case 3:A=J(e)}},wr08r1802:e=>{switch(3&s){case 0:X.push(e),16===X.length&&(s&=-17);break;case 1:d=e,f=0;break;case 2:E=J(e);break;case 3:y=J(e)}},wr08r1803:e=>{switch(3&s){case 0:128===e&&(s|=64);break;case 1:31&e&d&&(e=>{f&=~(31&e&d)})(e),64&e&&N();break;case 2:m=J(e);break;case 3:32&e&&(o=E,v=m,w=y,g=A)}},nextpcm:e=>{if(3===t){if(P.audio){let a=b+i>>1,s=r[a+0]/32768,c=r[a+1]/32768,t=s*o+c*w,n=c*g+s*v;e[0]=t,e[1]=n}return P.data&&(e[0]=0,e[1]=0),void(i+=4)}if(0!=(72&u)){I>=C-1&&(I=C-1);let a=q[I+0],r=q[I+1],s=a*o+r*w,c=r*g+a*v;e[0]=s,e[1]=c,I+=2}},dmaTransferMode0000:(e,a)=>{if(!(8388607&e))return 16;const c=(65535&a)<<2;clearCodeCache(e,c);for(let a=0;a<c;a+=2)map16[(2097151&e)>>1]=r[b+k>>1],k+=2,e+=2;return k>=l&&(s&=-65),c},setTOC:e=>{B.splice(0,B.length,...e)},setCdImage:e=>{r=new Int16Array(e.buffer),a=new Int8Array(e.buffer)}})}}));mdlr('enge:psx:core',(e=>{const c={clock:0,eventClock:0,events:[],inactiveEvents:[],lastId:0,addEvent:(e,t)=>{const n=Object.seal({id:c.lastId++,active:!0,clock:+c.clock+ +e,start:+c.clock,cb:t});return c.eventClock>n.clock&&(c.eventClock=n.clock),c.events.push(n),n},updateEvent:(e,t)=>(e.start=e.clock,e.clock+=+t,e.active=!0,c.eventClock>e.clock&&(c.eventClock=e.clock),e),unsetEvent:e=>{if(!e.active)return;const t=c.events.findIndex((c=>c.id===e.id));return-1!==t&&(c.inactiveEvents.push(e),c.events.splice(t,1),e.active=!1),e},eventCycles:e=>+c.clock-e.start,setEvent:(e,t)=>{if(!e.active){const t=c.inactiveEvents.findIndex((c=>c.id===e.id));-1!==t&&(c.inactiveEvents.splice(t,1),c.events.push(e))}return e.clock=+c.clock+ +t,e.start=+c.clock,e.active=!0,c.eventClock>e.clock&&(c.eventClock=e.clock),e},handleEvents:e=>{let t=Number.MAX_SAFE_INTEGER;const n=[];for(let e=0,t=c.events.length;e<t;++e){const t=c.events[e];c.clock>=t.clock&&n.push(t)}for(let e=0,t=n.length;e<t;++e){const t=n[e];t.cb(t,c.clock)}for(let e=0,n=c.events.length;e<n;++e){const n=c.events[e];n.clock<t&&n.active&&(t=n.clock)}return c.eventClock=t,cpuInterrupt(e)}};return Object.seal(c),{psx:c}}));mdlr('enge:psx:cpu',(s=>{const t={cause:0,cop:new Int32Array(32),cycles:0,epc:0,gpr:new Int32Array(32),hi:0,imask:0,istat:0,icurr:0,lo:0,pc:0,sr:0,forceWriteBits:0,getCtrl:function(s){switch(s){case 12:return this.sr>>0;case 13:return this.cause>>0;case 14:return this.epc>>0;case 15:return 2;default:return console.warn('getCtrl:'+s),this.cop[s]}},setCtrl:function(s,t){switch(this.cop[s]=t>>0,s){case 3:case 5:case 6:case 7:case 9:case 11:break;case 12:this.sr=t,this.forceWriteBits=65536&t?33554428:0;break;case 13:this.cause=4294966527&this.cause,this.cause|=768&t;break;default:cons1ole.warn('setCtrl:'+s)}},rfe:function(){this.sr=-16&this.sr|this.sr>>2&15},lwl:function(s,t){var i=memRead32(-4&t&33554431);switch(3&t){case 0:this.gpr[s]=16777215&this.gpr[s]|i<<24;break;case 1:this.gpr[s]=65535&this.gpr[s]|i<<16;break;case 2:this.gpr[s]=255&this.gpr[s]|i<<8;break;case 3:this.gpr[s]=0&this.gpr[s]|i<<0}},lwr:function(s,t){var i=memRead32(-4&t&33554431);switch(3&t){case 0:this.gpr[s]=0&this.gpr[s]|i>>>0;break;case 1:this.gpr[s]=4278190080&this.gpr[s]|i>>>8;break;case 2:this.gpr[s]=4294901760&this.gpr[s]|i>>>16;break;case 3:this.gpr[s]=4294967040&this.gpr[s]|i>>>24}},swl:function(s,t){var i=memRead32(-4&t&33554431)>>>0;switch(3&t){case 0:i=4294967040&i|this.gpr[s]>>>24;break;case 1:i=4294901760&i|this.gpr[s]>>>16;break;case 2:i=4278190080&i|this.gpr[s]>>>8;break;case 3:i=0&i|this.gpr[s]>>>0}memWrite32(-4&t&33554431,i)},swr:function(s,t){var i=memRead32(-4&t&33554431)>>>0;switch(3&t){case 0:i=0&i|this.gpr[s]<<0;break;case 1:i=255&i|this.gpr[s]<<8;break;case 2:i=65535&i|this.gpr[s]<<16;break;case 3:i=16777215&i|this.gpr[s]<<24}memWrite32(-4&t&33554431,i)},neg:function(s){var t=s>>0&65535,i=s>>16&65535,r=1+(65535&~t);return t=65535&r,(i=65535&(r=(65535&~i)+(r>>>16)))<<16|t},mult:function(s,t){t>>=0;var i=0;if((s>>=0)<0&&(i^=1,s=this.neg(s)),t<0&&(i^=1,t=this.neg(t)),this.multu(s,t),1===i){var r=this.lo>>>0&65535,e=this.lo>>>16&65535,c=this.hi>>>0&65535,h=this.hi>>>16&65535,a=1+(65535&~r);r=65535&a,e=65535&(a=(65535&~e)+(a>>>16)),c=65535&(a=(65535&~c)+(a>>>16)),h=65535&(a=(65535&~h)+(a>>>16)),this.hi=(h<<16|c)>>0,this.lo=(e<<16|r)>>>0}},multu:function(s,t){var i=65535&(s>>>=0),r=s>>>16,e=65535&(t>>>=0),c=t>>>16,h=0,a=0,n=0,u=0;n+=(u+=i*e)>>>16,u&=65535,a+=(n+=i*c)>>>16,n&=65535,a+=(n+=r*e)>>>16,n&=65535,h+=(a+=r*c)>>>16,a&=65535,this.hi=(h<<16|a)>>>0,this.lo=(n<<16|u)>>>0},div:function(s,t){0===t?s>>0>=0?(this.hi=s,this.lo=4294967295):(this.hi=s,this.lo=1):t>>0==-1&&s>>>0==2147483648?(this.hi=0,this.lo=-2147483648):(this.hi=(s>>0)%(t>>0)>>0,this.lo=(s>>0)/(t>>0)>>0)},divu:function(s,t){0===t?(this.hi=s,this.lo=4294967295):(this.hi=(s>>>0)%(t>>>0)>>>0,this.lo=(s>>>0)/(t>>>0)>>>0)}};function i(s,i){return t.sr=-64&t.sr|t.sr<<2&63,t.cause=-125&t.cause|s,t.epc=i,vector}return Object.seal(t),{cpu:t,cpuException:i,cpuInterrupt:function(s){if(1==(1&t.sr)){let r=768&t.cause,e=768&t.sr;if(0!=(r&e))return i(r&e,s.pc);if(1024==(1024&t.sr)&&t.istat&t.imask)return i(1024,s.pc)}return s}}}));mdlr('enge:psx:dma',(r=>{const t={dpcr:0,dicr:0,r1080:0,r1084:0,r1088:0,r1080n:0,r1090:0,r1094:0,r1098:0,r1090n:0,r10a0:0,r10a4:0,r10a8:0,r10a0n:0,r10b0:0,r10b4:0,r10b8:0,r10b0n:0,r10c0:0,r10c4:0,r10c8:0,r10c0n:0,r10e0:0,r10e4:0,r10e8:0,r10e0n:0,eventDMA0:null,completeDMA0:function(r,e){this.r1088&=4278190079,this.r1080=this.r1080n,65536&t.dicr&&(t.dicr|=2164260864,cpu.istat|=8),psx.unsetEvent(r)},eventDMA1:null,completeDMA1:function(r,e){this.r1098&=4278190079,this.r1090=this.r1090n,131072&t.dicr&&(t.dicr|=2181038080,cpu.istat|=8),psx.unsetEvent(r)},eventDMA2:null,completeDMA2:function(r,e){this.r10a8&=4278190079,this.r10a0=this.r10a0n,262144&t.dicr&&(t.dicr|=2214592512,cpu.istat|=8),psx.unsetEvent(r)},eventDMA3:null,completeDMA3:function(r,e){this.r10b8&=4278190079,this.r10b0=this.r10b0n,524288&t.dicr&&(t.dicr|=2281701376,cpu.istat|=8),psx.unsetEvent(r)},eventDMA4:null,completeDMA4:function(r,e){this.r10c8&=4278190079,this.r10c0=this.r10c0n,1048576&t.dicr&&(t.dicr|=2415919104,cpu.istat|=8),psx.unsetEvent(r)},eventDMA6:null,completeDMA6:function(r,e){this.r10e8&=4278190079,this.r10e0=this.r10e0n,4194304&t.dicr&&(t.dicr|=3221225472,cpu.istat|=8),psx.unsetEvent(r)},rd08r10f6:function(){return t.dicr>>16&255},rd16r10f0:function(){return 65535&t.dpcr},rd32r10f0:function(){return t.dpcr},rd32r10f4:function(){return 2147483647&t.dicr},wr32r10f0:function(r){t.dpcr=r},wr08r10f6:function(r){r=r<<16|65535&t.dicr,t.dicr=t.dicr&~(2130706432&r|16777215)|16777215&r},wr32r10f4:function(r){t.dicr=t.dicr&~(2130706432&r|16777215)|16777215&r},wr32r1088:function(r){if(this.r1088=r,8&t.dpcr){let t=10;switch(r){case 0:break;case 16777729:t=mdc.dmaTransferMode0201(this.r1080,this.r1084),this.r1080n=this.r1080+(t<<2);break;default:abort('mdi-ctrl:'+hex(r))}psx.setEvent(this.eventDMA0,272*t/256>>>0)}else this.r1088&=4278190079},wr32r1098:function(r){if(this.r1098=r,128&t.dpcr){let t=10;switch(r){case 0:break;case 16777728:t=mdc.dmaTransferMode0200(this.r1090,this.r1094),this.r1090n=this.r1090+(t<<2);break;default:abort('mdo-ctrl:'+hex(r))}}else this.r1098&=4278190079},wr32r10a8:function(r){if(this.r10a8=r,2048&t.dpcr){let t=10;switch(r){case 0:case 1:case 1025:case 513:break;case 16777728:t=gpu.dmaTransferMode0200(this.r10a0,this.r10a4)||10,this.r10a0n=this.r10a0+(t<<2);break;case 16777729:t=gpu.dmaTransferMode0201(this.r10a0,this.r10a4)||10,this.r10a0n=this.r10a0+(t<<2);break;case 16778241:t=gpu.dmaTransferMode0401(this.r10a0,this.r10a4)||10,this.r10a0n=16777215;break;default:abort('gpu-ctrl:'+hex(r))}psx.setEvent(this.eventDMA2,272*t/256>>>0)}else this.r10a8&=4278190079},wr32r10b8:function(r){if(this.r10b8=r,32768&t.dpcr){let t=10;switch(r){case 0:break;case 285212672:case 289407232:t=cdr.dmaTransferMode0000(this.r10b0,this.r10b4),this.r10b0n=this.r10b0+(t<<2);break;default:abort('cd-ctrl:'+hex(r))}psx.setEvent(this.eventDMA3,(t*(128&cdr.mode)?5120:10240)/256>>>0)}else this.r10b8&=4278190079},wr32r10c8:function(r){if(this.r10c8=r,524288&t.dpcr){let t=10;switch(r){case 513:break;case 16777216:case 16777728:t=spu.dmaTransferMode0200(this.r10c0,this.r10c4),this.r10c0n=this.r10c0+(t<<2);break;case 16777217:case 16777729:t=spu.dmaTransferMode0201(this.r10c0,this.r10c4),this.r10c0n=this.r10c0+(t<<2);break;default:abort('spu-ctrl:'+hex(r))}psx.setEvent(this.eventDMA4,1056*t/256>>>0)}else this.r10c8&=4278190079},wr32r10e8:function(r){if(this.r10e8=1342177282&r|2,134217728&t.dpcr){let t=10;switch(this.r10e8){case 2:this.r10e0n=this.r10e0=map[(33554431&this.r10e0)>>2];break;case 268435458:case 1342177282:t=gpu.dmaLinkedListMode0002(this.r10e0,this.r10e4),this.r10e0n=16777215;break;default:abort('otc-ctrl:'+hex(r)+' '+hex(this.r10e8))}psx.setEvent(this.eventDMA6,272*t/256>>>0)}else this.r10e8&=4278190079}};return Object.seal(t),{dma:t}}));mdlr('enge:psx:gamepad',(e=>{let t=null,s=null;const o=new Map;function n(e){if(t===e)return;t=e;const s=document.getElementById('gamepad');s&&(s.classList.remove(...s.classList),s.classList.add('connected'),s.classList.add(e))}return o.set(69,{bits:16,property:'hi'}),o.set(68,{bits:32,property:'hi'}),o.set(88,{bits:64,property:'hi'}),o.set(83,{bits:128,property:'hi'}),o.set(81,{bits:1,property:'hi'}),o.set(84,{bits:2,property:'hi'}),o.set(87,{bits:4,property:'hi'}),o.set(82,{bits:8,property:'hi'}),o.set(38,{bits:16,property:'lo'}),o.set(39,{bits:32,property:'lo'}),o.set(40,{bits:64,property:'lo'}),o.set(37,{bits:128,property:'lo'}),o.set(32,{bits:1,property:'lo'}),o.set(13,{bits:8,property:'lo'}),window.addEventListener("keydown",(function(e){const t=o.get(e.keyCode),s=joy.devices[0];void 0!==t&&(s[t.property]&=~t.bits,n('keyboard'))}),!1),window.addEventListener("keyup",(function(e){const t=o.get(e.keyCode),s=joy.devices[0];void 0!==t&&(s[t.property]|=t.bits)}),!1),window.addEventListener("gamepadconnected",(function(e){s=e.gamepad,console.log(`~~ Gamepad '${s.id}' connected  ~~`),document.getElementById('gamepad').classList.add('connected')})),window.addEventListener("gamepaddisconnected",(function(e){console.log(`~~ Gamepad '${s.id}' disconnected  ~~`),document.getElementById('gamepad').classList.remove('connected'),s=null})),{handleGamePads:function(){if(!s)return;const e=navigator.getGamepads()[s.index];if(e){const t=joy.devices[0];n('gamepad'),t.lo=255,e.axes[0]<=-.4&&(t.lo&=-129),e.axes[0]>=.4&&(t.lo&=-33),e.axes[1]<=-.4&&(t.lo&=-17),e.axes[1]>=.4&&(t.lo&=-65),e.buttons[14].pressed&&(t.lo&=-129),e.buttons[15].pressed&&(t.lo&=-33),e.buttons[12].pressed&&(t.lo&=-17),e.buttons[13].pressed&&(t.lo&=-65),e.buttons[8].pressed&&(t.lo&=-2),e.buttons[9].pressed&&(t.lo&=-9),t.hi=255,e.buttons[3].pressed&&(t.hi&=-17),e.buttons[1].pressed&&(t.hi&=-33),e.buttons[0].pressed&&(t.hi&=-65),e.buttons[2].pressed&&(t.hi&=-129),e.buttons[4].pressed&&(t.hi&=-5),e.buttons[6].pressed&&(t.hi&=-2),e.buttons[5].pressed&&(t.hi&=-9),e.buttons[7].pressed&&(t.hi&=-3)}}}}));mdlr('enge:psx:gpu',(e=>{const a=renderer,[t,n,d]=[a.drawLine,a.drawTriangle,a.drawRectangle].map((e=>e.bind(a))),c=new Set;var r=[1,1,3,1,1,1,0,0,1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,4,4,7,7,7,7,5,5,5,5,9,9,9,9,6,6,6,6,9,9,9,9,8,8,8,8,12,12,12,12,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,3,3,3,3,4,4,4,4,2,2,2,2,0,0,0,0,2,2,2,2,3,3,3,3,2,2,2,2,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];const l={dispB:256,dispL:0,dispR:0,dispT:16,dispX:0,dispY:0,dispW:0,dmaBuffer:new Int32Array(4096),dmaIndex:0,drawAreaX1:0,drawAreaX2:0,drawAreaY1:0,drawAreaY2:0,drawOffsetX:0,drawOffsetY:0,handlers:[],heights:[1,2,1,2],hline:0,img:{w:0,h:0,x:0,y:0,index:0,pixelCount:0,buffer:new Uint16Array(524288)},info:new Uint32Array(16),maxheights:[240,480,256,512],maxwidths:[256,368,320,368,512,368,640,368],packetSize:0,result:2,status:343941120,tp:0,transferTotal:0,twin:0,tx:0,txflip:0,ty:0,tyflip:0,widths:[10,7,8,7,5,7,4,7],frame:0,internalFrame:0,updated:!1,cyclesToDotClock:function(e){switch(l.status>>16&7){case 0:return 11*e/7/10;case 1:case 3:case 5:case 7:return 11*e/7/7;case 2:return 11*e/7/8;case 4:return 11*e/7/5;case 6:return 11*e/7/4}},getDisplayArea:function(){if(l.status>>20&1)var e=l.dispT%256,a=Math.min(l.dispB,314);else e=l.dispT%240,a=Math.min(l.dispB,263);var t=a-e,n=l.dispR-l.dispL,d=l.maxwidths[l.status>>16&7],c=n/l.widths[l.status>>16&7];c=Math.min(d,c+2&-4);var r=l.maxheights[l.status>>19&3],h=l.heights[l.status>>19&3]*t;return h=Math.min(r,h),{x:l.dispX,y:l.dispY,w:c,h}},onScanLine:function(e){l.hline=e;let a=l.status&1<<22,t=!!(l.status>>20&1),n=t?314:263,d=l.dispB-l.dispT>>1,c=t?163:136,r=c-d,h=c+d;h>n&&(h=n),r<0&&(r=0),a?1==(1&l.frame)?l.status|=2147483648:l.status&=2147483647:1==(1&l.hline+(1&l.frame))?l.status|=2147483648:l.status&=2147483647,l.hline===h&&renderer.onVBlankBegin(),l.hline===r&&renderer.onVBlankEnd(),(l.hline>=h||l.hline<r)&&(l.status&=2147483647),++l.hline>=n&&(l.updated&&++l.internalFrame,l.updated=!1,cpu.istat|=1,l.hline=0,++l.frame)},rd32r1810:function(){return 134217728&l.rR1814&&abort('gpu.rd32r1810 not implemented'),l.result},rd32r1814:function(){return l.status},wr32r1810:function(e){if(268435456&l.status){if(l.dmaBuffer[l.dmaIndex++]=e,1===l.dmaIndex&&(l.packetSize=r[e>>>24]),l.dmaIndex===l.packetSize){var a=l.dmaBuffer[0]>>>24;nextPrimitive(),l.handlers[a].call(this,l.dmaBuffer),l.dmaIndex=0}}else{if(l.img.buffer[l.img.index++]=e>>>0&65535,--l.transferTotal<=0)return void l.imgTransferComplete(l.img);if(l.img.buffer[l.img.index++]=e>>>16&65535,--l.transferTotal<=0)return void l.imgTransferComplete(l.img)}},wr32r1814:function(e){switch(e>>>24){case 0:l.status=344064e3,l.dmaIndex=0,l.dispL=512,l.dispR=3072,l.dispW=320,l.dispT=16,l.dispB=256,l.dispX=0,l.dispY=0,l.handlePacketE1([0]),l.handlePacketE2([0]),l.handlePacketE3([0]),l.handlePacketE4([0]),l.handlePacketE5([0]),l.handlePacketE6([0]),renderer.updateDrawArea?.call(renderer);break;case 1:l.status|=1879048192,l.dmaIndex=0;break;case 2:case 64:break;case 3:l.status&=4286578687,l.status|=(1&e)<<23;break;case 4:l.status&=2684354559,l.status|=(3&e)<<29;break;case 5:l.dispX=e>>0&1023,l.dispY=e>>10&511;break;case 6:l.dispL=e>>0&4095,l.dispR=e>>12&4095;var a=l.dispR-l.dispL,t=l.maxwidths[l.status>>16&7],n=a/l.widths[l.status>>16&7];l.dispW=Math.min(t,n+2&-4);break;case 7:l.dispT=e>>0&1023,l.dispB=e>>10&1023,l.dispB<l.dispT&&(l.dispB+=288);break;case 8:l.status&=4286644223,l.status|=(63&e)<<17,l.status|=64&e?65536:0;break;case 16:switch(15&e){case 2:case 3:case 4:case 5:case 7:case 8:l.result=l.info[15&e]}break;default:console.warn('gpu.cmnd'+hex(e>>>24,2))}l.updateTexturePage()},invalidPacketHandler:function(e){},updateTexturePage:function(e){switch(void 0!==e&&(l.status=-2560&l.status|2559&e),l.tx=(l.status>>>0&15)<<6,l.ty=(l.status>>>4&1)<<8,l.tp=l.status>>>7&3,l.tp){case 0:l.tx<<=2;break;case 1:l.tx<<=1;break;case 2:case 3:l.tx<<=0}},handlePacket00:function(e){},handlePacket01:function(e){l.status=-134217729&(268435456|l.status)},handlePacket02:function(e){renderer.fillRectangle(e)},handlePacket03:function(e){},handlePacket04:function(e){},handlePacket05:function(e){},handlePacket08:function(e){},handlePacket09:function(e){},handlePacket0D:function(e){},handlePacket20:function(e){n(e,0,1,0,2,0,3)},renderTexture:function(e,a){6==(6&e[0]>>>24)?(e[0]|=2147483648,a(),nextPrimitive(),e[0]&=-33554433,a()):a()},handlePacket24:function(e){l.updateTexturePage(e[4]>>>16),this.renderTexture(e,(()=>{n(e,0,1,0,3,0,5,l.tx,l.ty,2,4,6,e[2]>>>16)}))},handlePacket28:function(e){n(e,0,1,0,2,0,3),n(e,0,2,0,3,0,4)},handlePacket2C:function(e){l.updateTexturePage(e[4]>>>16),this.renderTexture(e,(()=>{n(e,0,1,0,3,0,5,l.tx,l.ty,2,4,6,e[2]>>>16),n(e,0,3,0,5,0,7,l.tx,l.ty,4,6,8,e[2]>>>16)}))},handlePacket30:function(e){n(e,0,1,2,3,4,5)},handlePacket34:function(e){l.updateTexturePage(e[5]>>>16),this.renderTexture(e,(()=>{n(e,0,1,3,4,6,7,l.tx,l.ty,2,5,8,e[2]>>>16)}))},handlePacket38:function(e){n(e,0,1,2,3,4,5),n(e,2,3,4,5,6,7)},handlePacket3C:function(e){l.updateTexturePage(e[5]>>>16),this.renderTexture(e,(()=>{n(e,0,1,3,4,6,7,l.tx,l.ty,2,5,8,e[2]>>>16),n(e,3,4,6,7,9,10,l.tx,l.ty,5,8,11,e[2]>>>16)}))},handlePacket40:function(e){t(e,0,1,0,2)},handlePacket48:function(e,a){for(var n=2;n<a;n+=1)t(e,0,n-1,0,n)},handlePacket50:function(e){t(e,0,1,2,3)},handlePacket58:function(e,a){for(var n=3;n<a;n+=2)t(e,n-3,n-2,n-1,n)},handlePacket60:function(e){d([e[0],e[1],e[2]],0,0,0)},handlePacket64:function(e){const a=e[2]>>>0&255,t=e[2]>>>8&255;this.renderTexture(e,(()=>{d([e[0],e[1],e[3]],a,t,e[2]>>>16)}))},handlePacket68:function(e){d([e[0],e[1],65537],0,0,0)},handlePacket70:function(e){d([e[0],e[1],524296],0,0,0)},handlePacket74:function(e){const a=e[2]>>>0&255,t=e[2]>>>8&255;this.renderTexture(e,(()=>{d([e[0],e[1],524296],a,t,e[2]>>>16)}))},handlePacket78:function(e){d([e[0],e[1],1048592],0,0,0)},handlePacket7C:function(e){const a=e[2]>>>0&255,t=e[2]>>>8&255;this.renderTexture(e,(()=>{d([e[0],e[1],1048592],a,t,e[2]>>>16)}))},handlePacket80:function(e){if(e[1]!==e[2]){var a=e[1]>>0,t=e[1]>>16,n=e[2]>>0,d=e[2]>>16,c=e[3]>>0,r=e[3]>>16;n&=1023,d&=511,a&=1023,t&=511,(c=1+(c-1&1023))*(r=1+(r-1&511))&&renderer.moveImage(a,t,n,d,c,r)}},handlePacketA0:function(e){l.status&=-268435457;var a=e[1]<<16>>>16,t=e[1]<<0>>>16,n=e[2]<<16>>>16,d=e[2]<<0>>>16;l.img.w=1+(n-1&1023),l.img.h=1+(d-1&511),l.img.x=1023&a,l.img.y=511&t,l.img.index=0,l.transferTotal=l.img.w*l.img.h+1&-2,l.img.pixelCount=l.transferTotal},handlePacketC0:function(e){l.status|=134217728;var a=e[1]<<16>>>16,t=e[1]<<0>>>16,n=e[2]<<16>>>16,d=e[2]<<0>>>16;l.img.w=1+(n-1&1023),l.img.h=1+(d-1&511),l.img.x=1023&a,l.img.y=511&t,l.img.index=0,l.transferTotal=l.img.w*l.img.h+1&-2,l.img.pixelCount=l.transferTotal,renderer.loadImage(l.img.x,l.img.y,l.img.w,l.img.h,l.img.buffer)},handlePacketE1:function(e){l.status=4294965248&l.status|2047&e[0],l.txflip=e[0]>>>12&1,l.tyflip=e[0]>>>13&1,l.updateTexturePage()},handlePacketE2:function(e){l.info[2]=1048575&e[0];const a=((e[0]>>0&31)<<3<<0)+((e[0]>>5&31)<<3<<8)+((e[0]>>10&31)<<3<<16)+((e[0]>>15&31)<<3<<24);l.twin=a},handlePacketE3:function(e){l.info[3]=1048575&e[0],l.drawAreaX1=e[0]<<22>>>22,l.drawAreaY1=e[0]<<12>>>22,renderer.setDrawAreaTL(l.drawAreaX1,l.drawAreaY1)},handlePacketE4:function(e){l.info[4]=1048575&e[0],l.drawAreaX2=e[0]<<22>>>22,l.drawAreaY2=e[0]<<12>>>22,renderer.setDrawAreaBR(l.drawAreaX2,l.drawAreaY2)},handlePacketE5:function(e){l.info[5]=4194303&e[0],l.drawOffsetX=e[0]<<21>>21,l.drawOffsetY=e[0]<<11>>22,renderer.setDrawAreaOF(l.drawOffsetX,l.drawOffsetY)},handlePacketE6:function(e){l.status&=4294961151,l.status|=(3&e[0])<<11},imgTransferComplete:function(e){renderer.storeImage(l.img),l.status|=268435456},dmaTransferMode0200:function(e,a){if(!(8388607&e))return 16;var t=(a>>16)*(65535&a)<<1;l.transferTotal-=t;const n=l.img;for(;--t>=0;){const a=l.img.buffer[n.index++];map16[(2097151&e)>>>1]=a,e+=2}return l.transferTotal<=0&&(l.status&=-134217729),(a>>16)*(65535&a)},dmaTransferMode0201:function(e,a){if(!(8388607&e))return 16;if(0==(-4&e))return(a>>16)*(65535&a);var t=(a>>16)*(65535&a)<<1;l.transferTotal-=t;const n=l.img;for(;--t>=0;){const a=map16[(2097151&e)>>>1];n.buffer[n.index++]=a,e+=2}return l.transferTotal<=0&&(l.imgTransferComplete(l.img),l.updated=!0),(a>>16)*(65535&a)},dmaTransferMode0401:function(e,a){if(!(8388607&e))return 16;if(0!==l.dmaIndex&&abort('not implemented'),0==(-4&e))return(a>>16)*(65535&a);const t=new Set;var n=l.dmaBuffer;let d=0;for(;;){e&=2097151;var h=ram.getInt32(e,!0),i=h>>>24,s=2097151&h;for(e+=4,++d;i>0;){if(t.has(e))return d;t.add(e);const a=ram.getInt32(e,!0)>>>0,s=a>>>24;if(0===r[s]){if(e+=4,--i,++d,c.has(s))continue;return c.add(s),console.warn('invalid packetId:',hex(s,2),hex(h),hex(a)),d}if(s>=72&&s<80||s>=88&&s<96){let a=0;for(;a<4096;++a){const t=ram.getInt32(e,!0);if(e+=4,--i,++d,1431655765===t)break;if(1342197760===t)break;n[a]=t}nextPrimitive(),l.handlers[s].call(this,n,a),l.updated=!0}else{for(var k=0;k<r[s];++k)n[k]=ram.getInt32(e,!0),e+=4,--i,++d;nextPrimitive(),l.handlers[s].call(this,n,0),l.updated=!0}}if(!s||2097151==s)break;e=s}return d},dmaLinkedListMode0002:function(e,a){if(!e)return;if(0==(-4&e))throw 43;a>=65536&&abort('unexpected blck size'),0===a&&(a=65536),e&=2097151;let t=a;for(;--a>=1;){const a=e-4&2097151;ram.setInt32(e,a,!0),e=a}return ram.setInt32(e,16777215,!0),t}};l.handlePacket21=l.handlePacket20,l.handlePacket22=l.handlePacket20,l.handlePacket23=l.handlePacket20,l.handlePacket25=l.handlePacket24,l.handlePacket26=l.handlePacket24,l.handlePacket27=l.handlePacket24,l.handlePacket29=l.handlePacket28,l.handlePacket2A=l.handlePacket28,l.handlePacket2B=l.handlePacket28,l.handlePacket2D=l.handlePacket2C,l.handlePacket2E=l.handlePacket2C,l.handlePacket2F=l.handlePacket2C,l.handlePacket31=l.handlePacket30,l.handlePacket32=l.handlePacket30,l.handlePacket33=l.handlePacket30,l.handlePacket35=l.handlePacket34,l.handlePacket36=l.handlePacket34,l.handlePacket37=l.handlePacket34,l.handlePacket39=l.handlePacket38,l.handlePacket3A=l.handlePacket38,l.handlePacket3B=l.handlePacket38,l.handlePacket3D=l.handlePacket3C,l.handlePacket3E=l.handlePacket3C,l.handlePacket3F=l.handlePacket3C,l.handlePacket41=l.handlePacket40,l.handlePacket42=l.handlePacket40,l.handlePacket43=l.handlePacket40,l.handlePacket44=l.handlePacket40,l.handlePacket45=l.handlePacket40,l.handlePacket46=l.handlePacket40,l.handlePacket47=l.handlePacket40,l.handlePacket49=l.handlePacket48,l.handlePacket4A=l.handlePacket48,l.handlePacket4B=l.handlePacket48,l.handlePacket4C=l.handlePacket48,l.handlePacket4D=l.handlePacket48,l.handlePacket4E=l.handlePacket48,l.handlePacket4F=l.handlePacket48,l.handlePacket51=l.handlePacket50,l.handlePacket52=l.handlePacket50,l.handlePacket53=l.handlePacket50,l.handlePacket54=l.handlePacket50,l.handlePacket55=l.handlePacket50,l.handlePacket56=l.handlePacket50,l.handlePacket57=l.handlePacket50,l.handlePacket59=l.handlePacket58,l.handlePacket5A=l.handlePacket58,l.handlePacket5B=l.handlePacket58,l.handlePacket5C=l.handlePacket58,l.handlePacket5D=l.handlePacket58,l.handlePacket5E=l.handlePacket58,l.handlePacket5F=l.handlePacket58,l.handlePacket61=l.handlePacket60,l.handlePacket62=l.handlePacket60,l.handlePacket63=l.handlePacket60,l.handlePacket65=l.handlePacket64,l.handlePacket66=l.handlePacket64,l.handlePacket67=l.handlePacket64,l.handlePacket69=l.handlePacket68,l.handlePacket6A=l.handlePacket68,l.handlePacket6B=l.handlePacket68,l.handlePacket71=l.handlePacket70,l.handlePacket72=l.handlePacket70,l.handlePacket73=l.handlePacket70,l.handlePacket75=l.handlePacket74,l.handlePacket76=l.handlePacket74,l.handlePacket77=l.handlePacket74,l.handlePacket79=l.handlePacket78,l.handlePacket7A=l.handlePacket78,l.handlePacket7B=l.handlePacket78,l.handlePacket7D=l.handlePacket7C,l.handlePacket7E=l.handlePacket7C,l.handlePacket7F=l.handlePacket7C;for(var h=0;h<256;++h){var i='handlePacket'+hex(h,2).toUpperCase();l.handlers[h]=l[i]||l.invalidPacketHandler}for(h=129;h<=159;++h)l.handlers[h]=l.handlePacket80;for(h=161;h<=191;++h)l.handlers[h]=l.handlePacketA0;for(h=193;h<=223;++h)l.handlers[h]=l.handlePacketC0;return l.info[7]=2,l.info[8]=0,{gpu:l}}));mdlr('enge:psx:gte',(e=>{let a,r,s,c=0,t=0,b=0;const k=new Int32Array(4),n=new Int32Array(4),u=new Int32Array(4),w=new Int32Array(9),y=new Int32Array(9),o=new Int32Array(9),l=new Int32Array(9),A=new Int32Array(3),I=new Int32Array(3),h=new Int32Array(3),i=new Int32Array(4),f=new Float64Array(4),d=new Float64Array(4),g=new Int32Array(64),m=new Int32Array(32),v=new Int32Array(3),x=new Int32Array(3),p=new Int32Array(4),F=(e,a,r,s,c)=>e<a?(g[63]|=m[r],a):e>s?(g[63]|=m[c],s):e,$=e=>{const a=e?0:-32768;f[1]=F(d[1],a,24,32767,24),f[2]=F(d[2],a,23,32767,23),f[3]=F(d[3],a,22,32767,22)},j=()=>{f[1]=(4096*I[0]-d[1])/r,f[2]=(4096*I[1]-d[2])/r,f[3]=(4096*I[2]-d[3])/r,f[1]=F(f[1],-32768,24,32767,24),f[2]=F(f[2],-32768,23,32767,23),f[3]=F(f[3],-32768,22,32767,22)},O=()=>{d[1]=(d[1]+f[1]*f[0])/r,d[2]=(d[2]+f[2]*f[0])/r,d[3]=(d[3]+f[3]*f[0])/r,$(a)},q=(e,s,c)=>{d[1]=(4096*e[0]+s[0]*c[1]+s[1]*c[2]+s[2]*c[3])/r,d[2]=(4096*e[1]+s[3]*c[1]+s[4]*c[2]+s[5]*c[3])/r,d[3]=(4096*e[2]+s[6]*c[1]+s[7]*c[2]+s[8]*c[3])/r,$(a)},z=()=>{const e=i[3]>>>24,a=F(d[1]/16,0,21,255,21),r=F(d[2]/16,0,20,255,20),s=F(d[3]/16,0,19,255,19);i[0]=i[1],i[1]=i[2],i[2]=e<<24|s<<16|r<<8|a<<0},B=e=>{d[1]=65536*(e>>0&255),d[2]=65536*(e>>8&255),d[3]=65536*(e>>16&255),j(),O(),z()},C=e=>{q(l,w,e),q(A,y,f),d[1]=(i[3]>>0&255)*f[1]*16,d[2]=(i[3]>>8&255)*f[2]*16,d[3]=(i[3]>>16&255)*f[3]*16,d[1]=d[1]/r,d[2]=d[2]/r,d[3]=d[3]/r,$(a),z()},D=e=>{q(l,w,e),q(A,y,f),d[1]=(i[3]>>0&255)*f[1]*16,d[2]=(i[3]>>8&255)*f[2]*16,d[3]=(i[3]>>16&255)*f[3]*16,j(),O(),z()},E=e=>{q(l,w,e),q(A,y,f),z()},G=e=>{const c=65535&g[58],t=g[56],b=g[57],k=g[59],n=g[60];d[1]=(4096*h[0]+o[0]*e[1]+o[1]*e[2]+o[2]*e[3])/r,d[1]>8796093022207&&(g[63]|=m[30]),d[1]<-8796093022208&&(g[63]|=m[27]),d[2]=(4096*h[1]+o[3]*e[1]+o[4]*e[2]+o[5]*e[3])/r,d[2]>8796093022207&&(g[63]|=m[29]),d[2]<-8796093022208&&(g[63]|=m[26]),d[3]=(4096*h[2]+o[6]*e[1]+o[7]*e[2]+o[8]*e[3])/r,d[3]>8796093022207&&(g[63]|=m[28]),d[3]<-8796093022208&&(g[63]|=m[25]),$(a),v[0]=v[1],v[1]=v[2],x[0]=x[1],x[1]=x[2],p[0]=p[1],p[1]=p[2],p[2]=p[3];let u=d[3]/s;p[3]=F(u,0,18,65535,18);let w=131072;w=(131072*c/p[3]+1)/2,w>131071&&(g[63]|=m[17],w=131071),d[0]=w*f[1]+t,v[2]=d[0]/65536,d[0]>2147483647&&(g[63]|=m[16]),d[0]<-2147483648&&(g[63]|=m[15]),d[0]=w*f[2]+b,x[2]=d[0]/65536,d[0]>2147483647&&(g[63]|=m[16]),d[0]<-2147483648&&(g[63]|=m[15]),d[0]=w*k+n,f[0]=d[0]/4096,d[0]>2147483647&&(g[63]|=m[16]),d[0]<-2147483648&&(g[63]|=m[15]),v[2]=F(v[2],-1024,14,1023,14),x[2]=F(x[2],-1024,13,1023,13),f[0]=F(f[0],0,12,4096,12)},H=Object.seal({get:e=>{switch(e){case 0:case 2:case 4:case 6:case 23:case 30:case 32:case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:case 59:case 60:case 61:case 62:case 63:return g[e];case 1:return k[3]<<16>>16;case 3:return n[3]<<16>>16;case 5:return u[3]<<16>>16;case 7:return g[e]<<16>>>16;case 8:return f[0]<<16>>16;case 9:return f[1]<<16>>16;case 10:return f[2]<<16>>16;case 11:return f[3]<<16>>16;case 12:return 65535&v[0]|x[0]<<16;case 13:return 65535&v[1]|x[1]<<16;case 14:case 15:return 65535&v[2]|x[2]<<16;case 16:return p[0]<<16>>>16;case 17:return p[1]<<16>>>16;case 18:return p[2]<<16>>>16;case 19:return p[3]<<16>>>16;case 20:return i[0];case 21:return i[1];case 22:return i[2];case 24:return d[0];case 25:return d[1];case 26:return d[2];case 27:return d[3];case 29:var a=0;return a|=f[1]>>7<<0,(a|=f[2]>>7<<5)|f[3]>>7<<10;case 31:return b;case 58:return g[e]<<16>>16;default:abort('get gte.r'+hex(e,2)+' not yet implemented')}},set:(e,a)=>{switch(g[e]=a,e){case 0:k[1]=a<<16>>16,k[2]=a<<0>>16;break;case 1:k[3]=a<<16>>16;break;case 2:n[1]=a<<16>>16,n[2]=a<<0>>16;break;case 3:n[3]=a<<16>>16;break;case 4:u[1]=a<<16>>16,u[2]=a<<0>>16;break;case 5:u[3]=a<<16>>16;break;case 6:i[3]=a;break;case 7:case 23:case 29:case 31:break;case 8:f[0]=a<<16>>16;break;case 9:f[1]=a<<16>>16;break;case 10:f[2]=a<<16>>16;break;case 11:f[3]=a<<16>>16;break;case 12:v[0]=a<<16>>16,x[0]=a<<0>>16;break;case 13:v[1]=a<<16>>16,x[1]=a<<0>>16;break;case 14:v[2]=a<<16>>16,x[2]=a<<0>>16;break;case 15:v[0]=v[1],x[0]=x[1],v[1]=v[2],x[1]=x[2],v[2]=a<<16>>16,x[2]=a<<0>>16;break;case 16:p[0]=a<<16>>>16;break;case 17:p[1]=a<<16>>>16;break;case 18:p[2]=a<<16>>>16;break;case 19:p[3]=a<<16>>>16;break;case 20:i[0]=a;break;case 21:i[1]=a;break;case 22:i[2]=a;break;case 24:d[0]=a<<0>>0;break;case 25:d[1]=a<<0>>0;break;case 26:d[2]=a<<0>>0;break;case 27:d[3]=a<<0>>0;break;case 28:f[1]=(31&a)<<7,f[2]=(992&a)<<2,f[3]=(31744&a)>>3;break;case 30:(e=>{if(2147483648&e&&(e^=4294967295),0===e)b=32;else{for(var a=31;0==(e&1<<a)&&a>=0;--a);b=31-a}})(a);break;case 32:o[0]=a<<16>>16,o[1]=a<<0>>16;break;case 33:o[2]=a<<16>>16,o[3]=a<<0>>16;break;case 34:o[4]=a<<16>>16,o[5]=a<<0>>16;break;case 35:o[6]=a<<16>>16,o[7]=a<<0>>16;break;case 36:g[e]=o[8]=a<<16>>16;break;case 37:h[0]=a<<0>>0;break;case 38:h[1]=a<<0>>0;break;case 39:h[2]=a<<0>>0;break;case 40:w[0]=a<<16>>16,w[1]=a<<0>>16;break;case 41:w[2]=a<<16>>16,w[3]=a<<0>>16;break;case 42:w[4]=a<<16>>16,w[5]=a<<0>>16;break;case 43:w[6]=a<<16>>16,w[7]=a<<0>>16;break;case 44:g[e]=w[8]=a<<16>>16;break;case 45:A[0]=a<<0>>0;break;case 46:A[1]=a<<0>>0;break;case 47:A[2]=a<<0>>0;break;case 48:y[0]=a<<16>>16,y[1]=a<<0>>16;break;case 49:y[2]=a<<16>>16,y[3]=a<<0>>16;break;case 50:y[4]=a<<16>>16,y[5]=a<<0>>16;break;case 51:y[6]=a<<16>>16,y[7]=a<<0>>16;break;case 52:g[e]=y[8]=a<<16>>16;break;case 53:I[0]=a<<0>>0;break;case 54:I[1]=a<<0>>0;break;case 55:I[2]=a<<0>>0;break;case 56:case 57:case 60:g[e]=a<<0>>0;break;case 58:g[e]=a<<16>>>16;break;case 59:g[e]=a<<16>>16;break;case 61:g[e]=c=a<<16>>16;break;case 62:g[e]=t=a<<16>>16;break;case 63:g[e]=2147479552&a,2139611136&g[e]&&(g[e]|=2147483648);break;default:abort('gte.set(r'+hex(e,2)+', '+hex(a)+') not yet implemented')}},command:e=>{switch(r=e>>19&1?4096:1,s=e>>19&1?1:4096,a=e>>10&1,g[63]=0,63&e){case 1:G(k);break;case 6:d[0]=v[0]*(x[1]-x[2])+v[1]*(x[2]-x[0])+v[2]*(x[0]-x[1]),d[0]>2147483647&&(g[63]|=m[16]),d[0]<-2147483648&&(g[63]|=m[15]);break;case 12:d[1]=(f[3]*o[4]-f[2]*o[8])/r,d[2]=(f[1]*o[8]-f[3]*o[0])/r,d[3]=(f[2]*o[0]-f[1]*o[4])/r,$(a);break;case 16:B(i[3]);break;case 17:d[1]=4096*f[1],d[2]=4096*f[2],d[3]=4096*f[3],j(),O(),z();break;case 18:(e=>{switch(e>>17&3){case 0:var a=o;break;case 1:a=w;break;case 2:a=y;break;case 3:a=l}switch(e>>15&3){case 0:var r=k;break;case 1:r=n;break;case 2:r=u;break;case 3:r=f}switch(e>>13&3){case 0:var s=h;break;case 1:s=A;break;case 2:s=I,abort('faulty');break;case 3:s=l}q(s,a,r)})(e);break;case 19:D(k);break;case 20:q(A,y,f),d[1]=(i[3]>>0&255)*f[1]*16,d[2]=(i[3]>>8&255)*f[2]*16,d[3]=(i[3]>>16&255)*f[3]*16,j(),O(),d[1]=d[1]/r,d[2]=d[2]/r,d[3]=d[3]/r,$(a),z();break;case 22:D(k),D(n),D(u);break;case 27:C(k);break;case 28:q(A,y,f),d[1]=(i[3]>>0&255)*f[1]*16,d[2]=(i[3]>>8&255)*f[2]*16,d[3]=(i[3]>>16&255)*f[3]*16,d[1]=d[1]/r,d[2]=d[2]/r,d[3]=d[3]/r,$(a),z();break;case 30:E(k);break;case 32:E(k),E(n),E(u);break;case 40:d[1]=f[1]*f[1]/r,d[2]=f[2]*f[2]/r,d[3]=f[3]*f[3]/r,$(a);break;case 41:d[1]=(i[3]>>0&255)*f[1]*16,d[2]=(i[3]>>8&255)*f[2]*16,d[3]=(i[3]>>16&255)*f[3]*16,j(),O(),z();break;case 42:B(i[0]),B(i[0]),B(i[0]);break;case 45:d[0]=c*(p[1]+p[2]+p[3]),d[0]>2147483647&&(g[63]|=m[16]),d[0]<-2147483648&&(g[63]|=m[15]),g[7]=F(d[0]/4096,0,18,65535,18);break;case 46:d[0]=t*(p[0]+p[1]+p[2]+p[3]),d[0]>2147483647&&(g[63]|=m[16]),d[0]<-2147483648&&(g[63]|=m[15]),g[7]=F(d[0]/4096,0,18,65535,18);break;case 48:G(k),G(n),G(u);break;case 61:d[1]=0,d[2]=0,d[3]=0,O(),z();break;case 62:d[1]=d[1]*r,d[2]=d[2]*r,d[3]=d[3]*r,O(),z();break;case 63:C(k),C(n),C(u);break;default:abort('gte.$'+hex(e,5)+' not yet implemented')}},cycles:e=>{switch(63&e){case 1:return 15;case 6:case 16:case 17:case 18:case 41:return 8;case 12:case 46:return 6;case 19:return 19;case 20:return 13;case 22:return 44;case 27:case 42:return 17;case 28:return 11;case 30:return 14;case 32:return 30;case 40:case 45:case 61:case 62:return 5;case 48:return 23;case 63:return 39;default:return abort('gte.$'+hex(e,5)+' has no cycles'),5}}});for(var J=0;J<=31;++J)m[J]=1<<J;for(J=23;J<=30;++J)m[J]|=2147483648;for(J=13;J<=18;++J)m[J]|=2147483648;return{gte:H}}));mdlr('enge:psx:index',(e=>{let t,n=!1;const o=33868800;function r(){throw console.error(Array.prototype.slice.call(arguments).join(' ')),t.style.borderColor='red',n=!1,spu.silence(),'abort'}let d=!0;document.addEventListener("visibilitychange",(function(){'visible'===document.visibilityState?d=!0:(d=!1,spu.silence())}));const a={timeStamp:0,realtime:0,emutime:0,counter:0};psx.addEvent(0,spu.event.bind(spu)),dma.eventDMA0=psx.addEvent(0,dma.completeDMA0.bind(dma)),dma.eventDMA2=psx.addEvent(0,dma.completeDMA2.bind(dma)),dma.eventDMA3=psx.addEvent(0,dma.completeDMA3.bind(dma)),dma.eventDMA4=psx.addEvent(0,dma.completeDMA4.bind(dma)),dma.eventDMA6=psx.addEvent(0,dma.completeDMA6.bind(dma)),joy.eventIRQ=psx.addEvent(0,joy.completeIRQ.bind(joy)),mdc.event=psx.addEvent(0,mdc.complete.bind(mdc)),dot.event=psx.addEvent(0,dot.complete.bind(dot));let c=psx.addEvent(0,(function(e,t){i=!0,psx.unsetEvent(e)})),i=!1;function s(e){(function(e){const t=e-a.timeStamp;if(a.timeStamp=e,!n||!d||t>250)return;a.realtime+=t;const s=(a.realtime-a.emutime)*(o/1e3);i=!1,psx.setEvent(c,+s),++a.counter,function(){let e=getCacheEntry(cpu.pc);if(!e)return r('invalid pc');handleGamePads();const t=psx;for(;!i;)e=e.code(t),t.clock>=t.eventClock&&(e=t.handleEvents(e));cpu.pc=e.pc}(),a.emutime=psx.clock/(o/1e3)})(e),requestAnimationFrame(s)}function l(){n=!1;let e=getCacheEntry(3217031168);const t=psx;for(;196608!==e.pc;)e=e.code(t),t.clock>=t.eventClock&&(e=t.handleEvents(e));a.realtime=a.emutime=psx.clock/(o/1e3),vector=getCacheEntry(128),cpu.pc=e.pc}function p(e){var t=new FileReader;t.onload=function(t){console.log(escape(e.name),e.size),function(e){const t=new DataView(e);if(21328===t.getUint16(0,!0)){for(let s=0;s<64;s+=4)console.log(hex(s,2),hex(t.getInt32(s,8)));cpu.pc=t.getInt32(16,!0),cpu.gpr[28]=t.getInt32(20,!0),cpu.gpr[29]=t.getInt32(48,!0)||2149580784,cpu.gpr[30]=t.getInt32(48,!0)||2149580784,cpu.gpr[31]=cpu.pc;for(var o=t.getInt32(24,!0),r=t.getInt32(28,!0),d=0;d<r;++d)2048+d>=e.byteLength||ram.setInt8(2097151&o++,t.getInt8(2048+d,!0),!0);clearCodeCache(t.getInt32(24,!0),e.byteLength),n=!0}else if(17229===t.getUint32(0,!0)){console.log('loaded MEMCARD');var a=new Uint8Array(e);let p=joy.devices?joy.devices[0].data:joy.cardOneMemory;for(d=0;d<a.length;++d)p[d]=a[d]}else if(524288===e.byteLength){for(writeStorageStream('bios',e),d=0;d<524288;d+=4){const m=t.getInt32(d,!0);rom.setInt32(d,m,!0)}l();let u=document.querySelector('span.nobios');u&&u.classList.remove('nobios')}else{let f=e.byteLength/4/588,g=[];g.push({id:0,begin:0,end:f});const v=2352;function c(e){let n=t.getInt32(e*v+0,!0)>>>0,o=t.getInt32(e*v+4,!0)>>>0,r=t.getInt32(e*v+8,!0)>>>0;return 4294967040===n&&4294967295===o&&16777215===r||!n&&!o&&!r}function i(e){let n=0;for(let o=0;o<v;o+=4)n|=t.getInt32(e*v+o,!0);return n>>>0==0}let y,b,E,h=0;for(y=h;h<f&&c(h);)++h;for(b=h;h<f&&i(h);)++h;g.push({id:1,begin:y,end:b,data:!0});let I=2;if(h<f){for(y=h;h<f;){for(;h<f&&!i(h);)++h;for(b=h;h<f&&i(h);)++h;E=h,E-b<75||(g.push({id:I,begin:y,end:b,audio:!0}),y=h,I++)}y<f&&(b=E=f,g.push({id:I,begin:y,end:b,audio:!0}))}cdr.setCdImage(t),cdr.setTOC(g),n=!0}}(t.target.result)},t.readAsArrayBuffer(e)}function u(e){e.stopPropagation(),e.preventDefault();const t=e.dataTransfer?e.dataTransfer.files:e.target.files;for(var n,o=0;n=t[o];o++)p(n)}function m(e){e.stopPropagation(),e.preventDefault()}return{init:function(){t=document.getElementById('display'),document.addEventListener('dragover',m,!1),document.addEventListener('drop',u,!1);const e=document.getElementById('file');e?.addEventListener('change',u,!1),settings.updateQuality();const o=document.getElementById('quality');o?.addEventListener('click',(e=>(settings.updateQuality(!0),e.stopPropagation(),e.preventDefault(),!1))),s(performance.now()),t.addEventListener("dblclick",(function(e){n=!n,n||spu.silence()})),t.addEventListener("touchstart",(function(e){n=!n,n||spu.silence()})),window.addEventListener("keydown",(function(e){'F12'!==e.key&&'F11'!==e.key&&'F5'!==e.key&&e.preventDefault()}),!1),window.addEventListener("keyup",(function(e){'1'===e.key&&e.ctrlKey&&renderer.setMode('disp'),'2'===e.key&&e.ctrlKey&&renderer.setMode('draw'),'3'===e.key&&e.ctrlKey&&renderer.setMode('clut8'),'4'===e.key&&e.ctrlKey&&renderer.setMode('clut4'),'0'===e.key&&e.ctrlKey&&renderer.setMode('page2'),'F12'!==e.key&&'F11'!==e.key&&'F5'!==e.key&&e.preventDefault()}),!1),readStorageStream('bios',(e=>{if(e){let n=new Uint32Array(e.buffer);for(var t=0;t<524288;t+=4)map[29360128+t>>>2]=n[t>>>2];let o=document.querySelector('span.nobios');o&&o.classList.remove('nobios'),l()}})),readStorageStream('card1',(e=>{if(e){let t=new Uint8Array(e.buffer);console.log('loading card1',t.length);for(let e=0;e<131072;++e)joy.devices[0].data[e]=t[e]}})),readStorageStream('card2',(e=>{if(e){let t=new Uint8Array(e.buffer);console.log('loading card2',t.length);for(let e=0;e<131072;++e)joy.devices[1].data[e]=t[e]}}))},PSX_SPEED:o,abort:r,context:a}}));mdlr('enge:psx:mdec',(t=>{var s={iq:new Int32Array(128),scale:new Uint8Array(768),zscan:[0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63],aanscales:[16384,22725,21407,19266,16384,12873,8867,4520,22725,31521,29692,26722,22725,17855,12299,6270,21407,29692,27969,25172,21407,16819,11585,5906,19266,26722,25172,22654,19266,15137,10426,5315,16384,22725,21407,19266,16384,12873,8867,4520,12873,17855,16819,15137,12873,10114,6967,3552,8867,12299,11585,10426,8867,6967,4799,2446,4520,6270,5906,5315,4520,3552,2446,1247],SCALERC256:function(t,s){return this.scale[384+t+s]},iqtab_reset:function(){this.iq.fill(0)},iqtab_init:function(t,s){for(let r=0;r<s;++r){const s=255&map8[(t+r&2097151)>>>0];this.iq[r]=s*this.aanscales[this.zscan[63&r]]>>12}},icdt:function(t,s){let r,n,e,i,a=s;for(let a=8;a>0;--a,s+=8){r=t[s+0]+t[s+4]>>0,n=t[s+0]-t[s+4]>>0,i=t[s+2]+t[s+6]>>0,e=t[s+2]-t[s+6]>>0,e=(362*e>>8)-i>>0;const a=r+i>>0,u=r-i>>0,c=n+e>>0,o=n-e>>0;i=t[s+3]+t[s+5]>>0,r=t[s+3]-t[s+5]>>0,n=t[s+1]+t[s+7]>>0,e=t[s+1]-t[s+7]>>0;const h=473*(e-r)>>8,p=n+i>>0,C=(669*r>>8)+h-p>>0,l=(362*(n-i)>>8)-C>>0,d=(277*e>>8)-h+l>>0;t[s+0]=a+p>>5,t[s+1]=c+C>>5,t[s+2]=o+l>>5,t[s+3]=u-d>>5,t[s+4]=u+d>>5,t[s+5]=o-l>>5,t[s+6]=c-C>>5,t[s+7]=a-p>>5}s=a;for(let a=8;a>0;--a,++s){r=t[s+0]+t[s+32]>>0,n=t[s+0]-t[s+32]>>0,i=t[s+16]+t[s+48]>>0,e=t[s+16]-t[s+48]>>0,e=(362*e>>8)-i>>0;const a=r+i>>0,u=r-i>>0,c=n+e>>0,o=n-e>>0;i=t[s+24]+t[s+40]>>0,r=t[s+24]-t[s+40]>>0,n=t[s+8]+t[s+56]>>0,e=t[s+8]-t[s+56]>>0;const h=473*(e-r)>>8,p=n+i>>0,C=(669*r>>8)+h-p>>0,l=(362*(n-i)>>8)-C>>0,d=(277*e>>8)-h+l>>0;t[s+0]=a+p>>0,t[s+8]=c+C>>0,t[s+16]=o+l>>0,t[s+24]=u-d>>0,t[s+32]=u+d>>0,t[s+40]=o-l>>0,t[s+48]=c-C>>0,t[s+56]=a-p>>0}},rl2blk:function(t,s){const r=this.iq;t.fill(0);let n=(2097151&s)>>>1;for(let s=0;s<6;s++){const e=s>=2?0:64,i=64*s,a=65535&map16[n++];let u=0;const c=a>>10,o=a<<22>>22;for(t[i]=r[e]*o;;){const s=65535&map16[n++];if(u+=1+(s>>10),u<=63){const n=s<<22>>22,a=r[e+u]*c*n>>3;t[i+this.zscan[u]]=a}if(u>63)break}this.icdt(t,i)}return n<<1},putquadrgb15:function(t,s,n,e,i){let a,u,c,o,h=r.STP;const p=1433*e>>10,C=-351*i-728*e>>10,l=1807*i>>10,d=(2097151&t)>>>0;a=s[n+0]<<0,u=this.SCALERC256(a,p)>>>3,c=this.SCALERC256(a,C)>>>3,o=this.SCALERC256(a,l)>>>3,map16[d+0>>>1]=h|o<<10|c<<5|u,a=s[n+1]<<0,u=this.SCALERC256(a,p)>>>3,c=this.SCALERC256(a,C)>>>3,o=this.SCALERC256(a,l)>>>3,map16[d+2>>>1]=h|o<<10|c<<5|u,a=s[n+8]<<0,u=this.SCALERC256(a,p)>>>3,c=this.SCALERC256(a,C)>>>3,o=this.SCALERC256(a,l)>>>3,map16[d+32>>>1]=h|o<<10|c<<5|u,a=s[n+9]<<0,u=this.SCALERC256(a,p)>>>3,c=this.SCALERC256(a,C)>>>3,o=this.SCALERC256(a,l)>>>3,map16[d+34>>>1]=h|o<<10|c<<5|u},yuv2rgb15:function(t,s){let r,n=0,e=64,i=128;for(r=0;r<16;r+=2,n+=8,e+=8,i+=16,s+=64)8==r&&(i+=64),this.putquadrgb15(s+0,t,i+0,t[n+0],t[e+0]),this.putquadrgb15(s+4,t,i+2,t[n+1],t[e+1]),this.putquadrgb15(s+8,t,i+4,t[n+2],t[e+2]),this.putquadrgb15(s+12,t,i+6,t[n+3],t[e+3]),this.putquadrgb15(s+16,t,i+64,t[n+4],t[e+4]),this.putquadrgb15(s+20,t,i+66,t[n+5],t[e+5]),this.putquadrgb15(s+24,t,i+68,t[n+6],t[e+6]),this.putquadrgb15(s+28,t,i+70,t[n+7],t[e+7])},putquadrgb24:function(t,s,r,n,e){let i;const a=1433*n>>10,u=-351*e-728*n>>10,c=1807*e>>10,o=(2097151&t)>>>0;i=s[r+0]<<0,map8[o+0]=this.SCALERC256(i,a),map8[o+1]=this.SCALERC256(i,u),map8[o+2]=this.SCALERC256(i,c),i=s[r+1]<<0,map8[o+3]=this.SCALERC256(i,a),map8[o+4]=this.SCALERC256(i,u),map8[o+5]=this.SCALERC256(i,c),i=s[r+8]<<0,map8[o+48]=this.SCALERC256(i,a),map8[o+49]=this.SCALERC256(i,u),map8[o+50]=this.SCALERC256(i,c),i=s[r+9]<<0,map8[o+51]=this.SCALERC256(i,a),map8[o+52]=this.SCALERC256(i,u),map8[o+53]=this.SCALERC256(i,c)},yuv2rgb24:function(t,s){let r;3&s&&abort('alignment');let n=0,e=64,i=128;for(r=0;r<16;r+=2,n+=8,e+=8,i+=16,s+=96)8==r&&(i+=64),this.putquadrgb24(s+0,t,i+0,t[n+0],t[e+0]),this.putquadrgb24(s+6,t,i+2,t[n+1],t[e+1]),this.putquadrgb24(s+12,t,i+4,t[n+2],t[e+2]),this.putquadrgb24(s+18,t,i+6,t[n+3],t[e+3]),this.putquadrgb24(s+24,t,i+64,t[n+4],t[e+4]),this.putquadrgb24(s+30,t,i+66,t[n+5],t[e+5]),this.putquadrgb24(s+36,t,i+68,t[n+6],t[e+6]),this.putquadrgb24(s+42,t,i+70,t[n+7],t[e+7])}},r={r1820:0,r1824:2147745792,rl:0,STP:0,end:0,block:new Int32Array(384),rd32r1820:function(){return r.r1820},wr32r1820:function(t){r.r1820=t},rd32r1824:function(){return r.r1824},wr32r1824:function(t){2147483648&t&&(r.r1820=0,r.r1824=2147745792,psx.unsetEvent(r.event))},dmaTransferMode0201:function(t,n){if(!(8388607&t))return 16;t&=2097151;const e=(n>>>16)*(65535&n);switch(r.r1820>>>29){case 0:case 1:r.rl=t;break;case 2:if(s.iqtab_init(t,e<<2),1073741825!==r.r1820)return abort('unsupported quant mode');break;default:console.log('not implemented',r.r1820>>>29)}return e},dmaTransferMode0200:function(t,n){if(!(8388607&t))return 16;t&=2097151;const e=(n>>>16)*(65535&n);clearCodeCache(t,e<<2);const i=r.block,a=t+(e<<2);r.end=a;let u=0;const c=r.r1820>>>27&3;for(r.STP=r.r1820&1<<25?32768:0;t<a;){switch(r.rl=s.rl2blk(i,r.rl),c){case 0:console.warn('unsupported depth',c),t+=128;break;case 1:console.warn('unsupported depth',c),t+=256;break;case 2:s.yuv2rgb24(i,t),t+=768;break;case 3:s.yuv2rgb15(i,t),t+=512}u+=6}const o=PSX_SPEED/9e3*(u/6);return psx.setEvent(this.event,o>>>0),e},event:null,complete:function(t,s){dma.completeDMA1({}),psx.unsetEvent(t)}};for(let t=0;t<256;++t)s.scale[0+t]=0,s.scale[256+t]=t,s.scale[512+t]=255;return Object.seal(s),Object.seal(r),{mdc:r}}));mdlr('enge:psx:mmu',(r=>{const e=new Int32Array(8388608),a=new Int8Array(e.buffer),c=new Int16Array(e.buffer),t=new DataView(e.buffer,0,2097152),s=new DataView(e.buffer,29360128,524288);return{map:e,map8:a,map16:c,ram:t,rom:s,memRead8:function(r){return r<8388608?(psx.clock+=2,t.getInt8(2097151&r)):r>=25165824&&r<25178112?function(r){switch(psx.clock+=3,16383&r){case 4160:return joy.rd08r1040();case 4164:return joy.rd16r1044()<<24>>24;case 4180:return 0;case 4192:return a[r>>>0]>>0;case 4208:return cpu.istat<<24>>24;case 4336:return dma.rd16r10f0()<<24>>24;case 4342:return dma.rd08r10f6();case 4352:return rc0.getValue()<<24>>24;case 6144:return cdr.rd08r1800();case 6145:return cdr.rd08r1801();case 6146:return cdr.rd08r1802();case 6147:return cdr.rd08r1803();case 6164:return gpu.rd32r1814()<<24>>24;case 6180:return mdc.rd32r1824()<<24>>24;default:if(r<25169920)return psx.clock-=3,a[r>>>0];if(r>=25174016)return psx.clock+=10,a[r>>>0];if(r>=25172992&&r<25174016)return spu.getInt16(16383&r)}}(r)<<24>>24:r>=27262976&&r<27787264?(psx.clock+=5,a[r>>>0]>>0):r>=29360128&&r<29884416?(psx.clock+=8,a[r>>>0]>>0):r>=16777216&&r<17301504?(psx.clock+=6,a[r>>>0]>>0):33423664===r?a[r>>>0]>>0:void abort(`r8: unable to load from $${hex(r,8)}`)},memRead16:function(r){return r<8388608?(psx.clock+=3,t.getInt16(2097151&r,!0)):r>=25165824&&r<25178112?function(r){switch(psx.clock+=3,16383&r){case 4116:return c[r>>>1];case 4164:return joy.rd16r1044();case 4170:return joy.rd16r104a();case 4174:return joy.rd16r104e();case 4180:case 4186:case 4190:case 4400:return 0;case 4192:return c[r>>>1]>>0;case 4208:return cpu.istat;case 4212:return cpu.imask;case 4336:return dma.rd16r10f0();case 4352:return rc0.getValue();case 4356:return rc0.getMode();case 4360:return rc0.getTarget();case 4368:return rc1.getValue();case 4372:return rc1.getMode();case 4376:return rc1.getTarget();case 4384:return rc2.getValue();case 4388:return rc2.getMode();case 4392:return rc2.getTarget();case 6144:return cdr.rd08r1800();case 6164:return gpu.rd32r1814()<<16>>16;case 6180:return mdc.rd32r1824()<<16>>16;default:if(r<25169920)return psx.clock-=3,c[r>>>1];if(r>=25174016)return psx.clock+=24,c[r>>>1];if(r>=25172992&&r<25174016)return spu.getInt16(16383&r)}}(r)<<16>>16:r>=27262976&&r<27787264?(psx.clock+=5,c[r>>>1]>>0):r>=29360128&&r<29884416||r>=16777216&&r<17301504?(psx.clock+=12,c[r>>>1]):33423664===r?c[r>>>1]>>0:void abort(`r16: unable to load from $${hex(r,8)}`)},memRead32:function(r){return r<8388608?(psx.clock+=5,t.getInt32(2097151&r,!0)):r>=25165824&&r<25178112?function(r){switch(psx.clock+=3,16383&r){case 4116:case 4128:case 4192:return e[r>>>2]>>0;case 4164:return joy.rd16r1044()>>0;case 4180:return 0;case 4208:return cpu.istat>>0;case 4212:return cpu.imask>>0;case 4224:return dma.r1080>>0;case 4232:return dma.r1088>>0;case 4240:return dma.r1090>>0;case 4248:return dma.r1098>>0;case 4256:return dma.r10a0>>0;case 4264:return dma.r10a8>>0;case 4272:return dma.r10b0>>0;case 4280:return dma.r10b8>>0;case 4288:return dma.r10c0>>0;case 4296:return dma.r10c8>>0;case 4320:return dma.r10e0>>0;case 4328:return dma.r10e8>>0;case 4336:return dma.rd32r10f0()>>0;case 4340:return dma.rd32r10f4()>>0;case 4352:return rc0.getValue()>>0;case 4356:return rc0.getMode()>>0;case 4360:return rc0.getTarget()>>0;case 4368:return rc1.getValue()>>0;case 4372:return rc1.getMode()>>0;case 4376:return rc1.getTarget()>>0;case 4384:return rc2.getValue()>>0;case 4388:return rc2.getMode()>>0;case 4392:return rc2.getTarget()>>0;case 6144:return cdr.rd08r1800();case 6160:return gpu.rd32r1810()>>0;case 6164:return gpu.rd32r1814()>>0;case 6176:return mdc.rd32r1820()>>0;case 6180:return mdc.rd32r1824()>>0;default:if(r<25169920)return psx.clock-=3,e[r>>>2]>>0;if(r>=25174016)return psx.clock+=56,e[r>>>2]>>0;if(r>=25172992&&r<25174016)return 65535&spu.getInt16(16383&r)|spu.getInt16(r+2&16383)<<16}abort(`r32: unable to load from $${hex(r,8)}`)}(r)>>0:r>=27262976&&r<27787264?(psx.clock+=9,e[r>>>2]>>0):r>=29360128&&r<29884416?(psx.clock+=24,e[r>>>2]>>0):33423664===r?e[r>>>2]>>0:r>=16777216&&r<17301504?(psx.clock+=24,e[r>>>2]):void abort(`r32: unable to load from $${hex(r,8)}`)},memWrite8:function(r,e){if(r<8388608){const c=2097151&r;return a[(c|cpu.forceWriteBits)>>>0]=e,void(fastCache[c]=0)}if(r>=25165824&&r<25174016)return a[r>>>0]=e,void(r>=25169920&&function(r,e){switch(16383&r){case 4160:return joy.wr08r1040(e);case 4342:return dma.wr08r10f6(e);case 6144:return cdr.wr08r1800(e);case 6145:return cdr.wr08r1801(e);case 6146:return cdr.wr08r1802(e);case 6147:return cdr.wr08r1803(e);default:abort(`w8: unable to store at $${hex(r,8)}`)}}(r,e));25174081!==r?abort(`w8: unable to store at $${hex(r,8)}`):a[r>>>0]=e},memWrite16:function(r,e){if(r<8388608){const a=2097151&r;return c[(a|cpu.forceWriteBits)>>>1]=e,void(fastCache[a]=0)}if(r>=25165824&&r<25174016)return c[r>>>1]=e,void(r>=25169920&&function(r,e){switch(16383&r){case 4116:return c[r>>>1]=e;case 4168:return joy.wr16r1048(e);case 4170:return joy.wr16r104a(e);case 4174:return joy.wr16r104e(e);case 4184:case 4186:case 4190:return;case 4208:return void(cpu.istat&=65535&e&cpu.imask);case 4212:return void(cpu.imask=e);case 4336:return dma.wr32r10f0(e);case 4352:return rc0.setValue(e);case 4356:return rc0.setMode(e);case 4360:return rc0.setTarget(e);case 4368:return rc1.setValue(e);case 4372:return rc1.setMode(e);case 4376:return rc1.setTarget(e);case 4384:return rc2.setValue(e);case 4388:return rc2.setMode(e);case 4392:return rc2.setTarget(e);default:if(r>=25172992&&r<25174016)return c[r>>>1]=e,spu.setInt16(16383&r,e);abort(`w16: unable to store at $${hex(r,8)}`)}}(r,e));abort(`w16: unable to store at $${hex(r,8)}`)},memWrite32:function(r,a){if(r<8388608){const c=2097151&r;return e[(c|cpu.forceWriteBits)>>>2]=a,void(fastCache[c]=0)}if(r>=25165824&&r<25174016)return e[r>>>2]=a,void(r>=25169920&&function(r,a){switch(16383&r){case 4096:case 4100:case 4104:case 4108:case 4112:case 4116:case 4120:case 4124:case 4128:case 4192:break;case 4208:cpu.istat&=a&cpu.imask;break;case 4212:cpu.imask=a>>>0;break;case 4224:dma.r1080=a>>>0;break;case 4228:dma.r1084=a>>>0;break;case 4232:dma.wr32r1088(a);break;case 4240:dma.r1090=a>>>0;break;case 4244:dma.r1094=a>>>0;break;case 4248:dma.wr32r1098(a);break;case 4256:dma.r10a0=a>>>0;break;case 4260:dma.r10a4=a>>>0;break;case 4264:dma.wr32r10a8(a);break;case 4272:dma.r10b0=a>>>0;break;case 4276:dma.r10b4=a>>>0;break;case 4280:dma.wr32r10b8(a);break;case 4288:dma.r10c0=a>>>0;break;case 4292:dma.r10c4=a>>>0;break;case 4296:dma.wr32r10c8(a);break;case 4320:dma.r10e0=a>>>0;break;case 4324:dma.r10e4=a>>>0;break;case 4328:dma.wr32r10e8(a);break;case 4336:dma.wr32r10f0(a);break;case 4340:dma.wr32r10f4(a);break;case 4352:rc0.setValue(a);break;case 4356:rc0.setMode(a);break;case 4360:rc0.setTarget(a);break;case 4368:rc1.setValue(a);break;case 4372:rc1.setMode(a);break;case 4376:rc1.setTarget(a);break;case 4384:rc2.setValue(a);break;case 4388:rc2.setMode(a);break;case 4392:rc2.setTarget(a);break;case 6160:gpu.wr32r1810(a);break;case 6164:gpu.wr32r1814(a);break;case 6176:mdc.wr32r1820(a);break;case 6180:mdc.wr32r1824(a);break;default:if(r>=25172992&&r<25174016)return e[r>>>2]=a,spu.setInt16(r+0&16383,a>>>0),void spu.setInt16(r+2&16383,a>>>16);abort(`w32: unable to store at $${hex(r,8)}`)}}(r,a));33423664!==r?abort(`w32: unable to store at $${hex(r,8)}`):e[r>>>2]=a}}}));mdlr('enge:psx:rec',(t=>{function e(t,e,r){const s=["  return function $"+hex(t).toUpperCase()+"(psx) { ++calls;\n    "+e.replace(/[\r\n]/g,'\n    ')+"\n  }"];return s.unshift(''),[...new Set(r||[])].forEach((t=>{s.unshift(`  const _${hex(t)} = getCacheEntry(0x${hex(t)});`)})),s.unshift("'use strict;'"),new Function(s.join('\n'))()}const r={compile02:function(t,e){t.stop=!0,t.jump=!0,t.skipNext=!0,t.branchTarget=(8388607&e)<<2;const r='j       $'+hex(t.branchTarget);return t.setReg(r,0,`target = _${hex(t.branchTarget)}`)},compile03:function(t,e){t.stop=!0,t.jump=!0,t.branchTarget=(8388607&e)<<2;const r='jal     $'+hex(t.branchTarget),s=t.setReg(r,0,`target = _${hex(t.branchTarget)};\n`+t.reg(31)+' = 0x'+hex(t.pc+8));return h.resetConst(31),s},compile04:function(t,e){t.stop=!0,t.branchTarget=t.pc+4+4*(e<<16>>16);const r='beq     r'+t.rs+', r'+t.rt+', $'+hex(e,4);return t.setReg(r,0,`target = (${t.getRS()} === ${t.getRT()}) ? _${hex(t.branchTarget)} : _${hex(t.pc+8)}`)},compile05:function(t,e){t.stop=!0,t.branchTarget=t.pc+4+4*(e<<16>>16);const r='bne     r'+t.rs+', r'+t.rt+', $'+hex(e,4);return t.setReg(r,0,`target = (${t.getRS()} !== ${t.getRT()}) ? _${hex(t.branchTarget)} : _${hex(t.pc+8)}`)},compile06:function(t,e){t.stop=!0,t.branchTarget=t.pc+4+4*(e<<16>>16);const r='blez    r'+t.rs+', $'+hex(e,4);return t.setReg(r,0,`target = (${t.getRS()} <= 0) ? _${hex(t.branchTarget)} : _${hex(t.pc+8)}`)},compile07:function(t,e){t.stop=!0,t.branchTarget=t.pc+4+4*(e<<16>>16);const r='bgtz    r'+t.rs+', $'+hex(e,4);return t.setReg(r,0,`target = (${t.getRS()} > 0) ? _${hex(t.branchTarget)} : _${hex(t.pc+8)}`)},compile08:function(t,e){const r='addi    r'+t.rt+', r'+t.rs+', $'+hex(e,4);if(h.isConst(t.rs)){const s=e<<16>>16,n=h.getConst(t.rs)+s,o=t.setReg(r,t.rt,`0x${hex(n)}`);return h.setConst(t.rt,n),o}const s=t.setReg(r,t.rt,(e<<16>>16)+' + '+t.getRS());return h.resetConst(t.rt),s},compile09:function(t,e){const r='addiu   r'+t.rt+', r'+t.rs+', $'+hex(e,4);if(h.isConst(t.rs)){const s=e<<16>>16,n=h.getConst(t.rs)+s,o=t.setReg(r,t.rt,`0x${hex(n)}`);return h.setConst(t.rt,n),o}const s=t.setReg(r,t.rt,(e<<16>>16)+' + '+t.getRS());return h.resetConst(t.rt),s},compile0A:function(t,e){const r='slti    r'+t.rt+', r'+t.rs+', $'+hex(e,4),s=t.setReg(r,t.rt,'('+t.getRS()+' < '+(e<<16>>16)+') ? 1 : 0');return h.resetConst(t.rt),s},compile0B:function(t,e){const r='sltiu   r'+t.rt+', r'+t.rs+', $'+hex(e,4),s=t.setReg(r,t.rt,'(('+t.getRS()+' >>> 0) < ('+(e<<16>>16)+' >>> 0)) ? 1 : 0');return h.resetConst(t.rt),s},compile0C:function(t,e){const r='andi    r'+t.rt+', r'+t.rs+', $'+hex(e,4);if(h.isConst(t.rs)){const s=e<<16>>>16,n=h.getConst(t.rs)&s,o=t.setReg(r,t.rt,`0x${hex(n)}`);return h.setConst(t.rt,n),o}const s=t.setReg(r,t.rt,t.getRS()+' & 0x'+hex(e,4));return h.resetConst(t.rt),s},compile0D:function(t,e){const r='ori     r'+t.rt+', r'+t.rs+', $'+hex(e,4);if(h.isConst(t.rs)){const s=e<<16>>>16,n=h.getConst(t.rs)|s,o=t.setReg(r,t.rt,`0x${hex(n)}`);return h.setConst(t.rt,n),o}const s=t.setReg(r,t.rt,t.getRS()+' | 0x'+hex(e,4));return h.resetConst(t.rt),s},compile0E:function(t,e){const r='xori    r'+t.rt+', r'+t.rs+', $'+hex(e,4);if(h.isConst(t.rs)){const s=e<<16>>>16,n=h.getConst(t.rs)^s,o=t.setReg(r,t.rt,`0x${hex(n)}`);return h.setConst(t.rt,n),o}const s=t.setReg(r,t.rt,t.getRS()+' ^ 0x'+hex(e,4));return h.resetConst(t.rt),s},compile0F:function(t,e){const r='lui     r'+t.rt+', $'+hex(e,4),s=t.setReg(r,t.rt,'0x'+hex((65535&e)<<16),!0);return h.setConst(t.rt,(65535&e)<<16),s},compile20:function(t,e){const r='lb      r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')',s=t.setReg(r,t.rt,'(memRead8('+t.getOF(e)+') << 24) >> 24');return h.resetConst(t.rt),s},compile21:function(t,e){const r='lh      r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')',s=t.setReg(r,t.rt,'(memRead16 ('+t.getOF(e)+') << 16) >> 16');return h.resetConst(t.rt),s},compile22:function(t,e){const r='lwl     r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')',s=t.setReg(r,0,'cpu.lwl('+t.rt+', '+t.getOF(e)+')');return h.resetConst(t.rt),s},compile23:function(t,e){const r='lw      r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')';if(h.isConst(t.rs)){const s=e<<16>>16,n=h.getConst(t.rs)+s&33554431;if(n<=8388608){t.cycles+=5;const e=t.setReg(r,t.rt,`ram.getInt32(0x${hex(2097151&n)}, true)`);return h.resetConst(t.rt),e}}const s=t.setReg(r,t.rt,'memRead32('+t.getOF(e)+')');return h.resetConst(t.rt),s},compile24:function(t,e){const r='lbu     r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')';if(h.isConst(t.rs)){const s=e<<16>>16,n=h.getConst(t.rs)+s&33554431;if(n<=8388608){t.cycles+=5;const e=t.setReg(r,t.rt,`ram.getUint8(0x${hex(2097151&n)})`);return h.resetConst(t.rt),e}}const s=t.setReg(r,t.rt,'memRead8('+t.getOF(e)+') & 0xff');return h.resetConst(t.rt),s},compile25:function(t,e){const r='lhu     r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')',s=t.setReg(r,t.rt,'memRead16('+t.getOF(e)+') & 0xffff');return h.resetConst(t.rt),s},compile26:function(t,e){const r='lwr     r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')',s=t.setReg(r,0,'cpu.lwr('+t.rt+', '+t.getOF(e)+')');return h.resetConst(t.rt),s},compile28:function(t,e){const r='sb      r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')';return t.setReg(r,0,'memWrite8('+t.getOF(e)+', '+t.getRT()+')')},compile29:function(t,e){const r='sh      r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')';return t.setReg(r,0,'memWrite16('+t.getOF(e)+', '+t.getRT()+')')},compile2A:function(t,e){const r='swl     r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')';return t.setReg(r,0,'cpu.swl('+t.rt+', '+t.getOF(e)+')')},compile2B:function(t,e){const r='sw      r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')';if(h.isConst(t.rs)){const s=e<<16>>16,n=h.getConst(t.rs)+s&33554431;if(n<=8388608){const e=t.setReg(r,0,`map[(0x${hex(2097151&n)} | cpu.forceWriteBits) >> 2] = ${t.getRT()}`);return h.resetConst(t.rt),e}}return t.setReg(r,0,`memWrite32(${t.getOF(e)}, ${t.getRT()})`)},compile2E:function(t,e){const r='swr     r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')';return t.setReg(r,0,'cpu.swr('+t.rt+', '+t.getOF(e)+')')},compile32:function(t,e){const r='lwc2    r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')';return t.setReg(r,0,'gte.set('+t.rt+', memRead32('+t.getOF(e)+'))')},compile3A:function(t,e){const r='swc2    r'+t.rt+', $'+hex(e,4)+'(r'+t.rs+')';return t.setReg(r,0,'memWrite32('+t.getOF(e)+', gte.get('+t.rt+'))')},compile40:function(t,e){if(0===e)return'// '+hex(t.pc)+': '+hex(e)+': nop';const r='sll     r'+t.rd+', r'+t.rt+', $'+(e>>6&31),s=t.setReg(r,t.rd,t.getRT()+' << '+(e>>6&31));return h.resetConst(t.rd),s},compile42:function(t,e){const r='srl     r'+t.rd+', r'+t.rt+', $'+(e>>6&31),s=t.setReg(r,t.rd,t.getRT()+' >>> '+(e>>6&31));return h.resetConst(t.rd),s},compile43:function(t,e){const r='sra     r'+t.rd+', r'+t.rt+', $'+(e>>6&31),s=t.setReg(r,t.rd,t.getRT()+' >> '+(e>>6&31));return h.resetConst(t.rd),s},compile44:function(t,e){const r='sllv    r'+t.rd+', r'+t.rt+', r'+t.rs,s=t.setReg(r,t.rd,t.getRT()+' << ('+t.getRS()+' & 0x1f)');return h.resetConst(t.rd),s},compile46:function(t,e){const r='srlv    r'+t.rd+', r'+t.rt+', r'+t.rs;return h.resetConst(t.rd),t.setReg(r,t.rd,t.getRT()+' >>> ('+t.getRS()+' & 0x1f)')},compile47:function(t,e){const r='srav    r'+t.rd+', r'+t.rt+', r'+t.rs,s=t.setReg(r,t.rd,t.getRT()+' >> ('+t.getRS()+' & 0x1f)');return h.resetConst(t.rd),s},compile48:function(t,e){t.stop=!0,t.jump=!0,t.skipNext=!0;const r='jr      r'+t.rs;return h.isConst(t.rs)?(t.branchTarget=33554431&h.getConst(t.rs),t.setReg(r,0,`target = _${hex(t.branchTarget)}`)):t.setReg(r,0,'target = getCacheEntry('+t.getRS()+')')},compile49:function(t,e){t.stop=!0,t.jump=!0;const r='jalr    r'+t.rs+', r'+t.rd,s=t.setReg(r,t.rd,'0x'+hex(t.pc+8)+';\ntarget = getCacheEntry('+t.getRS()+')');return h.resetConst(t.rd),s},compile4C:function(t,e){return t.stop=!0,t.syscall=!0,t.setReg('syscall',0,'target = cpuException(8 << 2, 0x'+hex(t.pc)+')')},compile4D:function(t,e){return'//break'},compile50:function(t,e){const r='mfhi     r'+t.rd,s=t.setReg(r,t.rd,'cpu.hi');return h.resetConst(t.rd),s},compile51:function(t,e){const r='mthi     r'+t.rs;return t.setReg(r,0,'cpu.hi = '+t.getRS())},compile52:function(t,e){const r='mflo     r'+t.rd,s=t.setReg(r,t.rd,'cpu.lo');return h.resetConst(t.rd),s},compile53:function(t,e){const r='mtlo     r'+t.rs;return t.setReg(r,0,'cpu.lo = '+t.getRS())},compile58:function(t,e){const r='mult    r'+t.rs+', r'+t.rt,s=t.setReg(r,0,'cpu.mult('+t.getRS()+', '+t.getRT()+')');return t.cycles+=8,s},compile59:function(t,e){const r='multu   r'+t.rs+', r'+t.rt,s=t.setReg(r,0,'cpu.multu('+t.getRS()+', '+t.getRT()+')');return t.cycles+=8,s},compile5A:function(t,e){const r='div     r'+t.rs+', r'+t.rt,s=t.setReg(r,0,'cpu.div('+t.getRS()+', '+t.getRT()+')');return t.cycles+=35,s},compile5B:function(t,e){const r='divu    r'+t.rs+', r'+t.rt,s=t.setReg(r,0,'cpu.divu('+t.getRS()+', '+t.getRT()+')');return t.cycles+=35,s},compile60:function(t,e){const r='add     r'+t.rd+', r'+t.rs+', r'+t.rt;if(h.isConst(t.rs)&&h.isConst(t.rt)){const e=h.getConst(t.rs)+h.getConst(t.rt),s=t.setReg(r,t.rd,`0x${hex(e)}`);return h.setConst(t.rd,e),s}const s=t.setReg(r,t.rd,t.getRS()+' + '+t.getRT());return h.resetConst(t.rd),s},compile61:function(t,e){const r='addu    r'+t.rd+', r'+t.rs+', r'+t.rt;if(h.isConst(t.rs)&&h.isConst(t.rt)){const e=h.getConst(t.rs)+h.getConst(t.rt),s=t.setReg(r,t.rd,`0x${hex(e)}`);return h.setConst(t.rd,e),s}const s=t.setReg(r,t.rd,t.getRS()+' + '+t.getRT());return h.resetConst(t.rd),s},compile62:function(t,e){const r='sub     r'+t.rd+', r'+t.rs+', r'+t.rt;if(h.isConst(t.rs)&&h.isConst(t.rt)){const e=h.getConst(t.rs)-h.getConst(t.rt),s=t.setReg(r,t.rd,`0x${hex(e)}`);return h.setConst(t.rd,e),s}const s=t.setReg(r,t.rd,t.getRS()+' - '+t.getRT());return h.resetConst(t.rd),s},compile63:function(t,e){const r='subu    r'+t.rd+', r'+t.rs+', r'+t.rt;if(h.isConst(t.rs)&&h.isConst(t.rt)){const e=h.getConst(t.rs)-h.getConst(t.rt),s=t.setReg(r,t.rd,`0x${hex(e)}`);return h.setConst(t.rd,e),s}const s=t.setReg(r,t.rd,t.getRS()+' - '+t.getRT());return h.resetConst(t.rd),s},compile64:function(t,e){const r='and     r'+t.rd+', r'+t.rs+', r'+t.rt;if(h.isConst(t.rs)&&h.isConst(t.rt)){const e=h.getConst(t.rs)&h.getConst(t.rt),s=t.setReg(r,t.rd,`0x${hex(e)}`);return h.setConst(t.rd,e),s}const s=t.setReg(r,t.rd,t.getRS()+' & '+t.getRT());return h.resetConst(t.rd),s},compile65:function(t,e){const r='or      r'+t.rd+', r'+t.rs+', r'+t.rt;if(h.isConst(t.rs)&&h.isConst(t.rt)){const e=h.getConst(t.rs)|h.getConst(t.rt),s=t.setReg(r,t.rd,`0x${hex(e)}`);return h.setConst(t.rd,e),s}const s=t.setReg(r,t.rd,t.getRS()+' | '+t.getRT());return h.resetConst(t.rd),s},compile66:function(t,e){const r='xor     r'+t.rd+', r'+t.rs+', r'+t.rt;if(h.isConst(t.rs)&&h.isConst(t.rt)){const e=h.getConst(t.rs)^h.getConst(t.rt),s=t.setReg(r,t.rd,`0x${hex(e)}`);return h.setConst(t.rd,e),s}const s=t.setReg(r,t.rd,t.getRS()+' ^ '+t.getRT());return h.resetConst(t.rd),s},compile67:function(t,e){const r='nor     r'+t.rd+', r'+t.rs+', r'+t.rt;if(h.isConst(t.rs)&&h.isConst(t.rt)){const e=~(h.getConst(t.rs)|h.getConst(t.rt)),s=t.setReg(r,t.rd,`0x${hex(e)}`);return h.setConst(t.rd,e),s}const s=t.setReg(r,t.rd,'~('+t.getRS()+' | '+t.getRT()+')');return h.resetConst(t.rd),s},compile6A:function(t,e){const r='slt     r'+t.rd+', r'+t.rs+', r'+t.rt,s=t.setReg(r,t.rd,'('+t.getRS()+' < '+t.getRT()+') ? 1 : 0');return h.resetConst(t.rd),s},compile6B:function(t,e){const r='sltu    r'+t.rd+', r'+t.rs+', r'+t.rt,s=t.setReg(r,t.rd,'(('+t.getRS()+' >>> 0) < ('+t.getRT()+' >>> 0)) ? 1 : 0');return h.resetConst(t.rd),s},compile80:function(t,e){t.stop=!0,t.branchTarget=t.pc+4+4*(e<<16>>16);const r='bltz    r'+t.rs+', $'+hex(e,4);return t.setReg(r,0,`target = (${t.getRS()} < 0) ? _${hex(t.branchTarget)} : _${hex(t.pc+8)}`)},compile81:function(t,e){t.stop=!0,t.branchTarget=t.pc+4+4*(e<<16>>16);const r='bgez    r'+t.rs+', $'+hex(e,4);return t.setReg(r,0,`target = (${t.getRS()} >= 0) ? _${hex(t.branchTarget)} : _${hex(t.pc+8)}`)},compile90:function(t,e){t.stop=!0,t.branchTarget=t.pc+4+4*(e<<16>>16);const r='bltzal  r'+t.rs+', $'+hex(e,4),s=t.setReg(r,0,`target = (${t.getRS()} < 0) ? _${hex(t.branchTarget)} : _${hex(t.pc+8)};\n`+t.reg(31)+' = 0x'+hex(t.pc+8));return h.resetConst(31),s},compile91:function(t,e){t.stop=!0,t.branchTarget=t.pc+4+4*(e<<16>>16);const r='bgezal  r'+t.rs+', $'+hex(e,4),s=t.setReg(r,0,`target = (${t.getRS()} >= 0) ? _${hex(t.branchTarget)} : _${hex(t.pc+8)};\n`+t.reg(31)+' = 0x'+hex(t.pc+8));return h.resetConst(31),s},compileA0:function(t,e){const r='mfc0    r'+t.rt+', r'+t.rd,s=t.setReg(r,t.rt,'cpu.getCtrl('+t.rd+')');return h.resetConst(t.rt),s},compileA4:function(t,e){const r='mtc0    r'+t.rt+', r'+t.rd;return t.setReg(r,0,'cpu.setCtrl('+t.rd+', '+t.getRT()+')')},compileB0:function(t,e){return t.setReg('rfe',0,'cpu.rfe()')},compileC0:function(t,e){const r='mfc2    r'+t.rt+', r'+t.rd,s=t.setReg(r,t.rt,'gte.get('+t.rd+')');return h.resetConst(t.rt),s},compileC2:function(t,e){const r='cfc2    r'+t.rt+', r'+t.rd,s=t.setReg(r,t.rt,'gte.get('+(32+t.rd)+')');return h.resetConst(t.rt),s},compileC4:function(t,e){const r='mtc2    r'+t.rt+', r'+t.rd;return t.setReg(r,0,'gte.set('+t.rd+', '+t.getRT()+')')},compileC6:function(t,e){const r='ctc2    r'+t.rt+', r'+t.rd;return t.setReg(r,0,'gte.set('+(32+t.rd)+', '+t.getRT()+')')},compileD0:function(t,e){t.cycles+=gte.cycles(33554431&e);const r='cop2    0x'+hex(33554431&e);return t.setReg(r,0,'gte.command(0x'+hex(33554431&e)+')')},invalid:(t,e)=>{abort('invalid instruction')}};r.compileD1=r.compileD0,r.compileD2=r.compileD0,r.compileD3=r.compileD0,r.compileD4=r.compileD0,r.compileD5=r.compileD0,r.compileD6=r.compileD0,r.compileD7=r.compileD0,r.compileD8=r.compileD0,r.compileD9=r.compileD0,r.compileDA=r.compileD0,r.compileDB=r.compileD0,r.compileDC=r.compileD0,r.compileDD=r.compileD0,r.compileDE=r.compileD0,r.compileDF=r.compileD0;const s=new Array(256);for(let t=0;t<256;++t)s[t]=r[`compile${hex(t,2).toUpperCase()}`]||r.invalid;function n(t,e,r){const n=u(t.pc),o=map[n>>2];var c=0;switch(o>>>26&63){default:c=0+(o>>>26&63);break;case 0:c=64+(o>>>0&63);break;case 1:c=128+(o>>>16&31);break;case 16:c=160+(o>>>21&31);break;case 18:c=192+(o>>>21&31)}t.rd=o>>>11&31,t.rs=o>>>21&31,t.rt=o>>>16&31,e.push(s[c](t,o))}const o={pc:0,rt:0,rs:0,rd:0,stop:!1,break:!1,syscall:!1,cause:!1,sr:!1,cycles:0,skipNext:!1,entry:null,branchTarget:0,jump:!1,entryPC:0,reg:function(t){return t?'gpr['+t+']':'0'},getRS:function(){if(h.isConst(this.rs)){const t=h.getConst(this.rs);return t<-127||t>127?`(0x${hex(t)}|0)`:`${t}`}return`${this.reg(this.rs)}`},getRT:function(){if(h.isConst(this.rt)){const t=h.getConst(this.rt);return t<-127||t>127?`(0x${hex(t)}|0)`:`${t}`}return`${this.reg(this.rt)}`},getOF:function(t){const e=t<<16>>16;return h.isConst(this.rs)?`0x${hex(e+h.getConst(this.rs)&33554431)}`:e?`(${e} + ${this.reg(this.rs)}) & 0x01ffffff`:`${this.reg(this.rs)} & 0x01ffffff`},setReg:function(t,e,r){const s=map[u(this.pc)>>>2];let n='// '+hex(this.pc)+': '+hex(s)+': '+t;return r&&(n+='\n'+(e?this.reg(e)+' = ':'')+`${r};`),n},clear:function(){this.branchTarget=0,this.jump=!1,this.stop=!1,this.break=!1,this.syscall=!1,this.cause=!1,this.sr=!1,this.cycles=0,this.skipNext=!1}},c=new Map,i=new Uint8Array(2097152);function u(t){let e=33554431&t;return e<8388608&&(e&=2097151),e}i.fill(0),Object.seal(o),Object.seal(r),Object.seal(c);let g=0;function l(){if(this.loop.length){const t=new Set,r=[],s=[];for(let e=0;e<this.loop.length;++e){let n=this.loop[e];t.add(n.pc),s.push(n.text),s.push(`_${hex(n.pc)}.clock = psx.clock;`),s.push(`++_${hex(n.pc)}.count;`),s.push('');let o=e+1<this.loop.length?this.loop[e+1].pc:this.pc;s.push("if (psx.clock >= psx.eventClock) break;"),s.push(`if (target !== _${hex(o)}) break;`),n.jump&&t.add(n.jump.pc),n.next&&t.add(n.next.pc),n.pc<2097152&&r.push(`if (!fastCache[${n.pc}]) { return resetCacheEntry(_${hex(this.pc)}); }\n`),s.push(''),this.code=null,i[n.pc]=1}let n=r.join('');return n+=`\nconst gpr = cpu.gpr; let target = _${hex(this.pc)};\nfor (;;) {\n`,n+=s.join('\n'),n+='\n}\nreturn target;',this.code=e(this.pc,n,[...t]),this.jump=this,this}return this.code=function(t){const r=t.pc>>>0;let s=function(t){const e=t.pc>>>0;o.clear(),o.pc=e,o.entryPC=e,o.entry=t;const r=[];for(h.resetState();!o.stop&&o.cycles<2048;)n(o,r),o.cycles+=1,o.pc+=4;if(!o.stop&&o.cycles>=64){o.branchTarget=o.pc>>>0&33554431,o.skipNext=!0,o.jump=!0;const t=o.setReg('*snip*',0,`target = _${hex(o.branchTarget)}`);r.push(t)}return!o.stop||o.break||o.syscall||o.sr||(n(o,r),o.cycles+=1,o.pc+=4),160!==e&&176!==e&&192!==e||r.unshift(`trace(${e}, gpr[9]);`),r.push('psx.clock += '+o.cycles+';'),r}(t).join('\n').split('\n');t.jump=p(o.branchTarget),t.next=o.skipNext?null:p(o.pc);let c=[o.branchTarget>>>0,o.skipNext?0:o.pc>>>0,r].filter((t=>null!==t||void 0!==t));return t.text=s.join('\n'),s.push(' '),s.push('return target;'),s.unshift(`const gpr = cpu.gpr; let target = _${hex(r)};\n`),r<2097152&&(s.unshift(`if (!fastCache[${r}]) { return invalidateCache(this); }`),i[r]=1),e(r,s.filter((t=>t)).join('\n'),c)}(this),this}function p(t){const e=u(t);let r=c.get(e);return r||(c.set(e,r=a.createCacheEntry(e)),r.code=l),r}const h={values:new Int32Array(32),state:new Int8Array(32),resetState:function(){this.state.fill(0)},isConst:function(t){return!t||this.state[t]},getConst:function(t){return t?this.values[t]:0},setConst:function(t,e){t&&(this.values[t]=e,this.state[t]=1)},resetConst:function(t){this.state[t]=0}},a={createCacheEntry:t=>Object.seal({pc:t>>>0,code:null,jump:null,next:null,count:0,clock:0,opt:!1,text:'',loop:[]})};window.stats=window.stats||{},window.stats.top=(t=1,e=25)=>{const r=psx.clock-33868800*t,s=[...c.values()].filter((t=>t.clock>r)),n=s.reduce(((t,e)=>t+e.count),0);s.sort(((t,e)=>e.count-t.count)).slice(0,e).forEach((t=>{console.log(`$${hex(t.pc)}\t${(t.count/n).toFixed(3)}\t`,{code:t.code},`\t${t.count}`)}))},window.calls=0;const f=33868800,x=0===window.location.href.indexOf('file://');let R=0,d=0,m=0;return psx.addEvent(0,(t=>{const e=renderer.fpsRenderCounter-m;m=renderer.fpsRenderCounter,x&&console.log(`${calls} ${(f/calls).toFixed(1)} ${g} ${context.counter-R}/${renderer.fpsCounter-d}/${e}`),psx.setEvent(t,f),R=context.counter,d=renderer.fpsCounter,g=0,calls=0})),window.vector=null,window.fastCache=i,window.cached=c,window.invalidateCache=t=>(t.code=l,t.count=0,t.clock=0,t.opt=!1,t),window.resetCacheEntry=t=>(t.code=l,t.count=0,t.clock=0,t.opt=!1,t.loop=[],t),{getCacheEntry:p,clearCodeCache:function(t,e){const r=u(t);r>=2097152||(i.fill(0,r,r+e),++g)}}}));mdlr('enge:psx:rtc',(e=>{const t=new Float64Array(4),s=new Uint32Array(4),a=new Uint32Array(4);function c(e,c,n){const i=8&s[e]?11:12;switch(i){case 11:var r=+(a[e]+1);break;case 12:r=65536;break;default:return abort('invalid limit bit')}let o=t[e]+c;return o>=r?(n&&n(),s[e]|=1<<i,o%r):o}t.fill(0),s.fill(0),a.fill(65535);const n={freerun:!1,getValue:function(e){const t=this.freerun;let a=0;switch(7&s[0]){case 0:a=+(psx.clock-o.start);break;case 1:switch(o.whereInScanLine()){case-1:a=0;break;case 0:a=+(psx.clock-o.dispHStart);break;case 1:a=+(o.dispHStop-o.dispHStart)}break;case 3:switch(o.whereInScanLine()){case-1:case 0:a=+(psx.clock-o.start);break;case 1:a=+(psx.clock-o.dispHStop)}break;case 5:switch(o.whereInScanLine()){case-1:a=+(psx.clock-o.start);break;case 0:a=+(o.dispHStart-o.start);break;case 1:a=+(psx.clock-o.dispHStop)}break;case 7:switch(o.whereInScanLine()){case-1:case 0:a=t?+(psx.clock-o.start):0;break;case 1:a=t?+(psx.clock-o.start):+(psx.clock-o.dispHStop)}break;default:return abort(`RC0: invalid mode: $${hex(s[0],4)}`)}return 256&s[0]?c(0,+gpu.cyclesToDotClock(a)):c(0,+a)},getTarget:function(e){return a[0]},getMode:function(){let e=s[0];return s[0]&=59391,e},setMode:function(e){s[0]=1023&e|1024;let a=0;switch(7&e){case 0:a=+(psx.clock-o.start);break;case 1:switch(o.whereInScanLine()){case-1:a=0;break;case 0:a=+(psx.clock-o.dispHStart);break;case 1:a=0}break;case 3:case 5:switch(o.whereInScanLine()){case-1:case 0:a=0;break;case 1:a=+(psx.clock-o.dispHStop)}break;case 7:this.freerun=!1,a=0;break;default:return abort(`RC0: invalid mode: $${hex(s[0],4)}`)}256&s[0]?(t[0]=0,c(0,-gpu.cyclesToDotClock(a))):(t[0]=0,c(0,-a))},setTarget:function(e){e||(e=65535),a[0]=e},setValue:function(e){if(e)return abort('not supported');t[0]=e},onLimitReached:function(){48&s[0]&&(cpu.istat|=16)},onScanLine:function(){const e=this.freerun;let a=0;switch(7&s[0]){case 0:a=+(o.stop-o.start);break;case 1:a=+(o.dispHStop-o.dispHStart);break;case 3:case 5:switch(o.whereInScanLine()){case-1:case 0:a=0;break;case 1:a=-+(psx.clock-o.dispHStop)}break;case 7:a=e?+(o.stop-o.start):+(o.stop-o.dispHStop),this.freerun=!0;break;default:return abort(`RC1: invalid mode: $${hex(s[0],4)}`)}256&s[0]?t[0]=c(0,gpu.cyclesToDotClock(a),this.onLimitReached):t[0]=c(0,a,this.onLimitReached)}},i={freerun:!1,getValue:function(e){switch(o.isInVBlank(),263&s[1]){case 0:return c(1,+(psx.clock-o.start));case 1:return c(1,o.isInVBlank()?0:+psx.eventCycles(o.event));case 3:return c(1,+psx.eventCycles(o.event));case 5:return c(1,(o.isInVBlank(),0));case 7:return this.freerun?c(1,+psx.eventCycles(o.event)):c(1,0);case 256:case 257:case 259:case 261:return c(1,0);case 263:return this.freerun,c(1,0);default:return abort(`RC1: invalid mode: $${hex(s[1],4)}`)}},getTarget:function(e){return a[1]},getMode:function(){let e=s[1];return s[1]&=59391,e},setMode:function(e){switch(s[1]=(319&e|1024)>>>0,263&s[1]){case 0:case 1:case 3:case 5:t[1]=-+(psx.clock-o.start),t[1]=c(1,0);break;case 7:case 263:this.freerun=!1,t[1]=0;break;case 256:case 257:case 259:case 261:t[1]=0;break;default:return abort(`RC1: invalid mode: $${hex(s[1],4)}`)}},setTarget:function(e){e||(e=65535),a[1]=e>>>0},setValue:function(e){if(e)return abort('not supported');t[1]=+e},onLimitReached:function(){48&s[1]&&(cpu.istat|=32)},onScanLine:function(e){const a=+(o.stop-o.start);switch(263&s[1]){case 0:t[1]=c(1,a,this.onLimitReached);break;case 1:t[1]=c(1,o.isInVBlank()?0:a,this.onLimitReached);break;case 3:t[1]=c(1,a,this.onLimitReached),e&&(t[1]=0);break;case 5:t[1]=c(1,o.isInVBlank()?a:0,this.onLimitReached),o.isInVBlank()&&(t[1]=0);break;case 7:this.freerun?t[1]=c(1,a,this.onLimitReached):(t[1]=c(1,0,this.onLimitReached),e&&(this.freerun=!0));break;case 256:t[1]=c(1,1,this.onLimitReached);break;case 257:t[1]=c(1,o.isInVBlank()?0:1,this.onLimitReached);break;case 259:t[1]=c(1,1,this.onLimitReached),e&&(t[1]=0);break;case 261:t[1]=c(1,o.isInVBlank()?0:1,this.onLimitReached),e&&(t[1]=0);break;case 263:this.freerun?t[1]=c(1,1,this.onLimitReached):(t[1]=c(1,0,this.onLimitReached),e&&(this.freerun=!0));break;default:return abort(`RC1: invalid mode: $${hex(s[1],4)}`)}}},r={getValue:function(e){switch(519&s[2]){case 0:case 3:case 5:case 8:return c(2,+(psx.clock-o.start));case 1:case 7:return c(2,0);case 512:return c(2,.125*+(psx.clock-o.start));default:return abort(`RC2: invalid mode: $${hex(s[2],4)}`)}},getTarget:function(e){return a[2]},getMode:function(){let e=s[2];return s[2]&=59391,e},setMode:function(e){switch(s[2]=1023&e|1024,519&s[2]){case 0:case 3:case 5:t[2]=-+(psx.clock-o.start),t[2]=c(2,0);break;case 1:case 7:t[2]=0;break;case 8:t[2]=-1*psx.eventCycles(o.event);break;case 512:t[2]=-.125*psx.eventCycles(o.event);break;default:return abort(`RC2: invalid mode: $${hex(s[2],4)}`)}},setTarget:function(e){e||(e=65535),a[2]=65535&e},setValue:function(e){if(e)return abort('not supported');t[2]=e},onLimitReached:function(){48&s[2]&&(cpu.istat|=64)},onScanLine:function(){switch(519&s[2]){case 0:case 3:case 5:t[2]=c(2,+(o.stop-o.start),this.onLimitReached);break;case 1:case 7:t[2]=c(2,0,this.onLimitReached);break;case 512:t[2]=c(2,.125*+(o.stop-o.start),this.onLimitReached);break;default:return abort(`RC2: invalid mode: $${hex(s[2],4)}`)}}},o={event:null,remainder:0,scanLine:0,vblank:!1,dispHStart:+Number.MAX_SAFE_INTEGER,dispHStop:+Number.MAX_SAFE_INTEGER,start:+Number.MAX_SAFE_INTEGER,stop:+Number.MAX_SAFE_INTEGER,upateToLastGpuState:function(e){const t=7*(gpu.status>>20&1?3406:3413)/11*(PSX_SPEED/33868800);this.start=+e.clock,this.stop=+t+this.start,this.dispHStart=this.start+7*+gpu.dispL/11,this.dispHStop=this.start+7*+gpu.dispR/11},complete:function(e,t){this.upateToLastGpuState(e);const s=gpu.status>>20&1?314:263;this.scanLine=(this.scanLine+1)%s,this.vblank=this.scanLine<gpu.dispT||this.scanLine>=gpu.dispB,n.onScanLine(),i.onScanLine(this.scanLine===gpu.dispB),r.onScanLine(),gpu.onScanLine(this.scanLine);let a=this.stop-this.start;psx.updateEvent(e,+a)},isInVBlank:function(){return this.vblank},whereInScanLine:function(){return psx.clock<this.dispHStart?-1:psx.clock<this.dispHStop?0:1}};return Object.seal(n),Object.seal(i),Object.seal(r),Object.seal(o),{rc0:n,rc1:i,rc2:r,dot:o}}));mdlr('enge:psx:serial',(e=>{const s=e.require('base64');var t={baud:136,data:0,r1044:0,r104a:0,command:0,devices:[{id:0,lo:255,hi:255,data:new Uint8Array(131072),addr:0,checkSum:0,mode:0,response:[],received:[],initMemCard:function(){this.mode=0,this.response=[],this.received=[]},initController:function(){this.mode=0,this.response=[],this.received=[]},buildMemCardResponse:function(e){switch(this.mode=e,e){case 82:this.response.push(0,90,93,0,-1,92,-1,-1,-1);for(let e=0;e<128;++e)this.response.push(-1);this.response.push(-1),this.response.push(71);break;case 87:this.response.push(0,90,93,-1,-1);for(let e=0;e<128;++e)this.response.push(-1);this.response.push(-1),this.response.push(92),this.response.push(93),this.response.push(71);break;default:this.response.push(255)}},buildControllerResponse:function(e){switch(this.mode=e,e){case 66:this.response.push(65,90,this.lo,this.hi);break;case 67:this.response.push(255);break;default:return abort(`unknown subCommand: $${hex(e,2)}`)}},sendReceiveByte:function(e){this.response.length<=0&&console.log(`#${this.id}: reading unexpected in mode $${hex(this.mode,2)}`);let t=this.response.shift()||0;if(82===this.mode&&-1===t){let e=this.received.length;switch(!0){case 4===e:t=this.received[3];break;case 6===e:t=93;break;case 7===e:t=this.received[3],this.checkSum=t;break;case 8===e:this.addr=this.received[3]<<8|this.received[4],t=this.received[4],this.checkSum^=t;break;case e>=9&&e<137:let s=128*this.addr+e-9;t=this.data[s],this.checkSum^=t;break;case 137===e:t=255&this.checkSum}}if(87===this.mode&&-1===t){let i=this.received.length;switch(!0){case 3===i:t=this.received[3],this.checkSum=t;break;case 4===i:t=this.received[3],this.checkSum^=t,this.addr=t<<8|e;break;case i>=5&&i<133:let h=128*this.addr+i-5;t=this.data[h-1],this.data[h]=e,this.checkSum^=e;break;case 133===i:t=this.data[132];const r=s.encode(this.data);localStorage.setItem('card1',r)}}return this.received.push(e),255&t},hasMore:function(){return this.response.length>0}},{id:1,lo:255,hi:255,data:new Uint8Array(131072),addr:0,checkSum:0,mode:0,response:[],received:[],initMemCard:function(){this.mode=0,this.response=[],this.received=[]},initController:function(){this.mode=0,this.response=[],this.received=[]},buildMemCardResponse:function(e){switch(this.mode=e,e){case 82:this.response.push(0,90,93,0,-1,92,-1,-1,-1);for(let e=0;e<128;++e)this.response.push(-1);this.response.push(-1),this.response.push(71);break;case 87:this.response.push(0,90,93,-1,-1);for(let e=0;e<128;++e)this.response.push(-1);this.response.push(-1),this.response.push(92),this.response.push(93),this.response.push(71);break;default:this.response.push(255)}},buildControllerResponse:function(e){switch(this.mode=e,e){case 66:this.response.push(65,90,this.lo,this.hi);break;case 67:this.response.push(255);break;default:return abort(`unknown subCommand: $${hex(e,2)}`)}},sendReceiveByte:function(e){this.response.length<=0&&console.log(`#${this.id}: reading unexpected in mode $${hex(this.mode,2)}`);let t=this.response.shift()||0;if(82===this.mode&&-1===t){let e=this.received.length;switch(!0){case 4===e:t=this.received[3];break;case 6===e:t=93;break;case 7===e:t=this.received[3],this.checkSum=t;break;case 8===e:this.addr=this.received[3]<<8|this.received[4],t=this.received[4],this.checkSum^=t;break;case e>=9&&e<137:let s=128*this.addr+e-9;t=this.data[s],this.checkSum^=t;break;case 137===e:t=255&this.checkSum}}if(87===this.mode&&-1===t){let i=this.received.length;switch(!0){case 3===i:t=this.received[3],this.checkSum=t;break;case 4===i:t=this.received[3],this.checkSum^=t,this.addr=t<<8|e;break;case i>=5&&i<133:let h=128*this.addr+i-5;t=this.data[h-1],this.data[h]=e,this.checkSum^=e;break;case 133===i:t=this.data[132];const r=s.encode(this.data);localStorage.setItem('card2',r)}}return this.received.push(e),255&t},hasMore:function(){return this.response.length>0}}],rd08r1040:function(){return 2&this.r1044&&(this.r1044&=-3),this.data},rd16r1044:function(){return this.r1044},rd16r104a:function(){return this.r104a},rd16r104e:function(){return this.baud},wr08r1040:function(e){let s=null;switch(0==(2&this.r104a)&&abort('should not receive byte for device null'),2==(2&this.r104a)&&(s=8192&this.r104a?this.devices[1]:this.devices[0]),this.command){case 0:if(!s)return this.setResult(255,!0);this.setResult(255,!1),this.command=255&e,129===this.command&&s.initMemCard(),1===this.command&&s.initController();break;case 1:s.buildControllerResponse(255&e),this.command=2;case 2:{let t=s.sendReceiveByte(255&e),i=s.hasMore();this.setResult(t,!i)}break;case 129:s.buildMemCardResponse(255&e),this.command=130;case 130:{let t=s.sendReceiveByte(255&e),i=s.hasMore();this.setResult(t,!i)}break;case 131:return this.setResult(255,!0);default:console.warn('unknown command state:',hex(this.command,4),' device:',s.id)}},wr16r1048:function(e){13!==e&&abort(`invalid JOY_MODE: $${hex(e,4)}`)},wr16r104a:function(e){if(this.r104a=-81&e,64&e||!(2&this.r104a)){let e=null;2==(2&this.r104a)&&(e.initController(),e.initMemCard()),psx.unsetEvent(this.eventIRQ),this.command=0,this.r1044=5}16&e&&(this.r1044&=-513)},wr16r104e:function(e){136!==e&&abort(`invalid JOY_BAUD: $${hex(e,4)}`),this.baud=65535&e},setResult:function(e,s){this.r1044|=2,this.data=255&e,s||psx.setEvent(this.eventIRQ,8*this.baud>>>0)},eventIRQ:null,completeIRQ:function(e,s){this.r1044|=512,cpu.istat|=128,psx.unsetEvent(e)}};return Object.seal(t),{joy:t}}));mdlr('enge:psx:spu',(e=>{const t=22050;let s=null,i=null;for(var a={totalSamples:0,voices:[],index:0,writeIndex:5512,data:new Uint8Array(524288),ENDX:16777215,SPUCNT:0,SPUSTAT:0,SPUSTATm:0,mainVolumeLeft:0,mainVolumeRight:0,reverbVolumeLeft:0,reverbVolumeRight:0,cdVolumeLeft:0,cdVolumeRight:0,extVolumeLeft:0,extVolumeRight:0,irqOffset:0,ramOffset:0,reverbOffset:0,silence:function(){if(s&&i)for(var e=0;e<t;++e)s[e]=i[e]=0},getVolume:function(e){return(e<<17>>16)/32768},getInt16:function(e){switch(e){case 7594:return this.SPUCNT;case 7598:return-64&this.SPUSTAT|63&this.SPUCNT;case 7580:return this.ENDX;default:if(e>=7168&&e<7552){const t=e-7168>>4;return this.voices[t].getRegister(15&e)}return map16[(25165824+e&33554431)>>>1]}},setInt16:function(e,a){switch(a&=65535,e){case 7552:this.mainVolumeLeft=this.getVolume(a);break;case 7554:this.mainVolumeRight=this.getVolume(a);break;case 7556:this.reverbVolumeLeft=this.getVolume(a);break;case 7558:this.reverbVolumeRight=this.getVolume(a);break;case 7560:for(var r=0;r<16;++r)0!=(a&1<<r)&&(this.voices[r].keyOn(),this.ENDX&=~(1<<r));break;case 7562:for(r=0;r<8;++r)0!=(a&1<<r)&&(this.voices[16+r].keyOn(),this.ENDX&=~(1<<16+r));break;case 7564:for(r=0;r<16;++r)0!=(a&1<<r)&&this.voices[r].keyOff();break;case 7566:for(r=0;r<8;++r)0!=(a&1<<r)&&this.voices[16+r].keyOff();break;case 7568:for(r=0;r<16;++r)0!=(a&1<<r)&&this.voices[r].modOn();break;case 7570:for(r=0;r<8;++r)0!=(a&1<<r)&&this.voices[16+r].modOn();break;case 7572:for(r=0;r<16;++r)0!=(a&1<<r)&&this.voices[r].noiseOn();break;case 7574:for(r=0;r<8;++r)0!=(a&1<<r)&&this.voices[16+r].noiseOn();break;case 7576:for(r=0;r<16;++r)0!=(a&1<<r)&&this.voices[r].echoOn();break;case 7578:for(r=0;r<8;++r)0!=(a&1<<r)&&this.voices[16+r].echoOn();break;case 7580:case 7582:case 7584:case 7596:case 7598:case 7608:case 7610:case 7612:case 7614:break;case 7586:this.reverbOffset=a<<3;break;case 7588:this.irqOffset=a<<3;break;case 7590:this.ramOffset=a<<3;break;case 7592:this.data[this.ramOffset+0]=a>>0&255,this.data[this.ramOffset+1]=a>>8&255,this.ramOffset+=2,this.checkIrq();break;case 7594:this.SPUCNT=a,s&&i||!(32768&this.SPUCNT)||function(){const e=new AudioContext,a=e.createBuffer(2,t,e.sampleRate),r=e.createBufferSource();s=a.getChannelData(0),s.fill(0),i=a.getChannelData(1),i.fill(0),r.playbackRate.value=44100/e.sampleRate,r.buffer=a,r.loop=!0,r.connect(e.destination),r.start()}(),64&this.SPUCNT&&(this.SPUSTAT&=-65),this.SPUSTATm=63&this.SPUCNT;break;case 7600:this.cdVolumeLeft=a/32768;break;case 7602:this.cdVolumeRight=a/32768;break;case 7604:this.extVolumeLeft=a/32768;break;case 7606:this.extVolumeRight=a/32768;break;default:if(e>=7168&&e<7552){var h=(e-7168)/16|0;this.voices[h].setRegister(15&e,a);break}if(e>=7616&&e<7680){this.setReverbRegister(e,a);break}abort("Unimplemented spu register:"+hex(e,4))}},dmaTransferMode0200:function(e,t){if(!(8388607&e))return 16;var s=(t>>16)*(65535&t)*4>>>0;for(clearCodeCache(e,s);s>0;){var i=0;i|=this.data[this.ramOffset+0]>>>0<<0,i|=this.data[this.ramOffset+1]>>>0<<8,map16[(2097151&e)>>>1]=i,this.ramOffset+=2,s-=2,e+=2}return(t>>16)*(65535&t)},dmaTransferMode0201:function(e,t){if(!(8388607&e))return 16;for(var s=(t>>16)*(65535&t)*4>>>0;s>0;){const t=map16[(2097151&e)>>>1];this.data[this.ramOffset+0]=t>>0&255,this.data[this.ramOffset+1]=t>>8&255,this.checkIrq(),this.ramOffset+=2,s-=2,e+=2}return(t>>16)*(65535&t)},setReverbRegister:function(e,t){},checkIrq:function(e){if(32832!=(32832&this.SPUCNT))return;const t=this.totalSamples%512<<1;let s=!1;void 0!==e?s=e.checkIrq(this.irqOffset):(this.ramOffset===this.irqOffset&&(s=!0),t===this.irqOffset&&(s=!0)),s&&(cpu.istat|=512,this.SPUSTAT|=64)},event:function(e,r){if(psx.updateEvent(e,PSX_SPEED/44100*8),s&&i){this.SPUSTAT&=-64,this.SPUSTAT|=63&this.SPUSTATm;for(let e=8;e>0;--e){++this.totalSamples;let e=0,r=0;const c=this.totalSamples%512<<1;this.checkIrq();let o=[0,0];for(let t=0;t<24;++t){if(this.voices[t].advance(a.data,o),e+=o[0],r+=o[1],3===t){const e=32768*o[0]>>>0;this.data[3072+c]=255&e,this.data[3073+c]=e>>8}if(1===t){const e=32768*o[0]>>>0;this.data[2048+c]=255&e,this.data[2049+c]=e>>8}}var h=[0,0];cdr.nextpcm(h);let f=h[0]*this.cdVolumeLeft,n=h[1]*this.cdVolumeRight;{const e=32768*f>>>0;this.data[0+c]=255&e,this.data[1+c]=e>>8}{const e=32768*n>>>0;this.data[1024+c]=255&e,this.data[1025+c]=e>>8}e+=f,r+=n,e*=this.mainVolumeLeft,r*=this.mainVolumeRight,s[this.writeIndex]=Math.max(Math.min(e,1),-1),i[this.writeIndex]=Math.max(Math.min(r,1),-1),this.writeIndex=(this.writeIndex+1)%t,0===c&&(this.SPUSTAT&=-2049),512===c&&(this.SPUSTAT|=2048)}}}},r=0;r<24;++r){const{voice:t}=e.require('enge:psx:spu-voice');a.voices[r]=t.setId(r)}const h=new Float32Array(32);h.fill(0),h[2]=60/64,h[3]=0,h[4]=115/64,h[5]=-52/64,h[6]=98/64,h[7]=-55/64,h[8]=122/64,h[9]=-60/64;const c=new Float32Array(8192);for(let e=0;e<16;++e)for(let t=0;t<256;++t){const s=(e<<8)+t<<1;var o;32768&(o=(240&t)<<8)&&(o|=4294901760),c[s+1]=(o>>e)/32768,32768&(o=(15&t)<<12)&&(o|=4294901760),c[s+0]=(o>>e)/32768}return{spu:a,xa2flt:h,xa2pcm:c}}));mdlr('enge:psx:spu-voice',(e=>{const r=114688,a=new Uint32Array(160);(e=>{let r,a,s;e.fill(0),r=3,a=1,s=0;for(let t=32;t<160;++t)r<2147483647&&(r+=a,s++,5===s&&(s=1,a*=2)),r>2147483647&&(r=2147483647),e[t]=r})(a);let s=0,t=0,c=0,n=0,l=0,k=0,o=0,u=0,i=0,b=0,h=0,p=0,f=0,m=0,g=0,w=0,O=r,x=0,y=0,d=new Float32Array(28),I=0,v=0,A=0,q=0,R=new Int32Array(16);const V=[32,36,38,40,41,42,43,44],j=()=>{c=4};return{voice:Object.seal(new class{setId(e){return s=e,this}advance(e,D){O+=w,O>=r&&(O-=r,(e=>{const r=e[y+0],a=e[y+1],c=(15&r)>>>0,n=(240&r)>>>3,l=xa2flt[n+0],k=xa2flt[n+1];let o,u=0;for(let r=2;r<16;++r){let a=(c<<8)+e[y+r]<<1;d[u++]=o=I*l+v*k+xa2pcm[a+0],v=I,I=o,d[u++]=o=I*l+v*k+xa2pcm[a+1],v=I,I=o}4==(4&a)&&(x=y),y+=16,1==(1&a)&&(y=x,spu.ENDX|=1<<s,0==(2&a)&&(j(),t=0))})(e),spu.checkIrq(this));const E=d[O>>>12],F=(()=>{switch(c){case 0:return 0;case 1:t+=n?t<1610612736?a[l-16+32]:a[l-24+32]:a[l-16+32],t>=2147483647&&(c=2);break;case 2:k&&(t-=a[o+(V[t>>29&7]-24)]),(t>>28&15)<=b&&(c=3);break;case 3:u?0==h?t+=t<1610612736?a[i-16+32]:a[i-24+32]:t-=a[i+(V[t>>29&7]-27)]:t+=p;break;case 4:t-=f?a[m+(V[t>>29&7]-24)]:g}return t>2147483647&&(t=2147483647),t<0&&(4===c&&1!==s&&3!==s&&(c=0),t=0),(R[12]=t>>>16)/32768})();return D[0]=E*F*A,D[1]=E*F*q,c}checkIrq(e){return y<=e&&e<y+16}keyOn(){I=0,v=0,O=r,y=R[6]<<3,x=R[14]<<3,c=1,t=0}echoOn(){}modOn(){}noiseOn(){}keyOff(){j()}getRegister(e){return R[15&e]}setRegister(e,r){switch(R[15&e]=r,e%16){case 0:A=spu.getVolume(r);break;case 2:q=spu.getVolume(r);break;case 4:w=Math.min(r,16384);break;case 6:y=r<<3;break;case 8:n=(32768&r)>>>15,l=(32512&r)>>>8^127,k=1,o=((240&r)>>>4^31)<<2,b=(15&r)>>>0;break;case 10:u=(32768&r)>>>15,h=(16384&r)>>>14,i=(8128&r)>>>6^127,f=(32&r)>>>5,m=((31&r)>>>0^31)<<2,g=a[m-12+32],p=0==h?a[i-16+32]:-a[i-15+32];break;case 12:t=r<<16;break;case 14:x=r<<3}}})}}));mdlr('enge:psx:trace',(e=>{const c=/[A-Za-z]{4}_[0-9]{3}\.[0-9]{2}/;let t='',n=null,r='';function o(e){t+=String.fromCharCode(e),10!==e&&13!==e||(t!==n&&(function(){const e=c.exec(t);if(e){let c=e[0].replace('.','').toUpperCase();r!==c&&(document.title=`eNGE - [${c}]`,r=c)}}(),n=t),console.debug(t),t='')}return{trace:function(e,c){switch(e){case 160:60===c&&o(cpu.gpr[4]);break;case 176:61===c&&o(cpu.gpr[4])}}}}));mdlr('enge:psx:webgl2',(e=>{Object.assign(window,e.require('enge:utils')),e.require('enge:webgl2'),e.require('enge:psx')}));mdlr('enge:utils',(t=>{const e=t.require('base64'),o=(()=>{const t=JSON.parse(localStorage.getItem('config')||'{}');return Object.assign({quality:1,overscan:0},t)})();return o.updateQuality=t=>{const e=document.getElementById('quality');e&&(t&&(o.quality<<=1,o.quality>4&&(o.quality=1),localStorage.setItem('config',JSON.stringify(o)),e.classList.add('restart')),e.innerText=`Q${o.quality}`)},window.addEventListener('storage',(()=>{const t=JSON.parse(localStorage.getItem('config')||'{}');Object.assign(o,t)})),{log:function(){console.log.call(console,('000000000000'+psx.clock).substr(-12)+']',Array.prototype.slice.call(arguments).join(''))},hex:function(t,e){return("00000000"+(t>>>0).toString(16)).substr(-(e||8))},readStorageStream:function(t,o){const n=localStorage.getItem(t);return o(n?e.decode(n):null)},writeStorageStream:function(t,o){const n=e.encode(o);localStorage.setItem(t,n)},settings:o}}));mdlr('enge:webgl2',(e=>{const{createVertexBuffer:r,createProgramFromScripts:a}=e.require('enge:webgl2:utils'),t={},d=new Uint32Array(65536),n=new Uint32Array(8388608),s=new Uint8Array(n.buffer),i=r(),l=document.getElementById('display'),o=document.querySelector('#ambilight').getContext('2d',{alpha:!1});o.imageSmoothingEnabled=!1;for(let e=0;e<65536;++e)d[e]=(e>>>0&31)<<3,d[e]|=(e>>>5&31)<<11,d[e]|=(e>>>10&31)<<19,d[e]|=e>>>15&1?4278190080:0;let u=null;try{u=l.getContext("webgl2",{alpha:!1,antialias:!1,preserveDrawingBuffer:!0,premultipliedAlpha:!1,depth:!1,stencil:!1})}catch(e){return abort()}const[T,E,R,c,A,h,p,f,b,x]=[u.STENCIL_TEST,u.FRAMEBUFFER,u.READ_FRAMEBUFFER,u.DRAW_FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_2D,u.RGBA,u.UNSIGNED_BYTE,u.NEAREST,u.COLOR_BUFFER_BIT],[g,m,D,w,N,B,S,F,O,C,y,L,V]=[u.enable,u.disable,u.getUniformLocation,u.texSubImage2D,u.bindFramebuffer,u.framebufferTexture2D,u.blitFramebuffer,u.enableVertexAttribArray,u.getAttribLocation,u.vertexAttribPointer,u.bindTexture,u.texImage2D,u.createFramebuffer].map((e=>e.bind(u))),M=(e,r,a,t,d,n,s=d,i=n)=>Math.abs(e-a)>1023||Math.abs(a-d)>1023||Math.abs(d-e)>1023||Math.abs(s-a)>1023||Math.abs(s-d)>1023||Math.abs(r-t)>511||Math.abs(t-n)>511||Math.abs(n-r)>511||Math.abs(i-t)>511||Math.abs(i-n)>511;function P(e,r=0){return 4278190080&e[0]|16316664&e[r]}function U(){g(u.DEPTH_TEST),N(E,z),B(E,A,h,W,0),B(E,u.DEPTH_ATTACHMENT,h,Z,0),u.clearDepth(0),u.clear(u.DEPTH_BUFFER_BIT),N(E,null),primitiveId=1,m(u.DEPTH_TEST)}function H(e,r=!1,a=!1){if(a){const{x:e,y:r,w:a,h:t}=gpu.getDisplayArea();N(R,z),B(R,A,h,W,0),N(c,J),B(c,A,h,j,0),S(4*e,4*r,4*(e+a),4*(r+t),4*e,4*r,4*(e+a),4*(r+t),x,b)}else{const e=4*(r?t.daLold:t.daL),a=4*(r?t.daTold:t.daT),d=4*(r?t.daRold:t.daR+1),n=4*(r?t.daBold:t.daB+1);N(R,z),B(R,A,h,W,0),N(c,J),B(c,A,h,j,0),S(e,a,d,n,e,a,d,n,x,b)}N(E,null)}function I(e,r){e.size()&&(g(u.DEPTH_TEST),u.depthMask(!0),u.depthFunc(u.GREATER),renderer.setTransparencyMode(r,renderer.programRenderer),u.useProgram(renderer.programRenderer),u.viewport(0,0,4096,2048),u.bindBuffer(u.ARRAY_BUFFER,renderer.displayBuffer),u.bufferData(u.ARRAY_BUFFER,e,u.STREAM_DRAW,e.base(),e.bytes()),N(E,z),B(E,A,h,W,0),B(E,u.DEPTH_ATTACHMENT,h,Z,0),y(h,j),u.drawArrays(u.TRIANGLES,0,e.size()),N(E,null),e.reset(),m(u.DEPTH_TEST))}let v=4;const Y=(e,r)=>{const a=33554432&r[0]?gpu.status>>5&3:4;return 4!==a&&a!==v&&(X(),v=a),e.buffers[a]},X=()=>{I(i);for(let e=4;e>=0;--e)I(renderer.buffers[e],e)},k=(e,r,a={x:0,y:0,w:1024,h:512})=>{const d=e.programDisplay;l.width===a.w*settings.quality&&l.height===a.h*settings.quality||(l.width=o.canvas.width=a.w*settings.quality,l.height=o.canvas.height=a.h*settings.quality),u.viewport(0,0,l.width,l.height),u.useProgram(d);const n=gpu.getDisplayArea();u.uniform4i(d.displayArea,n.x,n.y,n.x+n.w-1,n.y+n.h-1),u.uniform1i(d.mode,r),u.uniform4i(d.drawArea,t.daL,t.daT,t.daR,t.daB),N(E,null),u.bindBuffer(u.ARRAY_BUFFER,e.displayBuffer),u.bufferData(u.ARRAY_BUFFER,(({x:e,y:r,w:a,h:t})=>(i.addVertex(0,0,e+0,r+0),i.addVertex(1024,0,e+a,r+0),i.addVertex(0,512,e+0,r+t),i.addVertex(0,512,e+0,r+t),i.addVertex(1024,0,e+a,r+0),i.addVertex(1024,512,e+a,r+t),i.view()))(a),u.STATIC_DRAW),u.activeTexture(u.TEXTURE0),y(h,W),u.drawArrays(u.TRIANGLES,0,6),i.reset(),l.width&&l.height&&o.drawImage(l,0,0)},G=24,q=()=>{const e=u.createTexture();return y(h,e),u.texParameteri(h,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(h,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),u.texParameteri(h,u.TEXTURE_MIN_FILTER,b),u.texParameteri(h,u.TEXTURE_MAG_FILTER,b),e},W=q();L(h,0,p,4096,2048,0,p,f,null);const Z=((e,r)=>{const a=q();return L(h,0,u.DEPTH_COMPONENT16,4096,2048,0,u.DEPTH_COMPONENT,u.UNSIGNED_SHORT,null),y(h,null),a})(),z=V();N(E,z),B(E,A,h,W,0),y(h,Z),B(E,u.DEPTH_ATTACHMENT,h,Z,0),N(E,null);const j=q();L(h,0,p,4096,2048,0,p,f,null);const J=V();N(E,J),B(E,A,h,j,0),N(E,null);const K=q();L(h,0,p,4096,2048,0,p,f,null);const Q=V();window.primitiveId=0,window.nextPrimitive=()=>{++primitiveId},window.renderer=new class{buffers=[r(),r(),r(),r(),r(!0)];constructor(){this.mode='disp',this.fpsRenderCounter=0,this.fpsCounter=0,this.skipped=0,this.seenRender=!1,u?(m(T),m(u.DEPTH_TEST),m(u.BLEND),m(u.CULL_FACE),m(u.DITHER),m(u.POLYGON_OFFSET_FILL),m(u.SAMPLE_COVERAGE),m(u.SCISSOR_TEST),F(0),u.blendColor(0,0,0,0),u.clearDepth(0),this.displayBuffer=u.createBuffer(),this.programDisplay=(e=>{const r=a(u,'vertex','displayScreen');let t;return u.useProgram(r),r.displayArea=D(r,"u_disp"),r.mode=D(r,"u_mode"),r.drawArea=D(r,"u_draw"),u.bindBuffer(u.ARRAY_BUFFER,e),t=O(r,"a_position"),F(t),C(t,3,u.SHORT,!1,G,0),t=O(r,"a_texcoord"),F(t),C(t,2,u.SHORT,!1,G,6),r})(this.displayBuffer),this.renderBuffer=u.createBuffer(),this.programRenderer=(e=>{const r=a(u,'pixel','videoram');let t;return u.useProgram(r),r.drawArea=D(r,"u_draw"),t=O(r,"a_position"),F(t),C(t,3,u.SHORT,!1,G,0),t=O(r,"a_texcoord"),F(t),C(t,2,u.SHORT,!1,G,6),t=O(r,"a_color"),F(t),C(t,4,f,!0,G,10),t=O(r,"a_twin"),F(t),C(t,4,f,!1,G,14),t=O(r,"a_clut"),F(t),C(t,1,u.SHORT,!1,G,18),t=O(r,"a_tmode"),F(t),C(t,1,u.BYTE,!1,G,20),r})(this.renderBuffer),y(h,W),n.fill(0),w(h,0,0,0,4096,2048,p,f,s),U()):alert("Error: Your browser does not appear to support WebGL.")}loadImage(e,r,a,t,d){X(),N(R,z),B(R,A,h,W,0),N(c,Q),B(c,A,h,K,0),S(4*e,4*r,4*(e+a),4*(r+t),e,r,e+a,r+t,x,b),N(R,Q),u.readPixels(e,r,a,t,p,f,s);const i=a*t;for(let e=0;e<i;++e){const r=n[e];let a=0;a|=r>>>24&255?32768:0,a|=(r>>>19&31)<<10,a|=(r>>>11&31)<<5,a|=(r>>>3&31)<<0,d[e]=a}N(E,null)}moveImage(e,r,a,t,d,n){this.seenRender=!0,X(),N(R,z),B(R,A,h,W,0),N(c,J),B(c,A,h,j,0),S(4*e,4*r,4*(e+d),4*(r+n),4*a,4*t,4*(a+d),4*(t+n),x,b),N(R,J),B(R,A,h,j,0),N(c,z),B(c,A,h,W,0),S(4*a,4*t,4*(a+d),4*(t+n),4*a,4*t,4*(a+d),4*(t+n),x,b),N(R,J),B(R,A,h,j,0),N(c,Q),B(c,A,h,K,0),S(4*a,4*t,4*(a+d),4*(t+n),a,t,a+d,t+n,x,b),N(c,null),N(R,null),u.activeTexture(u.TEXTURE0+0)}storeImage(e){this.seenRender=!0,X();for(let r=0,a=e.pixelCount;r<a;++r){const a=e.buffer[r]>>>0;n[r]=d[a]}const{x:r,y:a,w:t,h:i}=e;y(h,K),w(h,0,r,a,t,i,p,f,s),y(h,null),N(R,Q),B(R,A,h,K,0),N(c,z),B(c,A,h,W,0),S(r,a,r+t,a+i,4*r,4*a,4*(r+t),4*(a+i),x,b),N(R,z),B(R,A,h,W,0),N(c,J),B(c,A,h,j,0),S(4*r,4*a,4*(r+t),4*(a+i),4*r,4*a,4*(r+t),4*(a+i),x,b),N(E,null)}setTransparencyMode(e,r){switch(u.useProgram(r),7&e){case 0:g(u.BLEND),u.blendEquation(u.FUNC_ADD),u.blendColor(0,0,0,.5),u.blendFuncSeparate(u.CONSTANT_ALPHA,u.CONSTANT_ALPHA,u.ONE,u.ZERO);break;case 1:g(u.BLEND),u.blendEquation(u.FUNC_ADD),u.blendColor(0,0,0,1),u.blendFuncSeparate(u.CONSTANT_ALPHA,u.CONSTANT_ALPHA,u.ONE,u.ZERO);break;case 2:g(u.BLEND),u.blendEquationSeparate(u.FUNC_REVERSE_SUBTRACT,u.FUNC_ADD),u.blendFunc(u.ZERO,u.ONE_MINUS_SRC_COLOR,u.ONE,u.ZERO);break;case 3:g(u.BLEND),u.blendEquation(u.FUNC_ADD),u.blendColor(0,0,0,.75),u.blendFuncSeparate(u.ONE_MINUS_CONSTANT_ALPHA,u.ONE,u.ONE,u.ZERO);break;case 4:m(u.BLEND)}}drawLine(e,r,a,d,n){this.seenRender=!0,this.updateDrawArea();var s=t.daX+(e[a]<<21>>21),i=t.daY+(e[a]<<5>>21),l=t.daX+(e[n]<<21>>21),o=t.daY+(e[n]<<5>>21);if(M(s,i,l,o,s,i))return;const u=Y(renderer,e);var T=Math.abs(s-l),E=Math.abs(i-o),R=u;s!==l||i!==o?T>=E?(R.addVertex(s,i+1,0,0,4278190080&e[0]|16777215&e[r]),R.addVertex(s,i+0,0,0,4278190080&e[0]|16777215&e[r]),R.addVertex(l,o+0,0,0,4278190080&e[0]|16777215&e[d]),R.addVertex(l,o+0,0,0,4278190080&e[0]|16777215&e[d]),R.addVertex(l,o+1,0,0,4278190080&e[0]|16777215&e[d]),R.addVertex(s,i+1,0,0,4278190080&e[0]|16777215&e[r])):(R.addVertex(s+0,i,0,0,4278190080&e[0]|16777215&e[r]),R.addVertex(s+1,i,0,0,4278190080&e[0]|16777215&e[r]),R.addVertex(l+1,o,0,0,4278190080&e[0]|16777215&e[d]),R.addVertex(l+1,o,0,0,4278190080&e[0]|16777215&e[d]),R.addVertex(l+0,o,0,0,4278190080&e[0]|16777215&e[d]),R.addVertex(s+0,i,0,0,4278190080&e[0]|16777215&e[r])):(R.addVertex(l+0,o+0,0,0,4278190080&e[0]|16777215&e[d]),R.addVertex(l+1,o+0,0,0,4278190080&e[0]|16777215&e[d]),R.addVertex(l+0,o+1,0,0,4278190080&e[0]|16777215&e[d]),R.addVertex(l+0,o+1,0,0,4278190080&e[0]|16777215&e[d]),R.addVertex(l+1,o+0,0,0,4278190080&e[0]|16777215&e[d]),R.addVertex(l+1,o+1,0,0,4278190080&e[0]|16777215&e[d]))}drawTriangle(e,r,a,d,n,s,i,l,o,u,T,E,R){this.seenRender=!0,this.updateDrawArea(),r=P(e,r),d=P(e,d),s=P(e,s);const c=t.daX+(e[a]<<21>>21),A=t.daY+(e[a]<<5>>21),h=t.daX+(e[n]<<21>>21),p=t.daY+(e[n]<<5>>21),f=t.daX+(e[i]<<21>>21),b=t.daY+(e[i]<<5>>21);if(M(c,A,h,p,f,b))return;const x=Y(renderer,e),g=e[u]>>>0&255,m=e[u]>>>8&255,D=e[T]>>>0&255,w=e[T]>>>8&255,N=e[E]>>>0&255,B=e[E]>>>8&255;x.addVertex(c,A,g,m,r,R),x.addVertex(h,p,D,w,d,R),x.addVertex(f,b,N,B,s,R)}drawRectangle(e,r,a,d){this.seenRender=!0,this.updateDrawArea();var n=t.daX+(e[1]<<21>>21),s=t.daY+(e[1]<<5>>21),i=P(e,0),l=e[2]<<16>>16,o=e[2]>>16;if(!l||!o)return;if(M(n,s,n+l,s,n,s+o,n+l,s+o))return;const u=Y(renderer,e);var T=r+0,E=r+l;gpu.txflip&&(T=r+0,E=r-l+1);var R=a+0,c=a+o;gpu.tyflip&&(R=a+0,c=a-o+1);var A=u;A.addVertex(n+0,s+0,T,R,i,d),A.addVertex(n+l,s+0,E,R,i,d),A.addVertex(n+0,s+o,T,c,i,d),A.addVertex(n+l,s+0,E,R,i,d),A.addVertex(n+0,s+o,T,c,i,d),A.addVertex(n+l,s+o,E,c,i,d)}fillRectangle(e){X();var r=e[1]<<16>>>16,a=e[1]<<0>>>16,t=e[2]<<16>>>16,d=e[2]<<0>>>16,i=16316664&e[0];(t||d)&&(r&=1008,a&=511,t=15+(1023&t)&-16,d&=511,n.fill(i,0,t*d),y(h,K),w(h,0,r,a,t,d,p,f,s),y(h,null),N(R,Q),B(R,A,h,K,0),N(c,z),B(c,A,h,W,0),S(r,a,r+t,a+d,4*r,4*a,4*(r+t),4*(a+d),x,b),N(R,z),B(R,A,h,W,0),N(c,J),B(c,A,h,j,0),S(4*r,4*a,4*(r+t),4*(a+d),4*r,4*a,4*(r+t),4*(a+d),x,b),N(c,null),N(R,null),N(E,null))}updateDrawArea(){t.daM&&(X(),H(0,!0),U(),t.daM=!1,u.useProgram(this.programRenderer),u.uniform4i(this.programRenderer.drawArea,t.daL,t.daT,t.daR,t.daB))}setDrawAreaOF(e,r){t.daX=e,t.daY=r}setDrawAreaTL(e,r){t.daLold=t.daL,t.daTold=t.daT,t.daL=e,t.daT=r,t.daM=!0}setDrawAreaBR(e,r){t.daRold=t.daR,t.daBold=t.daB,t.daR=e,t.daB=r,t.daM=!0}onVBlankBegin(){}onVBlankEnd(){if(++this.fpsCounter,!this.seenRender)return;X(),U(),H(0,!1,!0),++this.fpsRenderCounter,this.seenRender=!1,this.setTransparencyMode(4,this.programDisplay);const e=gpu.getDisplayArea();switch(this.mode){case'clut4':k(this,3);break;case'clut8':k(this,2);break;case'draw':k(this,6);break;case'page2':k(this,7);break;case'disp':const r=settings.overscan*e.w,a=settings.overscan*e.h;e.x+=r>>1,e.y+=a>>1,e.w-=r>>0,e.h-=a>>0,k(this,gpu.status>>21&5,e)}}setMode(e){this.mode=e,this.seenRender=!0}}}));mdlr('enge:webgl2:utils',(t=>{function e(t,e,n){var r=document.getElementById(e);if(!r)throw"*** Error: unknown script element: "+e;var i=r.text;if(!n)if("x-shader/x-vertex"==r.type)n=t.VERTEX_SHADER;else if("x-shader/x-fragment"==r.type)n=t.FRAGMENT_SHADER;else if(!n)throw"*** Error: shader type not set";return function(t,e,n){var r=t.createShader(n);if(t.shaderSource(r,e),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))throw"could not compile shader:"+t.getShaderInfoLog(r);return r}(t,i,n)}return{createProgramFromScripts:function(t,n,r){return function(t,e,n){var r=t.createProgram();if(t.attachShader(r,e),t.attachShader(r,n),t.linkProgram(r),!t.getProgramParameter(r,t.LINK_STATUS))throw"program filed to link:"+t.getProgramInfoLog(r);return r}(t,e(t,n,t.VERTEX_SHADER),e(t,r,t.FRAGMENT_SHADER))},createVertexBuffer:function(t=!1){const e=new Uint8Array(1048576),n=new DataView(e.buffer);return e.addVertex=function(e,r,i,s,h=8421504,a){t&&(this.index-=24),n.setInt16(this.index+0,e,!0),n.setInt16(this.index+2,r,!0),n.setInt16(this.index+4,primitiveId,!0),n.setInt16(this.index+6,i,!0),n.setInt16(this.index+8,s,!0),n.setUint32(this.index+10,h,!0),n.setUint32(this.index+14,gpu.twin,!0),n.setUint16(this.index+18,a>>>0,!0),n.setUint8(this.index+20,gpu.status>>7&3|(31&gpu.status)<<2,!0),t||(this.index+=24)},e.reset=function(){this.index=t?this.length:0},e.size=function(){return t?(this.length-this.index)/24:this.index/24},e.view=function(){return t?new Uint8Array(this.buffer,this.index,this.length-this.index):new Uint8Array(this.buffer,0,this.index)},e.base=function(){return t?this.index:0},e.bytes=function(){return t?this.length-this.index:this.index},e.reset(),e}}}));mdlr('[unit]enge:psx:webgl2')